let gameState={version:1.306},gameConfig={levels:["Level1Fight1","Level1Fight2","Level1Fight3","Level2Fight1","Level2Fight2","Level2Fight3","Level3Fight1","Level3Fight2","Level3Fight3","Level4Fight1","Level4Fight2","Level4Fight3","Endscene"]};class Preload extends Phaser.Scene{constructor(){super("Preload")}preload(){WebFont.load({custom:{families:["Rock Kapak"]},active:()=>{this.fontLoaded=!0}});const e=this.cameras.main.width,t=this.cameras.main.height,a=e/2,r=t/2,n=this.add.graphics(),o=this.add.graphics();n.fillStyle(2236962,.8),n.fillRect(e/2-160,270,320,50);const s=this.add.text(a,r-50,"Loading...",{font:"20px monospace",fill:"#ffffff"}).setOrigin(.5,.5),i=this.add.text(a,r-5,"0%",{font:"18px monospace",fill:"#ffffff"}).setOrigin(.5,.5);this.load.on("progress",(function(t){i.setText(parseInt(100*t)+"%"),o.clear(),o.fillStyle(16777215,1),o.fillRect(e/2-150,280,300*t,30)})),this.load.on("complete",(function(){o.destroy(),n.destroy(),s.destroy(),i.destroy()})),gameState.restartGame||(this.load.image("knuckleFist","assets/images/cards/knuckleFist.jpg"),this.load.image("kabutu","assets/images/cards/kabutu.jpg"),this.load.image("combatBoots","assets/images/cards/combatBoots.jpg"),this.load.image("tantoBlade","assets/images/cards/tantoBlade.jpg"),this.load.image("circlePit","assets/images/cards/circlePit.jpg"),this.load.image("seppuku","assets/images/cards/seppuku.jpg"),this.load.image("katana","assets/images/cards/katana.jpg"),this.load.image("rocknRonin","assets/images/cards/rocknRonin.jpg"),this.load.image("powerChord","assets/images/cards/powerChord.jpg"),this.load.image("rawEnergy","assets/images/cards/rawEnergy.jpg"),this.load.image("pyromania","assets/images/cards/pyromania.jpg"),this.load.image("stageInvasion","assets/images/cards/stageInvasion.jpg"),this.load.image("studdedLeather","assets/images/cards/studdedLeather.jpg"),this.load.image("boneShredder","assets/images/cards/boneShredder.jpg"),this.load.image("blackFumes","assets/images/cards/blackFumes.jpg"),this.load.image("masakari","assets/images/cards/masakari.jpg"),this.load.image("discontent","assets/images/cards/discontent.jpg"),this.load.image("dogsOfWar","assets/images/cards/dogsOfWar.jpg"),this.load.image("roninsRot","assets/images/cards/roninsRot.jpg"),this.load.image("libertySpikes","assets/images/cards/libertySpikes.jpg"),this.load.image("moshpitMassacre","assets/images/cards/moshpitMassacre.jpg"),this.load.image("bladesBlight","assets/images/cards/bladesBlight.jpg"),this.load.image("scorchedSoul","assets/images/cards/scorchedSoul.jpg"),this.load.image("risingWakizashi","assets/images/cards/risingWakizashi.jpg"),this.load.image("deadCities","assets/images/cards/deadCities.jpg"),this.load.image("nastyNihonto","assets/images/cards/nastyNihonto.jpg"),this.load.image("crowdSurfer","assets/images/cards/crowdSurfer.jpg"),this.load.image("shogunShred","assets/images/cards/shogunShred.jpg"),this.load.image("rocknRejuvinate","assets/images/cards/rocknRejuvinate.jpg"),this.load.image("detox","assets/images/cards/detox.jpg"),this.load.image("laidoSoho","assets/images/cards/laidoSoho.jpg"),this.load.image("dBeat","assets/images/cards/dBeat.jpg"),this.load.image("shikoroStrike","assets/images/cards/shikoroStrike.jpg"),this.load.image("rottenResonance","assets/images/cards/rottenResonance.jpg"),this.load.image("troopsOfTakamori","assets/images/cards/troopsOfTakamori.jpg"),this.load.image("bassSolo","assets/images/cards/bassSolo.jpg"),this.load.image("zenZine","assets/images/cards/zenZine.jpg"),this.load.image("kabutuOverdrive","assets/images/cards/kabutuOverdrive.jpg"),this.load.image("nenguStyle","assets/images/cards/nenguStyle.jpg"),this.load.image("canibalize","assets/images/cards/canibalize.jpg"),this.load.image("bloodOath","assets/images/cards/bloodOath.jpg"),this.load.image("roninMerc","assets/images/cards/roninMerc.jpg"),this.load.image("pyroPunk","assets/images/cards/pyroPunk.jpg"),this.load.image("pissDrunkBastards","assets/images/cards/pissDrunkBastards.jpg"),this.load.image("gutterGeisha","assets/images/cards/gutterGeisha.jpg"),this.load.image("noFuture","assets/images/cards/noFuture.jpg"),this.load.image("coverCharge","assets/images/cards/coverCharge.jpg"),this.load.image("wrathOfMoen","assets/images/cards/wrathOfMoen.jpg"),this.load.image("saisenBlaster","assets/images/cards/saisenBlaster.jpg"),this.load.image("riotRonin","assets/images/cards/riotRonin.jpg"),this.load.image("rebelLife","assets/images/cards/rebelLife.jpg"),this.load.image("soulSquatter","assets/images/cards/soulSquatter.jpg"),this.load.image("soulSquatterToken","assets/images/cards/soulSquatterToken.png"),this.load.image("punksNotDead","assets/images/cards/punksNotDead.jpg"),this.load.image("punksNotDeadToken","assets/images/cards/punksNotDeadToken.png"),this.load.image("lustForLifeToken","assets/images/cards/lustForLifeToken.png"),this.load.image("lustForLife","assets/images/cards/lustForLife.jpg"),this.load.image("gundanSeizaiToken","assets/images/cards/gundanSeizaiToken.png"),this.load.image("gundanSeizai","assets/images/cards/gundanSeizai.jpg"),this.load.image("deadTokugawasToken","assets/images/cards/deadTokugawasToken.png"),this.load.image("deadTokugawas","assets/images/cards/deadTokugawas.jpg"),this.load.image("toxicFrets","assets/images/cards/toxicFrets.jpg"),this.load.image("toxicFretsToken","assets/images/cards/toxicFretsToken.png"),this.load.image("ashenEncore","assets/images/cards/ashenEncore.jpg"),this.load.image("ashenEncoreToken","assets/images/cards/ashenEncoreToken.png"),this.load.image("edoEruption","assets/images/cards/edoEruption.jpg"),this.load.image("edoEruptionToken","assets/images/cards/edoEruptionToken.png"),this.load.image("steelToe","assets/images/cards/steelToe.jpg"),this.load.image("steelToeToken","assets/images/cards/steelToeToken.png"),this.load.image("foreverTrueToken","assets/images/cards/foreverTrueToken.png"),this.load.image("foreverTrue","assets/images/cards/foreverTrue.jpg"),this.load.image("rebelSpiritToken","assets/images/cards/rebelSpiritToken.png"),this.load.image("rebelSpirit","assets/images/cards/rebelSpirit.jpg"),this.load.image("rebelHeartToken","assets/images/cards/rebelHeartToken.png"),this.load.image("rebelHeart","assets/images/cards/rebelHeart.jpg"),this.load.image("bushidoToken","assets/images/cards/bushidoToken.png"),this.load.image("bushido","assets/images/cards/bushido.jpg"),this.load.image("toxicAvengerToken","assets/images/cards/toxicAvengerToken.png"),this.load.image("toxicAvenger","assets/images/cards/toxicAvenger.jpg"),this.load.image("kirisuteGomenToken","assets/images/cards/kirisuteGomenToken.png"),this.load.image("kirisuteGomen","assets/images/cards/kirisuteGomen.jpg"),this.load.image("hollidayInKamakuraToken","assets/images/cards/hollidayInKamakuraToken.png"),this.load.image("hollidayInKamakura","assets/images/cards/hollidayInKamakura.jpg"),this.load.image("kamishimoUberAllesToken","assets/images/cards/kamishimoUberAllesToken.png"),this.load.image("kamishimoUberAlles","assets/images/cards/kamishimoUberAlles.jpg"),this.load.image("bouncingSolesToken","assets/images/cards/bouncingSolesToken.png"),this.load.image("bouncingSoles","assets/images/cards/bouncingSoles.jpg"),this.load.image("bouncingSoles2","assets/images/cards/bouncingSoles2.jpg"),this.load.image("bouncingSoles3","assets/images/cards/bouncingSoles3.jpg"),this.load.image("bouncingSoles4","assets/images/cards/bouncingSoles4.jpg"),this.load.image("enduringSpiritToken","assets/images/cards/enduringSpiritToken.png"),this.load.image("enduringSpirit","assets/images/cards/enduringSpirit.jpg"),this.load.image("shogunsShellToken","assets/images/cards/shogunsShellToken.png"),this.load.image("shogunsShell","assets/images/cards/shogunsShell.jpg"),this.load.image("chemicalWarfareToken","assets/images/cards/chemicalWarfareToken.png"),this.load.image("chemicalWarfare","assets/images/cards/chemicalWarfare.jpg"),this.load.image("zaibatsuUndergroundToken","assets/images/cards/zaibatsuUndergroundToken.png"),this.load.image("zaiUnderground","assets/images/cards/zaibatsuUnderground.jpg"),this.load.image("bgLoadingScreen","assets/images/bgLoadingScreen.jpg"),this.load.audio("titleTheme","assets/sounds/music/TitleTheme.mp3"),this.load.audio("thundersound","assets/sounds/thundersound.mp3"),this.load.image("shop1","assets/images/shop1.jpg"),this.load.audio("bossTune","assets/sounds/music/DecisiveBattle.mp3"),this.load.audio("attackSound","assets/sounds/attacksound.wav"),this.load.audio("powerUpSound","assets/sounds/powerupsound.wav"),this.load.audio("healSound","assets/sounds/healsound.wav"),this.load.audio("victorySound","assets/sounds/victorysound.mp3"),this.load.audio("keyboardSound","assets/sounds/keyboardsound.mp3"),this.load.audio("coinSound","assets/sounds/coinsound.mp3"),this.load.image("goldCard","assets/images/goldCard.jpg"),this.load.image("goldCoin","assets/images/goldCoin.png"))}create(){self=this,this.input.keyboard.createCursorKeys(),gameState.score={numberOfTurns:0,levelsCompleted:0,damageTaken:0,damageDealt:0,totaleScore:0},gameState.player={healthBarColor:"0x00ff00",alive:!0,stance:"Neutral",stancePoints:0,gold:0,goldMax:99,poison:0,numCards:5,numCardsBase:5,numCardsStance:0,health:100,healthMax:100,mana:3,manaMax:3,manaBase:3,manaStance:0,manaCard:0,strength:0,strengthMax:15,strengthBase:0,strengthStance:0,strengthCard:0,armor:0,armorMax:15,armorBase:0,armorStance:0,armorCard:0,lifeStealBase:0,lifeStealThisTurn:0},gameState.enemy={name:"Name",sprite:"",healthBarColor:"0xff0000",alive:!0,actions:[],health:40,healthMax:40,strength:0,strengthBase:0,strengthTurn:0,strengthMax:15,armor:0,armorMax:15,poison:0},gameState.deck=[{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"combatBoots",type:"targetAll",cost:2,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?1+gameState.player.stancePoints:1,reduceTargetStrength:0,drawCard:0},{key:"tantoBlade",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?12-2*gameState.player.stancePoints:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"discontent",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints>0?-2:gameState.player.stancePoints<0?2:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}],gameState.bonusCards=[{key:"kamishimoUberAlles",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kamishimoUberAllesToken"},{key:"hollidayInKamakura",type:"permanent",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"hollidayInKamakuraToken"},{key:"rebelSpirit",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelSpiritToken"},{key:"foreverTrue",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"foreverTrueToken"},{key:"toxicFrets",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicFretsToken"},{key:"ashenEncore",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"ashenEncoreToken"},{key:"punksNotDead",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"punksNotDeadToken"},{key:"toxicAvenger",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicAvengerToken"},{key:"bushido",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"bushidoToken"},{key:"bouncingSoles",type:"permanent",cost:3,goldCost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"bouncingSolesToken"},{key:"shogunsShell",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"shogunsShellToken"},{key:"steelToe",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"steelToeToken"},{key:"chemicalWarfare",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"chemicalWarfareToken"},{key:"zaiUnderground",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"zaibatsuUndergroundToken"},{key:"studdedLeather",type:"buff",cost:1,stancePoints:2,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rocknRonin",type:"buff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:()=>gameState.player.strength,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rawEnergy",type:"buff",cost:()=>gameState.player.stancePoints>0?-2:-1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"powerChord",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints<=0?1:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?3:0},{key:"crowdSurfer",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:()=>gameState.player.stancePoints<0?2*gameState.player.stancePoints:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?gameState.player.stancePoints:0},{key:"rocknRejuvinate",type:"buff",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:10,poisonRemove:()=>gameState.player.stancePoints>0?3:0,strength:0,armor:()=>gameState.player.stancePoints<0?3:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"detox",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:4,poisonRemove:4,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"dBeat",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shogunShred",type:"buff",cost:0,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bloodOath",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"kabutuOverdrive",type:"buff",cost:1,stancePoints:-3,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:15,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"nenguStyle",type:"buff",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"zenZine",type:"buff",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"gutterGeisha",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>Math.floor(.1*(gameState.player.healthMax-gameState.player.health)),reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"noFuture",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"coverCharge",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"seppuku",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:-5,poisonRemove:0,strength:()=>gameState.player.stancePoints<0?1-gameState.player.stancePoints:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"canibalize",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"saisenBlaster",type:"buff",cost:1,goldCost:1,stancePoints:-2,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:10,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"bassSolo",type:"targetAll",cost:1,stancePoints:0,damage:6,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rottenResonance",type:"targetAll",cost:1,stancePoints:0,damage:0,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pissDrunkBastards",type:"targetAll",cost:2,stancePoints:1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"stageInvasion",type:"targetAll",cost:2,stancePoints:0,damage:()=>4*(gameState.currentCards.length+1),fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"circlePit",type:"targetAll",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:()=>4*gameState.costPlayed,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"moshpitMassacre",type:"targetAll",cost:2,stancePoints:0,damage:8,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"blackFumes",type:()=>gameState.player.stancePoints>=0?"targetAll":"targetSelected",cost:2,stancePoints:0,damage:0,fire:0,poison:()=>gameState.player.stancePoints>0?3:gameState.player.stancePoints<0?5:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"deadCities",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"boneShredder",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:1,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"masakari",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?10*(1-gameState.player.stancePoints*gameState.player.strength/10):10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyromania",type:"targetSelected",cost:2,stancePoints:0,damage:0,fire:15,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninsRot",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"dogsOfWar",type:"targetSelected",cost:1,stancePoints:1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"libertySpikes",type:"targetSelected",cost:1,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>gameState.player.stancePoints<0?2:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bladesBlight",type:"targetSelected",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"scorchedSoul",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"katana",type:"targetSelected",cost:3,stancePoints:0,damage:()=>gameState.player.stancePoints<0?13*(1-gameState.player.stancePoints*gameState.player.strength/10):13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"risingWakizashi",type:"targetSelected",cost:1,stancePoints:-1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"nastyNihonto",type:"targetSelected",cost:2,stancePoints:0,damage:10,fire:0,poison:()=>gameState.player.stancePoints>0?2*gameState.player.stancePoints:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shikoroStrike",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.stancePoints<0?8:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?3:0,reduceTargetStrength:0,drawCard:0},{key:"laidoSoho",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.armor>0?gameState.player.armor:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninMerc",type:"targetSelected",cost:0,goldCost:1,stancePoints:0,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyroPunk",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:()=>Math.round(.15*(gameState.player.healthMax-gameState.player.health)),poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"troopsOfTakamori",type:"targetSelected",cost:1,stancePoints:0,damage:6,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"wrathOfMoen",type:"targetSelected",cost:2,stancePoints:0,damage:24,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"riotRonin",type:"targetSelected",cost:2,goldCost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}],gameState.extraCards=[{key:"lustForLife",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"lustForLifeToken"},{key:"kirisuteGomen",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kirisuteGomenToken"},{key:"rebelHeart",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelHeartToken"},{key:"gundanSeizai",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"gundanSeizaiToken"},{key:"soulSquatter",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"soulSquatterToken"},{key:"enduringSpirit",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"enduringSpiritToken"},{key:"edoEruption",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"edoEruptionToken"},{key:"deadTokugawas",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"deadTokugawasToken"}],gameState.bouncingSolesCards=[{key:"bouncingSoles2",type:"permanent",cost:4,goldCost:4,token:"bouncingSolesToken"},{key:"bouncingSoles3",type:"permanent",cost:5,goldCost:5,token:"bouncingSolesToken"},{key:"bouncingSoles4",type:"permanent",cost:6,goldCost:6,token:"bouncingSolesToken"}],gameConfig.allCards=[...gameState.deck,...gameState.bonusCards,...gameState.extraCards,...gameState.bouncingSolesCards],gameConfig.minDeckSize=10,gameConfig.maxDeckSize=40,gameState.latestDraw=[],gameState.lustForLifeCounter=0,gameState.enduringSpiritCounter=0,gameState.healButtonPermanence=!1,gameState.bonusPermanentSlots=[{available:!0,x:50,y:130,index:4},{available:!0,x:125,y:130,index:5},{available:!0,x:200,y:130,index:6},{available:!0,x:275,y:130,index:7}],gameState.taunts=[{key:1,enemy:"A punk rock samurai?\nWhat's next?\nA disco knight?",player:"What's next, is me\nusing your bones\nas my drumsticks!"},{key:2,enemy:"A Samurai punk rocker?\nIs this some kind of joke?",player:"The only joke here\nwill be your attempt\nto survive this encounter!"},{key:3,enemy:"You must be lost,\nsamurai boy.\nThe cosplay convention\nis down the street.",player:"The only thing lost today\nwill be your head\nfrom your shoulders!"},{key:4,enemy:"You look like a kid who\nfound his grandpa's armor.",player:"And you'll look like\nyour grandpa's corpse\nwhen I'm done with you!"},{key:5,enemy:"Nice samurai outfit, kid!\nWhen does the\ncostume party begin?",player:"The only party you'll\nbe attending today\nis your own funeral!"},{key:6,enemy:"A Samurai punk rocker?\nHow's that midlife\ncrisis going for you?",player:"The only crisis happening\ntoday is for the janitor\nwho has to clean up\nwhat's left of you."},{key:7,enemy:"Samurai and punk rocker?\nSchizophrenia's a bitch, huh?",player:"The only bitch here\nis the one whose about to\nbe begging me for mercy!"},{key:8,enemy:"What's with the big sword?\nCompensating for something?",player:"The only things small here\nare your chances of survival!"},{key:9,enemy:"Nice clown costume.\nDo you do childrens\nbirthdays and bar mitzvahs?",player:"Just funerals.\nYours is next\non the list!"},{key:11,enemy:"A samurai in the\n21st century?\nI want whatever\nyour smoking",player:"Very soon,\nthe only thing\nyou'll be wanting,\nis mercy!"},{key:17,enemy:"What's the matter,\ndid they run out\nof shirts your size,\nor is this a flex-off?",player:"I'm saving my shirt\nfor your funeral wake!"},{key:18,enemy:"What's with the flex?\nAre you here to fight\nor to pose for a\nhomoerotic magazine?",player:"The only posing happening\ntoday, will be for your\npost-mortem photography!"}],gameState.ratTaunts=[{key:201,enemy:"Hsss..\nYou’ll make a fine\nmeal for my pups!",player:"Tell them not to wait up.\nDaddy's not comming home tonight!"},{key:202,enemy:"Hsss..\nYou come here to fight\nor to display your\nHalloween costume?",player:"The only thing on\ndisplay today\nwill be your entrails!"}],gameState.extraTaunts=[{key:101,enemy:"You really believe\nyou're a samurai, huh?",player:"You believe in ghosts?\nBecause you're\nabout to become one!"},{key:102,enemy:"Childish music\nand childish fantasies.\nGrow up!",player:"I'll make sure you\nnever grow old!"},{key:103,enemy:"Must be hard, living\na deluded fantasy.",player:"Not as hard as what's\ncoming for you!"},{key:104,enemy:"Punk and Samurai?\nTwo failures in one!",player:"I'll silence that laughter\nwith the sound of\nyour gurgling blood!"},{key:105,enemy:"Chasing fantasies while\nthe world laughs at you?",player:"I'll silence that laughter\nwith the sound of\nyour gurgling blood!"},{key:106,enemy:"You're a relic in a world that's moved on.",player:"You won't be moving much soon!"},{key:107,enemy:"Is that sword real,\nor are you just cosplaying hard?",player:"It's as real as the pain\nyou're about to feel!"},{key:108,enemy:"Hey, Samurai punk,\nthe circus called,\nthey want their clown back",player:"Sorry, I'm booked up\nmopping your entrails\noff the floor!"},{key:109,enemy:"Still holding onto\npunk's corpse, I see",player:"The only corpse here\nwill be the one\nI leave behind!"},{key:110,enemy:"Your delusions of grandeur\nare quite entertaining.",player:"The only entertainment tonight\nwill be your cries of agony!"},{key:111,enemy:"I've seen better costumes\nat a kid's party.",player:"And I've seen better\nfighters in a retirement home!"},{key:112,enemy:"That haircut's\na cry for help.",player:"The only one crying\nfor help will be you,\nsoon enough!"},{key:113,enemy:"Whats with the outfit?\nAre you auditioning for\na bad action movie?",player:"No movie could capture\nthe reality of the suffering\nyour about to experience!"},{key:16,enemy:"What's with the\nsilly haircut,\nsamurai wannabe?",player:"Not as silly as your\nentrails will look\nsprawled all over the ground!"},{key:15,enemy:"You take this Samurai gig\npretty seriously, huh??",player:"As serious as the grave\nyou're about to fill!"},{key:10,enemy:"Whats with the outfit?\nYou look like you\nraided a costume store",player:"And you look like\nsomeone whose about to\nhave a very bad day!"},{key:13,enemy:"Nice cosplay.\nWhere's the convention?",player:"No time for conventions.\nI'm' booked up\nmopping whats left of\nyou off the floor!"},{key:14,enemy:"Trying to be a samurai\nor just lost a bet?",player:"The only thing worth\nbetting on today is\nwhich part of you\nhits the ground first!"},{key:12,enemy:"You look like an\nantagonist from a bad\nMad Max movie",player:"And you look like\nthe first stunt\nto get taken out!"}],gameState.restartGame&&self.scene.start("Mainmenu");let e=this.add.image(550,480,"bgLoadingScreen").setScale(1.4).setInteractive();this.add.text(550,170,"Punk Rock Samurai",{fontSize:"100px",fill:"#000000",fontFamily:"Rock Kapak"}).setOrigin(.5),this.add.text(550,500,"Click to start",{fontSize:"45px",fill:"#ff0000",fontWeight:"bold"}).setOrigin(.5);let t=!1;function a(){gameConfig.thunder.play({volume:.9,seek:.25}),self.cameras.main.shake(200,.002,!1),self.cameras.main.flash(100),self.time.delayedCall(100,(()=>{self.cameras.main.fadeOut(100)}),[],this),self.time.delayedCall(200,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),self.time.delayedCall(100,(()=>{self.scene.start("Mainmenu"),console.log("Mainmenu called")}))}),[],this)}gameConfig.thunder=this.sound.add("thundersound"),gameConfig.musicTheme=this.sound.add("titleTheme"),e.on("pointerup",(()=>{t||(t=!0,a())})),this.input.keyboard.on("keydown",(()=>{t||(t=!0,a())}))}}class BaseScene extends Phaser.Scene{create(){this.scene.start("Preload")}baseCreate(e,t=.75){this.add.image(0,0,e).setScale(t).setOrigin(.02,0),this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),gameConfig.targetingCursor=this.add.image(0,0,"targetingCursor").setDepth(200).setVisible(!1),gameState.redrawPrice=1,gameState.endGameMenyExited=!1,gameState.playingCard=!1,gameState.skipIntro=!1,gameState.fightStarted=!1,gameState.discardPile=[],gameState.drawPile=[],gameState.currentCards=[],gameState.cardImages=[],gameState.summonedEnemies=[],gameState.actionTextObjects=[],gameState.redrawButtonObjects=[],gameState.healButtonTextObjects=[],gameState.kamishimoUberAlles=0,gameState.chemicalWarfare=0,gameState.shogunsShellCondition=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.zaibatsuUnderground=!1,gameConfig.cardsDealtSound=this.sound.add("cardsDealtSound"),gameConfig.victorySound=this.sound.add("victorySound"),gameConfig.buttonPressedSound=this.sound.add("buttonPressedSound"),gameConfig.attackSound=this.sound.add("attackSound"),gameConfig.powerUpSound=this.sound.add("powerUpSound"),gameConfig.healSound=this.sound.add("healSound"),gameConfig.thunder=this.sound.add("thundersound"),gameConfig.music=this.sound.add("bossTune"),gameConfig.coinSound=this.sound.add("coinSound"),gameConfig.keyboardSound=this.sound.add("keyboardSound"),gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop())}resetPlayer(e,t,a=360,r=350){e.sprite=this.add.image(a,r,"player").setScale(t).setFlipX(!1).setInteractive(),e.stance="Neutral",e.poison=0,e.stancePoints=0,e.numCards=5,e.numCardsBase=5,e.numCardsStance=0,e.manaBase=3,e.manaStance=0,e.manaCard=0,e.mana=3,e.strengthMax=3,e.strength=0,e.strengthBase=0,e.strengthStance=0,e.strengthCard=0,e.strengthMax=15,e.armor=0,e.armorMax=15,e.armorBase=0,e.armorStance=0,e.armorCard=0,e.lifeStealBase=0,e.lifeStealThisTurn=0,e.lifeStealCounter=0}saveGameState(e){try{const t={player:{health:gameState.player.health,healthMax:gameState.player.healthMax,mana:gameState.player.mana,manaMax:gameState.player.manaMax,gold:gameState.player.gold,goldMax:gameState.player.goldMax,name:gameState.player.name,alive:gameState.player.alive},deck:gameState.deck,bonusCards:gameState.bonusCards,extraCards:gameState.extraCards,latestDraw:gameState.latestDraw,taunts:gameState.taunts,ratTaunts:gameState.ratTaunts,extraTaunts:gameState.extraTaunts,permanents:gameState.permanents,permanentSlots:gameState.permanentSlots,enemy:gameState.enemy,playerName:gameState.playerName,version:gameState.version,score:gameState.score,lustForLifeCounter:gameState.lustForLifeCounter,enduringSpiritCounter:gameState.enduringSpiritCounter,bouncingSolesCards:gameState.bouncingSolesCards,bonusPermanentSlots:gameState.bonusPermanentSlots,savedScene:e,loadedGame:!0},a=JSON.stringify(t);localStorage.setItem("gameState",a),console.log("Game state saved successfully.")}catch(e){console.error("Failed to save the game state.",e)}}definePermanentSlots(){gameState.permanentSlots=[{available:!0,x:50,y:50,index:0},{available:!0,x:125,y:50,index:1},{available:!0,x:200,y:50,index:2},{available:!0,x:275,y:50,index:3}]}addHealthBar(e,t){const a=e.x,r=e.y,n=e.height;e.healthBarBackground=this.add.graphics(),e.healthBarBackground.fillStyle(16777215,.5),e.healthBarBackground.fillRect(a-40,r-n/2-30,100,10),e.healthBarBackground.setDepth(12),e.healthBarFrame=this.add.graphics(),e.healthBarFrame.lineStyle(3,0,1),e.healthBarFrame.strokeRect(a-40,r-n/2-30,100,10),e.healthBarFrame.setDepth(13),e.healthBar=this.add.graphics(),e.healthBar.fillStyle(t,1),e.healthBar.fillRect(a-40,r-n/2-30,e.health/e.healthMax*100,10),e.healthBar.setDepth(14),e.healthBarText=this.add.text(a-18,r-n/2-25,`${e.health}/${e.healthMax}`,{fontSize:"11px",fill:"#000000"}),e.healthBarText.setOrigin(.5).setDepth(15)}addManaBar(e){const t=e.x,a=e.y,r=e.height;e.manaBarBackground=this.add.graphics(),e.manaBarBackground.lineStyle(3,0,1),e.manaBarBackground.strokeRect(t-40,a-r/2-45,100,10),e.manaBarFrame=this.add.graphics(),e.manaBarFrame.lineStyle(3,0,1),e.manaBarFrame.strokeRect(e.x-40,e.y-r/2-45,100,10),e.manaBar=this.add.graphics(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(t-40,a-r/2-45,e.mana/e.manaMax*100,10),e.manaBarText=this.add.text(t-27,a-r/2-40,`${e.mana}/${e.manaMax}`,{fontSize:"11px",fill:"#000000"}).setOrigin(.5)}addStatsDisplay(e,t=420){const a={fontSize:"11px",fill:"#FFFFFF"},r=e.sprite.x;e.strengthAndArmorImage=this.add.image(r-20,t,"strengthAndArmor").setScale(.4).setInteractive().setDepth(20),e.armorText=this.add.text(r+13,t,`${e.armor}/${e.armorMax}`,a).setDepth(25),e.strengthText=this.add.text(r-40,t,`${e.strength}/${e.strengthMax}`,a).setDepth(25)}addGoldCoin(){const e=this.add.image(1040,50,"goldCoin").setScale(.1).setDepth(220).setOrigin(.5).setInteractive();gameState.goldCounter=this.add.text(1040,50,gameState.player.gold,{fontSize:"60px",fill:"#000000"}).setDepth(221).setOrigin(.5);let t="";e.on("pointerover",(()=>{gameState.goldCard=this.add.image(550,300,"goldCard").setScale(.55).setDepth(220),this.input.keyboard.on("keydown",(function(e){t+=e.key,"showmethemoney"===t&&(console.log("showmethemoney"),gameState.player.gold=99,gameState.player.goldMax=99,gameState.goldCounter.setText(gameState.player.gold),"admin"!==gameState.playerName&&(gameState.playerName="Cheater"),"admin"!==gameState.player.name&&(gameState.player.name="Cheater"),t=""),t.length>30&&(t=t.substring(t.length-30))}))})),e.on("pointerout",(()=>{gameState.goldCard.destroy(),t="",this.input.keyboard.removeAllListeners("keydown")}))}describeCharacter(e){gameConfig.targetingCursor.visible||!0!==e.alive||e.sprite.on("pointerover",(()=>{const t=e.armor<0?"more":"less",a=e.strength<0?"less":"more",r=`${e.name}\n\n${e.armor} armor: Take ${Math.round(Math.abs(e.armor/20*100))} %\n${t} physical damage\n\nMax armor: Take 75 %\nless physical damage \n\n${e.strength} Strength: Deal ${10*Math.abs(e.strength)} %\n${a} physical damage\n\nMax strength: Deal 150 %\nmore physical damage\n\nPoison: ${e.poison}\nPoison change per turn: ${e.poison>0?-1:0}`,n=e.sprite.x-e.width/2;e.descriptionBackground=this.add.graphics({x:n-200,y:210}),e.descriptionBackground.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(30),e.descriptionBackground.fillRoundedRect(0,0,215,250,10);e.descriptionText=this.add.text(n+10,335,r,{fontSize:"12px",fill:"#000000"}).setDepth(35).setOrigin(1,.5)})),e.sprite.on("pointerout",(function(){e.descriptionBackground&&e.descriptionBackground.destroy(),e.descriptionText&&e.descriptionText.destroy()}))}addStanceBar(e,t){e.stancePoints=0;let a=this.cameras.main.width/2;gameState.stanceBarHeight=20,gameState.stanceBarMargin=60,gameState.stanceBarStartX=a-220,gameState.stanceBarBackground=this.add.graphics(),gameState.stanceBarBackground.lineStyle(3,0,1),gameState.stanceBarBackground.strokeRect(gameState.stanceBarStartX,gameState.stanceBarMargin,440,gameState.stanceBarHeight).setDepth(20);for(let e=1;e<6;e++)gameState.stanceBarBackground.moveTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin),gameState.stanceBarBackground.lineTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin+20),gameState.stanceBarBackground.strokePath();gameState.stanceBar=this.add.graphics(),gameState.stanceBar.fillStyle(65280,1);let r={fontSize:"28px",fill:t};gameState.stanceText=this.add.text(550,gameState.stanceBarMargin-25,`Stance: ${gameState.player.stance}`,r).setOrigin(.5).setInteractive(),gameState.stanceText.on("pointerover",(()=>{gameState.stanceDescriptionText=this.add.text(550,gameState.stanceBarBackground.y+105,"Stance represents the ever-shifting balance\nbetween the conflicting ideals of the\npunk rock samurai: Discipline and Freedom.\n\nPositive Discipline during your turn:\n+3 Strength\n\nPositive Discipline at the end of your turn:\n+3 Armor\n\nMax Discipline at the end of your turn:\n-1 card next turn\n\nPositive Freedom during your turn:\n+1 mana\n\nPositive Freedom at the end of your turn:\n50% chance of +1 card next turn\n50% chance of +1 mana next turn\n\nMax Freedom at the end of your turn:\n-2 Armor",{fontSize:"14px",fill:"#000000"}).setDepth(25).setOrigin(.5,0);const e=gameState.stanceDescriptionText.getBounds(),t=e.width+10,a=e.height+10,r=e.x-5,n=e.y-5;gameState.stanceTextBackground=this.add.graphics(),gameState.stanceTextBackground.fillStyle(16777215,1).setAlpha(.9).setDepth(24),gameState.stanceTextBackground.fillRoundedRect(r,n,t,a,7)})),gameState.stanceText.on("pointerout",(()=>{gameState.stanceTextBackground.destroy(),gameState.stanceDescriptionText.destroy()}))}extractLevelFightFromName(e){const t=/Level(\d+)Fight(\d+)/.exec(e);return t?{level:parseInt(t[1],10),fight:parseInt(t[2],10)}:{level:null,fight:null}}powerUpTweens(e){this.tweens.add({targets:e.sprite,scaleY:1.125*e.sprite.scaleX,scaleX:1.125*e.sprite.scaleY,duration:120,ease:"Cubic",yoyo:!0},this)}attackTweens(e,t){if("undefined"==typeof attackTweenStarted||!attackTweenStarted){let a=!0;this.tweens.add({targets:e.sprite,x:e.x+t,duration:120,ease:"Cubic",yoyo:!0,onComplete:()=>a=!1},this)}}cardTweens(e,t,a){this.tweens.add({targets:e,scaleX:t,scaleY:t,duration:a,ease:"Cubic"},this)}animateCard(e,t){e.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.08}),this.tweens.add({targets:e.sprite,y:470,angle:0,scaleX:.46,scaleY:.46,duration:300,ease:"Cubic"}),e.sprite.setDepth(100)}),this),e.sprite.on("pointerout",(()=>{e.isBeingPlayed||(this.tweens.add({targets:e.sprite,y:e.startHeight,angle:e.angle,scaleX:.35,scaleY:.35,duration:300,ease:"Cubic"}),e.sprite.setDepth(t))}),this)}addEndOfTurnButton(e=500){gameState.endOfTurnButton=this.add.image(900,e,"rectangularButtonPressed").setScale(.45).setOrigin(.5),gameState.endOfTurnText=this.add.text(900,e,"End Turn",{fontSize:"18px",fill:"#000000"}).setOrigin(.5),gameState.endOfTurnButton.on("pointerover",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButtonHovered")})),gameState.endOfTurnButton.on("pointerout",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButton")}))}addRedrawButton(){const e=900;gameState.redrawButton=this.add.image(e,52,"rectangularButtonPressed").setScale(.45).setOrigin(.5).setInteractive(),gameState.redrawText=this.add.text(e,52,"Redraw",{fontSize:"18px",fill:"#000000"}).setOrigin(.5),gameState.redrawButton.on("pointerover",(()=>{gameState.redrawButtonObjects.forEach((e=>e.destroy())),gameState.redrawButtonObjects=[],gameState.redrawEnabled&&gameState.redrawButton.setTexture("rectangularButtonHovered"),gameState.redrawButtonDescriptionBackground=this.add.graphics(),gameState.redrawButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.redrawButtonDescriptionBackground.fillRoundedRect(835,82,130,40,5);const t=`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`;gameState.redrawButtonDescriptionText=this.add.text(e,102,t,{fontSize:"12px",fill:"#000000"}).setDepth(123).setOrigin(.5,.5),gameState.redrawButtonObjects.push(gameState.redrawButtonDescriptionText,gameState.redrawButtonDescriptionBackground)})),gameState.redrawButton.on("pointerout",(()=>{gameState.redrawEnabled&&gameState.redrawButton.setTexture("rectangularButton"),gameState.redrawButtonObjects.forEach((e=>e.destroy())),gameState.redrawButtonObjects=[]}))}addHealButton(){const e=900,t=130,a={fontSize:"12px",fill:"#000000"},r=gameState.fightStarted?"rectangularButton":"rectangularButtonPressed";gameState.healButton=this.add.image(e,t,r).setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=this.add.text(e,t,"Heal",{fontSize:"18px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{if(gameState.healButtonTextObjects.forEach((e=>e.destroy())),gameState.healButtonTextObjects=[],gameState.healButtonEnabled){const t=" Heal 7 HP\nCost: 1 gold";gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=this.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(835,160,130,40,5),gameState.healButtonDescriptionText=this.add.text(e,180,t,a).setDepth(123).setOrigin(.5,.5),gameState.healButtonTextObjects.push(gameState.healButtonDescriptionText,gameState.healButtonDescriptionBackground)}})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setDepth(8),gameState.healText.setDepth(9),gameState.healButtonEnabled&&gameState.healButton.setTexture("rectangularButton"),gameState.healButtonTextObjects.forEach((e=>e.destroy())),gameState.healButtonTextObjects=[]}))}clearBoard(){gameState.characters.forEach((e=>{e.sprite.destroy(),e.strengthAndArmorImage.destroy(),e.armorText.destroy(),e.strengthText.destroy(),e.strengthAndArmorImage.destroy(),e.healthBarBackground.destroy(),e.healthBarFrame.destroy(),e.healthBar.destroy(),e.healthBarText.destroy()}));[gameState.player.manaBarBackground,gameState.player.manaBarFrame,gameState.player.manaBar,gameState.player.manaBarText,gameState.endOfTurnButton,gameState.endOfTurnText,gameState.drawPileImage,gameState.discardPileImage,gameState.drawPileText,gameState.discardPileText,gameState.stanceBar,gameState.stanceText,gameState.stanceBarBackground,gameState.redrawButton,gameState.redrawText,gameState.healButton,gameState.healText,gameState.actionText].forEach((e=>{e&&e.destroy()})),console.log("board cleared")}shuffleDeck(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}updateEnemyIntention(e){let t="function"==typeof e.chosenAction.key?e.chosenAction.key():e.chosenAction.key;e.intentionText.setText(`${t}`)}updateHealthBar(e){e.health=Phaser.Math.Clamp(e.health,0,e.healthMax);e.healthBar.clear(),e.healthBar.fillStyle(e===gameState.player?65280:16711680,1),e.healthBar.fillRect(e.x-40,e.y-e.height/2-30,e.health/e.healthMax*100,10),e.healthBarText.setText(`${e.health}/${e.healthMax}`),e.healthBarText.setColor("#000000")}updateManaBar(e){e.mana=Phaser.Math.Clamp(e.mana,0,e.manaMax),e.manaBar.clear(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(e.x-40,e.y-e.height/2-45,e.mana/e.manaMax*100,10),e.manaBarText.setText(`${e.mana}/${e.manaMax}`)}updateStanceBar(e){const t=gameState.player.stancePoints;if(t>0){Math.random()>.5?(e.manaStance=1,e.numCardsStance=0):(e.manaStance=0,e.numCardsStance=1)}else e.manaStance=0;switch(t){case-3:e.armorStance=3,e.strengthStance=3,e.numCardsStance=-1,e.stance="Discipline";break;case-2:case-1:e.armorStance=3,e.strengthStance=3,e.numCardsStance=0,e.stance="Discipline";break;case 0:e.armorStance=0,e.strengthStance=0,e.numCardsStance=0,e.stance="Neutral";break;case 1:case 2:e.armorStance=0,e.strengthStance=0,e.stance="Freedom";break;case 3:e.armorStance=-2,e.strengthStance=0,e.stance="Freedom";break;default:return void console.error(`Unexpected value for points: ${t}`)}gameState.stanceBar.clear(),t<0?gameState.stanceBar.fillRect(gameState.stanceBarStartX+220+73.33*t,gameState.stanceBarMargin,73.33*Math.abs(t),gameState.stanceBarHeight):gameState.stanceBar.fillRect(gameState.stanceBarStartX+220,gameState.stanceBarMargin,73.33*t,gameState.stanceBarHeight),gameState.stanceText.setText(`Stance: ${e.stance}`)}updateTextAndBackground(e,t,a,r=7,n=20,o=.6){e.setText(a),e.setDepth(n+1);const s=e.getBounds(),i=s.width+10,l=s.height+10,m=s.x-5,g=s.y-5;t.clear(),t.fillStyle(16777215,1).setAlpha(o).setDepth(n),t.fillRoundedRect(m,g,i,l,r)}delay(e){return new Promise((t=>setTimeout(t,e)))}}const sceneState={};class Mainmenu extends Phaser.Scene{constructor(){super("Mainmenu")}async getTopScores(){const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");let t=(await e.json()).dreamlo.leaderboard.entry;return t.length>1&&t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}preload(){this.load.image("player","assets/images/sprites/punkrock.png"),this.load.image("deck","assets/images/cardback.jpg"),this.load.image("strengthAndArmor","assets/images/strengthAndArmor.png"),this.load.image("targetingCursor","assets/images/targetingCursor.png"),this.load.image("targetingCursorReady","assets/images/targetingCursorReady.png"),this.load.image("listbox1","assets/images/listbox1.png"),this.load.image("rectangularButton","assets/images/stoneButtonInsetReady.png"),this.load.image("rectangularButtonHovered","assets/images/stoneButtonInsetHovered.png"),this.load.image("rectangularButtonPressed","assets/images/stoneButtonInsetPressed.png"),this.load.image("rectangularFrame","assets/images/stoneButtonFrame.png"),this.load.audio("cardsDealtSound","assets/sounds/cardsdealt.wav"),this.load.audio("buttonPressedSound","assets/sounds/buttonpressed.wav")}create(){const e=this;this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,480,"bgLoadingScreen").setScale(1.4),this.add.text(15,5,`Punk Rock Samurai Beta v${gameState.version}`,{fontSize:"12px",fill:"#ff0000"});let t=!1;gameState.isEnteringName=!1,sceneState.name="",sceneState.cardsDealtSound=this.sound.add("cardsDealtSound"),sceneState.buttonPressedSound=this.sound.add("buttonPressedSound"),sceneState.newGameElements=[],sceneState.leaderboardElements=[],sceneState.creditsElements=[],sceneState.instructionsElements=[],sceneState.displayedScoreArray=[],sceneState.loadGameElements=[];const a={fontSize:"25px",fill:"#000000"},r={fontSize:"14px",fill:"#000000"},n={fontSize:"18px",fill:"#000000"},o=120,s=350,i=e.add.image(o,s,"rectangularButton"),l=e.add.text(o,s,"New Game",n).setOrigin(.5);sceneState.newGameButtonClicked=!1;const m=e.add.image(o,415,"rectangularButton"),g=localStorage.getItem("gameState")?"#000000":"#a9a9a9",d=e.add.text(o,415,"Load Game",{fontSize:"16px",fill:g}).setOrigin(.5);let p=!1;const c=e.add.image(o,480,"rectangularButton"),S=e.add.text(o,480,"Leaderboard",n).setOrigin(.5);let u=!1;const h=e.add.image(o,545,"rectangularButton"),y=e.add.text(o,545,"Credits",n).setOrigin(.5);let f=!1;const x=e.add.image(o,610,"rectangularButton"),k=e.add.text(o,610,"Instructions",n).setOrigin(.5);let T=!1;function C(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function b(t){t.on("pointerup",(()=>{if(!gameState.isEnteringName){gameState.isEnteringName=!0,console.log("isEnteringName has been activated"),"Enter your name..."===gameState.name&&(gameState.name=""),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.resume();try{C()&&gameState.hiddenInput.focus()}catch(e){console.error("Onscreen keyboard failed to open",e),gameState.isEnteringName=!1,B()}e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER).once("down",(function(){gameState.isEnteringName=!1,B()})),e.time.delayedCall(200,(()=>{e.input.off("pointerup"),e.input.once("pointerup",(()=>{if(gameState.isEnteringName){let t=0;gameState.name||(gameState.name="Enter your name...",t=100),e.time.delayedCall(t,(()=>{gameState.isEnteringName=!1,console.log("isEnteringName has been deactivated")})),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.pause();try{C()&&gameState.hiddenInput.blur()}catch(e){console.error("Onscreen keyboard failed to close",e),gameState.isEnteringName=!1,B()}}}))}))}}))}function B(){"Enter your name..."===gameState.name||""===gameState.name?gameState.playerName="Punk Rock Samurai":gameState.playerName=gameState.name,console.log(`Playername: ${gameState.playerName}`),E(),sceneState.menuElements.forEach((e=>{e.destroy()})),e.time.delayedCall(600,(()=>{!function(){const a=320,r=430,n=220;D(gameState.extraCards);const o=gameState.extraCards.slice(0,3),s={fontSize:"50px",fill:"#ff0000"},i=e.add.text(550,170,"Choose 1 Free Permanent",s).setOrigin(.5).setDepth(21),l=e.add.graphics();v(i,l,"Choose 1 Free Permanent"),o.forEach(((s,m)=>{s.sprite=e.add.sprite(a+m*n,r,s.key).setScale(.45).setInteractive(),console.log(`bonusCardsprite added for: ${s.key}`),s.sprite.on("pointerover",(function(){sceneState.cardsDealtSound.play({volume:.8,seek:.12}),w(s.sprite,.58,200)}),this),s.sprite.on("pointerout",(function(){w(s.sprite,.45,400)}),this),s.sprite.on("pointerup",(function(){sceneState.cardsDealtSound.play({volume:1.2,seek:.12}),s.freePermanent=!0,gameState.deck.push(s),gameState.extraCards.splice(gameState.extraCards.indexOf(s),1),D(gameState.extraCards),o.forEach((t=>{var a,r;t.sprite.removeInteractive(),t!==s&&(a=t.sprite,r=200,a&&e.tweens.add({targets:a,alpha:0,ease:"Power1",duration:r,onComplete:()=>{a.destroy()}}))})),e.tweens.add({targets:s.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),i.setText("Permanent Selected"),v(i,l,"Permanent Selected"),e.time.delayedCall(2500,(()=>{t||(t=!0,P())})),e.input.on("pointerup",(()=>{t||(t=!0,P())})),e.input.keyboard.on("keydown",(()=>{t||(t=!0,P())}))}))}))}()}))}function v(e,t,a,r=7){e.setText(a);const n=e.getBounds(),o=n.width+10,s=n.height+10,i=n.x-5,l=n.y-5;t.clear(),t.fillStyle(16777215,1).setAlpha(.4).setDepth(20),t.fillRoundedRect(i,l,o,s,r)}function P(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level1Fight1")}))}function w(t,a,r){e.tweens.add({targets:t,scaleX:a,scaleY:a,duration:r,ease:"Cubic"})}function M(e){e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))}function E(){[...sceneState.newGameElements,...sceneState.loadGameElements,...sceneState.leaderboardElements,...sceneState.creditsElements,...sceneState.instructionsElements,...sceneState.displayedScoreArray].forEach((e=>{e&&"function"==typeof e.destroy?e.destroy():console.log(`${e} not phaser object`)}))}function D(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}sceneState.buttons=[i,m,c,h,x],sceneState.textArray=[l,d,S,y,k],sceneState.menuElements=[...sceneState.buttons,...sceneState.textArray],sceneState.buttons.forEach((e=>{M(e),e.setScale(.8,.5).setInteractive().setOrigin(.5)})),C()&&(gameState.hiddenInput=document.createElement("input"),gameState.hiddenInput.style.position="absolute",gameState.hiddenInput.style.opacity="0",gameState.hiddenInput.style.zIndex="-1",document.body.appendChild(gameState.hiddenInput),gameState.hiddenInput.addEventListener("input",(function(e){gameState.name=e.target.value}))),i.on("pointerdown",(()=>{if(sceneState.newGameButtonClicked)sceneState.newGameButtonClicked=!1,E();else{sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!0,p=!1,u=!1,f=!1,T=!1,E(),gameState.name="Enter your name...";const e={fontSize:"23px",fill:"#000000"};sceneState.nameText=this.add.text(420,315,gameState.name,e).setDepth(21);const t={fontSize:"28px",fill:"#000000"};sceneState.startGameButton=this.add.image(550,400,"rectangularButton").setScale(1.2,.6).setInteractive(),sceneState.startGameText=this.add.text(470,387,"Let's go!",t),M(sceneState.startGameButton),sceneState.startGameButton.on("pointerdown",(()=>{gameState.isEnteringName=!1,B()}));const a={fontSize:"32px",fill:"#000000"};sceneState.formCursor=this.add.text(420,310,"|",a).setDepth(21).setAlpha(0),sceneState.cursorTween=this.tweens.add({targets:sceneState.formCursor,alpha:1,duration:300,hold:600,yoyo:!0,repeat:-1,paused:!0}),sceneState.formFrame=this.add.image(550,325,"rectangularFrame"),sceneState.formFrame.setScale(1.2,.6).setInteractive().setDepth(22),sceneState.nameForm=this.add.graphics({x:400,y:290}),sceneState.nameForm.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(20),sceneState.nameForm.fillRect(0,0,300,65),sceneState.nameForm.setInteractive(new Phaser.Geom.Rectangle(0,0,300,65),Phaser.Geom.Rectangle.Contains),sceneState.newGameElements=[sceneState.formCursor,sceneState.nameForm,sceneState.nameText,sceneState.formFrame,sceneState.startGameButton,sceneState.startGameText],b(sceneState.nameForm),b(sceneState.formFrame)}})),this.input.keyboard.on("keydown",(t=>{if(gameState.isEnteringName){const a=18;8===t.keyCode&&gameState.name.length>0?gameState.name=gameState.name.slice(0,-1):1===t.key.length&&t.key.match(/[a-zA-Z0-9\s\-_]/)&&gameState.name.length<a?gameState.name+=t.key:gameState.name.length===a&&e.cameras.main.shake(30,.001,!1)}})),m.on("pointerup",(function(){if(p)p=!1,E();else{sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!1,p=!0,u=!1,f=!1,T=!1,E();try{const t=localStorage.getItem("gameState");if(null===t)!function(){const t="No saved game state found.",a={fontSize:"40px",fill:"#000000"},r=e.add.text(620,350,t,a).setOrigin(.5).setDepth(21),n=r.getBounds(),o=n.width+10,s=n.height+10,i=n.x-10,l=n.y-5,m=e.add.graphics();m.fillStyle(16777215,1).setAlpha(.8).setDepth(20),m.fillRoundedRect(i,l,o,s,10),sceneState.loadGameElements.push(r,m),console.log(t),e.cameras.main.shake(70,.002,!1)}();else{const a=JSON.parse(t);if(a.version!==gameState.version){if(!confirm(`The game has been updated since this save was made (saved version: ${a.version}, current version: ${gameState.version}). Loading this file might cause issues. Do you still want to load?`))return}[a.deck,a.bonusCards,a.extraCards].forEach((e=>function(e){e.forEach((e=>{const t=gameConfig.allCards.find((t=>t.key===e.key));t&&Object.assign(e,t)}))}(e))),gameState=a,console.log("Game state loaded successfully."),e.scene.start(gameState.savedScene)}}catch(e){console.error("Failed to load the game state.",e)}}})),c.on("pointerup",(async()=>{if(sceneState.buttonPressedSound.play({volume:.7}),u)u=!1,E();else{const t=await e.getTopScores(),a=250;let n=200;sceneState.newGameButtonClicked=!1,p=!1,u=!0,f=!1,T=!1,E(),sceneState.leaderboardsBackground=this.add.graphics(),sceneState.leaderboardsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.leaderboardsBackground.fillRect(a,n,810,250);const o={fontSize:"25px",fill:"#000000"};sceneState.leaderboardHeadline=this.add.text(a+20,n+30,"Leaderboard",o).setOrigin(0),sceneState.displayedScoreArray=[];for(let e=0;e<t.length;e++){const o=t[e].date.split(" ")[0],s=`${e+1}. Name: ${t[e].name}, Score: ${t[e].score}, Date: ${o}`,i=this.add.text(a+30,n+80,s,r).setOrigin(0);sceneState.displayedScoreArray.push(i),n+=20}sceneState.leaderboardElements=[sceneState.leaderboardsBackground,sceneState.leaderboardHeadline,sceneState.displayedScoreArray]}})),h.on("pointerup",(function(){f?(f=!1,E()):(sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!1,p=!1,u=!1,f=!0,T=!1,E(),sceneState.creditsBackground=e.add.graphics(),sceneState.creditsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.creditsBackground.fillRect(250,200,810,340),sceneState.creditsHeadline=e.add.text(270,230,"Credits",a).setOrigin(0),sceneState.creditsText=e.add.text(270,280,"Game Design and Programming by Erlend Kulander Kvitrud\nMusic by Marllon Silva (xDeviruchi) (https://soundcloud.com/xdeviruchi)\nPunch sound by @danielsoundsgood (https://danielsoundsgood.itch.io/)\nHealing sound by Dylan Kelk (https://freesound.org/people/SilverIllusionist/)\nPower up sound by MATRIXXX (https://freesound.org/people/MATRIXXX_/)\nGunshot sound by Fesliyan Studios (https://www.fesliyanstudios.com)\nButton Sprites by Ian Eborn (http://thaumaturge-art.com/)\nArmor and Strength symbols by Josepzin (https://opengameart.org/users/josepzin)\nCard sprites by Avery Ross (https://opengameart.org/users/averyre)\nCoin sound by ProjectsU012 (https://freesound.org/people/ProjectsU012/)\n",r),sceneState.creditsText.setLineSpacing(2),sceneState.creditsElements=[sceneState.creditsBackground,sceneState.creditsHeadline,sceneState.creditsText])})),x.on("pointerup",(function(){sceneState.buttonPressedSound.play({volume:.7}),T?(T=!1,E()):(sceneState.newGameButtonClicked=!1,p=!1,u=!1,f=!1,T=!0,E(),sceneState.instructionsBackground=e.add.graphics(),sceneState.instructionsBackground.fillStyle(16777215,1).setAlpha(.9).setDepth(20),sceneState.instructionsBackground.fillRect(250,20,810,640),sceneState.instructionsHeadline=e.add.text(270,50,"Instructions",a).setOrigin(0).setDepth(21),sceneState.instructionsText=e.add.text(270,100,'The game consists of four levels, each of which consists of three fights.\nAt the start of each turn, you gain 3 mana and draw 5 cards. You may then play any number\nof cards before hitting "End Turn". Your remaining cards and mana are then depleted,\nand the enemy\'s turn begins. You win the fight by killing all enemies. Losing a fight\nresults in permadeath. Missing health carries over from fight to fight\n\nStance represents the balance between Discipline and Freedom.\n-Positive Discipline during your turn: +3 Strength.\n-Positive Discipline at the end of your turn: +3 Armor.\n-Max Discipline at the end of your turn: -1 card next turn.\n\n-Positive Freedom during your turn: +1 mana.\n-Positive Freedom at the end of your turn: 50/50 chance of +1 card or +1 mana next turn.\n-Max Freedom at the end of your turn:-2 Armor.\n\nPhysical damage is affected by the Strength of the attacker and the Armor of the defender\n-Each unit of Strength increases outgoing physical damage by 10 %.\n-Each unit of Armor blocks 5 % of incomming physical damage\nArmor and Strength are both capped at 15 units.\n\nFire damage is unaffected by Strength and Armor, but otherwise acts like physical damage.\n\nPoison is unaffected by Strength and Armor. A poisoned character suffers damage at the start\nof their turn equal to their poison counter. At the end of the turn, this counter is reduced\nby 1. Unlike physical and fire damage, poison cannot reduce a characters health below 1 HP.\n\nPermanents are cards that can only be played once, and are then removed from your deck.\nAfter use, they remain active and provide passive bonuses. A maximum of 4 permanents may be\nactive at any given time. Permanents can be depleted, which unleases powerful one-off\neffects and then removes them from the game. If there are no empty slots for new permanents,\npermanent cards may be played directly from hand for their depletion effects.\n\nGold is earned by defeating enemies, and may be spent in the shop, or on in-fight bonuses.\n',r),sceneState.instructionsText.setLineSpacing(1.5).setDepth(21),sceneState.instructionsElements=[sceneState.instructionsBackground,sceneState.instructionsHeadline,sceneState.instructionsText])}))}update(){let e=0;gameState.isEnteringName&&sceneState.newGameButtonClicked&&(sceneState.nameText.setText(gameState.name),e=sceneState.nameText.width,sceneState.formCursor.x=sceneState.nameText.x+e-7)}}class Level1Fight1 extends BaseScene{self;constructor(){super("Level1Fight1")}preload(){this.load.image("theCity","assets/images/theCity.jpg"),this.load.image("bakgrunnCity1","assets/images/bakgrunnCity1.jpg"),this.load.image("nazi","assets/images/sprites/nazi.png")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnCity1"),this.resetPlayer(gameState.player,.46,370,352),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Nazi Punk",gameState.enemy1.sprite=this.add.image(740,355,"nazi").setScale(.42).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,470)})),gameState.player.name=gameState.playerName?gameState.playerName:"Punk Rock Samurai",gameState.permanents=[],this.definePermanentSlots(),gameState.deck.forEach((e=>{e.freePermanent&&B(e)})),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{Z(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{Z(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),V());const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theCity").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 1:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"On City Streets",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(async function(){if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),b(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),r=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,r,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{Z(gameState.startText,500)})),async function(){let t="",a="";const r=400,n=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>Z(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),r=gameState.taunts.splice(e,1)[0];t=r.enemy,a=r.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*r),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(800),gameState.skipIntro)return;Z(d,n),Z(p,n),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{Z(e,n)})),gameState.skipIntro||(await e.delay(n),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),J(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),X(gameState.player),y(),K(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{Z(r,200),Z(n,200)}))}();const n=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>Z(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{h(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),g(t)}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,Z(a,2e3),Z(r,2e3),Z(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,Z(a,2e3),Z(r,2e3),Z(n,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,Z(a,2e3),Z(r,2e3),Z(n,2e3),e.time.delayedCall(2200,s()))}));async function g(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),o=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(o),n.usedOneShot&&n.sprite.setTint(8421504);const s=gameState.slots[a+r];s&&(n.startHeight=s.y,n.angle=s.angle,await e.delay(110+7*r),e.tweens.add({targets:n.sprite,x:s.x,y:s.y,scaleX:.35,scaleY:.35,angle:s.angle,duration:110+7*r,ease:"Circ.easeInOut",onComplete:()=>{s.available=!1,n.slot=s}})),gameConfig.cardsDealtSound.play({volume:2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,o),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),p(n))})),r===t-1&&(d(110,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function d(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function p(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,console.log(`gameState.costPlayed: ${gameState.costPlayed}`));const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&b(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),c(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;c(t,a,n)}))}else"permanent"===gameState.typePlayed?B(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),c(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function c(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),Z(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:u,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=r>0?2*(1+r):2,c=i?1:0;return{damagePlayed:n?11:S(e.damage),firePlayed:m?3:o?10:S(e.fire),stancePointsPlayed:m&&a?-1:m&&!a?0:S(e.stancePoints),poisonPlayed:s?t.poison:S(e.poison)+c,healPlayed:S(e.heal),strengthPlayed:S(e.strength),armorPlayed:d?2:S(e.armor),reduceTargetArmorPlayed:g?p:S(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:S(e.reduceTargetStrength),drawCardPlayed:S(e.drawCard),poisonRemovePlayed:S(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+o*x));n&&(gameState.player.lifeStealCounter+=o*x*n),a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),Z(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),_(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];Z(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&C(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&C(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(k,l,g,d,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),Y(a),e.updateHealthBar(a),K(gameState.player),X(a),y(),h(),_(u),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const T=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{T.forEach((e=>{Z(e,200)}))}))}function S(e){return"function"==typeof e?e():e}function u(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{Z(e,100)}))}))}t.turnComplete=!1,async function(t){const a=t.lifeStealText?430:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),J(t),gameState.toxicAvenger&&t.poison>0&&Y(t);const r=""!==t.poisonText._text||t.turnText?1500:500;await e.delay(r),Z(t.poisonText,100),Z(t.poisonTextBackground,100),await e.delay(100);const n=t.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",o).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=n.poison,t.health=Math.min(t.health+n.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+n.strength,t.strengthMax),Y(t),t.armor=Math.min(t.armor+n.armor,t.armorMax),n.damage>0||n.fire>0||n.poison>0){const a=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,n.fire+n.damage*a)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=n.poison>0?n.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else n.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n.text),e.powerUpTweens(t)):(n.strength>0||n.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),X(t),Y(t)}));const r=1300;await e.delay(r),gameState.actionText&&Z(gameState.actionText,200);gameState.actionTextBackground&&Z(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>Z(e,200))),t.turnComplete=!0,y()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?u():(gameState.currentEnemyIndex=0,await e.delay(150),m()))}(t)}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,u()))}function h(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:5,text:"Heals 10 HP\nGains 5 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:3,armor:0,text:"Heals 10 HP\nGains 3 Strength",probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 17 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function y(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),q(),gameState.characters.forEach((e=>Z(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&C(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&Z(gameState.actionText,200);gameState.actionTextBackground&&Z(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>Z(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{T(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,C(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),u=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*r,"rectangularButton"),y=e.add.text(t,a+3*r,"Exit Shop",m);let x=[];const k=[g,h,p,S],T=[d,y,c,u];let C=[...k,...T,gameState.shopBackground];k.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),T.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),C.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),b(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))})),x.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();x.push(a,r),C.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(x=x.filter((e=>e!=a&&e!=r)),C=C.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),b(s),x.forEach((e=>{e&&e.destroy()})),f(210),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),b(i),x.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&Z(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{Z(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{Z(e,200)})),e.time.delayedCall(250,(()=>{C.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?f():x()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),q(),Z(gameState.actionText,200),Z(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>Z(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function f(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&Z(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{Z(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?x():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{Z(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],T(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(b(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),f(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function x(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,k())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,k())}))}function k(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function T(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function C(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function b(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function B(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),a?(t.freePermanent||(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),function(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}(t),function(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,K(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>Y(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,K(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?I(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(console.log("adding heal shop"),e.addHealButton(),V()),gameState.lustForLifeCounter>=5&&H(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&L(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?L(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?W(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?N(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,K(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,K(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),_(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":P(t);break;case"rebelSpirit":w(t);break;case"rebelHeart":M(t);break;case"bushido":E(t);break;case"toxicAvenger":D(t);break;case"kirisuteGomen":I(t);case"toxicFrets":A(t);break;case"ashenEncore":O(t);break;case"edoEruption":$(t);break;case"steelToe":R(t);break;case"deadTokugawas":F(t);break;case"gundanSeizai":z(t);break;case"LustForLife":H(t);break;case"PunksNotDead":j(t);break;case"soulSquatter":U(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":G(t);break;case"enduringSpirit":L(t);break;case"shogunsShell":W(t);break;case"zaiUnderground":N(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}function v(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function P(e){gameState.foreverTrue=!1,v(e),_(8)}function w(t){gameState.rebelSpirit=!1,v(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function M(t){gameState.rebelHeart=!1,v(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function E(e){gameState.bushido=!1,v(e),gameState.player.strengthBase+=6,K(gameState.player)}function D(e){gameState.toxicAvenger=!1,v(e),gameState.enemies.forEach((e=>{e.poison+=4,Y(e)}))}function I(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),X(r),y(),K(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function A(t){gameState.toxicFrets=!1,v(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),X(t),y())}))}function O(t){gameState.ashenEncore=!1,v(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),X(t),y()}))}function $(e){gameState.edoEruption=!1,v(e)}function R(t){gameState.steelToe=!1,v(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,Y(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function F(e){gameState.redrawPrice+=1,v(e)}function z(e){gameState.gundanSeizai=!1,C(3),v(e)}function H(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{Z(e,200)}))),v(e)}function j(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),v(t)}function U(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,v(e)}function G(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),v(e)}function L(e){v(e)}function W(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,K(gameState.player),v(e)}function N(e){gameState.zaibatsuUnderground=!1,v(e)}function K(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),Y(e)}function Y(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function X(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void j(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,Z(e.sprite,500),e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(C(1),gameState.troopsOfTakamoriCondition=!1)}[e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{e&&e.destroy()}))}}function V(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(b(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function q(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),Z(e.sprite,200)}}function _(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),X(t),y(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){p(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function Z(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function J(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),q(),K(gameState.player),h(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,Z(e.intentionText,200),Z(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),u()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(_(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,X(e),y(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight2 extends BaseScene{self;constructor(){super("Level1Fight2")}preload(){this.load.image("bakgrunnCity2","assets/images/bakgrunnCity2.jpg"),this.load.image("rat1","assets/images/sprites/rat1.png"),this.load.image("rat2","assets/images/sprites/rat2.png"),this.load.image("ratCard","assets/images/cards/ratCard.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,280,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,360,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),q(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{V(r,200),V(n,200)}))}();const o=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>V(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},r="Heads up: Rats\nare infectious!",o=e.add.text(550,280,"",a).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,r),e.time.delayedCall(2500,(()=>{V(o,200),V(s,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),n(t),gameState.enemies.forEach((e=>{g(),d(e),X(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{g(),d(e),X(e)})),n(t))}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnCity2"),this.resetPlayer(gameState.player,.48,360,285),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{V(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{V(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Mutant City Rat",gameState.enemy1.cardKey="ratCard",gameState.enemy1.sprite=this.add.image(630,332,"rat1").setScale(.4).setFlipX(!0).setInteractive(),gameState.enemy1.health=40,gameState.enemy1.healthMax=40,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mutant City Rat",gameState.enemy2.cardKey="ratCard",gameState.enemy2.sprite=this.add.image(790,353,"rat2").setScale(.42).setFlipX(!0).setInteractive(),gameState.enemy2.health=50,gameState.enemy2.healthMax=50,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),N()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),k(a),x(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),f(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],n(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{V(gameState.startText,500)})),async function(){let n="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>V(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.ratTaunts||(gameState.ratTaunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.ratTaunts.length),t=gameState.ratTaunts.splice(e,1)[0];n=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,n,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;V(d,i),V(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{V(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();async function n(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),i=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(i),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(110+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:110+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,i),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(n))})),r===t-1&&(o(110,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function o(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&f(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;i(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),k(t),x(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":C(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":P(t);break;case"kirisuteGomen":w(t);case"toxicFrets":M(t);break;case"ashenEncore":E(t);break;case"edoEruption":D(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":$(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":F(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":z(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":j(t);break;case"zaiUnderground":U(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),V(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:m,healPlayed:d,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return console.log(`enemy: ${t.name}\nisLastEnemy: ${a}\nstancePoints: ${r}\nkabutuEdoCondition: ${g}`),{damagePlayed:n?11:l(e.damage),firePlayed:g?3:o?10:l(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?2:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));n&&(gameState.player.lifeStealCounter+=o*k*n),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),u&&console.log(`reduceTargetArmorPlayed: ${u}`),a.strengthTurn-=h,a.armor-=u,a.poison+=m,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),V(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Y(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];V(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&y(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&y(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),L(a),e.updateHealthBar(a),G(gameState.player),W(a),p(),g(),Y(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{V(e,200)}))}))}function l(e){return"function"==typeof e?e():e}function m(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{V(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),q(t),gameState.toxicAvenger&&t.poison>0&&L(t);let n=""!==t.poisonText._text||t.turnText?1500:500;gameState.infection&&(n+=1e3,gameState.infection=!1);e.time.delayedCall(n,(()=>{V(t.poisonText),V(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,280,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),L(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.infect?function(t){new Promise((a=>{let r=0;const n=450,o=200,s=450;let i=.45;const l=2300;gameState.infection=!0,e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8});const m=[{key:"ratCard",type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"ratCard",type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];gameState.drawPile.push(...m);const g=[e.add.image(n,s,"ratCard").setScale(i).setOrigin(.5).setDepth(300),e.add.image(n+o,s,"ratCard").setScale(i).setOrigin(.5).setDepth(300)];let d="Adds 2 Infections into your draw pile";gameState.actionText.y=s-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(l,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:120,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===g.length&&a()}})}))}))}))}(t):gameState.infection=!1,a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),L(t)}));const n=gameState.infection?2200:1300;await e.delay(n),gameState.actionText&&V(gameState.actionText,200);gameState.actionTextBackground&&V(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>V(e,200))),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?m():(gameState.currentEnemyIndex=0,await e.delay(150),r()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,m()))}function g(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:4,text:"Heals 10 HP\nGains 4 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:3===gameState.turn||4===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 4 Poison",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 poison",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nInfect you",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Infects you",infect:!0,probability:1}]:2===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:4,text:"Heals 10 HP\nGains 4 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:3===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nInfect you",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Infects you",infect:!0,probability:1}]:4===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 4 Poison",probability:1}]:gameState.enemy2.actions=[{key:"Intends to\nDeal 5 poison",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function d(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),K(),gameState.characters.forEach((e=>V(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&y(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&V(gameState.actionText,200);gameState.actionTextBackground&&V(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>V(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{h(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,y(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,x,S,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),f(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&V(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{V(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{V(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?c():S()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),K(),V(gameState.actionText,200),V(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>V(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&V(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{V(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?S():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{V(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],h(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(f(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())}))}function u(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function h(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function x(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>L(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),N()),gameState.lustForLifeCounter>=5&&$(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&H(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Y(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function k(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function C(e){gameState.foreverTrue=!1,T(e),Y(8)}function b(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,G(gameState.player)}function P(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,L(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(r),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function M(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),p())}))}function E(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),p()}))}function D(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,L(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,y(3),T(e)}function $(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{V(e,200)}))),T(e)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function F(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,T(e)}function z(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),T(e)}function H(e){T(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),T(e)}function U(e){gameState.zaibatsuUnderground=!1,T(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),L(e)}function L(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(y(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{V(e,500)}))}}function N(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(f(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function K(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,"debuff"===e.type&&(gameState.player.poison+=2),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),V(e.sprite,200)}}function Y(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function X(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function V(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function q(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),K(),G(gameState.player),g(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,V(e.intentionText,200),V(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),m()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Y(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight3 extends BaseScene{self;constructor(){super("Level1Fight3")}preload(){this.load.image("bakgrunnCity3","assets/images/bakgrunnCity3.jpg"),this.load.image("police1","assets/images/sprites/police1.png"),this.load.image("police2","assets/images/sprites/police2.png"),this.load.audio("gunShotSound","assets/sounds/gunshot.mp3")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnCity3"),this.resetPlayer(gameState.player,.5,360,340),this.addEndOfTurnButton(510),this.addRedrawButton(),this.addGoldCoin();let t=7;function a(){gameState.skipTaunts()}async function r(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function n(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let a=gameState.player.numCardsBase+gameState.player.numCardsStance;if(t-=1,2===gameState.turn&&function(){const a={fontSize:"60px",fontWeight:"bold",fill:"#000000"};gameState.turnsTextBox=e.add.rectangle(550,150,55,55,16777215).setAlpha(.3).setOrigin(.5),gameState.turnsText=e.add.text(550,152,`${t}`,a).setOrigin(.5)}(),gameState.turn>2&&gameState.turnsText.setText(`${t}`),0===t)gameState.player.health=0,gameState.punksNotDeadCondition=!1,e.sound.add("gunShotSound").play({volume:1.5}),e.cameras.main.flash(600),e.cameras.main.shake(800,.01,!1),W(gameState.player),p();else{const t="Your turn!",r=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(r,n,t),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),V(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{X(r,200),X(n,200)}))}();const s=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(s,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,r,n].forEach((e=>X(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{d(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(22);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(21)}(t)})),o(a)}))}}gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Sgt. Pig",gameState.enemy1.sprite=this.add.image(680,340,"police1").setScale(.26).setFlipX(!0).setInteractive(),gameState.enemy1.health=45,gameState.enemy1.healthMax=45,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Lt. Pig",gameState.enemy2.sprite=this.add.image(840,340,"police2").setScale(.4).setFlipX(!0).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,460)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),N()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),k(a),x(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),f(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],o(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${t}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{X(gameState.startText,500)})),async function(){let t="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>X(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),n()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),a=gameState.taunts.splice(e,1)[0];t=a.enemy,o=a.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await r(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;X(d,i),X(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await r(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{X(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||n())}(),e.input.keyboard.on("keydown",a,this),e.input.on("pointerup",a,this)}))}();async function o(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),o=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(o),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,o),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),i(n))})),r===t-1&&(s(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function s(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function i(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&f(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),l(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;l(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),k(t),x(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":C(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":P(t);break;case"kirisuteGomen":w(t);case"toxicFrets":M(t);break;case"ashenEncore":E(t);break;case"edoEruption":D(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":$(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":F(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":z(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":j(t);break;case"zaiUnderground":U(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),l(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function l(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),X(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:g,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:m(e.damage),firePlayed:g?3:o?10:m(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:m(e.stancePoints),poisonPlayed:s?t.poison:m(e.poison)+S,healPlayed:m(e.heal),strengthPlayed:m(e.strength),armorPlayed:p?2:m(e.armor),reduceTargetArmorPlayed:d?c:m(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:m(e.reduceTargetStrength),drawCardPlayed:m(e.drawCard),poisonRemovePlayed:m(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));n&&(gameState.player.lifeStealCounter+=o*k*n),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=l,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),X(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Y(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];X(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&y(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&y(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,l,c,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),L(a),e.updateHealthBar(a),G(gameState.player),W(a),p(),d(),Y(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{X(e,200)}))}))}function m(e){return"function"==typeof e?e():e}function g(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const o=[t.turnText,r];if(gameState.canibalizeCondition){const a=Math.floor(gameState.player.lifeSteal),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-roundgameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),o.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{if(o.forEach((e=>X(e,100))),1===gameState.turn){const t={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},a=e.add.text(550,300,"   The pigs are\ncalling for backup!",t).setOrigin(.5).setDepth(201);let r=a.width,o=a.height,s=20,i=20,l=7;const m=e.add.graphics();m.fillStyle(16777215,.7),m.fillRoundedRect(a.x-r/2-s,a.y-o/2-i,r+2*s,o+2*i,l).setDepth(200),e.time.delayedCall(3500,(()=>{a.destroy(),m.destroy();const r=e.add.text(550,300,"Police snipers\n will hit you\n  in 5 turns!",t).setOrigin(.5).setDepth(201);let o=r.width,s=r.height,i=20,l=20,g=7;const d=e.add.graphics();d.fillStyle(16777215,.7),d.fillRoundedRect(r.x-o/2-i,r.y-s/2-l,o+2*i,s+2*l,g).setDepth(200),e.time.delayedCall(4500,(()=>{r.destroy(),d.destroy(),n()}))}))}}))}1!=gameState.turn&&(t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),V(t),gameState.toxicAvenger&&t.poison>0&&L(t);const r=""!==t.poisonText._text||t.turnText?1500:500;e.time.delayedCall(r,(()=>{X(t.poisonText),X(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),L(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),L(t)}));const r=1300;await e.delay(r),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200))),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?g():(gameState.currentEnemyIndex=0,await e.delay(150),n()))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,g()))}function d(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRequest backup",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRequest backup",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}])}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),K(),gameState.characters.forEach((e=>X(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&y(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have cleared Level ${s}\nHealth is resorted to ${gameState.player.healthMax}/${gameState.player.healthMax}`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=5,r=250,n=100;gameState.goldCollected=!1;const o="Collect loot and get\n ready for Level 2!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{h(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,y(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,x,S,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),f(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&X(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{X(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?c():S()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),K(),X(gameState.actionText,200),X(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>X(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),"permanent"===r.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(r),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&X(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?S():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{X(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],h(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),f(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())}))}function u(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function h(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function x(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>L(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),N()),gameState.lustForLifeCounter>=5&&$(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&H(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Y(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function k(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function C(e){gameState.foreverTrue=!1,T(e),Y(8)}function b(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,G(gameState.player)}function P(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,L(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(r),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function M(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),p())}))}function E(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),p()}))}function D(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,L(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,y(3),T(e)}function $(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{X(e,200)}))),T(e)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function F(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,T(e)}function z(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),T(e)}function H(e){T(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),T(e)}function U(e){gameState.zaibatsuUnderground=!1,T(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),L(e)}function L(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(y(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{X(e,500)}))}}function N(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(f(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function K(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),X(e.sprite,200)}}function Y(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){i(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function X(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function V(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),K(),G(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,X(e.intentionText,200),X(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),g()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Y(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight1 extends BaseScene{self;constructor(){super("Level2Fight1")}preload(){this.load.image("theForest","assets/images/theForest.jpg"),this.load.image("bakgrunnForest1","assets/images/bakgrunnForest1.jpg"),this.load.image("tree1","assets/images/sprites/tree1.png"),this.load.image("tree2","assets/images/sprites/tree2.png"),this.load.image("rooted","assets/images/cards/rooted.jpg")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnForest1"),this.resetPlayer(gameState.player,.37,360,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{ee(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{ee(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Timbermaw\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.cardKey="rooted",gameState.enemy1.sprite=this.add.sprite(680,315,"tree1").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy.armor=15,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mossbite\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy2.cardKey="rooted",gameState.enemy2.sprite=this.add.sprite(920,315,"tree2").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemy2.armor=15,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),_()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),P(a),v(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theForest").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 2:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Forest",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),B(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),r=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,r,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{ee(gameState.startText,500)})),async function(){let t="",a="";const r=400,n=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>ee(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),r=gameState.taunts.splice(e,1)[0];t=r.enemy,a=r.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*r),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;ee(d,n),ee(p,n),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{ee(e,n)})),gameState.skipIntro||(await e.delay(n),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),te(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),q(gameState.player),f(),X(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{ee(r,200),ee(n,200)}))}();const n=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>ee(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let r="Trees start with\nfull Armor, and lose\n1 Armor when attacked";const n=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{r="Naturally, they are also\nvulnerabel to fire",e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{ee(n,200),ee(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),g(t),gameState.enemies.forEach((e=>{h(),y(e),Q(e)}))}))}))}))}(t):(gameState.enemies.forEach((e=>{h(),y(e),Q(e)})),g(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,ee(a,2e3),ee(r,2e3),ee(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,ee(a,2e3),ee(r,2e3),ee(n,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,ee(a,2e3),ee(r,2e3),ee(n,2e3),e.time.delayedCall(2200,s()))}));async function g(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),o=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(o),n.usedOneShot&&n.sprite.setTint(8421504);const s=gameState.slots[a+r];s&&(n.startHeight=s.y,n.angle=s.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:s.x,y:s.y,scaleX:.35,scaleY:.35,angle:s.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{s.available=!1,n.slot=s}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,o),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),p(n))})),r===t-1&&(d(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function d(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function p(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&B(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),c(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;c(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),P(t),v(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":M(t);break;case"rebelSpirit":E(t);break;case"rebelHeart":D(t);break;case"bushido":I(t);break;case"toxicAvenger":A(t);break;case"kirisuteGomen":O(t);case"toxicFrets":$(t);break;case"ashenEncore":R(t);break;case"edoEruption":F(t);break;case"steelToe":z(t);break;case"deadTokugawas":H(t);break;case"gundanSeizai":j(t);break;case"LustForLife":U(t);break;case"PunksNotDead":G(t);break;case"soulSquatter":L(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":W(t);break;case"enduringSpirit":N(t);break;case"shogunsShell":K(t);break;case"zaiUnderground":Y(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),c(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function c(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),ee(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:u,poisonRemovePlayed:y}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=r>0?2*(1+r):2,c=i?1:0,u=1.2;return{damagePlayed:n?11:S(e.damage),firePlayed:u*(m?3:o?10:S(e.fire)),stancePointsPlayed:m&&a?-1:m&&!a?0:S(e.stancePoints),poisonPlayed:s?t.poison:S(e.poison)+c,healPlayed:S(e.heal),strengthPlayed:S(e.strength),armorPlayed:d?2:S(e.armor),reduceTargetArmorPlayed:g?p:S(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:S(e.reduceTargetStrength),drawCardPlayed:S(e.drawCard),poisonRemovePlayed:S(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+o*x));n&&(gameState.player.lifeStealCounter+=o*x*n),a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),ee(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),J(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];ee(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&b(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&b(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-y),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(k,l,g,d,y),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),V(a),e.updateHealthBar(a),X(gameState.player),q(a),f(),h(),J(u),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const T=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{T.forEach((e=>{ee(e,200)}))}))}function S(e){return"function"==typeof e?e():e}function u(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{ee(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),te(t),gameState.toxicAvenger&&t.poison>0&&V(t);let r=""!==t.poisonText._text||t.turnText?1800:500;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{ee(t.poisonText),ee(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),V(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),q(t),V(t)}));const r=gameState.debuffCardPlayed?1800:1300;await e.delay(r),gameState.actionText&&ee(gameState.actionText,200);gameState.actionTextBackground&&ee(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>ee(e,200))),t.turnComplete=!0,f()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?u():(gameState.currentEnemyIndex=0,await e.delay(150),m()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,u()))}function h(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(13*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 13 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):5===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.26+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,text:"Heals 10 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.13},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:0,text:"Heals 15 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,text:"Gains 2 strenght",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.28+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.15},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,text:"Heals 20 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,text:"Gains 2 strenght",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5}])}function y(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function f(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),Z(),gameState.characters.forEach((e=>ee(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&b(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&ee(gameState.actionText,200);gameState.actionTextBackground&&ee(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>ee(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{C(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,b(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),u=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*r,"rectangularButton"),y=e.add.text(t,a+3*r,"Exit Shop",m);let f=[];const k=[g,h,p,S],T=[d,y,c,u];let C=[...k,...T,gameState.shopBackground];k.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),T.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),C.push(gameState.shopWelcomeText,gameState.shopTextBackground);const b="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);b&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),B(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))})),f.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();f.push(a,r),C.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(f=f.filter((e=>e!=a&&e!=r)),C=C.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),B(s),f.forEach((e=>{e&&e.destroy()})),x(210),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),B(i),f.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&ee(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{ee(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{ee(e,200)})),e.time.delayedCall(250,(()=>{C.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?x():k()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),Z(),ee(gameState.actionText,200),ee(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>ee(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function x(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&ee(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{ee(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?k():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{ee(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],C(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),B(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),x(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function k(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,T())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,T())}))}function T(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function C(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function b(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function B(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function v(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,X(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>V(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,X(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?O(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),_()),gameState.lustForLifeCounter>=5&&U(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?L(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?W(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&N(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?N(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?K(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?Y(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,X(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,X(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),J(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function P(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function w(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function M(e){gameState.foreverTrue=!1,w(e),J(8)}function E(t){gameState.rebelSpirit=!1,w(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function D(t){gameState.rebelHeart=!1,w(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function I(e){gameState.bushido=!1,w(e),gameState.player.strengthBase+=6,X(gameState.player)}function A(e){gameState.toxicAvenger=!1,w(e),gameState.enemies.forEach((e=>{e.poison+=4,V(e)}))}function O(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),q(r),f(),X(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function $(t){gameState.toxicFrets=!1,w(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),q(t),f())}))}function R(t){gameState.ashenEncore=!1,w(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),q(t),f()}))}function F(e){gameState.edoEruption=!1,w(e)}function z(t){gameState.steelToe=!1,w(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,V(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function H(e){gameState.redrawPrice+=1,w(e)}function j(e){gameState.gundanSeizai=!1,b(3),w(e)}function U(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{ee(e,200)}))),w(e)}function G(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),w(t)}function L(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,w(e)}function W(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),w(e)}function N(e){w(e)}function K(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,X(gameState.player),w(e)}function Y(e){gameState.zaibatsuUnderground=!1,w(e)}function X(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),V(e)}function V(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function q(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void G(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(b(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{ee(e,500)}))}}function _(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(B(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function Z(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),ee(e.sprite,200)}}function J(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),q(t),f(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){p(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function Q(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function ee(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function te(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),Z(),X(gameState.player),h(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,ee(e.intentionText,200),ee(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),u()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(J(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,q(e),f(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight2 extends BaseScene{self;constructor(){super("Level2Fight2")}preload(){this.load.image("bakgrunnForest2","assets/images/bakgrunnForest2.jpg"),this.load.image("goblin1","assets/images/sprites/goblin1.png"),this.load.image("goblin2","assets/images/sprites/goblin2.png"),this.load.image("goblin3","assets/images/sprites/goblin3.png")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnForest2"),this.resetPlayer(gameState.player,.5,360,330),this.addEndOfTurnButton(510),this.addRedrawButton(),this.addGoldCoin();let t=7;function a(){gameState.skipTaunts()}async function r(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function n(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let a=gameState.player.numCardsBase+gameState.player.numCardsStance;t>0&&(t-=1),2===gameState.turn&&function(){const a={fontSize:"70px",fontWeight:"bold",fill:"#000000"};gameState.countdownTextBox=e.add.image(550,150,"goldCoin").setScale(.12),gameState.countdownText=e.add.text(530,120,`${t}`,a)}(),gameState.turn>2&&gameState.countdownText.setText(`${t}`),0===t&&(gameState.countdownTextBox.destroy(),gameState.countdownText.destroy(),e.cameras.main.shake(800,.005,!1));const r=e.add.text(550,310,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(r,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),_(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),N(gameState.player),c(),L(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{q(r,200),q(n,200)}))}();const s=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(s,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,r,n].forEach((e=>q(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},r="Defeat the Goblins\nto steal their gold!";gameState.introText=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),gameState.introTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.introText,gameState.introTextBackground,r),e.time.delayedCall(2500,(()=>{q(gameState.introText,200),q(gameState.introTextBackground,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),o(t),gameState.enemies.forEach((e=>{d(),p(e),V(e)}))}))}))}(a):(gameState.enemies.forEach((e=>{d(),p(e),V(e)})),o(a))}))}gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{q(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{q(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Junior Goblin\nApprentice of poison",gameState.enemy1.sprite=this.add.sprite(670,380,"goblin1").setScale(.2).setFlipX(!0).setInteractive(),gameState.enemy1.health=30,gameState.enemy1.healthMax=30,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Junior Goblin\nApprentice of poison",gameState.enemy2.sprite=this.add.sprite(800,380,"goblin3").setScale(.18).setFlipX(!1).setInteractive(),gameState.enemy2.health=30,gameState.enemy2.healthMax=30,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Senior Goblin\nMaster of poison",gameState.enemy3.sprite=this.add.sprite(930,380,"goblin2").setScale(.25).setFlipX(!1).setInteractive(),gameState.enemy3.health=45,gameState.enemy3.healthMax=45,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),K()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),T(a),k(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),x(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],o(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${t}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5).setDepth(20),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!").setDepth(20),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{q(gameState.startText,500)})),async function(){let t="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>q(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),n()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),a=gameState.taunts.splice(e,1)[0];t=a.enemy,o=a.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await r(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;q(d,i),q(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await r(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{q(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||n())}(),e.input.keyboard.on("keydown",a,this),e.input.on("pointerup",a,this)}))}();async function o(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),o=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(o),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,o),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),i(n))})),r===t-1&&(s(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function s(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function i(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&x(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),l(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;l(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),T(t),k(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":b(t);break;case"rebelSpirit":B(t);break;case"rebelHeart":v(t);break;case"bushido":P(t);break;case"toxicAvenger":w(t);break;case"kirisuteGomen":M(t);case"toxicFrets":E(t);break;case"ashenEncore":D(t);break;case"edoEruption":I(t);break;case"steelToe":A(t);break;case"deadTokugawas":O(t);break;case"gundanSeizai":$(t);break;case"LustForLife":R(t);break;case"PunksNotDead":F(t);break;case"soulSquatter":z(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":H(t);break;case"enduringSpirit":j(t);break;case"shogunsShell":U(t);break;case"zaiUnderground":G(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),l(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function l(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),q(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:g,strengthPlayed:p,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:x}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:m(e.damage),firePlayed:g?3:o?10:m(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:m(e.stancePoints),poisonPlayed:s?t.poison:m(e.poison)+S,healPlayed:m(e.heal),strengthPlayed:m(e.strength),armorPlayed:p?2:m(e.armor),reduceTargetArmorPlayed:d?c:m(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:m(e.reduceTargetStrength),drawCardPlayed:m(e.drawCard),poisonRemovePlayed:m(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));n&&(gameState.player.lifeStealCounter+=o*k*n),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=l,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=p:gameState.player.strengthCard+=p,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),q(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),X(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];q(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&f(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&f(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,l,p,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),W(a),e.updateHealthBar(a),L(gameState.player),N(a),c(),d(),X(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{q(e,200)}))}))}function m(e){return"function"==typeof e?e():e}function g(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,310,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const o=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),o.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{if(o.forEach((e=>q(e,100))),1===gameState.turn){const t=[],a={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},r="The Goblins are\nevacuating their gold!",o=e.add.text(550,300,"",a).setOrigin(.5),s=e.add.graphics();t.push(o,s),e.updateTextAndBackground(o,s,r,7,200),e.time.delayedCall(2500,(()=>{t.forEach((e=>e.destroy())),s.destroy();const r="Defeat them in\n5 turns to steal\nwhat's left!",o=e.add.text(550,300,"",a).setOrigin(.5),i=e.add.graphics();t.push(o,i),e.updateTextAndBackground(o,i,r,7,200),e.time.delayedCall(2500,(()=>{t.forEach((e=>e.destroy())),n()}))}))}}))}1!=gameState.turn&&(t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),_(t),gameState.toxicAvenger&&t.poison>0&&W(t);const r=""!==t.poisonText._text||t.turnText?1500:500;e.time.delayedCall(r,(()=>{q(t.poisonText),q(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),W(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),N(t),W(t)}));const r=1300;await e.delay(r),gameState.actionText&&q(gameState.actionText,200);gameState.actionTextBackground&&q(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>q(e,200))),t.turnComplete=!0,c()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?g():(gameState.currentEnemyIndex=0,await e.delay(150),n()))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,g()))}function d(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}],gameState.enemy3.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6}],gameState.enemy3.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:0+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(11*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:11,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage\nAnd 1 Poison",probability:.17+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage\nAnd 1 Poison",probability:.11+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.18+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 3 poison",probability:.19+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6}])}function p(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function c(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,async function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),Y(),gameState.actionText&&q(gameState.actionText,200);gameState.actionTextBackground&&q(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>q(e,200))),gameState.characters.forEach((e=>q(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)})),await e.delay(600),gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop();t&&await new Promise((a=>{let r=0;for(let n=0;n<t;n++)e.time.delayedCall(200*n,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),t-=1,gameState.goldCounter.setText(gameState.player.gold),gameState.countdownText.setText(t),gameConfig.coinSound.play({volume:.8,seek:.02}),r++,r===t&&(0===t&&(q(gameState.countdownTextBox,250),q(gameState.countdownText,250)),a())}))}));await e.delay(200);const a=gameState.gundanSeizai?1:0,r=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,n=a+r;n&&f(n);gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard();const o={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let s=e.add.text(550,300,"Victory!",o).setOrigin(.5).setDepth(21);const{level:i,fight:l}=e.extractLevelFightFromName(e.scene.key),m=3===l?3e3:100,g=3===l?`You have completed Level ${i}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1e3,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),s.setText(g),s.setStyle({fontSize:"60px"}),e.time.delayedCall(m,(()=>{s.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{y(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,f(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),f=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,f,c,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),x(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),x(s),k.forEach((e=>{e&&e.destroy()})),S(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),x(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&q(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{q(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{q(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?S():u()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),Y(),q(gameState.actionText,200),q(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>q(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function S(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&q(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{q(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?u():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{q(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],y(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),x(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),S(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function u(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,h())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,h())}))}function h(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function y(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function x(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function k(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,L(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>W(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,L(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?M(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),K()),gameState.lustForLifeCounter>=5&&R(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&j(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,L(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,L(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),X(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function T(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function C(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function b(e){gameState.foreverTrue=!1,C(e),X(8)}function B(t){gameState.rebelSpirit=!1,C(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function v(t){gameState.rebelHeart=!1,C(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function P(e){gameState.bushido=!1,C(e),gameState.player.strengthBase+=6,L(gameState.player)}function w(e){gameState.toxicAvenger=!1,C(e),gameState.enemies.forEach((e=>{e.poison+=4,W(e)}))}function M(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),N(r),c(),L(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function E(t){gameState.toxicFrets=!1,C(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),N(t),c())}))}function D(t){gameState.ashenEncore=!1,C(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),N(t),c()}))}function I(e){gameState.edoEruption=!1,C(e)}function A(t){gameState.steelToe=!1,C(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,W(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function O(e){gameState.redrawPrice+=1,C(e)}function $(e){gameState.gundanSeizai=!1,f(3),C(e)}function R(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{q(e,200)}))),C(e)}function F(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),C(t)}function z(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,C(e)}function H(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),C(e)}function j(e){C(e)}function U(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,L(gameState.player),C(e)}function G(e){gameState.zaibatsuUnderground=!1,C(e)}function L(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),W(e)}function W(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function N(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void F(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(f(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{q(e,500)}))}}function K(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(x(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function Y(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),q(e.sprite,200)}}function X(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),N(t),c(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){i(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function V(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function q(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function _(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),Y(),L(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,q(e.intentionText,200),q(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),g()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(X(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,N(e),c(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight3 extends BaseScene{self;constructor(){super("Level2Fight3")}preload(){this.load.image("bakgrunnForest3","assets/images/bakgrunnForest3.jpg"),this.load.image("tree3","assets/images/sprites/tree3.png"),this.load.image("rooted","assets/images/cards/rooted.jpg"),this.load.image("goblin1","assets/images/sprites/goblin1.png")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),V(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{X(r,200),X(n,200)}))}();const o=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>X(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),gameState.enemies.forEach((t=>{d(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(22);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(21)}(t)})),n(t)}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnForest3"),this.resetPlayer(gameState.player,.37,360,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Lord of the Trees\nLose Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.cardKey="rooted",gameState.enemy1.sprite=this.add.sprite(780,290,"tree3").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy1.health=110,gameState.enemy1.healthMax=110,gameState.enemy1.armor=15,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),N()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),k(a),x(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),f(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],n(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{X(gameState.startText,500)})),async function(){let n="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>X(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];n=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,n,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;X(d,i),X(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{X(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();async function n(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),i=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(i),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,i),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(n))})),r===t-1&&(o(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function o(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&f(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;i(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),k(t),x(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":C(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":P(t);break;case"kirisuteGomen":w(t);case"toxicFrets":M(t);break;case"ashenEncore":E(t);break;case"edoEruption":D(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":$(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":F(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":z(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":j(t);break;case"zaiUnderground":U(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),X(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:m,healPlayed:g,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0,u=t===gameState.enemy1?1.2:1;return{damagePlayed:n?11:l(e.damage),firePlayed:u*(g?3:o?10:l(e.fire)),stancePointsPlayed:g&&a?-1:g&&!a?0:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?2:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));n&&(gameState.player.lifeStealCounter+=o*k*n),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=m,a.health-=T,a.armor>0&&T>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),X(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Y(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];X(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&y(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&y(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),L(a),e.updateHealthBar(a),G(gameState.player),W(a),p(),d(),Y(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{X(e,200)}))}))}function l(e){return"function"==typeof e?e():e}function m(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{X(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),V(t),gameState.toxicAvenger&&t.poison>0&&L(t);let n=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{X(t.poisonText),X(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),L(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),"doubleDiscard"===a.debuffCard?(a.debuffCard="discard",g(t,a),a.debuffCard="doubleDiscard",e.time.delayedCall(2200,(()=>{e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,""),e.time.delayedCall(400,(()=>{a.debuffCard="discard",g(t,a)}))}))):a.debuffCard?g(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Junior Goblin\nApprentice of poison",t.sprite=e.add.sprite(560,380,"goblin1"),t.sprite.setScale(.16).setFlipX(!0).setAlpha(0).setInteractive(),t.health=30,t.healthMax=30,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Goblin";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),L(t)}));const n="doubleDiscard"===a.debuffCard?4500:gameState.debuffCardPlayed?1800:1300;await e.delay(n),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200))),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?m():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),await e.delay(150),r()))}(t,a)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,m()))}function g(t,a){return new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey;const s="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,i="draw"===a.debuffCard?"Draw pile":"Discard Pile",l="draw"===a.debuffCard?120:980;e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const m=[{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];s.push(...m);const g=[e.add.image(450,450,o).setScale(.45).setOrigin(.5).setDepth(300),e.add.image(650,450,o).setScale(.45).setOrigin(.5).setDepth(300)];let d=`Adds 2 ${{ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"}[o]} to your ${i}`;gameState.actionText.y=250,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(2300,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:l,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===g.length&&r()}})}))}))}))}function d(){3===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"doubleDiscard",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 10 HP\nGains 2 armor",probability:1}]:1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Goblin",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Goblin",summonEnemy:2,probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:5===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 3 armor",probability:1}]:gameState.enemy2&&gameState.enemy2.alive?gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.26+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 10 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.14},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Goblin",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Goblin",summonEnemy:2,probability:.33},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.19+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 10 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.1},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.06+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.05+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/5}],gameState.enemy2&&(gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.25+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/3},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/3},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.2},{key:"Intends to\nPoison you",damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 3 poison",probability:.4+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/3}])}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),K(),gameState.characters.forEach((e=>X(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&y(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have cleared Level ${s}\nHealth is resorted to ${gameState.player.healthMax}/${gameState.player.healthMax}`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=5,r=250,n=100;gameState.goldCollected=!1;const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=3===s?`Collect loot and get\nready for Level ${o+1}!`:"  Collect loot and get\nready for your next fight!",l={fontSize:"40px",fill:"#ff0000"},m=e.add.text(550,130,i,l).setOrigin(.5).setDepth(103),g=e.add.graphics();e.updateTextAndBackground(m,g,i),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const d=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,d,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const p=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{h(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,y(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,x,S,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,_:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),f(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&X(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{X(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...p,m,g];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?c():S()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),K(),X(gameState.actionText,200),X(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>X(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&X(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?S():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{X(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],h(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),f(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())}))}function u(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function h(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function x(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>L(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),N()),gameState.lustForLifeCounter>=5&&$(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&H(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Y(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function k(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function C(e){gameState.foreverTrue=!1,T(e),Y(8)}function b(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,G(gameState.player)}function P(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,L(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(r),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function M(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),p())}))}function E(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),p()}))}function D(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,L(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,y(3),T(e)}function $(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{X(e,200)}))),T(e)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function F(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,T(e)}function z(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),T(e)}function H(e){T(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),T(e)}function U(e){gameState.zaibatsuUnderground=!1,T(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),L(e)}function L(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(y(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{X(e,500)}))}}function N(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(f(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function K(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),X(e.sprite,200)}}function Y(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function X(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function V(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),K(),G(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,X(e.intentionText,200),X(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),m()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Y(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight1 extends BaseScene{self;constructor(){super("Level3Fight1")}preload(){this.load.image("bakgrunnLair1","assets/images/bakgrunnLair1.jpg"),this.load.image("theDemonLair","assets/images/theDemonLair.jpg"),this.load.image("voidling","assets/images/sprites/voidling.png"),this.load.image("demon2","assets/images/sprites/demon2.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnLair1"),this.resetPlayer(gameState.player,.41,350,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{ee(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{ee(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Infernus",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(840,315,"demon2").setScale(.3).setFlipX(!1).setInteractive(),gameState.enemy1.health=80,gameState.enemy1.healthMax=80,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Voidling",gameState.enemy2.cardKey="hellFire",gameState.enemy2.sprite=e.add.sprite(630,370,"voidling"),gameState.enemy2.sprite.setScale(.3).setFlipX(!1).setInteractive(),gameState.enemy2.health=25,gameState.enemy2.healthMax=25,gameState.enemy2.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#d1d1d1"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),_()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),P(a),v(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theDemonLair").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 3:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Demons' Lair",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),B(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),r=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,r,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{ee(gameState.startText,500)})),async function(){let t="",a="";const r=400,n=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>ee(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),r=gameState.taunts.splice(e,1)[0];t=r.enemy,a=r.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*r),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;ee(d,n),ee(p,n),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{ee(e,n)})),gameState.skipIntro||(await e.delay(n),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),te(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),q(gameState.player),f(),X(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{ee(r,200),ee(n,200)}))}();const n=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>ee(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let r="Heads up:\nDemons fight\nwith Fire!";const n=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{ee(n,200),ee(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),g(t),gameState.enemies.forEach((e=>{h(),y(e),Q(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{h(),y(e),Q(e)})),g(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,ee(a,2e3),ee(r,2e3),ee(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,ee(a,2e3),ee(r,2e3),ee(n,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,ee(a,2e3),ee(r,2e3),ee(n,2e3),e.time.delayedCall(2200,s()))}));async function g(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),o=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(o),n.usedOneShot&&n.sprite.setTint(8421504);const s=gameState.slots[a+r];s&&(n.startHeight=s.y,n.angle=s.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:s.x,y:s.y,scaleX:.35,scaleY:.35,angle:s.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{s.available=!1,n.slot=s}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,o),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),p(n))})),r===t-1&&(d(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function d(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function p(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&B(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),c(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;c(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),P(t),v(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":M(t);break;case"rebelSpirit":E(t);break;case"rebelHeart":D(t);break;case"bushido":I(t);break;case"toxicAvenger":A(t);break;case"kirisuteGomen":O(t);case"toxicFrets":$(t);break;case"ashenEncore":R(t);break;case"edoEruption":F(t);break;case"steelToe":z(t);break;case"deadTokugawas":H(t);break;case"gundanSeizai":j(t);break;case"LustForLife":U(t);break;case"PunksNotDead":G(t);break;case"soulSquatter":L(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":W(t);break;case"enduringSpirit":N(t);break;case"shogunsShell":K(t);break;case"zaiUnderground":Y(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),c(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function c(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),ee(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:u,poisonRemovePlayed:y}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=r>0?2*(1+r):2,c=i?1:0;return{damagePlayed:n?11:S(e.damage),firePlayed:m?3:o?10:S(e.fire),stancePointsPlayed:m&&a?-1:m&&!a?0:S(e.stancePoints),poisonPlayed:s?t.poison:S(e.poison)+c,healPlayed:S(e.heal),strengthPlayed:S(e.strength),armorPlayed:d?2:S(e.armor),reduceTargetArmorPlayed:g?p:S(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:S(e.reduceTargetStrength),drawCardPlayed:S(e.drawCard),poisonRemovePlayed:S(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+o*x));n&&(gameState.player.lifeStealCounter+=o*x*n),a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),ee(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),J(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];ee(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&b(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&b(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-y),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(k,l,g,d,y),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),V(a),e.updateHealthBar(a),X(gameState.player),q(a),f(),h(),J(u),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const T=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{T.forEach((e=>{ee(e,200)}))}))}function S(e){return"function"==typeof e?e():e}function u(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{ee(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),te(t),gameState.toxicAvenger&&t.poison>0&&V(t);let r=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{ee(t.poisonText),ee(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),V(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(630,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),q(t),V(t)}));let r=gameState.debuffCardPlayed?1500:1200;await e.delay(r),gameState.actionText&&ee(gameState.actionText,200);gameState.actionTextBackground&&ee(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>ee(e,200))),t.turnComplete=!0,f()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?u():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),r=gameState.debuffCardPlayed?500:150,await e.delay(r),m()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,u()))}function h(){gameState.enemy2&&gameState.enemy2.alive?1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:2,armor:5,reduceTargetStrength:0,reduceTargetArmor:0,text:"Heals 10 HP\nGains 2 Strength\nAnd 5 Armor",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 Fire damage",probability:.2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strenght",probability:.09+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 Armor",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.05}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:2}],gameState.enemy2&&(gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.5}])}function y(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function f(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),Z(),gameState.characters.forEach((e=>ee(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&b(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&ee(gameState.actionText,200);gameState.actionTextBackground&&ee(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>ee(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="Collect loot and get\n ready for Level 3!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{C(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,b(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),u=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*r,"rectangularButton"),y=e.add.text(t,a+3*r,"Exit Shop",m);let f=[];const k=[g,h,p,S],T=[d,y,c,u];let C=[...k,...T,gameState.shopBackground];k.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),T.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),C.push(gameState.shopWelcomeText,gameState.shopTextBackground);const b="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);b&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),B(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))})),f.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();f.push(a,r),C.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(f=f.filter((e=>e!=a&&e!=r)),C=C.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),B(s),f.forEach((e=>{e&&e.destroy()})),x(210),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),B(i),f.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&ee(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{ee(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{ee(e,200)})),e.time.delayedCall(250,(()=>{C.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?x():k()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),Z(),ee(gameState.actionText,200),ee(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>ee(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function x(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&ee(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{ee(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?k():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{ee(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],C(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),B(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),x(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function k(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,T())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,T())}))}function T(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function C(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function b(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function B(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function v(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,X(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>V(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,X(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?O(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),_()),gameState.lustForLifeCounter>=5&&U(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?L(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?W(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&N(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?N(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?K(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?Y(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,X(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,X(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),J(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function P(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function w(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function M(e){gameState.foreverTrue=!1,w(e),J(8)}function E(t){gameState.rebelSpirit=!1,w(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function D(t){gameState.rebelHeart=!1,w(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function I(e){gameState.bushido=!1,w(e),gameState.player.strengthBase+=6,X(gameState.player)}function A(e){gameState.toxicAvenger=!1,w(e),gameState.enemies.forEach((e=>{e.poison+=4,V(e)}))}function O(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),q(r),f(),X(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function $(t){gameState.toxicFrets=!1,w(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),q(t),f())}))}function R(t){gameState.ashenEncore=!1,w(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),q(t),f()}))}function F(e){gameState.edoEruption=!1,w(e)}function z(t){gameState.steelToe=!1,w(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,V(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function H(e){gameState.redrawPrice+=1,w(e)}function j(e){gameState.gundanSeizai=!1,b(3),w(e)}function U(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{ee(e,200)}))),w(e)}function G(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),w(t)}function L(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,w(e)}function W(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),w(e)}function N(e){w(e)}function K(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,X(gameState.player),w(e)}function Y(e){gameState.zaibatsuUnderground=!1,w(e)}function X(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),V(e)}function V(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function q(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void G(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(b(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{ee(e,500)}))}}function _(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(B(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function Z(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),ee(e.sprite,200)}}function J(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),q(t),f(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){p(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function Q(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function ee(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function te(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),Z(),X(gameState.player),h(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,ee(e.intentionText,200),ee(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),u()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(J(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,q(e),f(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight2 extends BaseScene{self;constructor(){super("Level3Fight2")}preload(){this.load.image("bakgrunnLair2","assets/images/bakgrunnLair2.jpg"),this.load.image("skeleton1","assets/images/sprites/skeleton1.png"),this.load.image("skeleton2","assets/images/sprites/skeleton2.png"),this.load.image("voidling","assets/images/sprites/voidling.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),V(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{X(r,200),X(n,200)}))}();const o=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>X(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{d(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),n(t)}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnLair2"),this.resetPlayer(gameState.player,.42,320,355),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Bonebaron",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(830,310,"skeleton2").setScale(.35).setFlipX(!1).setInteractive(),gameState.enemy1.health=120,gameState.enemy1.healthMax=120,gameState.enemy1.armor=0,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),N()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),k(a),x(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),f(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],n(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{X(gameState.startText,500)})),async function(){let n="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>X(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];n=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,n,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;X(d,i),X(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{X(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();async function n(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),i=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(i),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,i),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(n))})),r===t-1&&(o(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function o(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&f(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;i(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),k(t),x(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":C(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":P(t);break;case"kirisuteGomen":w(t);case"toxicFrets":M(t);break;case"ashenEncore":E(t);break;case"edoEruption":D(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":$(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":F(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":z(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":j(t);break;case"zaiUnderground":U(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),X(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:m,healPlayed:g,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:l(e.damage),firePlayed:g?3:o?10:l(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?2:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));a!=gameState.player&&(n&&(gameState.player.lifeStealCounter+=o*k*n),gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=m,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),X(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Y(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];X(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&y(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&y(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),L(a),e.updateHealthBar(a),G(gameState.player),W(a),p(),d(),Y(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{X(e,200)}))}))}function l(e){return"function"==typeof e?e():e}function m(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{X(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),V(t),gameState.toxicAvenger&&t.poison>0&&L(t);let n=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{X(t.poisonText),X(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),L(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(650,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),g(t,500)}(),3==a.summonEnemy&&function(){gameState.enemy3=Object.create(gameState.enemy);const t=gameState.enemy3;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(510,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),g(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),L(t)}));const n=gameState.debuffCardPlayed?1800:1300;await e.delay(n),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200))),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?m():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),await e.delay(150),r()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,m()))}function g(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}function d(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:2}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:3}]:gameState.enemy2&&gameState.enemy2.alive?gameState.enemy3&&gameState.enemy3.alive?gameState.enemy1.actions=[{key:"Intends to\nDeal 8 fire damage",damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 fire damage",probability:.05+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.3+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.2+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.14},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.07+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.07}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:.7,summonEnemy:3},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.3}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:.7,summonEnemy:2},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.3}],gameState.enemy2&&(gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.5}]),gameState.enemy3&&(gameState.enemy3.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.5}])}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),K(),gameState.characters.forEach((e=>X(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&y(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{h(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,y(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,x,S,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),f(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&X(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{X(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?c():S()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),K(),X(gameState.actionText,200),X(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>X(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&X(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?S():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{X(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],h(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),f(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())}))}function u(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function h(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function x(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>L(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),N()),gameState.lustForLifeCounter>=5&&$(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&H(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Y(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function k(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function C(e){gameState.foreverTrue=!1,T(e),Y(8)}function b(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,G(gameState.player)}function P(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,L(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(r),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function M(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),p())}))}function E(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),p()}))}function D(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,L(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,y(3),T(e)}function $(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{X(e,200)}))),T(e)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function F(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,T(e)}function z(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),T(e)}function H(e){T(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),T(e)}function U(e){gameState.zaibatsuUnderground=!1,T(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),L(e)}function L(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(y(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{X(e,500)}))}}function N(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(f(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function K(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),X(e.sprite,200)}}function Y(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function X(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function V(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),K(),G(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,X(e.intentionText,200),X(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),m()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Y(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight3 extends BaseScene{self;constructor(){super("Level3Fight3")}preload(){this.load.image("bakgrunnLair3","assets/images/bakgrunnLair3.jpg"),this.load.image("wraith1","assets/images/sprites/wraith1.png"),this.load.image("wraith2","assets/images/sprites/wraith2.png"),this.load.image("voidling","assets/images/sprites/voidling.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),_(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),N(gameState.player),c(),L(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{q(r,200),q(n,200)}))}(),gameState.enemy1&&gameState.enemy1.alive&&(gameState.enemy1.armor=12,W(gameState.enemy1));const o=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>q(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let r="Soulripper start each\nturn with 12 Armor,\nand lose 1 Armor\nper damage recieved";const o=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,r),e.time.delayedCall(4500,(()=>{q(o,200),q(s,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),n(t),gameState.enemies.forEach((e=>{d(),p(e),V(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{d(),p(e),V(e)})),n(t))}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnLair3"),this.resetPlayer(gameState.player,.41,350,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{q(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{q(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Soulripper",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(770,305,"wraith2").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy1.health=120,gameState.enemy1.healthMax=120,gameState.enemy1.armor=12,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),K()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),T(a),k(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),x(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],n(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{q(gameState.startText,500)})),async function(){let n="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>q(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];n=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,n,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;q(d,i),q(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{q(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();async function n(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),i=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(i),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,i),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(n))})),r===t-1&&(o(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function o(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&x(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;i(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),T(t),k(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":b(t);break;case"rebelSpirit":B(t);break;case"rebelHeart":v(t);break;case"bushido":P(t);break;case"toxicAvenger":w(t);break;case"kirisuteGomen":M(t);case"toxicFrets":E(t);break;case"ashenEncore":D(t);break;case"edoEruption":I(t);break;case"steelToe":A(t);break;case"deadTokugawas":O(t);break;case"gundanSeizai":$(t);break;case"LustForLife":R(t);break;case"PunksNotDead":F(t);break;case"soulSquatter":z(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":H(t);break;case"enduringSpirit":j(t);break;case"shogunsShell":U(t);break;case"zaiUnderground":G(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),q(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:m,healPlayed:g,strengthPlayed:p,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:x}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:l(e.damage),firePlayed:g?3:o?10:l(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?2:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));n&&(gameState.player.lifeStealCounter+=o*k*n),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=m,a.health-=T,a.armor>0&&T>0&&(a.armor=Math.max(0,a.armor-T))),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=p:gameState.player.strengthCard+=p,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),q(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),X(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];q(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&f(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&f(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,m,p,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),W(a),e.updateHealthBar(a),L(gameState.player),N(a),c(),d(),X(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{q(e,200)}))}))}function l(e){return"function"==typeof e?e():e}function m(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{q(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),_(t),gameState.toxicAvenger&&t.poison>0&&W(t);let n=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{q(t.poisonText),q(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),W(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),"doubleDiscard"===a.debuffCard?(a.debuffCard="discard",g(t,a),a.debuffCard="doubleDiscard",e.time.delayedCall(2200,(()=>{e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,""),e.time.delayedCall(400,(()=>{a.debuffCard="discard",g(t,a)}))}))):a.debuffCard?g(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(570,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),N(t),W(t)}));const n="doubleDiscard"===a.debuffCard?4500:gameState.debuffCardPlayed?1800:1300;await e.delay(n),gameState.actionText&&q(gameState.actionText,200);gameState.actionTextBackground&&q(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>q(e,200))),t.turnComplete=!0,c()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?m():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),await e.delay(150),r()))}(t,a)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,m()))}function g(t,a){return new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey;const s="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,i="draw"===a.debuffCard?"Draw pile":"Discard Pile",l="draw"===a.debuffCard?120:980;e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const m=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];s.push(...m);const g=[e.add.image(450,450,o).setScale(.45).setOrigin(.5).setDepth(300),e.add.image(650,450,o).setScale(.45).setOrigin(.5).setDepth(300)];let d=`Adds 2 ${{ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"}[o]} to your ${i}`;gameState.actionText.y=250,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(2300,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:l,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===g.length&&r()}})}))}))}))}function d(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"doubleDiscard",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:2}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:1}]:gameState.enemy2&&gameState.enemy2.alive?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.45+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/3},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/3},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:1,armor:0,text:"Heals 10 HP\nGains 1 strenght",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.1},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:2,armor:0,text:"Heals 10 HP\nGains 2 strenght",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.05+(gameState.enemy1.health>=gameState.enemy1.healthMax?.1:0)/3},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.15},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"doubleDiscard",probability:.05}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:.4,summonEnemy:2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.3+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4}],gameState.enemy2&&(gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.5}])}function p(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function c(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),Y(),gameState.characters.forEach((e=>q(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&f(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&q(gameState.actionText,200);gameState.actionTextBackground&&q(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>q(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have cleared Level ${s}\nHealth is resorted to ${gameState.player.healthMax}/${gameState.player.healthMax}`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{y(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,f(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),f=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,f,c,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),x(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),x(s),k.forEach((e=>{e&&e.destroy()})),S(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),x(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&q(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{q(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{q(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?S():u()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),Y(),q(gameState.actionText,200),q(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>q(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function S(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&q(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{q(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?u():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{q(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],y(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),x(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),S(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function u(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,h())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,h())}))}function h(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function y(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function x(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function k(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,L(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>W(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,L(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?M(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),K()),gameState.lustForLifeCounter>=5&&R(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&j(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,L(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,L(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),X(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function T(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function C(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function b(e){gameState.foreverTrue=!1,C(e),X(8)}function B(t){gameState.rebelSpirit=!1,C(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function v(t){gameState.rebelHeart=!1,C(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function P(e){gameState.bushido=!1,C(e),gameState.player.strengthBase+=6,L(gameState.player)}function w(e){gameState.toxicAvenger=!1,C(e),gameState.enemies.forEach((e=>{e.poison+=4,W(e)}))}function M(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),N(r),c(),L(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function E(t){gameState.toxicFrets=!1,C(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),N(t),c())}))}function D(t){gameState.ashenEncore=!1,C(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),N(t),c()}))}function I(e){gameState.edoEruption=!1,C(e)}function A(t){gameState.steelToe=!1,C(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,W(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function O(e){gameState.redrawPrice+=1,C(e)}function $(e){gameState.gundanSeizai=!1,f(3),C(e)}function R(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{q(e,200)}))),C(e)}function F(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),C(t)}function z(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,C(e)}function H(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),C(e)}function j(e){C(e)}function U(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,L(gameState.player),C(e)}function G(e){gameState.zaibatsuUnderground=!1,C(e)}function L(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),W(e)}function W(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function N(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void F(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(f(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{q(e,500)}))}}function K(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(x(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function Y(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),q(e.sprite,200)}}function X(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),N(t),c(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function V(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(27);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(26)}function q(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function _(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),Y(),L(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,q(e.intentionText,200),q(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),m()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(X(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,N(e),c(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level4Fight1 extends BaseScene{self;constructor(){super("Level4Fight1")}preload(){this.load.image("bakgrunnFortress1","assets/images/bakgrunnFortress1.jpg"),this.load.image("theFortress","assets/images/theFortress.jpg"),this.load.image("monster1","assets/images/sprites/monster1.png"),this.load.image("monster2","assets/images/sprites/monster2.png"),this.load.image("monstrosity","assets/images/cards/monstrosity.jpg")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnFortress1"),this.resetPlayer(gameState.player,.31,360,375),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{te(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{te(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Mong\nSteals Strength and Armor",gameState.enemy1.sprite=this.add.sprite(600,365,"monster1").setScale(.23).setFlipX(!1).setInteractive(),gameState.enemy1.cardKey="monstrosity",gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Goh\nSteals Strength and Armor",gameState.enemy2.sprite=this.add.sprite(780,370,"monster2").setScale(.35).setFlipX(!1).setInteractive(),gameState.enemy2.cardKey="monstrosity",gameState.enemy2.health=80,gameState.enemy2.healthMax=80,gameState.enemy2.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#d1d1d1"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),Z()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),w(a),P(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theFortress").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 4:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Fortress",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),v(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),r=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,r,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{te(gameState.startText,500)})),async function(){let t="",a="";const r=400,n=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>te(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),r=gameState.taunts.splice(e,1)[0];t=r.enemy,a=r.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*r),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;te(d,n),te(p,n),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{te(e,n)})),gameState.skipIntro||(await e.delay(n),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),ae(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),_(gameState.player),x(),V(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{te(r,200),te(n,200)}))}();const n=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>te(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let r="Heads up: Monsters steal\nStrength and Armor!";const n=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{te(n,200),te(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),g(t),gameState.enemies.forEach((e=>{y(),f(e),ee(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{y(),f(e),ee(e)})),g(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,te(a,2e3),te(r,2e3),te(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,te(a,2e3),te(r,2e3),te(n,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,te(a,2e3),te(r,2e3),te(n,2e3),e.time.delayedCall(2200,s()))}));async function g(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),o=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(o),n.usedOneShot&&n.sprite.setTint(8421504);const s=gameState.slots[a+r];s&&(n.startHeight=s.y,n.angle=s.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:s.x,y:s.y,scaleX:.35,scaleY:.35,angle:s.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{s.available=!1,n.slot=s}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,o),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),p(n))})),r===t-1&&(d(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function d(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function p(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&v(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),c(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;c(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),w(t),P(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":E(t);break;case"rebelSpirit":D(t);break;case"rebelHeart":I(t);break;case"bushido":A(t);break;case"toxicAvenger":O(t);break;case"kirisuteGomen":$(t);case"toxicFrets":R(t);break;case"ashenEncore":F(t);break;case"edoEruption":z(t);break;case"steelToe":H(t);break;case"deadTokugawas":j(t);break;case"gundanSeizai":U(t);break;case"LustForLife":G(t);break;case"PunksNotDead":L(t);break;case"soulSquatter":W(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":N(t);break;case"enduringSpirit":K(t);break;case"shogunsShell":Y(t);break;case"zaiUnderground":X(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):"debuff"===gameState.typePlayed?(t.reUseable&&gameState.discardPile.push(t),c(t,gameState.player)):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),c(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function c(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),te(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:h,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=r>0?2*(1+r):2,c=i?1:0;return{damagePlayed:n?11:S(e.damage),firePlayed:m?3:o?10:S(e.fire),stancePointsPlayed:m&&a?-1:m&&!a?0:S(e.stancePoints),poisonPlayed:s?t.poison:S(e.poison)+c,healPlayed:S(e.heal),strengthPlayed:S(e.strength),armorPlayed:d?2:S(e.armor),reduceTargetArmorPlayed:g?p:S(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:S(e.reduceTargetStrength),drawCardPlayed:S(e.drawCard),poisonRemovePlayed:S(e.poisonRemove)}}(t,a,r),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));n&&(gameState.player.lifeStealCounter+=o*k*n),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),te(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Q(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&u();"nenguStyle"===a.key&&gameState.currentCards.length>0&&B(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&B(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(T,l,g,d,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),q(a),e.updateHealthBar(a),V(gameState.player),_(a),x(),y(),Q(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const C=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{C.forEach((e=>{te(e,200)}))}))}function S(e){return"function"==typeof e?e():e}function u(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];te(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&"monstrosity"!=card.key&&gameState.discardPile.push(t)}function h(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{te(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),ae(t),gameState.toxicAvenger&&t.poison>0&&q(t);let r=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{te(t.poisonText),te(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),q(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),(a.reduceTargetArmor||a.reduceTargetStrength)&&(gameState.player.armorBase=Math.max(-15,gameState.player.armorBase-a.reduceTargetArmor),gameState.player.strengthBase=Math.max(-15,gameState.player.strengthBase-a.reduceTargetStrength),V(gameState.player)),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted",monstrosity:"Monstrosity"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:-1,armor:-2,reduceTargetArmor:0,reduceTargetStrength:0,reUseable:!0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:o,type:"debuff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:-1,armor:-2,reduceTargetArmor:0,reduceTargetStrength:0,reUseable:!0,drawCard:()=>gameState.player.stancePoints>0?1:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(630,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),_(t),q(t)}));let r=gameState.debuffCardPlayed?1500:1200;await e.delay(r),gameState.actionText&&te(gameState.actionText,200);gameState.actionTextBackground&&te(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>te(e,200))),t.turnComplete=!0,x()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?h():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),r=gameState.debuffCardPlayed?500:150,await e.delay(r),m()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,h()))}function y(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:2,reduceTargetArmor:0,text:"Steals 2 Strength",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):5===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strength",probability:1}]):6===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):7===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):8===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:.33+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 16 damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 10 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 20 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.04},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strenght",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Steals 1 Armor",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:" Deals 14 damage",probability:.33+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:" Heals 10 HP\nSteals 1 Armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"  Heals 20 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.04},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strenght",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Steals 1 Armor",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5}])}function f(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function x(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),J(),gameState.characters.forEach((e=>te(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&B(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&te(gameState.actionText,200);gameState.actionTextBackground&&te(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>te(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{b(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,B(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),u=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*r,"rectangularButton"),y=e.add.text(t,a+3*r,"Exit Shop",m);let f=[];const x=[g,h,p,S],T=[d,y,c,u];let C=[...x,...T,gameState.shopBackground];x.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),T.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),C.push(gameState.shopWelcomeText,gameState.shopTextBackground);const b="3"===e.scene.key.slice(-1),{level:B,fight:P}=e.extractLevelFightFromName(e.scene.key);b&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${B}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,x.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),v(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{x.forEach((e=>e.setInteractive()))})),f.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();f.push(a,r),C.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(f=f.filter((e=>e!=a&&e!=r)),C=C.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,x.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),v(s),f.forEach((e=>{e&&e.destroy()})),k(210),e.time.delayedCall(200,(()=>{x.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,x.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),v(i),f.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&te(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{te(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{x.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,x.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{te(e,200)})),e.time.delayedCall(250,(()=>{C.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?k():T()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),J(),te(gameState.actionText,200),te(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>te(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function k(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&te(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{te(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?T():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{te(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],b(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),v(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),k(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function T(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,C())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,C())}))}function C(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function b(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function B(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function v(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function P(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,V(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>q(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,V(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?$(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),Z()),gameState.lustForLifeCounter>=5&&G(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?L(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?W(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?N(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&K(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?K(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?Y(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?X(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,V(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,V(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Q(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function w(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function M(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function E(e){gameState.foreverTrue=!1,M(e),Q(8)}function D(t){gameState.rebelSpirit=!1,M(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function I(t){gameState.rebelHeart=!1,M(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function A(e){gameState.bushido=!1,M(e),gameState.player.strengthBase+=6,V(gameState.player)}function O(e){gameState.toxicAvenger=!1,M(e),gameState.enemies.forEach((e=>{e.poison+=4,q(e)}))}function $(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),_(r),x(),V(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function R(t){gameState.toxicFrets=!1,M(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),_(t),x())}))}function F(t){gameState.ashenEncore=!1,M(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),_(t),x()}))}function z(e){gameState.edoEruption=!1,M(e)}function H(t){gameState.steelToe=!1,M(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,q(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function j(e){gameState.redrawPrice+=1,M(e)}function U(e){gameState.gundanSeizai=!1,B(3),M(e)}function G(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{te(e,200)}))),M(e)}function L(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),M(t)}function W(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,M(e)}function N(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),M(e)}function K(e){M(e)}function Y(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,V(gameState.player),M(e)}function X(e){gameState.zaibatsuUnderground=!1,M(e)}function V(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),q(e)}function q(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function _(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void L(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(B(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{te(e,500)}))}}function Z(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(v(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function J(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),te(e.sprite,200)}}function Q(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),_(t),x(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){p(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function ee(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function te(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function ae(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),J(),V(gameState.player),y(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,te(e.intentionText,200),te(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),h()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Q(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,_(e),x(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level4Fight2 extends BaseScene{self;constructor(){super("Level4Fight2")}preload(){this.load.image("bakgrunnFortress2","assets/images/bakgrunnFortress2.jpg"),this.load.image("monster3","assets/images/sprites/monster3.png"),this.load.image("monster4","assets/images/sprites/monster4.png"),this.load.image("sorcerer1","assets/images/sprites/sorcerer1.png"),this.load.image("monstrosity","assets/images/cards/monstrosity.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),V(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{X(r,200),X(n,200)}))}();const o=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>X(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{d(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),n(t)}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnFortress2"),this.resetPlayer(gameState.player,.4,310,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Gloomhoof\nSteals Strength and Armor",gameState.enemy1.sprite=this.add.sprite(580,345,"monster3").setScale(.4).setFlipX(!1).setInteractive(),gameState.enemy1.cardKey="monstrosity",gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Darktuft\nSteals Strength and Armor",gameState.enemy2.sprite=this.add.sprite(800,340,"monster4").setScale(.44).setFlipX(!0).setInteractive(),gameState.enemy2.cardKey="monstrosity",gameState.enemy2.health=55,gameState.enemy2.healthMax=55,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Ampward\nMaster of healing and buffing",gameState.enemy3.sprite=this.add.sprite(990,360,"sorcerer1").setScale(.4).setFlipX(!1).setInteractive(),gameState.enemy3.cardKey="monstrosity",gameState.enemy3.health=50,gameState.enemy3.healthMax=50,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#d1d1d1"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),N()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),k(a),x(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),f(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],n(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{X(gameState.startText,500)})),async function(){let n="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>X(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];n=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,n,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;X(d,i),X(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{X(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();async function n(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),i=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(i),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,i),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(n))})),r===t-1&&(o(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function o(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&f(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;i(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),k(t),x(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":C(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":P(t);break;case"kirisuteGomen":w(t);case"toxicFrets":M(t);break;case"ashenEncore":E(t);break;case"edoEruption":D(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":$(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":F(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":z(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":j(t);break;case"zaiUnderground":U(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):"debuff"===gameState.typePlayed?(t.reUseable&&gameState.discardPile.push(t),i(t,gameState.player)):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),X(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:g,healPlayed:c,strengthPlayed:S,armorPlayed:u,reduceTargetArmorPlayed:h,reduceTargetStrengthPlayed:f,drawCardPlayed:x,poisonRemovePlayed:k}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:l(e.damage),firePlayed:g?3:o?10:l(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?2:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,r),T=(1+.1*gameState.player.strength)*(1-a.armor/20),C=Math.round(Math.max(0,s+o*T));n&&(gameState.player.lifeStealCounter+=o*T*n),a!=gameState.player&&(gameState.score.damageDealt+=C,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=f,a.armor-=h,a.poison+=g,a.health-=C),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=S:gameState.player.strengthCard+=S,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),X(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Y(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&m();"nenguStyle"===a.key&&gameState.currentCards.length>0&&y(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&y(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),c&&(gameState.player.health=Math.min(gameState.player.health+c,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=u,gameState.player.poison=Math.max(0,gameState.player.poison-k),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(C,g,S,u,k),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),L(a),e.updateHealthBar(a),G(gameState.player),W(a),p(),d(),Y(x),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const b=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{b.forEach((e=>{X(e,200)}))}))}function l(e){return"function"==typeof e?e():e}function m(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];X(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&"monstrosity"!=card.key&&gameState.discardPile.push(t)}function g(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{X(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),V(t),gameState.toxicAvenger&&t.poison>0&&L(t);let n=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{X(t.poisonText),X(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t===gameState.enemy3?gameState.enemies.forEach((t=>{t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),t.armor=Math.min(t.armor+a.armor,t.armorMax),L(t),e.updateHealthBar(t)})):(t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),t.armor=Math.min(t.armor+a.armor,t.armorMax),L(t)),(a.reduceTargetArmor||a.reduceTargetStrength)&&(gameState.player.armorBase=Math.max(-15,gameState.player.armorBase-a.reduceTargetArmor),gameState.player.strengthBase=Math.max(-15,gameState.player.strengthBase-a.reduceTargetStrength),G(gameState.player)),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted",monstrosity:"Monstrosity"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:-1,armor:-2,reduceTargetArmor:0,reduceTargetStrength:0,reUseable:!0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:o,type:"debuff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:-1,armor:-2,reduceTargetArmor:0,reduceTargetStrength:0,reUseable:!0,drawCard:()=>gameState.player.stancePoints>0?1:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(630,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),L(t)}));let n=gameState.debuffCardPlayed?1500:1200;await e.delay(n),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200))),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?g():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),n=gameState.debuffCardPlayed?500:150,await e.delay(n),r()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,g()))}function d(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:2,reduceTargetArmor:0,text:"Steals 2 Strength",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):5===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strength",probability:1}]):6===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):7===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):8===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:.33+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 16 damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 10 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 20 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.04},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strenght",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Steals 1 Armor",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:" Deals 14 damage",probability:.33+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:" Heals 10 HP\nSteals 1 Armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"  Heals 20 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.04},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strenght",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Steals 1 Armor",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5}]),gameState.enemy1.alive||gameState.enemy2.alive?1===gameState.turn?gameState.enemy3.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]:gameState.turn%2==1?gameState.enemy3.actions=[{key:"Intends to\nHeal his team",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"All enemies heal 10 HP",probability:1}]:gameState.enemy3.actions=[{key:()=>"Intends to\nBuff his team",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:2,text:"All enemies Gain 1 strength and 2 armor",probability:1}]:gameState.enemy3.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:.5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 16 damage",probability:.5}]}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),K(),gameState.characters.forEach((e=>X(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&y(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{h(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,y(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,x,S,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),f(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&X(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{X(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?c():S()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),K(),X(gameState.actionText,200),X(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>X(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&X(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?S():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{X(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],h(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),f(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())}))}function u(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function h(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function x(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>L(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),N()),gameState.lustForLifeCounter>=5&&$(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&H(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Y(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function k(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function C(e){gameState.foreverTrue=!1,T(e),Y(8)}function b(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,G(gameState.player)}function P(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,L(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(r),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function M(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),p())}))}function E(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),p()}))}function D(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,L(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,y(3),T(e)}function $(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{X(e,200)}))),T(e)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function F(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,T(e)}function z(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),T(e)}function H(e){T(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),T(e)}function U(e){gameState.zaibatsuUnderground=!1,T(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),L(e)}function L(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(y(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{X(e,500)}))}}function N(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(f(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function K(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),X(e.sprite,200)}}function Y(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function X(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function V(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),K(),G(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,X(e.intentionText,200),X(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),g()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Y(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level4Fight3 extends BaseScene{self;constructor(){super("Level4Fight3")}preload(){this.load.image("bakgrunnFortress3","assets/images/bakgrunnFortress3.jpg"),this.load.image("monster5","assets/images/sprites/monster5.png"),this.load.image("monster2","assets/images/sprites/monster2.png"),this.load.image("sorcerer2","assets/images/sprites/sorcerer2.png"),this.load.image("monstrosity","assets/images/cards/monstrosity.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,r,n){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<r.length?(i+=r.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,n),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),V(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.chemicalWarfare&&function(){gameState.enemies.forEach((e=>{e.poison+=gameState.chemicalWarfare}));const t=`Enemies get +${gameState.chemicalWarfare} Poison`,a={fontSize:"30px",fill:"#ff0000"},r=e.add.text(540,450,"",a).setOrigin(.5),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,20,.7),e.time.delayedCall(1500,(()=>{X(r,200),X(n,200)}))}();const o=gameState.player.poisonText._text?2500:1500;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>X(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{d(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),n(t)}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnFortress3"),this.resetPlayer(gameState.player,.33,300,370),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length,a=t>32?10:t>24?8:t>12?6:4,r=105,n=t>32?78:t>24?183:t>12?287:393,o=150,s=e.add.text(550,o-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),i=e.add.graphics();e.updateTextAndBackground(s,i,"Draw Pile",7,200,.95),gameState.cardImages.push(s,i),gameState.drawPile.forEach(((t,s)=>{let i=n+s%a*r,l=o+1.5*Math.floor(s/a)*r,m=e.add.image(i,l,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length,a=t>24?8:t>12?6:4,r=t>24?183:t>12?287:393,n=e.add.text(550,40,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,"Discard Pile",7,200,.8),gameState.cardImages.push(n,o),gameState.discardPile.length>0&&gameState.discardPile.forEach(((t,n)=>{let o=r+n%a*105,s=150+1.5*Math.floor(n/a)*105,i=e.add.image(o,s,t.key).setScale(.27).setDepth(200);gameState.cardImages.push(i)}))})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{X(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Goh Resurrected\nSteals Strength and Armor",gameState.enemy1.cardKey="monstrosity",gameState.enemy1.sprite=this.add.sprite(580,370,"monster2").setScale(.31).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Terrorsnout\nSteals Strength and Armor",gameState.enemy2.cardKey="monstrosity",gameState.enemy2.sprite=this.add.sprite(750,370,"monster5").setScale(.48).setFlipX(!1).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemy1.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Necronis\nMaster of fire and buffs",gameState.enemy3.cardKey="monstrosity",gameState.enemy3.sprite=this.add.sprite(920,340,"sorcerer2").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy3.health=80,gameState.enemy3.healthMax=80,gameState.enemy1.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#d1d1d1"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.lustForLifeCounter&&(e.addHealButton(),N()),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key||"chemicalWarfare"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),k(a),x(a))})),function(){gameState.turn=0,gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying&&gameConfig.musicTheme.stop();e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){gameState.redrawEnabled=!1,gameState.healButtonEnabled=!1,gameState.endOfTurnButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameState.endOfTurnButton.setTexture("rectangularButtonPressed"),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),f(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],n(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.musicTheme&&gameConfig.musicTheme.isPlaying||gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{X(gameState.startText,500)})),async function(){let n="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>X(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];n=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,n,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;X(d,i),X(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{X(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();async function n(t){const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++){if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const n=gameState.drawPile.pop(),i=10+r+a;n.sprite=e.add.image(120,600,n.key).setScale(0).setInteractive(),n.isBeingPlayed=!1,gameState.currentCards.push(n),n.sprite.setDepth(i),n.usedOneShot&&n.sprite.setTint(8421504);const l=gameState.slots[a+r];l&&(n.startHeight=l.y,n.angle=l.angle,await e.delay(120+7*r),e.tweens.add({targets:n.sprite,x:l.x,y:l.y,scaleX:.35,scaleY:.35,angle:l.angle,duration:120+7*r,ease:"Circ.easeInOut",onComplete:()=>{l.available=!1,n.slot=l}})),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(n,i),n.sprite.on("pointerup",(function(){gameState.playersTurn&&(console.log("card sprite clicked"),gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(n))})),r===t-1&&(o(120,7,t),gameState.playersTurn=!0,console.log(`gameState.playersTurn: ${gameState.playersTurn}`))}}async function o(t,a,r){const n=2*(t+a*r);await e.delay(n),gameState.redrawEnabled=!0,gameState.healButtonEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive(),gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&f(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;i(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key||"chemicalWarfare"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),k(t),x(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":C(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":P(t);break;case"kirisuteGomen":w(t);case"toxicFrets":M(t);break;case"ashenEncore":E(t);break;case"edoEruption":D(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":$(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":F(t);break;case"bouncingSoles":case"bouncingSoles2":case"bouncingSoles3":z(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":j(t);break;case"zaiUnderground":U(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":case"chemicalWarfare":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):"debuff"===gameState.typePlayed?(t.reUseable&&gameState.discardPile.push(t),i(t,gameState.player)):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,r=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),X(t.sprite,200),gameState.actionTextObjects.forEach((e=>e.destroy()));const n=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:g,healPlayed:c,strengthPlayed:S,armorPlayed:u,reduceTargetArmorPlayed:h,reduceTargetStrengthPlayed:f,drawCardPlayed:x,poisonRemovePlayed:k}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:l(e.damage),firePlayed:g?3:o?10:l(e.fire),stancePointsPlayed:g&&a?-1:g&&!a?0:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?2:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,r),T=(1+.1*gameState.player.strength)*(1-a.armor/20),C=Math.round(Math.max(0,s+o*T));n&&(gameState.player.lifeStealCounter+=o*T*n),a!=gameState.player&&(gameState.score.damageDealt+=C,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=f,a.armor-=h,a.poison+=g,a.health-=C),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=S:gameState.player.strengthCard+=S,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),X(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),Y(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&m();"nenguStyle"===a.key&&gameState.currentCards.length>0&&y(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&y(1);"pissDrunkBastards"===a.key&&t.health<18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),c&&(gameState.player.health=Math.min(gameState.player.health+c,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=u,gameState.player.poison=Math.max(0,gameState.player.poison-k),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};let i=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),l=e.add.graphics();if(gameState.actionTextObjects.push(i,l),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(i,l,o),e.attackTweens(gameState.player,60)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(i,l,t),e.powerUpTweens(gameState.player)}}(C,g,S,u,k),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),L(a),e.updateHealthBar(a),G(gameState.player),W(a),p(),d(),Y(x),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1}));const b=[...gameState.actionTextObjects];e.time.delayedCall(1500,(()=>{b.forEach((e=>{X(e,200)}))}))}function l(e){return"function"==typeof e?e():e}function m(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];X(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&"monstrosity"!=card.key&&gameState.discardPile.push(t)}function g(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),r=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=r,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,r){const a=`You stole ${r} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),n.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1500,(()=>{n.forEach((e=>{X(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),V(t),gameState.toxicAvenger&&t.poison>0&&L(t);let n=""!==t.poisonText._text||t.turnText?1500:500;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{X(t.poisonText),X(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t===gameState.enemy3?gameState.enemies.forEach((t=>{t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),t.armor=Math.min(t.armor+a.armor,t.armorMax),L(t),e.updateHealthBar(t)})):(t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),t.armor=Math.min(t.armor+a.armor,t.armorMax),L(t)),(a.reduceTargetArmor||a.reduceTargetStrength)&&(gameState.player.armorBase=Math.max(-15,gameState.player.armorBase-a.reduceTargetArmor),gameState.player.strengthBase=Math.max(-15,gameState.player.strengthBase-a.reduceTargetStrength),G(gameState.player)),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted",monstrosity:"Monstrosity"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:-1,armor:-2,reduceTargetArmor:0,reduceTargetStrength:0,reUseable:!0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:o,type:"debuff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:-1,armor:-2,reduceTargetArmor:0,reduceTargetStrength:0,reUseable:!0,drawCard:()=>gameState.player.stancePoints>0?1:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(630,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,async function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),L(t)}));let n=gameState.debuffCardPlayed?1500:1200;await e.delay(n),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200))),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?g():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),n=gameState.debuffCardPlayed?500:150,await e.delay(n),r()))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,g()))}function d(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:2,reduceTargetArmor:0,text:"Steals 2 Strength",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):5===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strength",probability:1}]):6===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):7===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):8===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:1}]):(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 12 damage",probability:.33+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 16 damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 10 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 20 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.04},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strenght",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Steals 1 Armor",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:" Deals 14 damage",probability:.33+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:" Heals 10 HP\nSteals 1 Armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"  Heals 20 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.04},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Steals 1 Strenght",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Steals 1 Armor",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5}]),1===gameState.turn?gameState.enemy3.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]:2===gameState.turn?gameState.enemy3.actions=[{key:"Intends to\nBuff team",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:3,text:"Team gains 2 Strength and 3 Armor",probability:1}]:gameState.enemy3.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.5},{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:.2},{key:"Intends to\nBuff Team",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:3,text:"Team gains 1 Strength and 2 armor",probability:.3}]}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),K(),gameState.characters.forEach((e=>X(e.sprite,200))),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e))),"riotRonin"===e.key&&(e.goldCost=0)}));const t=gameState.gundanSeizai?1:0,a=gameState.zaibatsuUnderground?Math.min(3,Math.floor(.1*gameState.player.gold)):0,r=t+a;e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),r&&y(r),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&X(gameState.actionText,200);gameState.actionTextBackground&&X(gameState.actionTextBackground,200);gameState.actionTextObjects.forEach((e=>X(e,200)));const n={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let o=e.add.text(550,300,"Victory!",n).setOrigin(.5).setDepth(21);const{level:s,fight:i}=e.extractLevelFightFromName(e.scene.key),l=3===i?3e3:100,m=3===i?`You have completed Level ${s}\nLevel 5 is comming in the next patch :)`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),o.setText(m),o.setStyle({fontSize:"60px"}),e.time.delayedCall(l,(()=>{o.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton");const m=gameState.deck.length<gameConfig.maxDeckSize?"Collect free card\n  and continue":"Maximum deck size\n    continue";gameState.rewardAddCardsText=e.add.text(550,r+2*n,m,t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{h(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,y(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,u],C=[d,x,S,h];let b=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const r=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let n=0;n<t.length;n++)e.time.delayedCall(n*r,(()=>{a+=t.charAt(n),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),b.push(gameState.shopWelcomeText,gameState.shopTextBackground);const B="3"===e.scene.key.slice(-1),{level:v,fight:P}=e.extractLevelFightFromName(e.scene.key);B&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${v}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!B&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),f(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),b.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),b=b.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed&&gameState.deck.length<gameConfig.maxDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameConfig.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),f(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&X(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{X(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)})),e.time.delayedCall(250,(()=>{b.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,gameState.deck.length<gameConfig.maxDeckSize?c():S()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),K(),X(gameState.actionText,200),X(gameState.actionTextBackground,200),gameState.actionTextObjects.forEach((e=>X(e,200))),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&X(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{X(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?S():(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{X(r.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],h(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),f(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,u())}))}function u(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function h(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function x(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>L(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key)gameState.lustForLifeCounter+=1,gameState.fightStarted&&(e.addHealButton(),N()),gameState.lustForLifeCounter>=5&&$(t),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key||"bouncingSoles2"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,e.updateHealthBar(gameState.player),gameState.enduringSpiritCounter+=1,gameState.enduringSpiritCounter>=7&&H(t)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("zaiUnderground"===t.key)gameState.zaibatsuUnderground=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),Y(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("chemicalWarfare"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.chemicalWarfare+=2,a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.chemicalWarfare-=2}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function k(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function C(e){gameState.foreverTrue=!1,T(e),Y(8)}function b(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,G(gameState.player)}function P(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,L(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(r),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function M(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),p())}))}function E(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),p()}))}function D(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,L(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,y(3),T(e)}function $(e){gameState.lustForLifeCounter<5&&(gameState.lustForLifeCounter=0,gameState.healButtonObjects.forEach((e=>{X(e,200)}))),T(e)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function F(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,T(e)}function z(e){gameState.bonusPermanentSlots.length&&gameState.permanentSlots.push(gameState.bonusPermanentSlots.shift()),gameState.bouncingSolesCards.lenght&&gameState.extraCards.push(gameState.bouncingSolesCards.shift()),T(e)}function H(e){T(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),T(e)}function U(e){gameState.zaibatsuUnderground=!1,T(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),L(e)}function L(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(y(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{X(e,500)}))}}function N(){gameState.healButton.on("pointerup",(()=>{gameState.player.gold>=1&&gameState.playersTurn&&gameState.player.health<gameState.player.healthMax&&(f(1),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+7),e.updateHealthBar(gameState.player))}))}function K(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),X(e.sprite,200)}}function Y(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function X(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function V(t){if(t.poison>0){const a=Math.max(1,t.health-t.poison),r=`-${t.health-a} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,r,7,20,.7),t.health=a,e.updateHealthBar(t),t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed"),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.healButtonEnabled=!1,gameState.redrawEnabled=!1,gameState.lustForLifeCounter&&gameState.healButton.setTexture("rectangularButtonPressed"),gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),K(),G(gameState.player),d(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,X(e.intentionText,200),X(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionTextObjects.forEach((e=>e.destroy())),g()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(Y(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}function updateLeaderboard(e,t){fetch(`https://www.dreamlo.com/lb/CBGhFikNak2i8KjH3UPThAfGJFnWo9A0O8mjvU19hS2Q/add/${e}/${t}`).then((e=>e.text())).then((e=>console.log(e))).catch((e=>{console.error("Error:",e)}))}class Endscene extends Phaser.Scene{constructor(){super("Endscene")}async getTopScores(){try{const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");if(!e.ok)throw new Error("Failed to fetch leaderboard data");let t=(await e.json()).dreamlo.leaderboard.entry;return t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}catch(e){return console.error(e),null}}preload(){this.load.image("endscene","assets/images/endscene.jpg")}create(){self=this;this.cameras.main.fadeIn(800,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,320,"endscene").setScale(.95).setOrigin(.5,.5).on("pointerup",(()=>r())),this.add.text(550,110,"    Thanks for playing\nPunk Rock Samurai Beta v1.3",{fontSize:"57px",fill:"#a9a9a9",fontFamily:"Rock Kapak"}).setOrigin(.5,.5),gameState.score.totalScore=gameState.score.levelsCompleted>0?gameState.score.levelsCompleted*(15+Math.max(0,7-gameState.score.numberOfTurns/gameState.score.levelsCompleted)):0;let e={numberOfTurns:"Number of turns played",levelsCompleted:"Number of fights won",damageTaken:"Total damage taken",damageDealt:"Total damage dealt",totalScore:"Your score"},t=250,a=200;function r(){console.log("returnto meny called"),gameState.name="",gameState.playerName="",self.cameras.main.shake(1500,.0015,!1),self.cameras.main.flash(500),self.time.delayedCall(500,(()=>{self.cameras.main.fadeOut(1e3),gameState.restartGame=!0,gameConfig.levels.forEach((e=>self.scene.stop(e))),self.scene.stop("Preload"),self.scene.stop("Mainmenu"),self.scene.start("Preload")}))}"admin"!=gameState.playerName&&"Cheater"!=gameState.playerName&&updateLeaderboard(gameState.playerName,gameState.score.totalScore);let n=!1;self.time.delayedCall(600,(()=>{!async function(){try{console.log("displayLeaderBoard called");let r=await self.getTopScores();const n=self.add.graphics();n.fillStyle(16777215,1).setAlpha(.7),n.fillRect(t,a,600,420),self.add.text(300,a+50,"Your Results",{fontSize:"25px",fill:"#000000"}).setOrigin(0),Object.entries(gameState.score).forEach((([t,r])=>{if(console.log(`${t}: ${r}`),e[t]){let n=`${e[t]}: ${r}`;self.add.text(300,a+90,n,{color:"#000",fontSize:"16px"}),a+=20}}));const o={fontSize:"16px",fill:"#000000"};self.add.text(300,a+150,"Leaderboard",{fontSize:"25px",fill:"#000000"}).setOrigin(0),r?r.forEach(((e,t)=>{let r=e.date.split(" ")[0];const n=`${t+1}. Name: ${e.name}, Score: ${e.score}, Date: ${r}`;let s=self.add.text(300,a+190,n,o).setOrigin(0);sceneState.displayedScoreArray.push(s),a+=20})):self.add.text(300,a+190,"Leaderboard is down for maintenance",o).setOrigin(0)}catch(e){console.error("Error in displayLeaderBoard: ",e);const t={fontSize:"16px",fill:"#FF0000"};self.add.text(300,a+190,"Leaderboard is down for maintenance",t).setOrigin(0)}}()})),self.time.delayedCall(8e3,(()=>{n||(n=!0,r())})),self.input.on("pointerup",(()=>{n||(n=!0,r())}))}}const config={type:Phaser.AUTO,width:1100,height:680,scene:[BaseScene,Preload,Mainmenu,Level1Fight1,Level1Fight2,Level1Fight3,Level2Fight1,Level2Fight2,Level2Fight3,Level3Fight1,Level3Fight2,Level3Fight3,Level4Fight1,Level4Fight2,Level4Fight3,Endscene],scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},dom:{createContainer:!0}},game=new Phaser.Game(config);