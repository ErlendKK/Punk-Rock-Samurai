let gameState={version:1.304},gameConfig={levels:["Level1Fight1","Level1Fight2","Level1Fight3","Level2Fight1","Level2Fight2","Level2Fight3","Level3Fight1","Level3Fight2","Level3Fight3","Endscene"]};class Preload extends Phaser.Scene{constructor(){super("Preload")}preload(){WebFont.load({custom:{families:["Rock Kapak"]},active:()=>{this.fontLoaded=!0}});const e=this.cameras.main.width,t=this.cameras.main.height,a=e/2,n=t/2,r=this.add.graphics(),o=this.add.graphics();r.fillStyle(2236962,.8),r.fillRect(e/2-160,270,320,50);const s=this.add.text(a,n-50,"Loading...",{font:"20px monospace",fill:"#ffffff"}).setOrigin(.5,.5),i=this.add.text(a,n-5,"0%",{font:"18px monospace",fill:"#ffffff"}).setOrigin(.5,.5);this.load.on("progress",(function(t){i.setText(parseInt(100*t)+"%"),o.clear(),o.fillStyle(16777215,1),o.fillRect(e/2-150,280,300*t,30)})),this.load.on("complete",(function(){o.destroy(),r.destroy(),s.destroy(),i.destroy()})),gameState.restartGame||(this.load.image("knuckleFist","assets/images/cards/knuckleFist.jpg"),this.load.image("kabutu","assets/images/cards/kabutu.jpg"),this.load.image("combatBoots","assets/images/cards/combatBoots.jpg"),this.load.image("tantoBlade","assets/images/cards/tantoBlade.jpg"),this.load.image("circlePit","assets/images/cards/circlePit.jpg"),this.load.image("seppuku","assets/images/cards/seppuku.jpg"),this.load.image("katana","assets/images/cards/katana.jpg"),this.load.image("rocknRonin","assets/images/cards/rocknRonin.jpg"),this.load.image("powerChord","assets/images/cards/powerChord.jpg"),this.load.image("rawEnergy","assets/images/cards/rawEnergy.jpg"),this.load.image("pyromania","assets/images/cards/pyromania.jpg"),this.load.image("stageInvasion","assets/images/cards/stageInvasion.jpg"),this.load.image("studdedLeather","assets/images/cards/studdedLeather.jpg"),this.load.image("boneShredder","assets/images/cards/boneShredder.jpg"),this.load.image("blackFumes","assets/images/cards/blackFumes.jpg"),this.load.image("masakari","assets/images/cards/masakari.jpg"),this.load.image("discontent","assets/images/cards/discontent.jpg"),this.load.image("dogsOfWar","assets/images/cards/dogsOfWar.jpg"),this.load.image("roninsRot","assets/images/cards/roninsRot.jpg"),this.load.image("libertySpikes","assets/images/cards/libertySpikes.jpg"),this.load.image("moshpitMassacre","assets/images/cards/moshpitMassacre.jpg"),this.load.image("bladesBlight","assets/images/cards/bladesBlight.jpg"),this.load.image("scorchedSoul","assets/images/cards/scorchedSoul.jpg"),this.load.image("risingWakizashi","assets/images/cards/risingWakizashi.jpg"),this.load.image("deadCities","assets/images/cards/deadCities.jpg"),this.load.image("nastyNihonto","assets/images/cards/nastyNihonto.jpg"),this.load.image("crowdSurfer","assets/images/cards/crowdSurfer.jpg"),this.load.image("shogunShred","assets/images/cards/shogunShred.jpg"),this.load.image("rocknRejuvinate","assets/images/cards/rocknRejuvinate.jpg"),this.load.image("detox","assets/images/cards/detox.jpg"),this.load.image("laidoSoho","assets/images/cards/laidoSoho.jpg"),this.load.image("dBeat","assets/images/cards/dBeat.jpg"),this.load.image("shikoroStrike","assets/images/cards/shikoroStrike.jpg"),this.load.image("rottenResonance","assets/images/cards/rottenResonance.jpg"),this.load.image("troopsOfTakamori","assets/images/cards/troopsOfTakamori.jpg"),this.load.image("bassSolo","assets/images/cards/bassSolo.jpg"),this.load.image("zenZine","assets/images/cards/zenZine.jpg"),this.load.image("kabutuOverdrive","assets/images/cards/kabutuOverdrive.jpg"),this.load.image("nenguStyle","assets/images/cards/nenguStyle.jpg"),this.load.image("canibalize","assets/images/cards/canibalize.jpg"),this.load.image("bloodOath","assets/images/cards/bloodOath.jpg"),this.load.image("roninMerc","assets/images/cards/roninMerc.jpg"),this.load.image("pyroPunk","assets/images/cards/pyroPunk.jpg"),this.load.image("pissDrunkBastards","assets/images/cards/pissDrunkBastards.jpg"),this.load.image("gutterGeisha","assets/images/cards/gutterGeisha.jpg"),this.load.image("noFuture","assets/images/cards/noFuture.jpg"),this.load.image("coverCharge","assets/images/cards/coverCharge.jpg"),this.load.image("wrathOfMoen","assets/images/cards/wrathOfMoen.jpg"),this.load.image("saisenBlaster","assets/images/cards/saisenBlaster.jpg"),this.load.image("riotRonin","assets/images/cards/riotRonin.jpg"),this.load.image("soulSquatter","assets/images/cards/soulSquatter.jpg"),this.load.image("soulSquatterToken","assets/images/cards/soulSquatterToken.png"),this.load.image("punksNotDead","assets/images/cards/punksNotDead.jpg"),this.load.image("punksNotDeadToken","assets/images/cards/punksNotDeadToken.png"),this.load.image("lustForLifeToken","assets/images/cards/lustForLifeToken.png"),this.load.image("lustForLife","assets/images/cards/lustForLife.jpg"),this.load.image("gundanSeizaiToken","assets/images/cards/gundanSeizaiToken.png"),this.load.image("gundanSeizai","assets/images/cards/gundanSeizai.jpg"),this.load.image("deadTokugawasToken","assets/images/cards/deadTokugawasToken.png"),this.load.image("deadTokugawas","assets/images/cards/deadTokugawas.jpg"),this.load.image("toxicFrets","assets/images/cards/toxicFrets.jpg"),this.load.image("toxicFretsToken","assets/images/cards/toxicFretsToken.png"),this.load.image("ashenEncore","assets/images/cards/ashenEncore.jpg"),this.load.image("ashenEncoreToken","assets/images/cards/ashenEncoreToken.png"),this.load.image("edoEruption","assets/images/cards/edoEruption.jpg"),this.load.image("edoEruptionToken","assets/images/cards/edoEruptionToken.png"),this.load.image("steelToe","assets/images/cards/steelToe.jpg"),this.load.image("steelToeToken","assets/images/cards/steelToeToken.png"),this.load.image("foreverTrueToken","assets/images/cards/foreverTrueToken.png"),this.load.image("foreverTrue","assets/images/cards/foreverTrue.jpg"),this.load.image("rebelSpiritToken","assets/images/cards/rebelSpiritToken.png"),this.load.image("rebelSpirit","assets/images/cards/rebelSpirit.jpg"),this.load.image("rebelHeartToken","assets/images/cards/rebelHeartToken.png"),this.load.image("rebelHeart","assets/images/cards/rebelHeart.jpg"),this.load.image("bushidoToken","assets/images/cards/bushidoToken.png"),this.load.image("bushido","assets/images/cards/bushido.jpg"),this.load.image("toxicAvengerToken","assets/images/cards/toxicAvengerToken.png"),this.load.image("toxicAvenger","assets/images/cards/toxicAvenger.jpg"),this.load.image("kirisuteGomenToken","assets/images/cards/kirisuteGomenToken.png"),this.load.image("kirisuteGomen","assets/images/cards/kirisuteGomen.jpg"),this.load.image("hollidayInKamakuraToken","assets/images/cards/hollidayInKamakuraToken.png"),this.load.image("hollidayInKamakura","assets/images/cards/hollidayInKamakura.jpg"),this.load.image("kamishimoUberAllesToken","assets/images/cards/kamishimoUberAllesToken.png"),this.load.image("kamishimoUberAlles","assets/images/cards/kamishimoUberAlles.jpg"),this.load.image("bouncingSolesToken","assets/images/cards/bouncingSolesToken.png"),this.load.image("bouncingSoles","assets/images/cards/bouncingSoles.jpg"),this.load.image("enduringSpiritToken","assets/images/cards/enduringSpiritToken.png"),this.load.image("enduringSpirit","assets/images/cards/enduringSpirit.jpg"),this.load.image("shogunsShellToken","assets/images/cards/shogunsShellToken.png"),this.load.image("shogunsShell","assets/images/cards/shogunsShell.jpg"),this.load.image("bgLoadingScreen","assets/images/bgLoadingScreen.jpg"),this.load.audio("titleTheme","assets/sounds/music/TitleTheme.mp3"),this.load.audio("thundersound","assets/sounds/thundersound.mp3"),this.load.image("shop1","assets/images/shop1.jpg"),this.load.audio("bossTune","assets/sounds/music/DecisiveBattle.mp3"),this.load.audio("attackSound","assets/sounds/attacksound.wav"),this.load.audio("powerUpSound","assets/sounds/powerupsound.wav"),this.load.audio("healSound","assets/sounds/healsound.wav"),this.load.audio("victorySound","assets/sounds/victorysound.mp3"),this.load.audio("keyboardSound","assets/sounds/keyboardsound.mp3"),this.load.audio("coinSound","assets/sounds/coinsound.mp3"),this.load.image("goldCard","assets/images/goldCard.jpg"),this.load.image("goldCoin","assets/images/goldCoin.png"))}create(){self=this,this.input.keyboard.createCursorKeys(),gameState.score={numberOfTurns:0,levelsCompleted:0,damageTaken:0,damageDealt:0,totaleScore:0},gameState.player={healthBarColor:"0x00ff00",alive:!0,stance:"Neutral",stancePoints:0,gold:0,goldMax:99,poison:0,numCards:5,numCardsBase:5,numCardsStance:0,health:100,healthMax:100,mana:3,manaMax:3,manaBase:3,manaStance:0,manaCard:0,strength:0,strengthMax:15,strengthBase:0,strengthStance:0,strengthCard:0,armor:0,armorMax:15,armorBase:0,armorStance:0,armorCard:0,lifeStealBase:0,lifeStealThisTurn:0},gameState.enemy={name:"Name",sprite:"",healthBarColor:"0xff0000",alive:!0,actions:[],health:40,healthMax:40,strength:0,strengthBase:0,strengthTurn:0,strengthMax:15,armor:0,armorMax:15,poison:0},gameState.deck=[{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"combatBoots",type:"targetAll",cost:2,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?1+gameState.player.stancePoints:1,reduceTargetStrength:0,drawCard:0},{key:"tantoBlade",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?12-2*gameState.player.stancePoints:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"discontent",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints>0?-2:gameState.player.stancePoints<0?2:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shogunsShell",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"shogunsShellToken"}],gameState.bonusCards=[{key:"kamishimoUberAlles",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kamishimoUberAllesToken"},{key:"hollidayInKamakura",type:"permanent",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"hollidayInKamakuraToken"},{key:"rebelSpirit",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelSpiritToken"},{key:"foreverTrue",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"foreverTrueToken"},{key:"toxicFrets",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicFretsToken"},{key:"ashenEncore",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"ashenEncoreToken"},{key:"edoEruption",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"edoEruptionToken"},{key:"deadTokugawas",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"deadTokugawasToken"},{key:"punksNotDead",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"punksNotDeadToken"},{key:"toxicAvenger",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicAvengerToken"},{key:"bushido",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"bushidoToken"},{key:"bouncingSoles",type:"permanent",cost:3,goldCost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"bouncingSolesToken"},{key:"enduringSpirit",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"enduringSpiritToken"},{key:"shogunsShell",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"shogunsShellToken"},{key:"studdedLeather",type:"buff",cost:1,stancePoints:2,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rocknRonin",type:"buff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:()=>gameState.player.strength,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rawEnergy",type:"buff",cost:()=>gameState.player.stancePoints>0?-2:-1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"powerChord",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints<=0?1:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?3:0},{key:"crowdSurfer",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:()=>gameState.player.stancePoints<0?2*gameState.player.stancePoints:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?gameState.player.stancePoints:0},{key:"rocknRejuvinate",type:"buff",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:10,poisonRemove:()=>gameState.player.stancePoints>0?3:0,strength:0,armor:()=>gameState.player.stancePoints<0?3:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"detox",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:4,strength:0,armor:4,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"dBeat",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shogunShred",type:"buff",cost:0,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bloodOath",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"kabutuOverdrive",type:"buff",cost:1,stancePoints:-3,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:15,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"nenguStyle",type:"buff",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"zenZine",type:"buff",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"gutterGeisha",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>Math.floor(.1*(gameState.player.healthMax-gameState.player.health)),reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"noFuture",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"coverCharge",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"seppuku",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:-5,poisonRemove:0,strength:()=>gameState.player.stancePoints<0?1-gameState.player.stancePoints:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"canibalize",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"saisenBlaster",type:"buff",cost:1,goldCost:1,stancePoints:1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:10,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"bassSolo",type:"targetAll",cost:1,stancePoints:0,damage:6,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rottenResonance",type:"targetAll",cost:1,stancePoints:0,damage:0,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pissDrunkBastards",type:"targetAll",cost:2,stancePoints:1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"stageInvasion",type:"targetAll",cost:2,stancePoints:0,damage:()=>4*(gameState.currentCards.length+1),fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"circlePit",type:"targetAll",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:()=>5*gameState.costPlayed,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"moshpitMassacre",type:"targetAll",cost:2,stancePoints:0,damage:8,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"blackFumes",type:()=>gameState.player.stancePoints>=0?"targetAll":"targetSelected",cost:2,stancePoints:0,damage:0,fire:0,poison:()=>gameState.player.stancePoints>0?3:gameState.player.stancePoints<0?5:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"deadCities",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"boneShredder",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:1,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"masakari",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?9*(1-gameState.player.stancePoints*gameState.player.strength/10):9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyromania",type:"targetSelected",cost:2,stancePoints:0,damage:0,fire:16,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninsRot",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"dogsOfWar",type:"targetSelected",cost:1,stancePoints:1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"libertySpikes",type:"targetSelected",cost:1,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>gameState.player.stancePoints<0?2:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bladesBlight",type:"targetSelected",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"scorchedSoul",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"katana",type:"targetSelected",cost:3,stancePoints:0,damage:()=>gameState.player.stancePoints<0?13*(1-gameState.player.stancePoints*gameState.player.strength/10):13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"risingWakizashi",type:"targetSelected",cost:1,stancePoints:-1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"nastyNihonto",type:"targetSelected",cost:2,stancePoints:0,damage:10,fire:0,poison:()=>gameState.player.stancePoints>0?2*gameState.player.stancePoints:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shikoroStrike",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.stancePoints<0?8:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?3:0,reduceTargetStrength:0,drawCard:0},{key:"laidoSoho",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.armor>0?gameState.player.armor:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninMerc",type:"targetSelected",cost:0,goldCost:1,stancePoints:0,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyroPunk",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:()=>Math.round(.2*(gameState.player.healthMax-gameState.player.health)),poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"troopsOfTakamori",type:"targetSelected",cost:1,stancePoints:0,damage:6,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"wrathOfMoen",type:"targetSelected",cost:2,stancePoints:0,damage:22,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"riotRonin",type:"targetSelected",cost:2,goldCost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}],gameState.extraCards=[{key:"kirisuteGomen",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kirisuteGomenToken"},{key:"rebelHeart",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelHeartToken"},{key:"steelToe",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"steelToeToken"},{key:"gundanSeizai",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"gundanSeizaiToken"},{key:"lustForLife",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"lustForLifeToken"},{key:"soulSquatter",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"soulSquatterToken"}],gameState.minDeckSize=8,gameState.latestDraw=[],gameState.taunts=[{key:1,enemy:"A punk rock samurai?\nWhat's next?\nA disco knight?",player:"What's next, is me\nusing your bones\nas my drumsticks!"},{key:3,enemy:"A Samurai punk rocker?\nIs this some kind of joke?",player:"The only joke here\nwill be your attempt\nat survival!"},{key:5,enemy:"Got lost on your way\nto a cosplay,\nSamurai boy?",player:"The only thing lost today\nwill be your head\nfrom your shoulders!"},{key:6,enemy:"You look like a kid who\nfound his granddad's armor.",player:"And you'll look like\nyour granddad's corpse\nwhen I'm done with you!"},{key:8,enemy:"Nice samurai outfit, kid!\nWhen does the\ncostume party begin?",player:"The only party you'll\nbe attending today\nis your own funeral!"},{key:9,enemy:"A Samurai punk rocker?\nHow's that midlife crisis going?",player:"The only crisis happening\ntoday is for the janitor\nwho has to clean up\nwhat's left of you."},{key:12,enemy:"Samurai and punk rocker?\nSchizophrenia's a bitch, huh?",player:"The only bitch here\nis the one whose about to\nbe begging me for mercy!"},{key:13,enemy:"What's with the big sword?\nCompensating for something?",player:"The only things small here\nare your chances of survival!"},{key:14,enemy:"Nice costume, boy.\nDo you do birthdays\nand bar mitzvahs too?",player:"Just funerals.\nYours is next\non the list."}],gameState.ratTaunts=[{key:11,enemy:"Hsss..\nYouâ€™ll make a fine\nmeal for my pups!",player:"Tell them not to wait up.\nDaddy's not comming home tonight!"},{key:11,enemy:"Hsss..\nYou come here to fight\nor to display your\nHalloween costume?",player:"The only thing on\ndisplay today\nwill be your entrails!"}],gameState.extraTaunts=[{key:4,enemy:"You really believe\nyou're a samurai, huh?",player:"You believe in ghosts?\nBecause you're\nabout to become one!"},{key:11,enemy:"A Samurai in the\n21st century?\nAre you on drugs?",player:"The only thing I'm\non is the path\nto your annihilation!"},{key:12,enemy:"Childish music\nand childish fantasies.\nGrow up!",player:"I'll make sure you\nnever grow old."},{key:13,enemy:"Must be hard, living\na deluded fantasy.",player:"Not as hard as what's\ncoming for you."},{key:10,enemy:"Punk and Samurai?\nTwo failures in one!",player:"I'll silence that laughter\nwith the sound of\nyour gurgling blood!"},{key:2,enemy:"Chasing fantasies while\nthe world laughs at you?",player:"I'll silence that laughter\nwith the sound of\nyour gurgling blood!"},{key:11,enemy:"You're a relic in a world that's moved on.",player:"You won't be moving much soon.!"},{key:11,enemy:"You take this Samurai gig\nseriously, huh?",player:"Serious as the grave\nI'm about to dig for you!"},{key:11,enemy:"Is that sword real,\nor are you just cosplaying hard?",player:"It's as real as the blood\nit will draw from your corpse!"},{key:11,enemy:"Hey, Samurai punk,\nthe circus called,\nthey want their clown back",player:"Sorry, I'm booked up\nmopping your entrails\noff the floor"},{key:7,enemy:"Still holding onto\npunk's corpse, I see",player:"The only corpse here\nwill be the one\nI leave behind!"},{key:10,enemy:"Your delusions of grandeur\nare quite entertaining.",player:"The only entertainment tonight\nwill be your cries of agony!"}],gameState.restartGame&&self.scene.start("Mainmenu");let e=this.add.image(550,480,"bgLoadingScreen").setScale(1.4).setInteractive();this.add.text(550,170,"Punk Rock Samurai",{fontSize:"100px",fill:"#000000",fontFamily:"Rock Kapak"}).setOrigin(.5),this.add.text(550,500,"Click to start",{fontSize:"45px",fill:"#ff0000",fontWeight:"bold"}).setOrigin(.5);let t=!1;function a(){gameConfig.thunder.play({volume:.9,seek:.25}),self.cameras.main.shake(200,.002,!1),self.cameras.main.flash(100),self.time.delayedCall(100,(()=>{self.cameras.main.fadeOut(100)}),[],this),self.time.delayedCall(200,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),self.time.delayedCall(100,(()=>{self.scene.start("Mainmenu"),console.log("Mainmenu called")}))}),[],this)}gameConfig.thunder=this.sound.add("thundersound"),gameConfig.musicTheme=this.sound.add("titleTheme"),e.on("pointerup",(()=>{t||(t=!0,a())})),this.input.keyboard.on("keydown",(()=>{t||(t=!0,a())}))}}class BaseScene extends Phaser.Scene{create(){this.scene.start("Preload")}baseCreate(e,t=.75){this.add.image(0,0,e).setScale(t).setOrigin(.02,0),this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),gameConfig.targetingCursor=this.add.image(0,0,"targetingCursor").setDepth(200).setVisible(!1),gameState.endGameMenyExited=!1,gameState.playingCard=!1,gameState.discardPile=[],gameState.drawPile=[],gameState.currentCards=[],gameState.cardImages=[],gameState.summonedEnemies=[],gameState.redrawPrice=1,gameState.skipIntro=!1,gameState.fightStarted=!1,gameState.kamishimoUberAlles=0,gameState.shogunsShellCondition=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameConfig.cardsDealtSound=this.sound.add("cardsDealtSound"),gameConfig.victorySound=this.sound.add("victorySound"),gameConfig.buttonPressedSound=this.sound.add("buttonPressedSound"),gameConfig.attackSound=this.sound.add("attackSound"),gameConfig.powerUpSound=this.sound.add("powerUpSound"),gameConfig.healSound=this.sound.add("healSound"),gameConfig.thunder=this.sound.add("thundersound"),gameConfig.music=this.sound.add("bossTune"),gameConfig.coinSound=this.sound.add("coinSound"),gameConfig.keyboardSound=this.sound.add("keyboardSound"),gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop())}resetPlayer(e,t,a=360,n=350){e.sprite=this.add.image(a,n,"player").setScale(t).setFlipX(!1).setInteractive(),e.stance="Neutral",e.poison=0,e.stancePoints=0,e.numCards=5,e.numCardsBase=5,e.numCardsStance=0,e.manaBase=3,e.manaStance=0,e.manaCard=0,e.mana=3,e.strengthMax=3,e.strength=0,e.strengthBase=0,e.strengthStance=0,e.strengthCard=0,e.strengthMax=15,e.armor=0,e.armorMax=15,e.armorBase=0,e.armorStance=0,e.armorCard=0,e.lifeStealBase=0,e.lifeStealThisTurn=0,e.lifeStealCounter=0}saveGameState(e){try{const t={player:{health:gameState.player.health,healthMax:gameState.player.healthMax,mana:gameState.player.mana,manaMax:gameState.player.manaMax,gold:gameState.player.gold,goldMax:gameState.player.goldMax,name:gameState.player.name,alive:gameState.player.alive},deck:gameState.deck,bonusCards:gameState.bonusCards,score:gameState.score,bonusCards:gameState.bonusCards,extraCards:gameState.extraCards,minDeckSize:gameState.minDeckSize,latestDraw:gameState.latestDraw,taunts:gameState.taunts,ratTaunts:gameState.ratTaunts,extraTaunts:gameState.extraTaunts,permanents:gameState.permanents,enemy:gameState.enemy,playerName:gameState.playerName,version:gameState.version,savedScene:e,loadedGame:!0},a=JSON.stringify(t);localStorage.setItem("gameState",a),console.log("Game state saved successfully.")}catch(e){console.error("Failed to save the game state.",e)}}definePermanentSlots(){gameState.permanentSlots=[{available:!0,x:50,y:50,index:0},{available:!0,x:125,y:50,index:1},{available:!0,x:200,y:50,index:2},{available:!0,x:275,y:50,index:3}]}addHealthBar(e,t){const a=e.x,n=e.y,r=e.height;e.healthBarBackground=this.add.graphics(),e.healthBarBackground.fillStyle(16777215,.5),e.healthBarBackground.fillRect(a-40,n-r/2-30,100,10),e.healthBarBackground.setDepth(12),e.healthBarFrame=this.add.graphics(),e.healthBarFrame.lineStyle(3,0,1),e.healthBarFrame.strokeRect(a-40,n-r/2-30,100,10),e.healthBarFrame.setDepth(13),e.healthBar=this.add.graphics(),e.healthBar.fillStyle(t,1),e.healthBar.fillRect(a-40,n-r/2-30,e.health/e.healthMax*100,10),e.healthBar.setDepth(14),e.healthBarText=this.add.text(a-18,n-r/2-25,`${e.health}/${e.healthMax}`,{fontSize:"11px",fill:"#000000"}),e.healthBarText.setOrigin(.5).setDepth(15)}addManaBar(e){const t=e.x,a=e.y,n=e.height;e.manaBarBackground=this.add.graphics(),e.manaBarBackground.lineStyle(3,0,1),e.manaBarBackground.strokeRect(t-40,a-n/2-45,100,10),e.manaBarFrame=this.add.graphics(),e.manaBarFrame.lineStyle(3,0,1),e.manaBarFrame.strokeRect(e.x-40,e.y-n/2-45,100,10),e.manaBar=this.add.graphics(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(t-40,a-n/2-45,e.mana/e.manaMax*100,10),e.manaBarText=this.add.text(t-27,a-n/2-40,`${e.mana}/${e.manaMax}`,{fontSize:"11px",fill:"#000000"}).setOrigin(.5)}addStatsDisplay(e,t=420){const a={fontSize:"11px",fill:"#FFFFFF"},n=e.sprite.x;e.strengthAndArmorImage=this.add.image(n-20,t,"strengthAndArmor").setScale(.4).setInteractive().setDepth(20),e.armorText=this.add.text(n+13,t,`${e.armor}/${e.armorMax}`,a).setDepth(25),e.strengthText=this.add.text(n-40,t,`${e.strength}/${e.strengthMax}`,a).setDepth(25)}addGoldCoin(){const e=this.add.image(1040,50,"goldCoin").setScale(.1).setDepth(220).setOrigin(.5).setInteractive();gameState.goldCounter=this.add.text(1040,50,gameState.player.gold,{fontSize:"60px",fill:"#000000"}).setDepth(221).setOrigin(.5);let t="";e.on("pointerover",(()=>{gameState.goldCard=this.add.image(550,300,"goldCard").setScale(.55).setDepth(220),this.input.keyboard.on("keydown",(function(e){t+=e.key,"showmethemoney"===t&&(console.log("showmethemoney"),gameState.player.gold=99,gameState.player.goldMax=99,gameState.goldCounter.setText(gameState.player.gold),"admin"!==gameState.playerName&&(gameState.playerName="Cheater"),"admin"!==gameState.player.name&&(gameState.player.name="Cheater"),t=""),t.length>30&&(t=t.substring(t.length-30))}))})),e.on("pointerout",(()=>{gameState.goldCard.destroy(),t="",this.input.keyboard.removeAllListeners("keydown")}))}describeCharacter(e){gameConfig.targetingCursor.visible||!0!==e.alive||e.sprite.on("pointerover",(()=>{const t=e.armor<0?"more":"less",a=e.strength<0?"less":"more",n=`${e.name}\n\n${e.armor} armor: Take ${Math.round(Math.abs(e.armor/20*100))} %\n${t} physical damage\n\nMax armor: Take 75 %\nless physical damage \n\n${e.strength} Strength: Deal ${10*Math.abs(e.strength)} %\n${a} physical damage\n\nMax strength: Deal 150 %\nmore physical damage\n\nPoison: ${e.poison}\nPoison change per turn: ${e.poison>0?-1:0}`,r=e.sprite.x-e.width/2;e.descriptionBackground=this.add.graphics({x:r-200,y:210}),e.descriptionBackground.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(30),e.descriptionBackground.fillRoundedRect(0,0,215,250,10);e.descriptionText=this.add.text(r+10,335,n,{fontSize:"12px",fill:"#000000"}).setDepth(35).setOrigin(1,.5)})),e.sprite.on("pointerout",(function(){e.descriptionBackground&&e.descriptionBackground.destroy(),e.descriptionText&&e.descriptionText.destroy()}))}addStanceBar(e,t){e.stancePoints=0;let a=this.cameras.main.width/2;gameState.stanceBarHeight=20,gameState.stanceBarMargin=60,gameState.stanceBarStartX=a-220,gameState.stanceBarBackground=this.add.graphics(),gameState.stanceBarBackground.lineStyle(3,0,1),gameState.stanceBarBackground.strokeRect(gameState.stanceBarStartX,gameState.stanceBarMargin,440,gameState.stanceBarHeight).setDepth(20);for(let e=1;e<6;e++)gameState.stanceBarBackground.moveTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin),gameState.stanceBarBackground.lineTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin+20),gameState.stanceBarBackground.strokePath();gameState.stanceBar=this.add.graphics(),gameState.stanceBar.fillStyle(65280,1);let n={fontSize:"28px",fill:t};gameState.stanceText=this.add.text(550,gameState.stanceBarMargin-25,`Stance: ${gameState.player.stance}`,n).setOrigin(.5).setInteractive(),gameState.stanceText.on("pointerover",(()=>{gameState.stanceDescriptionText=this.add.text(550,gameState.stanceBarBackground.y+105,"Stance represents the ever-shifting balance\nbetween the conflicting ideals of the\npunk rock samurai: Discipline and Freedom.\n\nPositive Discipline during your turn:\n+3 Strength\n\nPositive Discipline at the end of your turn:\n+3 Armor\n\nMax Discipline at the end of your turn:\n-1 card next turn\n\nPositive Freedom during your turn:\n+1 mana\n\nPositive Freedom at the end of your turn:\n50% chance of +1 card next turn\n50% chance of +1 mana next turn\n\nMax Freedom at the end of your turn:\n-2 Armor",{fontSize:"14px",fill:"#000000"}).setDepth(25).setOrigin(.5,0);const e=gameState.stanceDescriptionText.getBounds(),t=e.width+10,a=e.height+10,n=e.x-5,r=e.y-5;gameState.stanceTextBackground=this.add.graphics(),gameState.stanceTextBackground.fillStyle(16777215,1).setAlpha(.9).setDepth(24),gameState.stanceTextBackground.fillRoundedRect(n,r,t,a,7)})),gameState.stanceText.on("pointerout",(()=>{gameState.stanceTextBackground.destroy(),gameState.stanceDescriptionText.destroy()}))}extractLevelFightFromName(e){const t=/Level(\d+)Fight(\d+)/.exec(e);return t?{level:parseInt(t[1],10),fight:parseInt(t[2],10)}:{level:null,fight:null}}powerUpTweens(e){this.tweens.add({targets:e.sprite,scaleY:1.125*e.sprite.scaleX,scaleX:1.125*e.sprite.scaleY,duration:120,ease:"Cubic",yoyo:!0},this)}attackTweens(e,t){if("undefined"==typeof attackTweenStarted||!attackTweenStarted){let a=!0;this.tweens.add({targets:e.sprite,x:e.x+t,duration:120,ease:"Cubic",yoyo:!0,onComplete:()=>a=!1},this)}}cardTweens(e,t,a){this.tweens.add({targets:e,scaleX:t,scaleY:t,duration:a,ease:"Cubic"},this)}animateCard(e,t){e.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.08}),this.tweens.add({targets:e.sprite,y:470,angle:0,scaleX:.46,scaleY:.46,duration:300,ease:"Cubic"}),e.sprite.setDepth(100)}),this),e.sprite.on("pointerout",(()=>{e.isBeingPlayed||(this.tweens.add({targets:e.sprite,y:e.startHeight,angle:e.angle,scaleX:.35,scaleY:.35,duration:300,ease:"Cubic"}),e.sprite.setDepth(t))}),this)}addEndOfTurnButton(e=500){gameState.endOfTurnButton=this.add.image(900,e,"rectangularButton").setScale(.45).setOrigin(.5),gameState.endOfTurnText=this.add.text(900,e,"End Turn",{fontSize:"18px",fill:"#000000"}).setOrigin(.5),gameState.endOfTurnButton.on("pointerover",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButtonHovered")})),gameState.endOfTurnButton.on("pointerout",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButton")}))}addRedrawButton(){const e=900;gameState.redrawButton=this.add.image(e,52,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.redrawText=this.add.text(e,52,"Redraw",{fontSize:"18px",fill:"#000000"}).setOrigin(.5),gameState.redrawButton.on("pointerover",(()=>{gameState.redrawButton.setTexture("rectangularButtonHovered"),gameState.redrawButtonDescriptionBackground=this.add.graphics(),gameState.redrawButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.redrawButtonDescriptionBackground.fillRoundedRect(835,82,130,40,5);const t=`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`;gameState.redrawButtonDescriptionText=this.add.text(e,102,t,{fontSize:"12px",fill:"#000000"}).setDepth(123).setOrigin(.5,.5)})),gameState.redrawButton.on("pointerout",(()=>{gameState.redrawButton.setTexture("rectangularButton"),gameState.redrawButtonDescriptionBackground&&gameState.redrawButtonDescriptionBackground.destroy(),gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.destroy()}))}clearBoard(){gameState.characters.forEach((e=>{e.sprite.destroy(),e.strengthAndArmorImage.destroy(),e.armorText.destroy(),e.strengthText.destroy(),e.strengthAndArmorImage.destroy(),e.healthBarBackground.destroy(),e.healthBarFrame.destroy(),e.healthBar.destroy(),e.healthBarText.destroy()}));[gameState.player.manaBarBackground,gameState.player.manaBarFrame,gameState.player.manaBar,gameState.player.manaBarText,gameState.endOfTurnButton,gameState.endOfTurnText,gameState.drawPileImage,gameState.discardPileImage,gameState.drawPileText,gameState.discardPileText,gameState.stanceBar,gameState.stanceText,gameState.stanceBarBackground,gameState.redrawButton,gameState.redrawText,gameState.healButton,gameState.healText,gameState.actionText].forEach((e=>{e&&e.destroy()})),console.log("board cleared")}shuffleDeck(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}updateEnemyIntention(e){let t="function"==typeof e.chosenAction.key?e.chosenAction.key():e.chosenAction.key;e.intentionText.setText(`${t}`)}updateHealthBar(e){e.health=Phaser.Math.Clamp(e.health,0,e.healthMax);e.healthBar.clear(),e.healthBar.fillStyle(e===gameState.player?65280:16711680,1),e.healthBar.fillRect(e.x-40,e.y-e.height/2-30,e.health/e.healthMax*100,10),e.healthBarText.setText(`${e.health}/${e.healthMax}`),e.healthBarText.setColor("#000000")}updateManaBar(e){e.mana=Phaser.Math.Clamp(e.mana,0,e.manaMax),e.manaBar.clear(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(e.x-40,e.y-e.height/2-45,e.mana/e.manaMax*100,10),e.manaBarText.setText(`${e.mana}/${e.manaMax}`)}updateStanceBar(e){const t=gameState.player.stancePoints;if(t>0){Math.random()>.5?(e.manaStance=1,e.numCardsStance=0):(e.manaStance=0,e.numCardsStance=1)}else e.manaStance=0;switch(t){case-3:e.armorStance=3,e.strengthStance=3,e.numCardsStance=-1,e.stance="Discipline";break;case-2:case-1:e.armorStance=3,e.strengthStance=3,e.numCardsStance=0,e.stance="Discipline";break;case 0:e.armorStance=0,e.strengthStance=0,e.numCardsStance=0,e.stance="Neutral";break;case 1:case 2:e.armorStance=0,e.strengthStance=0,e.stance="Freedom";break;case 3:e.armorStance=-2,e.strengthStance=0,e.stance="Freedom";break;default:return void console.error(`Unexpected value for points: ${t}`)}gameState.stanceBar.clear(),t<0?gameState.stanceBar.fillRect(gameState.stanceBarStartX+220+73.33*t,gameState.stanceBarMargin,73.33*Math.abs(t),gameState.stanceBarHeight):gameState.stanceBar.fillRect(gameState.stanceBarStartX+220,gameState.stanceBarMargin,73.33*t,gameState.stanceBarHeight),gameState.stanceText.setText(`Stance: ${e.stance}`)}updateTextAndBackground(e,t,a,n=7,r=20,o=.6){e.setText(a),e.setDepth(r+1);const s=e.getBounds(),i=s.width+10,l=s.height+10,m=s.x-5,g=s.y-5;t.clear(),t.fillStyle(16777215,1).setAlpha(o).setDepth(r),t.fillRoundedRect(m,g,i,l,n)}delay(e){return new Promise((t=>setTimeout(t,e)))}}const sceneState={};class Mainmenu extends Phaser.Scene{constructor(){super("Mainmenu")}async getTopScores(){const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");let t=(await e.json()).dreamlo.leaderboard.entry;return t.length>1&&t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}preload(){this.load.image("player","assets/images/sprites/punkrock.png"),this.load.image("deck","assets/images/cardback.jpg"),this.load.image("strengthAndArmor","assets/images/strengthAndArmor.png"),this.load.image("targetingCursor","assets/images/targetingCursor.png"),this.load.image("targetingCursorReady","assets/images/targetingCursorReady.png"),this.load.image("listbox1","assets/images/listbox1.png"),this.load.image("rectangularButton","assets/images/stoneButtonInsetReady.png"),this.load.image("rectangularButtonHovered","assets/images/stoneButtonInsetHovered.png"),this.load.image("rectangularButtonPressed","assets/images/stoneButtonInsetPressed.png"),this.load.image("rectangularFrame","assets/images/stoneButtonFrame.png"),this.load.audio("cardsDealtSound","assets/sounds/cardsdealt.wav"),this.load.audio("buttonPressedSound","assets/sounds/buttonpressed.wav")}create(){const e=this;this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,480,"bgLoadingScreen").setScale(1.4),this.add.text(15,5,`Punk Rock Samurai Beta v${gameState.version}`,{fontSize:"12px",fill:"#ff0000"});let t=!1;gameState.isEnteringName=!1,sceneState.name="",sceneState.cardsDealtSound=this.sound.add("cardsDealtSound"),sceneState.buttonPressedSound=this.sound.add("buttonPressedSound"),sceneState.newGameElements=[],sceneState.leaderboardElements=[],sceneState.creditsElements=[],sceneState.instructionsElements=[],sceneState.displayedScoreArray=[],sceneState.loadGameElements=[];const a={fontSize:"25px",fill:"#000000"},n={fontSize:"14px",fill:"#000000"},r={fontSize:"18px",fill:"#000000"},o=120,s=350,i=e.add.image(o,s,"rectangularButton"),l=e.add.text(o,s,"New Game",r).setOrigin(.5);sceneState.newGameButtonClicked=!1;const m=e.add.image(o,415,"rectangularButton"),g=localStorage.getItem("gameState")?"#000000":"#a9a9a9",d=e.add.text(o,415,"Load Game",{fontSize:"16px",fill:g}).setOrigin(.5);let p=!1;const c=e.add.image(o,480,"rectangularButton"),S=e.add.text(o,480,"Leaderboard",r).setOrigin(.5);let u=!1;const h=e.add.image(o,545,"rectangularButton"),y=e.add.text(o,545,"Credits",r).setOrigin(.5);let f=!1;const x=e.add.image(o,610,"rectangularButton"),k=e.add.text(o,610,"Instructions",r).setOrigin(.5);let T=!1;function C(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function B(t){t.on("pointerup",(()=>{if(!gameState.isEnteringName){gameState.isEnteringName=!0,console.log("isEnteringName has been activated"),"Enter your name..."===gameState.name&&(gameState.name=""),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.resume();try{C()&&gameState.hiddenInput.focus()}catch(e){console.error("Onscreen keyboard failed to open",e),gameState.isEnteringName=!1,v()}e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER).once("down",(function(){gameState.isEnteringName=!1,v()})),e.time.delayedCall(200,(()=>{e.input.off("pointerup"),e.input.once("pointerup",(()=>{if(gameState.isEnteringName){let t=0;gameState.name||(gameState.name="Enter your name...",t=100),e.time.delayedCall(t,(()=>{gameState.isEnteringName=!1,console.log("isEnteringName has been deactivated")})),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.pause();try{C()&&gameState.hiddenInput.blur()}catch(e){console.error("Onscreen keyboard failed to close",e),gameState.isEnteringName=!1,v()}}}))}))}}))}function v(){"Enter your name..."===gameState.name||""===gameState.name?gameState.playerName="Punk Rock Samurai":gameState.playerName=gameState.name,console.log(`Playername: ${gameState.playerName}`),D(),sceneState.menuElements.forEach((e=>{e.destroy()})),e.time.delayedCall(600,(()=>{!function(){const a=320,n=430,r=220;E(gameState.extraCards);const o=gameState.extraCards.slice(0,3),s={fontSize:"50px",fill:"#ff0000"},i=e.add.text(550,170,"Choose 1 Free Permanent",s).setOrigin(.5).setDepth(21),l=e.add.graphics();b(i,l,"Choose 1 Free Permanent"),o.forEach(((s,m)=>{s.sprite=e.add.sprite(a+m*r,n,s.key).setScale(.45).setInteractive(),console.log(`bonusCardsprite added for: ${s.key}`),s.sprite.on("pointerover",(function(){sceneState.cardsDealtSound.play({volume:.8,seek:.12}),w(s.sprite,.58,200)}),this),s.sprite.on("pointerout",(function(){w(s.sprite,.45,400)}),this),s.sprite.on("pointerup",(function(){sceneState.cardsDealtSound.play({volume:1.2,seek:.12}),s.freePermanent=!0,gameState.deck.push(s),gameState.extraCards.splice(gameState.extraCards.indexOf(s),1),E(gameState.extraCards),o.forEach((t=>{var a,n;t.sprite.removeInteractive(),t!==s&&(a=t.sprite,n=200,a&&e.tweens.add({targets:a,alpha:0,ease:"Power1",duration:n,onComplete:()=>{a.destroy()}}))})),e.tweens.add({targets:s.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),i.setText("Permanent Selected"),b(i,l,"Permanent Selected"),e.time.delayedCall(2500,(()=>{t||(t=!0,P())})),e.input.on("pointerup",(()=>{t||(t=!0,P())})),e.input.keyboard.on("keydown",(()=>{t||(t=!0,P())}))}))}))}()}))}function b(e,t,a,n=7){e.setText(a);const r=e.getBounds(),o=r.width+10,s=r.height+10,i=r.x-5,l=r.y-5;t.clear(),t.fillStyle(16777215,1).setAlpha(.4).setDepth(20),t.fillRoundedRect(i,l,o,s,n)}function P(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level1Fight1")}))}function w(t,a,n){e.tweens.add({targets:t,scaleX:a,scaleY:a,duration:n,ease:"Cubic"})}function M(e){e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))}function D(){[...sceneState.newGameElements,...sceneState.loadGameElements,...sceneState.leaderboardElements,...sceneState.creditsElements,...sceneState.instructionsElements,...sceneState.displayedScoreArray].forEach((e=>{e&&"function"==typeof e.destroy?e.destroy():console.log(`${e} not phaser object`)}))}function E(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}sceneState.buttons=[i,m,c,h,x],sceneState.textArray=[l,d,S,y,k],sceneState.menuElements=[...sceneState.buttons,...sceneState.textArray],sceneState.buttons.forEach((e=>{M(e),e.setScale(.8,.5).setInteractive().setOrigin(.5)})),C()&&(gameState.hiddenInput=document.createElement("input"),gameState.hiddenInput.style.position="absolute",gameState.hiddenInput.style.opacity="0",gameState.hiddenInput.style.zIndex="-1",document.body.appendChild(gameState.hiddenInput),gameState.hiddenInput.addEventListener("input",(function(e){gameState.name=e.target.value}))),i.on("pointerdown",(()=>{if(sceneState.newGameButtonClicked)sceneState.newGameButtonClicked=!1,D();else{sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!0,p=!1,u=!1,f=!1,T=!1,D(),gameState.name="Enter your name...";const e={fontSize:"23px",fill:"#000000"};sceneState.nameText=this.add.text(420,315,gameState.name,e).setDepth(21);const t={fontSize:"28px",fill:"#000000"};sceneState.startGameButton=this.add.image(550,400,"rectangularButton").setScale(1.2,.6).setInteractive(),sceneState.startGameText=this.add.text(470,387,"Let's go!",t),M(sceneState.startGameButton),sceneState.startGameButton.on("pointerdown",(()=>{gameState.isEnteringName=!1,v()}));const a={fontSize:"32px",fill:"#000000"};sceneState.formCursor=this.add.text(420,310,"|",a).setDepth(21).setAlpha(0),sceneState.cursorTween=this.tweens.add({targets:sceneState.formCursor,alpha:1,duration:300,hold:600,yoyo:!0,repeat:-1,paused:!0}),sceneState.formFrame=this.add.image(550,325,"rectangularFrame"),sceneState.formFrame.setScale(1.2,.6).setInteractive().setDepth(22),sceneState.nameForm=this.add.graphics({x:400,y:290}),sceneState.nameForm.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(20),sceneState.nameForm.fillRect(0,0,300,65),sceneState.nameForm.setInteractive(new Phaser.Geom.Rectangle(0,0,300,65),Phaser.Geom.Rectangle.Contains),sceneState.newGameElements=[sceneState.formCursor,sceneState.nameForm,sceneState.nameText,sceneState.formFrame,sceneState.startGameButton,sceneState.startGameText],B(sceneState.nameForm),B(sceneState.formFrame)}})),this.input.keyboard.on("keydown",(t=>{if(gameState.isEnteringName){const a=18;8===t.keyCode&&gameState.name.length>0?gameState.name=gameState.name.slice(0,-1):1===t.key.length&&t.key.match(/[a-zA-Z0-9\s\-_]/)&&gameState.name.length<a?gameState.name+=t.key:gameState.name.length===a&&e.cameras.main.shake(30,.001,!1)}})),m.on("pointerup",(function(){if(p)p=!1,D();else{sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!1,p=!0,u=!1,f=!1,T=!1,D();try{const t=localStorage.getItem("gameState");if(null===t){const t="No saved game state found.",a={fontSize:"40px",fill:"#000000"},n=e.add.text(620,350,t,a).setOrigin(.5).setDepth(21),r=n.getBounds(),o=r.width+10,s=r.height+10,i=r.x-10,l=r.y-5,m=e.add.graphics();m.fillStyle(16777215,1).setAlpha(.8).setDepth(20),m.fillRoundedRect(i,l,o,s,10),sceneState.loadGameElements.push(n,m),console.log(t),e.cameras.main.shake(70,.002,!1)}else{const a=JSON.parse(t);if(a.version!==gameState.version){if(!confirm(`The game has been updated since this save was made (saved version: ${a.version}, current version: ${gameState.version}). Loading this file might cause issues. Do you still want to load?`))return}gameState=a,console.log("Game state loaded successfully."),e.scene.start(gameState.savedScene)}}catch(e){console.error("Failed to load the game state.",e)}}})),c.on("pointerup",(async()=>{if(sceneState.buttonPressedSound.play({volume:.7}),u)u=!1,D();else{const t=await e.getTopScores(),a=250;let r=200;sceneState.newGameButtonClicked=!1,p=!1,u=!0,f=!1,T=!1,D(),sceneState.leaderboardsBackground=this.add.graphics(),sceneState.leaderboardsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.leaderboardsBackground.fillRect(a,r,810,250);const o={fontSize:"25px",fill:"#000000"};sceneState.leaderboardHeadline=this.add.text(a+20,r+30,"Leaderboard",o).setOrigin(0),sceneState.displayedScoreArray=[];for(let e=0;e<t.length;e++){const o=t[e].date.split(" ")[0],s=`${e+1}. Name: ${t[e].name}, Score: ${t[e].score}, Date: ${o}`,i=this.add.text(a+30,r+80,s,n).setOrigin(0);sceneState.displayedScoreArray.push(i),r+=20}sceneState.leaderboardElements=[sceneState.leaderboardsBackground,sceneState.leaderboardHeadline,sceneState.displayedScoreArray]}})),h.on("pointerup",(function(){f?(f=!1,D()):(sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!1,p=!1,u=!1,f=!0,T=!1,D(),sceneState.creditsBackground=e.add.graphics(),sceneState.creditsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.creditsBackground.fillRect(250,200,810,340),sceneState.creditsHeadline=e.add.text(270,230,"Credits",a).setOrigin(0),sceneState.creditsText=e.add.text(270,280,"Game Design and Programming by Erlend Kulander Kvitrud\nMusic by Marllon Silva (xDeviruchi) (https://soundcloud.com/xdeviruchi)\nPunch sound by @danielsoundsgood (https://danielsoundsgood.itch.io/)\nHealing sound by Dylan Kelk (https://freesound.org/people/SilverIllusionist/)\nPower up sound by MATRIXXX (https://freesound.org/people/MATRIXXX_/)\nGunshot sound by Fesliyan Studios (https://www.fesliyanstudios.com)\nButton Sprites by Ian Eborn (http://thaumaturge-art.com/)\nArmor and Strength symbols by Josepzin (https://opengameart.org/users/josepzin)\nCard sprites by Avery Ross (https://opengameart.org/users/averyre)\nCoin sound by ProjectsU012 (https://freesound.org/people/ProjectsU012/)\n",n),sceneState.creditsText.setLineSpacing(2),sceneState.creditsElements=[sceneState.creditsBackground,sceneState.creditsHeadline,sceneState.creditsText])})),x.on("pointerup",(function(){sceneState.buttonPressedSound.play({volume:.7}),T?(T=!1,D()):(sceneState.newGameButtonClicked=!1,p=!1,u=!1,f=!1,T=!0,D(),sceneState.instructionsBackground=e.add.graphics(),sceneState.instructionsBackground.fillStyle(16777215,1).setAlpha(.9).setDepth(20),sceneState.instructionsBackground.fillRect(250,20,810,640),sceneState.instructionsHeadline=e.add.text(270,50,"Instructions",a).setOrigin(0).setDepth(21),sceneState.instructionsText=e.add.text(270,100,'The game consists of four levels, each of which consists of three fights.\nAt the start of each turn, you gain 3 mana and draw 5 cards. You may then play any number\nof cards before hitting "End Turn". Your remaining cards and mana are then depleted,\nand the enemy\'s turn begins. You win the fight by killing all enemies. Losing a fight\nresults in permadeath. Missing health carries over from fight to fight\n\nStance represents the balance between Discipline and Freedom.\n-Positive Discipline during your turn: +3 Strength.\n-Positive Discipline at the end of your turn: +3 Armor.\n-Max Discipline at the end of your turn: -1 card next turn.\n\n-Positive Freedom during your turn: +1 mana.\n-Positive Freedom at the end of your turn: 50/50 chance of +1 card or +1 mana next turn.\n-Max Freedom at the end of your turn:-2 Armor.\n\nPhysical damage is affected by the Strength of the attacker and the Armor of the defender\n-Each unit of Strength increases outgoing physical damage by 10 %.\n-Each unit of Armor blocks 5 % of incomming physical damage\nArmor and Strength are both capped at 15 units.\n\nFire damage is unaffected by Strength and Armor, but otherwise acts like physical damage.\n\nPoison is unaffected by Strength and Armor. A poisoned character suffers damage at the start\nof their turn equal to their poison counter. At the end of the turn, this counter is reduced\nby 1. Unlike physical and fire damage, poison cannot reduce a characters health below 1 HP.\n\nPermanents are cards that can only be played once, and are then removed from your deck.\nAfter use, they remain active and provide passive bonuses. A maximum of 4 permanents may be\nactive at any given time. Permanents can be depleted, which unleases powerful one-off\neffects and then removes them from the game. If there are no empty slots for new permanents,\npermanent cards may be played directly from hand for their depletion effects.\n\nGold is earned by defeating enemies, and may be spent in the shop, or on in-fight bonuses.\n',n),sceneState.instructionsText.setLineSpacing(1.5).setDepth(21),sceneState.instructionsElements=[sceneState.instructionsBackground,sceneState.instructionsHeadline,sceneState.instructionsText])})),gameState.playerName="Punk Rock Samurai";const I=gameState.extraCards[0];I.freePermanent=!0,gameState.deck.push(I),gameState.extraCards.splice(gameState.extraCards.indexOf(I),1),e.scene.start("Level1Fight1")}update(){let e=0;gameState.isEnteringName&&sceneState.newGameButtonClicked&&(sceneState.nameText.setText(gameState.name),e=sceneState.nameText.width,sceneState.formCursor.x=sceneState.nameText.x+e-7)}}class Level1Fight1 extends BaseScene{self;constructor(){super("Level1Fight1")}preload(){this.load.image("theCity","assets/images/theCity.jpg"),this.load.image("bakgrunnCity1","assets/images/bakgrunnCity1.jpg"),this.load.image("nazi","assets/images/sprites/nazi.png")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnCity1"),this.resetPlayer(gameState.player,.45,370,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Nazi Punk",gameState.enemy1.sprite=this.add.image(740,355,"nazi").setScale(.42).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,470)})),gameState.player.name=gameState.playerName?gameState.playerName:"Punk Rock Samurai",gameState.permanents=[],this.definePermanentSlots(),gameState.deck.forEach((e=>{e.freePermanent&&C(e)})),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:270,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{V(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{V(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theCity").setScale(.87).setOrigin(.02,0).setDepth(300),n=this.add.text(550,270,"Level 1:",t).setDepth(301).setOrigin(.5),r=this.add.text(550,430,"On City Streets",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){T(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),n=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,n,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(300,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{V(gameState.startText,500)})),async function(){let t="",a="";const n=400,r=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>V(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),n=gameState.taunts.splice(e,1)[0];t=n.enemy,a=n.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*n),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(800),gameState.skipIntro)return;V(d,r),V(p,r),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{V(e,r)})),gameState.skipIntro||(await e.delay(r),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),X(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),K(gameState.player),h(),L(gameState.player),e.shuffleDeck(gameState.drawPile);const r=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(r,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>V(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{u(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,n={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,n),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),g(t)}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,V(a,2e3),V(n,2e3),V(r,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,V(a,2e3),V(n,2e3),V(r,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,V(a,2e3),V(n,2e3),V(r,2e3),e.time.delayedCall(2200,s()))}));function g(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+n];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),d(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function d(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,console.log(`gameState.costPlayed: ${gameState.costPlayed}`));const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&T(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),p(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;p(t,a,r)}))}else"permanent"===gameState.typePlayed?C(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),p(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function p(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),V(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:S,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&n>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=n>0?2*(1+n):2,S=i?1:0;return{damagePlayed:r?11:c(e.damage),firePlayed:m?2*n:o?13:c(e.fire),stancePointsPlayed:m&&a?-1:c(e.stancePoints),poisonPlayed:s?t.poison:c(e.poison)+S,healPlayed:c(e.heal),strengthPlayed:c(e.strength),armorPlayed:d?-n:c(e.armor),reduceTargetArmorPlayed:g?p:c(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:c(e.reduceTargetStrength),drawCardPlayed:c(e.drawCard),poisonRemovePlayed:c(e.poisonRemove)}}(t,a,n),x=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*x));r&&(gameState.player.lifeStealCounter+=o*x*r),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=S,a.armor-=p,a.poison+=l,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),V(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),W(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];V(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&k(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&k(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,l,g,d,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),N(a),e.updateHealthBar(a),L(gameState.player),K(a),h(),u(),W(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&V(gameState.actionText,200),gameState.actionTextBackground&&V(gameState.actionTextBackground,200)}))}function c(e){return"function"==typeof e?e():e}function S(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{V(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),X(t),gameState.toxicAvenger&&t.poison>0&&N(t);const n=""!==t.poisonText._text||t.turnText?1800:700;e.time.delayedCall(n,(()=>{V(t.poisonText),V(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),N(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),K(t),N(t)})),e.time.delayedCall(1300,(()=>{gameState.actionText&&V(gameState.actionText,200),gameState.actionTextBackground&&V(gameState.actionTextBackground,200),t.turnComplete=!0,h()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?S():(gameState.currentEnemyIndex=0,m()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,S()))}function u(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:5,text:"Heals 10 HP\nGains 5 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:3,armor:0,text:"Heals 10 HP\nGains 3 Strength",probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 17 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function h(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),Y(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&k(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&V(gameState.actionText,200);gameState.actionTextBackground&&V(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have completed Level ${n}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{x(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,k(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*n,"rectangularButton"),c=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*n,"rectangularButton"),u=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*n,"rectangularButton"),f=e.add.text(t,a+3*n,"Exit Shop",m);let x=[];const k=[g,h,p,S],C=[d,f,c,u];let B=[...k,...C,gameState.shopBackground];k.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),T(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))})),x.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();x.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(x=x.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),T(s),x.forEach((e=>{e&&e.destroy()})),y(210),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),T(i),x.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&V(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{V(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{V(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,y()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),Y(),V(gameState.actionText,200),V(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function y(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&V(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{V(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,f())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,f())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{V(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],x(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(T(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),y(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function f(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function x(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function k(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function T(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function C(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),a?(t.freePermanent||(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),function(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}(t),function(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,L(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>N(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,L(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?D(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(T(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,L(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,L(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),W(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":v(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":P(t);break;case"bushido":w(t);break;case"toxicAvenger":M(t);break;case"kirisuteGomen":D(t);case"toxicFrets":E(t);break;case"ashenEncore":I(t);break;case"edoEruption":A(t);break;case"steelToe":O(t);break;case"deadTokugawas":R(t);break;case"gundanSeizai":$(t);break;case"LustForLife":H(t);break;case"PunksNotDead":F(t);break;case"soulSquatter":z(t);break;case"bouncingSoles":G(t);break;case"enduringSpirit":U(t);break;case"shogunsShell":j(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}function B(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function v(e){gameState.foreverTrue=!1,B(e),W(8)}function b(t){gameState.rebelSpirit=!1,B(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function P(t){gameState.rebelHeart=!1,B(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function w(e){gameState.bushido=!1,B(e),gameState.player.strengthBase+=6,L(gameState.player)}function M(e){gameState.toxicAvenger=!1,B(e),gameState.enemies.forEach((e=>{e.poison+=4,N(e)}))}function D(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),K(n),h(),L(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function E(t){gameState.toxicFrets=!1,B(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),K(t),h())}))}function I(t){gameState.ashenEncore=!1,B(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),K(t),h()}))}function A(e){gameState.edoEruption=!1,B(e)}function O(t){gameState.steelToe=!1,B(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,N(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function R(e){gameState.redrawPrice+=1,B(e)}function $(e){gameState.gundanSeizai=!1,k(3),B(e)}function H(t){gameState.lustForLife=!1,B(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{V(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function F(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),B(t)}function z(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,B(e)}function G(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),B(e)}function U(e){B(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,L(gameState.player),B(e)}function j(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,L(gameState.player),B(e)}function L(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),N(e)}function N(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function K(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void F(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,V(e.sprite,500),e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(k(1),gameState.troopsOfTakamoriCondition=!1)}[e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{e&&e.destroy()}))}}function Y(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),V(e.sprite,200)}}function W(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),K(t),h(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){d(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function V(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function X(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),Y(),L(gameState.player),u(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,V(e.intentionText,200),V(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),S()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(W(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,K(e),h(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight2 extends BaseScene{self;constructor(){super("Level1Fight2")}preload(){this.load.image("bakgrunnCity2","assets/images/bakgrunnCity2.jpg"),this.load.image("rat1","assets/images/sprites/rat1.png"),this.load.image("rat2","assets/images/sprites/rat2.png"),this.load.image("ratCard","assets/images/cards/ratCard.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function n(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,280,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,360,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),Y(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),U(gameState.player),d(),z(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>K(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},n="Heads up: Rats\nare infectious!",o=e.add.text(550,280,"",a).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,n),e.time.delayedCall(2500,(()=>{K(o,200),K(s,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),r(t),gameState.enemies.forEach((e=>{m(),g(e),N(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{m(),g(e),N(e)})),r(t))}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnCity2"),this.resetPlayer(gameState.player,.48,360,285),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{K(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{K(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Mutant City Rat",gameState.enemy1.cardKey="ratCard",gameState.enemy1.sprite=this.add.image(630,332,"rat1").setScale(.4).setFlipX(!0).setInteractive(),gameState.enemy1.health=40,gameState.enemy1.healthMax=40,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mutant City Rat",gameState.enemy2.cardKey="ratCard",gameState.enemy2.sprite=this.add.image(790,355,"rat2").setScale(.42).setFlipX(!0).setInteractive(),gameState.enemy2.health=50,gameState.enemy2.healthMax=50,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),f(a),y(a))})),function(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){h(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],r(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{K(gameState.startText,500)})),async function(){let r="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>K(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),n()))},gameState.skipIntro)return;gameState.ratTaunts||(gameState.ratTaunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.ratTaunts.length),t=gameState.ratTaunts.splice(e,1)[0];r=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,r,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;K(d,i),K(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{K(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||n())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();function r(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),o(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function o(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&h(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),s(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;s(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),f(t),y(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":k(t);break;case"rebelSpirit":T(t);break;case"rebelHeart":C(t);break;case"bushido":B(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":b(t);case"toxicFrets":P(t);break;case"ashenEncore":w(t);break;case"edoEruption":M(t);break;case"steelToe":D(t);break;case"deadTokugawas":E(t);break;case"gundanSeizai":I(t);break;case"LustForLife":A(t);break;case"PunksNotDead":O(t);break;case"soulSquatter":R(t);break;case"bouncingSoles":$(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":F(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("infection"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),s(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function s(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),K(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:l,poisonPlayed:g,healPlayed:p,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:h,reduceTargetStrengthPlayed:y,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&n>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=n>0?2*(1+n):2,S=l?1:0;return{damagePlayed:r?11:i(e.damage),firePlayed:g?2*n:o?13:i(e.fire),stancePointsPlayed:g&&a?-1:i(e.stancePoints),poisonPlayed:s?t.poison:i(e.poison)+S,healPlayed:i(e.heal),strengthPlayed:i(e.strength),armorPlayed:p?-n:i(e.armor),reduceTargetArmorPlayed:d?c:i(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:i(e.reduceTargetStrength),drawCardPlayed:i(e.drawCard),poisonRemovePlayed:i(e.poisonRemove)}}(t,a,n),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));r&&(gameState.player.lifeStealCounter+=o*k*r),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=h,a.poison+=g,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),K(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),L(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];K(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&u(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&u(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),p&&(gameState.player.health=Math.min(gameState.player.health+p,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,280,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,g,c,S,x),gameState.player.stancePoints+l>=-3&&gameState.player.stancePoints+l<=3&&(gameState.player.stancePoints+=l,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),G(a),e.updateHealthBar(a),z(gameState.player),U(a),d(),m(),L(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&K(gameState.actionText,200),gameState.actionTextBackground&&K(gameState.actionTextBackground,200)}))}function i(e){return"function"==typeof e?e():e}function l(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{K(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),Y(t),gameState.toxicAvenger&&t.poison>0&&G(t);let r=""!==t.poisonText._text||t.turnText?1800:700;gameState.infection&&(r+=1e3,gameState.infection=!1);e.time.delayedCall(r,(()=>{K(t.poisonText),K(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,280,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),G(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.infect?function(t){new Promise((a=>{let n=0;const r=450,o=200,s=450;let i=.45;const l=2300;gameState.infection=!0,e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8});const m=[{key:"ratCard",type:"infection",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"ratCard",type:"infection",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];gameState.drawPile.push(...m);const g=[e.add.image(r,s,"ratCard").setScale(i).setOrigin(.5).setDepth(300),e.add.image(r+o,s,"ratCard").setScale(i).setOrigin(.5).setDepth(300)];let d="Adds 2 Infectious to your draw pile";gameState.actionText.y=s-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(l,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:120,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.drawPileText.setText(gameState.drawPile.length),n++,n===g.length&&a()}})}))}))}))}(t):gameState.infection=!1,a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),U(t),G(t)}));const r=gameState.infection?2200:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&K(gameState.actionText,200),gameState.actionTextBackground&&K(gameState.actionTextBackground,200),t.turnComplete=!0,d()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?l():(gameState.currentEnemyIndex=0,n()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,l()))}function m(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:4,text:"Heals 10 HP\nGains 4 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:3===gameState.turn||4===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 4 Poison",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 poison",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nInfect you",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Infects you",infect:!0,probability:1}]:2===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:4,text:"Heals 10 HP\nGains 4 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:3===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nInfect you",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Infects you",infect:!0,probability:1}]:4===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 4 Poison",probability:1}]:gameState.enemy2.actions=[{key:"Intends to\nDeal 5 poison",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function g(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function d(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),j(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"infection"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&u(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&K(gameState.actionText,200);gameState.actionTextBackground&&K(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have completed Level ${n}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{S(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,u(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*n,"rectangularButton"),S=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*n,"rectangularButton"),y=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*n,"rectangularButton"),x=e.add.text(t,a+3*n,"Exit Shop",m);let k=[];const T=[g,f,c,u],C=[d,x,S,y];let B=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),h(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();k.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(s),k.forEach((e=>{e&&e.destroy()})),p(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&K(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{K(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{K(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,p()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),j(),K(gameState.actionText,200),K(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function p(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&K(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{K(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{K(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],S(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(h(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),p(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function c(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function S(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function u(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function h(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function y(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>G(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(h(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,z(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,z(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),L(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function f(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function x(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function k(e){gameState.foreverTrue=!1,x(e),L(8)}function T(t){gameState.rebelSpirit=!1,x(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function C(t){gameState.rebelHeart=!1,x(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function B(e){gameState.bushido=!1,x(e),gameState.player.strengthBase+=6,z(gameState.player)}function v(e){gameState.toxicAvenger=!1,x(e),gameState.enemies.forEach((e=>{e.poison+=4,G(e)}))}function b(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),U(n),d(),z(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,x(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),U(t),d())}))}function w(t){gameState.ashenEncore=!1,x(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),U(t),d()}))}function M(e){gameState.edoEruption=!1,x(e)}function D(t){gameState.steelToe=!1,x(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,G(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function E(e){gameState.redrawPrice+=1,x(e)}function I(e){gameState.gundanSeizai=!1,u(3),x(e)}function A(t){gameState.lustForLife=!1,x(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{K(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function O(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),x(t)}function R(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,x(e)}function $(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),x(e)}function H(e){x(e)}function F(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,z(gameState.player),x(e)}function z(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),G(e)}function G(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function U(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void O(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(u(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{K(e,500)}))}}function j(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,"infection"===e.type&&(gameState.player.poison+=2),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),K(e.sprite,200)}}function L(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),U(t),d(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){o(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function N(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,r=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*r,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function K(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function Y(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),j(),z(gameState.player),m(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,K(e.intentionText,200),K(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),l()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(L(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,U(e),d(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight3 extends BaseScene{self;constructor(){super("Level1Fight3")}preload(){this.load.image("bakgrunnCity3","assets/images/bakgrunnCity3.jpg"),this.load.image("police1","assets/images/sprites/police1.png"),this.load.image("police2","assets/images/sprites/police2.png"),this.load.audio("gunShotSound","assets/sounds/gunshot.mp3")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnCity3"),this.resetPlayer(gameState.player,.5,360,340),this.addEndOfTurnButton(510),this.addRedrawButton(),this.addGoldCoin();let t=7;function a(){gameState.skipTaunts()}async function n(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let a=gameState.player.numCardsBase+gameState.player.numCardsStance;if(t-=1,2===gameState.turn&&function(){const a={fontSize:"60px",fontWeight:"bold",fill:"#000000"};gameState.turnsTextBox=e.add.rectangle(550,150,55,55,16777215).setAlpha(.3).setOrigin(.5),gameState.turnsText=e.add.text(550,152,`${t}`,a).setOrigin(.5)}(),gameState.turn>2&&gameState.turnsText.setText(`${t}`),0===t)gameState.player.health=0,gameState.punksNotDeadCondition=!1,e.sound.add("gunShotSound").play({volume:1.5}),e.cameras.main.flash(600),e.cameras.main.shake(800,.01,!1),U(gameState.player),d();else{const t="Your turn!",n=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(n,r,t),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),K(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),U(gameState.player),d(),z(gameState.player),e.shuffleDeck(gameState.drawPile);const s=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(s,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,n,r].forEach((e=>N(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{g(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,n={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,n),t.intentionText.setOrigin(.5,1).setDepth(22);const r=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(21)}(t)})),o(a)}))}}gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{N(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{N(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Sgt. Pig",gameState.enemy1.sprite=this.add.image(680,340,"police1").setScale(.26).setFlipX(!0).setInteractive(),gameState.enemy1.health=45,gameState.enemy1.healthMax=45,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Lt. Pig",gameState.enemy2.sprite=this.add.image(840,340,"police2").setScale(.4).setFlipX(!0).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,460)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),f(a),y(a))})),function(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){h(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],o(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${t}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{N(gameState.startText,500)})),async function(){let t="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>N(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),a=gameState.taunts.splice(e,1)[0];t=a.enemy,o=a.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await n(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;N(d,i),N(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await n(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{N(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",a,this),e.input.on("pointerup",a,this)}))}();function o(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+n];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&h(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;i(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),f(t),y(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":k(t);break;case"rebelSpirit":T(t);break;case"rebelHeart":C(t);break;case"bushido":B(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":b(t);case"toxicFrets":P(t);break;case"ashenEncore":w(t);break;case"edoEruption":M(t);break;case"steelToe":D(t);break;case"deadTokugawas":E(t);break;case"gundanSeizai":I(t);break;case"LustForLife":A(t);break;case"PunksNotDead":O(t);break;case"soulSquatter":R(t);break;case"bouncingSoles":$(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":F(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),N(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:m,healPlayed:p,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:h,reduceTargetStrengthPlayed:y,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&n>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=n>0?2*(1+n):2,S=i?1:0;return{damagePlayed:r?11:l(e.damage),firePlayed:g?2*n:o?13:l(e.fire),stancePointsPlayed:g&&a?-1:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?-n:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,n),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));r&&(gameState.player.lifeStealCounter+=o*k*r),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=h,a.poison+=m,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),N(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),L(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];N(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&u(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&u(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),p&&(gameState.player.health=Math.min(gameState.player.health+p,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),G(a),e.updateHealthBar(a),z(gameState.player),U(a),d(),g(),L(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&N(gameState.actionText,200),gameState.actionTextBackground&&N(gameState.actionTextBackground,200)}))}function l(e){return"function"==typeof e?e():e}function m(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const o=[t.turnText,n];if(gameState.canibalizeCondition){const a=Math.floor(gameState.player.lifeSteal),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-roundgameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),o.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{if(o.forEach((e=>N(e,100))),1===gameState.turn){const t={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},a=e.add.text(550,300,"   The pigs are\ncalling for backup!",t).setOrigin(.5).setDepth(201);let n=a.width,o=a.height,s=20,i=20;const l=e.add.graphics();l.fillStyle(16777215,.7),l.fillRect(a.x-n/2-s,a.y-o/2-i,n+2*s,o+2*i).setDepth(200),e.time.delayedCall(3500,(()=>{a.destroy(),l.destroy();const n=e.add.text(550,300,"Police snipers\n will hit you\n  in 5 turns!",t).setOrigin(.5).setDepth(201);let o=n.width,s=n.height,i=20,m=20;const g=e.add.graphics();g.fillStyle(16777215,.7),g.fillRect(n.x-o/2-i,n.y-s/2-m,o+2*i,s+2*m).setDepth(200),e.time.delayedCall(4500,(()=>{n.destroy(),g.destroy(),r()}))}))}}))}1!=gameState.turn&&(t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),K(t),gameState.toxicAvenger&&t.poison>0&&G(t);const n=""!==t.poisonText._text||t.turnText?1800:700;e.time.delayedCall(n,(()=>{N(t.poisonText),N(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),G(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),U(t),G(t)})),e.time.delayedCall(1300,(()=>{gameState.actionText&&N(gameState.actionText,200),gameState.actionTextBackground&&N(gameState.actionTextBackground,200),t.turnComplete=!0,d()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?m():(gameState.currentEnemyIndex=0,r()))}))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,m()))}function g(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRequest backup",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRequest backup",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}])}function d(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),j(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1)})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&u(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&N(gameState.actionText,200);gameState.actionTextBackground&&N(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have cleared Level ${n}\nHealth is resorted to ${gameState.player.healthMax}/${gameState.player.healthMax}`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=5,n=250,r=100;gameState.goldCollected=!1;const o="Collect loot and get\n ready for Level 2!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{S(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,u(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*n,"rectangularButton"),S=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*n,"rectangularButton"),y=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*n,"rectangularButton"),x=e.add.text(t,a+3*n,"Exit Shop",m);let k=[];const T=[g,f,c,u],C=[d,x,S,y];let B=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),h(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();k.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(s),k.forEach((e=>{e&&e.destroy()})),p(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&N(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{N(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{N(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,p()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),j(),N(gameState.actionText,200),N(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function p(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),"permanent"===n.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(n),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&N(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{N(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{N(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],S(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),h(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),p(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function c(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function S(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function u(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function h(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function y(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>G(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(h(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,z(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,z(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),L(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function f(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function x(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function k(e){gameState.foreverTrue=!1,x(e),L(8)}function T(t){gameState.rebelSpirit=!1,x(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function C(t){gameState.rebelHeart=!1,x(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function B(e){gameState.bushido=!1,x(e),gameState.player.strengthBase+=6,z(gameState.player)}function v(e){gameState.toxicAvenger=!1,x(e),gameState.enemies.forEach((e=>{e.poison+=4,G(e)}))}function b(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),U(n),d(),z(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,x(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),U(t),d())}))}function w(t){gameState.ashenEncore=!1,x(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),U(t),d()}))}function M(e){gameState.edoEruption=!1,x(e)}function D(t){gameState.steelToe=!1,x(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,G(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function E(e){gameState.redrawPrice+=1,x(e)}function I(e){gameState.gundanSeizai=!1,u(3),x(e)}function A(t){gameState.lustForLife=!1,x(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{N(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function O(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),x(t)}function R(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,x(e)}function $(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),x(e)}function H(e){x(e)}function F(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,z(gameState.player),x(e)}function z(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),G(e)}function G(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function U(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void O(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(u(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{N(e,500)}))}}function j(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),N(e.sprite,200)}}function L(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),U(t),d(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function N(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function K(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),j(),z(gameState.player),g(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,N(e.intentionText,200),N(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),m()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(L(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,U(e),d(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight1 extends BaseScene{self;constructor(){super("Level2Fight1")}preload(){this.load.image("theForest","assets/images/theForest.jpg"),this.load.image("bakgrunnForest1","assets/images/bakgrunnForest1.jpg"),this.load.image("tree1","assets/images/sprites/tree1.png"),this.load.image("tree2","assets/images/sprites/tree2.png"),this.load.image("rooted","assets/images/cards/rooted.jpg")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnForest1"),this.resetPlayer(gameState.player,.37,360,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{_(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{_(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Timbermaw\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.cardKey="rooted",gameState.enemy1.sprite=this.add.sprite(680,315,"tree1").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy.armor=15,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mossbite\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy2.cardKey="rooted",gameState.enemy2.sprite=this.add.sprite(920,315,"tree2").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemy2.armor=15,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),v(a),B(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theForest").setScale(.87).setOrigin(.02,0).setDepth(300),n=this.add.text(550,270,"Level 2:",t).setDepth(301).setOrigin(.5),r=this.add.text(550,430,"The Forest",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){C(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),n=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,n,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{_(gameState.startText,500)})),async function(){let t="",a="";const n=400,r=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>_(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),n=gameState.taunts.splice(e,1)[0];t=n.enemy,a=n.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*n),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;_(d,r),_(p,r),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{_(e,r)})),gameState.skipIntro||(await e.delay(r),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),Z(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),y(),K(gameState.player),e.shuffleDeck(gameState.drawPile);const r=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(r,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>_(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let n="Trees start with\nfull Armor, and lose\n1 Armor when attacked";const r=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(r,o,n),e.time.delayedCall(3e3,(()=>{n="Naturally, they are also\nvulnerabel to fire",e.updateTextAndBackground(r,o,n),e.time.delayedCall(3e3,(()=>{_(r,200),_(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),g(t),gameState.enemies.forEach((e=>{u(),h(e),q(e)}))}))}))}))}(t):(gameState.enemies.forEach((e=>{u(),h(e),q(e)})),g(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,_(a,2e3),_(n,2e3),_(r,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,_(a,2e3),_(n,2e3),_(r,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,_(a,2e3),_(n,2e3),_(r,2e3),e.time.delayedCall(2200,s()))}));function g(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+n];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),d(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function d(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&C(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),p(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;p(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),v(t),B(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":P(t);break;case"rebelSpirit":w(t);break;case"rebelHeart":M(t);break;case"bushido":D(t);break;case"toxicAvenger":E(t);break;case"kirisuteGomen":I(t);case"toxicFrets":A(t);break;case"ashenEncore":O(t);break;case"edoEruption":R(t);break;case"steelToe":$(t);break;case"deadTokugawas":H(t);break;case"gundanSeizai":F(t);break;case"LustForLife":z(t);break;case"PunksNotDead":G(t);break;case"soulSquatter":U(t);break;case"bouncingSoles":j(t);break;case"enduringSpirit":L(t);break;case"shogunsShell":N(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),p(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function p(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),_(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:S,drawCardPlayed:h,poisonRemovePlayed:f}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&n>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=n>0?2*(1+n):2,S=i?1:0,u=1.5;return{damagePlayed:r?11:c(e.damage),firePlayed:u*(m?2*n:o?13:c(e.fire)),stancePointsPlayed:m&&a?-1:c(e.stancePoints),poisonPlayed:s?t.poison:c(e.poison)+S,healPlayed:c(e.heal),strengthPlayed:c(e.strength),armorPlayed:d?-n:c(e.armor),reduceTargetArmorPlayed:g?p:c(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:c(e.reduceTargetStrength),drawCardPlayed:c(e.drawCard),poisonRemovePlayed:c(e.poisonRemove)}}(t,a,n),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+o*x));r&&(gameState.player.lifeStealCounter+=o*x*r),a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=S,a.armor-=p,a.poison+=l,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),_(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),X(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];_(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&T(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&T(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,l,g,d,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),Y(a),e.updateHealthBar(a),K(gameState.player),W(a),y(),u(),X(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&_(gameState.actionText,200),gameState.actionTextBackground&&_(gameState.actionTextBackground,200)}))}function c(e){return"function"==typeof e?e():e}function S(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{_(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),Z(t),gameState.toxicAvenger&&t.poison>0&&Y(t);let n=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{_(t.poisonText),_(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),Y(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((n=>{gameState.debuffCardPlayed=!0;let r=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===h.length&&n()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),Y(t)}));const n=gameState.debuffCardPlayed?1800:1300;e.time.delayedCall(n,(()=>{gameState.actionText&&_(gameState.actionText,200),gameState.actionTextBackground&&_(gameState.actionTextBackground,200),t.turnComplete=!0,y()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?S():(gameState.currentEnemyIndex=0,m()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,S()))}function u(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(13*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 13 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):5===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.26+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:1,text:"Heals 10 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.13},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:0,text:"Heals 15 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,text:"Gains 2 strenght",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.18:0)/5}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.28+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.15},{key:"Intends\nto Rest",damage:0,fire:0,poison:0,heal:20,poisonRemove:0,strength:0,armor:0,text:"Heals 20 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,text:"Gains 2 strenght",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5}])}function h(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function y(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),V(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&T(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&_(gameState.actionText,200);gameState.actionTextBackground&&_(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have completed Level ${n}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{k(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,T(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*n,"rectangularButton"),c=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*n,"rectangularButton"),u=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*n,"rectangularButton"),y=e.add.text(t,a+3*n,"Exit Shop",m);let x=[];const k=[g,h,p,S],T=[d,y,c,u];let B=[...k,...T,gameState.shopBackground];k.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),T.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),C(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))})),x.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();x.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(x=x.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),C(s),x.forEach((e=>{e&&e.destroy()})),f(210),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),C(i),x.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&_(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{_(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{_(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,f()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),V(),_(gameState.actionText,200),_(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function f(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&_(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{_(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,x())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,x())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{_(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],k(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),C(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),f(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function x(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function k(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function T(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function C(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function B(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,K(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>Y(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,K(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?I(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(C(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?L(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?N(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,K(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,K(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),X(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function v(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function b(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function P(e){gameState.foreverTrue=!1,b(e),X(8)}function w(t){gameState.rebelSpirit=!1,b(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function M(t){gameState.rebelHeart=!1,b(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function D(e){gameState.bushido=!1,b(e),gameState.player.strengthBase+=6,K(gameState.player)}function E(e){gameState.toxicAvenger=!1,b(e),gameState.enemies.forEach((e=>{e.poison+=4,Y(e)}))}function I(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(n),y(),K(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function A(t){gameState.toxicFrets=!1,b(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),y())}))}function O(t){gameState.ashenEncore=!1,b(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),y()}))}function R(e){gameState.edoEruption=!1,b(e)}function $(t){gameState.steelToe=!1,b(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,Y(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function H(e){gameState.redrawPrice+=1,b(e)}function F(e){gameState.gundanSeizai=!1,T(3),b(e)}function z(t){gameState.lustForLife=!1,b(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{_(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function G(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),b(t)}function U(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,b(e)}function j(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),b(e)}function L(e){b(e)}function N(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,K(gameState.player),b(e)}function K(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),Y(e)}function Y(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void G(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(T(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{_(e,500)}))}}function V(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),_(e.sprite,200)}}function X(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),y(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){d(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function q(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,r=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*r,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function _(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function Z(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),V(),K(gameState.player),u(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,_(e.intentionText,200),_(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),S()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(X(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),y(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight2 extends BaseScene{self;constructor(){super("Level2Fight2")}preload(){this.load.image("bakgrunnForest2","assets/images/bakgrunnForest2.jpg"),this.load.image("goblin1","assets/images/sprites/goblin1.png"),this.load.image("goblin2","assets/images/sprites/goblin2.png"),this.load.image("goblin3","assets/images/sprites/goblin3.png")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnForest2"),this.resetPlayer(gameState.player,.5,360,330),this.addEndOfTurnButton(510),this.addRedrawButton(),this.addGoldCoin();let t=7;function a(){gameState.skipTaunts()}async function n(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function r(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let a=gameState.player.numCardsBase+gameState.player.numCardsStance;t>0&&(t-=1),2===gameState.turn&&function(){const a={fontSize:"70px",fontWeight:"bold",fill:"#000000"};gameState.countdownTextBox=e.add.image(550,150,"goldCoin").setScale(.12),gameState.countdownText=e.add.text(530,120,`${t}`,a)}(),gameState.turn>2&&gameState.countdownText.setText(`${t}`),0===t&&(gameState.countdownTextBox.destroy(),gameState.countdownText.destroy(),e.cameras.main.shake(800,.005,!1));const n=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(n,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),W(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),j(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile);const s=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(s,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,n,r].forEach((e=>Y(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},n="Defeat the Goblins\nto steal their gold!";gameState.introText=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),gameState.introTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.introText,gameState.introTextBackground,n),e.time.delayedCall(2500,(()=>{Y(gameState.introText,200),Y(gameState.introTextBackground,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),o(t),gameState.enemies.forEach((e=>{g(),d(e),K(e)}))}))}))}(a):(gameState.enemies.forEach((e=>{g(),d(e),K(e)})),o(a))}))}gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{Y(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{Y(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Junior Goblin\nApprentice of poison",gameState.enemy1.sprite=this.add.sprite(670,380,"goblin1").setScale(.2).setFlipX(!0).setInteractive(),gameState.enemy1.health=30,gameState.enemy1.healthMax=30,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Junior Goblin\nApprentice of poison",gameState.enemy2.sprite=this.add.sprite(800,380,"goblin3").setScale(.18).setFlipX(!1).setInteractive(),gameState.enemy2.health=30,gameState.enemy2.healthMax=30,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Senior Goblin\nMaster of poison",gameState.enemy3.sprite=this.add.sprite(930,380,"goblin2").setScale(.25).setFlipX(!1).setInteractive(),gameState.enemy3.health=45,gameState.enemy3.healthMax=45,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),x(a),f(a))})),function(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){y(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],o(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${t}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{Y(gameState.startText,500)})),async function(){let t="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>Y(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),r()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),a=gameState.taunts.splice(e,1)[0];t=a.enemy,o=a.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await n(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;Y(d,i),Y(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await n(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{Y(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",a,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||r())}(),e.input.keyboard.on("keydown",a,this),e.input.on("pointerup",a,this)}))}();function o(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+n];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),s(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function s(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&y(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),i(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;i(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),x(t),f(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":T(t);break;case"rebelSpirit":C(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":b(t);break;case"kirisuteGomen":P(t);case"toxicFrets":w(t);break;case"ashenEncore":M(t);break;case"edoEruption":D(t);break;case"steelToe":E(t);break;case"deadTokugawas":I(t);break;case"gundanSeizai":A(t);break;case"LustForLife":O(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":$(t);break;case"bouncingSoles":H(t);break;case"enduringSpirit":F(t);break;case"shogunsShell":z(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),i(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function i(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),Y(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:m,healPlayed:d,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:y,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&n>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=n>0?2*(1+n):2,S=i?1:0;return{damagePlayed:r?11:l(e.damage),firePlayed:g?2*n:o?13:l(e.fire),stancePointsPlayed:g&&a?-1:l(e.stancePoints),poisonPlayed:s?t.poison:l(e.poison)+S,healPlayed:l(e.heal),strengthPlayed:l(e.strength),armorPlayed:p?-n:l(e.armor),reduceTargetArmorPlayed:d?c:l(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:l(e.reduceTargetStrength),drawCardPlayed:l(e.drawCard),poisonRemovePlayed:l(e.poisonRemove)}}(t,a,n),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));r&&(gameState.player.lifeStealCounter+=o*k*r),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=u,a.poison+=m,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),Y(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),N(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];Y(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&h(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&h(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),U(a),e.updateHealthBar(a),G(gameState.player),j(a),p(),g(),N(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&Y(gameState.actionText,200),gameState.actionTextBackground&&Y(gameState.actionTextBackground,200)}))}function l(e){return"function"==typeof e?e():e}function m(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const o=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),o.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{if(o.forEach((e=>Y(e,100))),1===gameState.turn){const t={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},a=e.add.text(550,300,"The Goblins are\nevacuating their gold!",t).setOrigin(.5).setDepth(201);let n=a.width,o=a.height,s=20,i=20;const l=e.add.graphics();l.fillStyle(16777215,.7),l.fillRect(a.x-n/2-s,a.y-o/2-i,n+2*s,o+2*i).setDepth(200),e.time.delayedCall(2500,(()=>{a.destroy(),l.destroy();const n=e.add.text(550,300,"Defeat them in\n5 turns to steal\nwhat's left!",t).setOrigin(.5).setDepth(201);let o=n.width,s=n.height,i=20,m=20;const g=e.add.graphics();g.fillStyle(16777215,.7),g.fillRect(n.x-o/2-i,n.y-s/2-m,o+2*i,s+2*m).setDepth(200),e.time.delayedCall(2500,(()=>{n.destroy(),g.destroy(),r()}))}))}}))}1!=gameState.turn&&(t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),W(t),gameState.toxicAvenger&&t.poison>0&&U(t);const n=""!==t.poisonText._text||t.turnText?1800:700;e.time.delayedCall(n,(()=>{Y(t.poisonText),Y(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),U(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),j(t),U(t)})),e.time.delayedCall(1300,(()=>{gameState.actionText&&Y(gameState.actionText,200),gameState.actionTextBackground&&Y(gameState.actionTextBackground,200),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?m():(gameState.currentEnemyIndex=0,r()))}))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,m()))}function g(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}],gameState.enemy3.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6}],gameState.enemy3.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:0+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(11*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:11,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage\nAnd 1 Poison",probability:.17+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage\nAnd 1 Poison",probability:.11+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.18+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 3 poison",probability:.19+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6}])}function d(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),L(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1)})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&h(1),t>0&&function(){for(let a=0;a<t;a++)e.time.delayedCall(200*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),t-=1,gameState.goldCounter.setText(gameState.player.gold),gameState.countdownText.setText(t),gameConfig.coinSound.play({volume:.8,seek:.02})}));0===t&&(Y(gameState.countdownTextBox,250),Y(gameState.countdownText,250))}(),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&Y(gameState.actionText,200);gameState.actionTextBackground&&Y(gameState.actionTextBackground,200);const a={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let n=e.add.text(550,300,"Victory!",a).setOrigin(.5).setDepth(21);const{level:r,fight:o}=e.extractLevelFightFromName(e.scene.key),s=3===o?3e3:100,i=3===o?`You have completed Level ${r}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),n.setText(i),n.setStyle({fontSize:"60px"}),e.time.delayedCall(s,(()=>{n.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{u(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,h(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*n,"rectangularButton"),S=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*n,"rectangularButton"),h=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*n,"rectangularButton"),x=e.add.text(t,a+3*n,"Exit Shop",m);let k=[];const T=[g,f,p,u],C=[d,x,S,h];let B=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),y(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();k.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),y(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),y(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&Y(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{Y(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{Y(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,c()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),L(),Y(gameState.actionText,200),Y(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&Y(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{Y(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,S())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,S())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{Y(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],u(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),y(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function u(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function h(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function f(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>U(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?P(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(y(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),N(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function x(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function k(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function T(e){gameState.foreverTrue=!1,k(e),N(8)}function C(t){gameState.rebelSpirit=!1,k(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,k(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,k(e),gameState.player.strengthBase+=6,G(gameState.player)}function b(e){gameState.toxicAvenger=!1,k(e),gameState.enemies.forEach((e=>{e.poison+=4,U(e)}))}function P(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),j(n),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function w(t){gameState.toxicFrets=!1,k(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),j(t),p())}))}function M(t){gameState.ashenEncore=!1,k(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),j(t),p()}))}function D(e){gameState.edoEruption=!1,k(e)}function E(t){gameState.steelToe=!1,k(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,U(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function I(e){gameState.redrawPrice+=1,k(e)}function A(e){gameState.gundanSeizai=!1,h(3),k(e)}function O(t){gameState.lustForLife=!1,k(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{Y(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),k(t)}function $(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,k(e)}function H(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),k(e)}function F(e){k(e)}function z(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),k(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),U(e)}function U(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function j(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(h(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{Y(e,500)}))}}function L(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),Y(e.sprite,200)}}function N(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),j(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){s(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function K(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,r=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*r,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function Y(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function W(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),L(),G(gameState.player),g(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,Y(e.intentionText,200),Y(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),m()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(N(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,j(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight3 extends BaseScene{self;constructor(){super("Level2Fight3")}preload(){this.load.image("bakgrunnForest3","assets/images/bakgrunnForest3.jpg"),this.load.image("tree3","assets/images/sprites/tree3.png"),this.load.image("rooted","assets/images/cards/rooted.jpg"),this.load.image("goblin1","assets/images/sprites/goblin1.png")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function n(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),K(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),U(gameState.player),d(),z(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>N(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),gameState.enemies.forEach((t=>{g(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,n={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,n),t.intentionText.setOrigin(.5,1).setDepth(22);const r=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(21)}(t)})),r(t)}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnForest3"),this.resetPlayer(gameState.player,.37,360,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{N(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{N(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Lord of the Trees\nLose Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.cardKey="rooted",gameState.enemy1.sprite=this.add.sprite(780,290,"tree3").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy1.health=110,gameState.enemy1.healthMax=110,gameState.enemy1.armor=15,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),f(a),y(a))})),function(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){h(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],r(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{N(gameState.startText,500)})),async function(){let r="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>N(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),n()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];r=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,r,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;N(d,i),N(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{N(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||n())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();function r(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),o(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function o(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&h(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),s(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;s(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),f(t),y(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":k(t);break;case"rebelSpirit":T(t);break;case"rebelHeart":C(t);break;case"bushido":B(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":b(t);case"toxicFrets":P(t);break;case"ashenEncore":w(t);break;case"edoEruption":M(t);break;case"steelToe":D(t);break;case"deadTokugawas":E(t);break;case"gundanSeizai":I(t);break;case"LustForLife":A(t);break;case"PunksNotDead":O(t);break;case"soulSquatter":R(t);break;case"bouncingSoles":$(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":F(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),s(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function s(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),N(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:l,poisonPlayed:m,healPlayed:p,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:h,reduceTargetStrengthPlayed:y,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&n>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=n>0?2*(1+n):2,S=l?1:0,u=t===gameState.enemy1?1.5:1;return{damagePlayed:r?11:i(e.damage),firePlayed:u*(g?2*n:o?13:i(e.fire)),stancePointsPlayed:g&&a?-1:i(e.stancePoints),poisonPlayed:s?t.poison:i(e.poison)+S,healPlayed:i(e.heal),strengthPlayed:i(e.strength),armorPlayed:p?-n:i(e.armor),reduceTargetArmorPlayed:d?c:i(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:i(e.reduceTargetStrength),drawCardPlayed:i(e.drawCard),poisonRemovePlayed:i(e.poisonRemove)}}(t,a,n),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));r&&(gameState.player.lifeStealCounter+=o*k*r),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=h,a.poison+=m,a.health-=T,a.armor>0&&T>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),N(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),L(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];N(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&u(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&u(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),p&&(gameState.player.health=Math.min(gameState.player.health+p,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+l>=-3&&gameState.player.stancePoints+l<=3&&(gameState.player.stancePoints+=l,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),G(a),e.updateHealthBar(a),z(gameState.player),U(a),d(),g(),L(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&N(gameState.actionText,200),gameState.actionTextBackground&&N(gameState.actionTextBackground,200)}))}function i(e){return"function"==typeof e?e():e}function l(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{N(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),K(t),gameState.toxicAvenger&&t.poison>0&&G(t);let r=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{N(t.poisonText),N(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),G(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),"doubleDiscard"===a.debuffCard?(a.debuffCard="discard",m(t,a),a.debuffCard="doubleDiscard",e.time.delayedCall(2200,(()=>{e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,""),e.time.delayedCall(400,(()=>{a.debuffCard="discard",m(t,a)}))}))):a.debuffCard?m(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Junior Goblin\nApprentice of poison",t.sprite=e.add.sprite(560,380,"goblin1"),t.sprite.setScale(.16).setFlipX(!0).setAlpha(0).setInteractive(),t.health=30,t.healthMax=30,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Goblin";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),U(t),G(t)}));const r="doubleDiscard"===a.debuffCard?4500:gameState.debuffCardPlayed?1800:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&N(gameState.actionText,200),gameState.actionTextBackground&&N(gameState.actionTextBackground,200),t.turnComplete=!0,d()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?l():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),n()))}))}(t,a)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,l()))}function m(t,a){return new Promise((n=>{gameState.debuffCardPlayed=!0;let r=0;const o=t.cardKey;const s="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,i="draw"===a.debuffCard?"Draw pile":"Discard Pile",l="draw"===a.debuffCard?120:980;e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const m=[{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];s.push(...m);const g=[e.add.image(450,450,o).setScale(.45).setOrigin(.5).setDepth(300),e.add.image(650,450,o).setScale(.45).setOrigin(.5).setDepth(300)];let d=`Adds 2 ${{ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"}[o]} to your ${i}`;gameState.actionText.y=250,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(2300,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:l,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===g.length&&n()}})}))}))}))}function g(){3===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"doubleDiscard",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 10 HP\nGains 2 armor",probability:1}]:1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Goblin",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Goblin",summonEnemy:2,probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:5===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 3 armor",probability:1}]:gameState.enemy2&&gameState.enemy2.alive?gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.23+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 10 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Goblin",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Goblin",summonEnemy:2,probability:.33},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.162:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.16:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:2,text:"Heals 10 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.11},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.06+(gameState.enemy1.health>=gameState.enemy1.healthMax?.16:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.16:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.05+(gameState.enemy1.health>=gameState.enemy1.healthMax?.16:0)/5}],gameState.enemy2&&(gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.25+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/3},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/3},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.2},{key:"Intends to\nPoison you",damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 3 poison",probability:.4+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/3}])}function d(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),j(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&u(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&N(gameState.actionText,200);gameState.actionTextBackground&&N(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have cleared Level ${n}\nHealth is resorted to ${gameState.player.healthMax}/${gameState.player.healthMax}`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=5,n=250,r=100;gameState.goldCollected=!1;const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=3===s?`Collect loot and get\nready for Level ${o+1}!`:"  Collect loot and get\nready for your next fight!",l={fontSize:"40px",fill:"#ff0000"},m=e.add.text(550,130,i,l).setOrigin(.5).setDepth(103),g=e.add.graphics();e.updateTextAndBackground(m,g,i),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const d=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{S(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,u(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*n,"rectangularButton"),S=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*n,"rectangularButton"),y=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*n,"rectangularButton"),x=e.add.text(t,a+3*n,"Exit Shop",m);let k=[];const T=[g,f,c,u],C=[d,x,S,y];let B=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,_:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),h(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();k.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(s),k.forEach((e=>{e&&e.destroy()})),p(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&N(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{N(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{N(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...d,m,g];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,p()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),j(),N(gameState.actionText,200),N(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function p(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&N(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{N(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{N(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],S(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),h(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),p(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function c(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function S(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function u(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function h(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function y(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>G(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(h(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,z(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,z(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),L(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function f(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function x(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function k(e){gameState.foreverTrue=!1,x(e),L(8)}function T(t){gameState.rebelSpirit=!1,x(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function C(t){gameState.rebelHeart=!1,x(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function B(e){gameState.bushido=!1,x(e),gameState.player.strengthBase+=6,z(gameState.player)}function v(e){gameState.toxicAvenger=!1,x(e),gameState.enemies.forEach((e=>{e.poison+=4,G(e)}))}function b(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),U(n),d(),z(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,x(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),U(t),d())}))}function w(t){gameState.ashenEncore=!1,x(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),U(t),d()}))}function M(e){gameState.edoEruption=!1,x(e)}function D(t){gameState.steelToe=!1,x(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,G(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function E(e){gameState.redrawPrice+=1,x(e)}function I(e){gameState.gundanSeizai=!1,u(3),x(e)}function A(t){gameState.lustForLife=!1,x(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{N(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function O(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),x(t)}function R(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,x(e)}function $(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),x(e)}function H(e){x(e)}function F(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,z(gameState.player),x(e)}function z(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),G(e)}function G(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function U(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void O(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(u(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{N(e,500)}))}}function j(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),N(e.sprite,200)}}function L(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),U(t),d(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){o(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function N(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function K(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),j(),z(gameState.player),g(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,N(e.intentionText,200),N(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),l()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(L(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,U(e),d(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight1 extends BaseScene{self;constructor(){super("Level3Fight1")}preload(){this.load.image("bakgrunnLair1","assets/images/bakgrunnLair1.jpg"),this.load.image("theDemonLair","assets/images/theDemonLair.jpg"),this.load.image("voidling","assets/images/sprites/voidling.png"),this.load.image("demon2","assets/images/sprites/demon2.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;this.saveGameState(e.scene.key),this.baseCreate("bakgrunnLair1"),this.resetPlayer(gameState.player,.41,350,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{_(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{_(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Infernus",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(840,315,"demon2").setScale(.3).setFlipX(!1).setInteractive(),gameState.enemy1.health=80,gameState.enemy1.healthMax=80,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Voidling",gameState.enemy2.cardKey="hellFire",gameState.enemy2.sprite=e.add.sprite(630,370,"voidling"),gameState.enemy2.sprite.setScale(.3).setFlipX(!1).setInteractive(),gameState.enemy2.health=25,gameState.enemy2.healthMax=25,gameState.enemy2.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#d1d1d1"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),v(a),B(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theDemonLair").setScale(.87).setOrigin(.02,0).setDepth(300),n=this.add.text(550,270,"Level 3:",t).setDepth(301).setOrigin(.5),r=this.add.text(550,430,"The Demons' Lair",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){C(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],g(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key),n=`Level ${t}\nFight ${a}!`;gameState.startText=e.add.text(550,320,n,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{_(gameState.startText,500)})),async function(){let t="",a="";const n=400,r=200,o={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>_(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),m()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),n=gameState.taunts.splice(e,1)[0];t=n.enemy,a=n.player}let s=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(s,g,"",o).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*n),gameState.skipIntro)return;if(await l(d,p,t,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;_(d,r),_(p,r),s=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(s,g,"",o).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await l(c,S,a,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{_(e,r)})),gameState.skipIntro||(await e.delay(r),e.input.keyboard.off("keydown",i,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||m())}(),e.input.keyboard.on("keydown",i,this),e.input.on("pointerup",i,this)}))}function i(){gameState.skipTaunts()}async function l(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function m(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),Z(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),W(gameState.player),y(),K(gameState.player),e.shuffleDeck(gameState.drawPile);const r=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(r,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>_(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let n="Heads up:\nDemons fight\nwith Fire!";const r=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(r,o,n),e.time.delayedCall(3e3,(()=>{_(r,200),_(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),g(t),gameState.enemies.forEach((e=>{u(),h(e),q(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{u(),h(e),q(e)})),g(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,_(a,2e3),_(n,2e3),_(r,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,_(a,2e3),_(n,2e3),_(r,2e3),e.time.delayedCall(2200,s()))})),e.input.keyboard.on("keydown",(()=>{o||(o=!0,_(a,2e3),_(n,2e3),_(r,2e3),e.time.delayedCall(2200,s()))}));function g(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+n];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),d(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function d(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&C(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),p(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;p(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),v(t),B(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":P(t);break;case"rebelSpirit":w(t);break;case"rebelHeart":M(t);break;case"bushido":D(t);break;case"toxicAvenger":E(t);break;case"kirisuteGomen":I(t);case"toxicFrets":A(t);break;case"ashenEncore":O(t);break;case"edoEruption":R(t);break;case"steelToe":$(t);break;case"deadTokugawas":H(t);break;case"gundanSeizai":F(t);break;case"LustForLife":z(t);break;case"PunksNotDead":G(t);break;case"soulSquatter":U(t);break;case"bouncingSoles":j(t);break;case"enduringSpirit":L(t);break;case"shogunsShell":N(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),p(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function p(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),_(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:i,poisonPlayed:l,healPlayed:m,strengthPlayed:g,armorPlayed:d,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:S,drawCardPlayed:h,poisonRemovePlayed:f}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&n>0,g="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const p=n>0?2*(1+n):2,S=i?1:0;return{damagePlayed:r?11:c(e.damage),firePlayed:m?2*n:o?13:c(e.fire),stancePointsPlayed:m&&a?-1:c(e.stancePoints),poisonPlayed:s?t.poison:c(e.poison)+S,healPlayed:c(e.heal),strengthPlayed:c(e.strength),armorPlayed:d?-n:c(e.armor),reduceTargetArmorPlayed:g?p:c(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:c(e.reduceTargetStrength),drawCardPlayed:c(e.drawCard),poisonRemovePlayed:c(e.poisonRemove)}}(t,a,n),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+o*x));r&&(gameState.player.lifeStealCounter+=o*x*r),a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=S,a.armor-=p,a.poison+=l,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=g:gameState.player.strengthCard+=g,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),_(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),X(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];_(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&T(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&T(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,l,g,d,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),Y(a),e.updateHealthBar(a),K(gameState.player),W(a),y(),u(),X(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&_(gameState.actionText,200),gameState.actionTextBackground&&_(gameState.actionTextBackground,200)}))}function c(e){return"function"==typeof e?e():e}function S(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{_(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),Z(t),gameState.toxicAvenger&&t.poison>0&&Y(t);let n=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(n+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(n,(()=>{_(t.poisonText),_(t.poisonTextBackground);const a=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),Y(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((n=>{gameState.debuffCardPlayed=!0;let r=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===h.length&&n()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(630,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),W(t),Y(t)}));const n=gameState.debuffCardPlayed?1500:1200;e.time.delayedCall(n,(()=>{if(gameState.actionText&&_(gameState.actionText,200),gameState.actionTextBackground&&_(gameState.actionTextBackground,200),t.turnComplete=!0,!y()&&(gameState.enemies[gameState.currentEnemyIndex].turnComplete||!gameState.enemies[gameState.currentEnemyIndex].alive))if(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length)S();else{gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))}));const t=gameState.debuffCardPlayed?500:250;e.time.delayedCall(t,(()=>m()))}}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,S()))}function u(){gameState.enemy2&&gameState.enemy2.alive?1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:2,armor:5,reduceTargetStrength:0,reduceTargetArmor:0,text:"Heals 10 HP\nGains 2 Strength\nAnd 5 Armor",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 Fire damage",probability:.2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strenght",probability:.09+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 Armor",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.05}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:2}],gameState.enemy2&&(gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.5}])}function h(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function y(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),V(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&T(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&_(gameState.actionText,200);gameState.actionTextBackground&&_(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have completed Level ${n}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="Collect loot and get\n ready for Level 3!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{k(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,T(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*n,"rectangularButton"),c=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*n,"rectangularButton"),u=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),h=e.add.image(t,a+3*n,"rectangularButton"),y=e.add.text(t,a+3*n,"Exit Shop",m);let x=[];const k=[g,h,p,S],T=[d,y,c,u];let B=[...k,...T,gameState.shopBackground];k.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),T.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),C(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))})),x.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();x.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(x=x.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),C(s),x.forEach((e=>{e&&e.destroy()})),f(210),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),C(i),x.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&_(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{_(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{k.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,k.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{_(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,f()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),V(),_(gameState.actionText,200),_(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function f(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&_(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{_(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,x())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,x())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{_(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],k(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),C(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),f(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function x(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function k(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function T(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function C(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function B(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,K(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>Y(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,K(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?I(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(C(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?G(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?U(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?j(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?L(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?N(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,K(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,K(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),X(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function v(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function b(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function P(e){gameState.foreverTrue=!1,b(e),X(8)}function w(t){gameState.rebelSpirit=!1,b(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function M(t){gameState.rebelHeart=!1,b(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function D(e){gameState.bushido=!1,b(e),gameState.player.strengthBase+=6,K(gameState.player)}function E(e){gameState.toxicAvenger=!1,b(e),gameState.enemies.forEach((e=>{e.poison+=4,Y(e)}))}function I(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),W(n),y(),K(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function A(t){gameState.toxicFrets=!1,b(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),W(t),y())}))}function O(t){gameState.ashenEncore=!1,b(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),W(t),y()}))}function R(e){gameState.edoEruption=!1,b(e)}function $(t){gameState.steelToe=!1,b(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,Y(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function H(e){gameState.redrawPrice+=1,b(e)}function F(e){gameState.gundanSeizai=!1,T(3),b(e)}function z(t){gameState.lustForLife=!1,b(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{_(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function G(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),b(t)}function U(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,b(e)}function j(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),b(e)}function L(e){b(e)}function N(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,K(gameState.player),b(e)}function K(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),Y(e)}function Y(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function W(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void G(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(T(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{_(e,500)}))}}function V(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),_(e.sprite,200)}}function X(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),W(t),y(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){d(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function q(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,r=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*r,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function _(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function Z(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),V(),K(gameState.player),u(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,_(e.intentionText,200),_(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),S()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(X(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,W(e),y(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight2 extends BaseScene{self;constructor(){super("Level3Fight2")}preload(){this.load.image("bakgrunnLair2","assets/images/bakgrunnLair2.jpg"),this.load.image("skeleton1","assets/images/sprites/skeleton1.png"),this.load.image("skeleton2","assets/images/sprites/skeleton2.png"),this.load.image("voidling","assets/images/sprites/voidling.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function n(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),K(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),U(gameState.player),d(),z(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>N(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{g(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,n={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,n),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),r(t)}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnLair2"),this.resetPlayer(gameState.player,.42,320,355),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{N(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{N(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Bonebaron",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(830,310,"skeleton2").setScale(.35).setFlipX(!1).setInteractive(),gameState.enemy1.health=120,gameState.enemy1.healthMax=120,gameState.enemy1.armor=0,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),f(a),y(a))})),function(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){h(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],r(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}!`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{N(gameState.startText,500)})),async function(){let r="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>N(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),n()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];r=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,r,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;N(d,i),N(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{N(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||n())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();function r(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),o(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function o(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&h(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),s(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;s(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),f(t),y(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":k(t);break;case"rebelSpirit":T(t);break;case"rebelHeart":C(t);break;case"bushido":B(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":b(t);case"toxicFrets":P(t);break;case"ashenEncore":w(t);break;case"edoEruption":M(t);break;case"steelToe":D(t);break;case"deadTokugawas":E(t);break;case"gundanSeizai":I(t);break;case"LustForLife":A(t);break;case"PunksNotDead":O(t);break;case"soulSquatter":R(t);break;case"bouncingSoles":$(t);break;case"enduringSpirit":H(t);break;case"shogunsShell":F(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),s(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function s(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),N(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:l,poisonPlayed:m,healPlayed:p,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:h,reduceTargetStrengthPlayed:y,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&n>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=n>0?2*(1+n):2,S=l?1:0;return{damagePlayed:r?11:i(e.damage),firePlayed:g?2*n:o?13:i(e.fire),stancePointsPlayed:g&&a?-1:i(e.stancePoints),poisonPlayed:s?t.poison:i(e.poison)+S,healPlayed:i(e.heal),strengthPlayed:i(e.strength),armorPlayed:p?-n:i(e.armor),reduceTargetArmorPlayed:d?c:i(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:i(e.reduceTargetStrength),drawCardPlayed:i(e.drawCard),poisonRemovePlayed:i(e.poisonRemove)}}(t,a,n),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));a!=gameState.player&&(r&&(gameState.player.lifeStealCounter+=o*k*r),gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=h,a.poison+=m,a.health-=T),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),N(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),L(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];N(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&u(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&u(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),p&&(gameState.player.health=Math.min(gameState.player.health+p,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+l>=-3&&gameState.player.stancePoints+l<=3&&(gameState.player.stancePoints+=l,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),G(a),e.updateHealthBar(a),z(gameState.player),U(a),d(),g(),L(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&N(gameState.actionText,200),gameState.actionTextBackground&&N(gameState.actionTextBackground,200)}))}function i(e){return"function"==typeof e?e():e}function l(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{N(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),K(t),gameState.toxicAvenger&&t.poison>0&&G(t);let r=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{N(t.poisonText),N(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),G(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((n=>{gameState.debuffCardPlayed=!0;let r=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===h.length&&n()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(650,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),m(t,500)}(),3==a.summonEnemy&&function(){gameState.enemy3=Object.create(gameState.enemy);const t=gameState.enemy3;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(510,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),m(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),U(t),G(t)}));const r=gameState.debuffCardPlayed?1800:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&N(gameState.actionText,200),gameState.actionTextBackground&&N(gameState.actionTextBackground,200),t.turnComplete=!0,d()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?l():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),n()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,l()))}function m(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}function g(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:2}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:3}]:gameState.enemy2&&gameState.enemy2.alive?gameState.enemy3&&gameState.enemy3.alive?gameState.enemy1.actions=[{key:"Intends to\nDeal 8 fire damage",damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 fire damage",probability:.05+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.3+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.2+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.14},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.07+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.07}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:.7,summonEnemy:3},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.3}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:.7,summonEnemy:2},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.3}],gameState.enemy2&&(gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.5}]),gameState.enemy3&&(gameState.enemy3.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.5}])}function d(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),j(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&u(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&N(gameState.actionText,200);gameState.actionTextBackground&&N(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have completed Level ${n}\nHealth is resorted to Health Max`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{S(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,u(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*n,"rectangularButton"),S=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*n,"rectangularButton"),y=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*n,"rectangularButton"),x=e.add.text(t,a+3*n,"Exit Shop",m);let k=[];const T=[g,f,c,u],C=[d,x,S,y];let B=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),h(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();k.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(s),k.forEach((e=>{e&&e.destroy()})),p(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),h(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&N(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{N(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{N(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,p()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),j(),N(gameState.actionText,200),N(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function p(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&N(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{N(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,c())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{N(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],S(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),h(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),p(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function c(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function S(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function u(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function h(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function y(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>G(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,z(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(h(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,z(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,z(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),L(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function f(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function x(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function k(e){gameState.foreverTrue=!1,x(e),L(8)}function T(t){gameState.rebelSpirit=!1,x(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function C(t){gameState.rebelHeart=!1,x(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function B(e){gameState.bushido=!1,x(e),gameState.player.strengthBase+=6,z(gameState.player)}function v(e){gameState.toxicAvenger=!1,x(e),gameState.enemies.forEach((e=>{e.poison+=4,G(e)}))}function b(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),U(n),d(),z(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,x(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),U(t),d())}))}function w(t){gameState.ashenEncore=!1,x(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),U(t),d()}))}function M(e){gameState.edoEruption=!1,x(e)}function D(t){gameState.steelToe=!1,x(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,G(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function E(e){gameState.redrawPrice+=1,x(e)}function I(e){gameState.gundanSeizai=!1,u(3),x(e)}function A(t){gameState.lustForLife=!1,x(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{N(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function O(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),x(t)}function R(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,x(e)}function $(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),x(e)}function H(e){x(e)}function F(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,z(gameState.player),x(e)}function z(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),G(e)}function G(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function U(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void O(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(u(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{N(e,500)}))}}function j(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),N(e.sprite,200)}}function L(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),U(t),d(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){o(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function N(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function K(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),j(),z(gameState.player),g(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,N(e.intentionText,200),N(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),l()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(L(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,U(e),d(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight3 extends BaseScene{self;constructor(){super("Level3Fight3")}preload(){this.load.image("bakgrunnLair3","assets/images/bakgrunnLair3.jpg"),this.load.image("wraith1","assets/images/sprites/wraith1.png"),this.load.image("wraith2","assets/images/sprites/wraith2.png"),this.load.image("voidling","assets/images/sprites/voidling.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;function t(){gameState.skipTaunts()}async function a(t,a,n,r){return new Promise((o=>{let s=0,i="";const l=()=>{gameState.skipIntro?o():s<n.length?(i+=n.charAt(s),t.setText(i),e.updateTextAndBackground(t,a,i,7,r),s++,e.time.delayedCall(33.4,l)):o()};l()}))}function n(){gameState.fightStarted=!0,gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;let t=gameState.player.numCardsBase+gameState.player.numCardsStance;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(a,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),W(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),j(gameState.player),p(),G(gameState.player),e.shuffleDeck(gameState.drawPile),gameState.enemy1&&gameState.enemy1.alive&&(gameState.enemy1.armor=15,U(gameState.enemy1));const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,n].forEach((e=>Y(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let n="Soulripper start each\nturn with full Armor,\nand lose 1 Armor\nper damage recieved";const o=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,n),e.time.delayedCall(4500,(()=>{Y(o,200),Y(s,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),r(t),gameState.enemies.forEach((e=>{g(),d(e),K(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{g(),d(e),K(e)})),r(t))}))}this.saveGameState(e.scene.key),this.baseCreate("bakgrunnLair3"),this.resetPlayer(gameState.player,.41,350,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),gameState.drawPile=[...gameState.deck],function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,n=gameState.drawPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{Y(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,n=gameState.discardPile.length<12?400:250,r=150,o=e.add.text(550,r-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=n+s%t*a,l=r+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{Y(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Soulripper",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(770,305,"wraith2").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy1.health=90,gameState.enemy1.healthMax=90,gameState.enemy1.armor=2,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),this.updateManaBar(gameState.player),this.updateHealthBar(gameState.player),gameState.permanents.forEach((t=>{const a=t.card,n=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?n.available=!0:(a.tokenSprite=e.add.sprite(n.x,n.y,a.token).setScale(1).setDepth(210).setInteractive(),n.available=!1,a.tokenSlot=n,console.log(`Recreated permanent: ${a.key}\nfor slot ${n.index}`),x(a),f(a))})),function(){gameState.turn=0,gameConfig.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){y(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],r(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive(),gameState.startFightObjects=[];const{level:o,fight:s}=e.extractLevelFightFromName(e.scene.key),i=`Level ${o}\nFight ${s}`;gameState.startText=e.add.text(550,320,i,{fontSize:"75px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.startFightObjects.push(gameState.startText),e.time.delayedCall(350,(()=>{gameConfig.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{gameState.startText.setText("Fight!"),gameState.startText.setStyle({fontSize:"100px"}),e.time.delayedCall(2300,(()=>{Y(gameState.startText,500)})),async function(){let r="",o="";const s=400,i=200,l={fontSize:"20px",fill:"#000000"};if(gameState.skipTaunts=async()=>{gameState.skipIntro||(gameState.skipIntro=!0,gameState.startFightObjects.forEach((e=>Y(e,200))),await e.delay(300),gameState.fightStarted||(e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),n()))},gameState.skipIntro)return;gameState.taunts||(gameState.taunts=gameState.extraTaunts);if(gameState.taunts.length>0){const e=Math.floor(Math.random()*gameState.taunts.length),t=gameState.taunts.splice(e,1)[0];r=t.enemy,o=t.player}let m=gameState.enemy1.x,g=gameState.enemy1.y-200,d=e.add.text(m,g,"",l).setOrigin(.5);const p=e.add.graphics();if(gameState.startFightObjects.push(d,p),await e.delay(2*s),gameState.skipIntro)return;if(await a(d,p,r,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;Y(d,i),Y(p,i),m=gameState.player.x,g=gameState.player.y-200;let c=e.add.text(m,g,"",l).setOrigin(.5);const S=e.add.graphics();if(gameState.startFightObjects.push(c,S),await a(c,S,o,301),gameState.skipIntro)return;if(await e.delay(1e3),gameState.skipIntro)return;gameState.startFightObjects.forEach((e=>{Y(e,i)})),gameState.skipIntro||(await e.delay(i),e.input.keyboard.off("keydown",t,this),e.time.removeAllEvents(),await e.delay(50),gameState.fightStarted||n())}(),e.input.keyboard.on("keydown",t,this),e.input.on("pointerup",t,this)}))}();function r(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(80*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),r=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(r),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,r),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),o(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function o(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,n=gameState.player.mana>=gameState.costPlayed,r=!1===gameState.playingCard&&!t.usedOneShot;if(a&&n&&r)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&y(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameConfig.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),s(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const r=n===e.length-1;s(t,a,r)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),x(t),f(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":T(t);break;case"rebelSpirit":C(t);break;case"rebelHeart":B(t);break;case"bushido":v(t);break;case"toxicAvenger":b(t);break;case"kirisuteGomen":P(t);case"toxicFrets":w(t);break;case"ashenEncore":M(t);break;case"edoEruption":D(t);break;case"steelToe":E(t);break;case"deadTokugawas":I(t);break;case"gundanSeizai":A(t);break;case"LustForLife":O(t);break;case"PunksNotDead":R(t);break;case"soulSquatter":$(t);break;case"bouncingSoles":H(t);break;case"enduringSpirit":F(t);break;case"shogunsShell":z(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),s(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function s(t,a,n=!1){gameState.playingCard=!0,gameConfig.targetingCursor.setVisible(!1),Y(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const r=gameState.player.lifeStealBase+gameState.player.lifeStealThisTurn,{damagePlayed:o,firePlayed:s,stancePointsPlayed:l,poisonPlayed:m,healPlayed:d,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:y,drawCardPlayed:f,poisonRemovePlayed:x}=function(e,t,a=!1){const n=gameState.player.stancePoints,r="moshpitMassacre"===e.key&&n>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&n>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&n<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=n>0?2*(1+n):2,S=l?1:0;return{damagePlayed:r?11:i(e.damage),firePlayed:g?2*n:o?13:i(e.fire),stancePointsPlayed:g&&a?-1:i(e.stancePoints),poisonPlayed:s?t.poison:i(e.poison)+S,healPlayed:i(e.heal),strengthPlayed:i(e.strength),armorPlayed:p?-n:i(e.armor),reduceTargetArmorPlayed:d?c:i(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:i(e.reduceTargetStrength),drawCardPlayed:i(e.drawCard),poisonRemovePlayed:i(e.poisonRemove)}}(t,a,n),k=(1+.1*gameState.player.strength)*(1-a.armor/20),T=Math.round(Math.max(0,s+o*k));r&&(gameState.player.lifeStealCounter+=o*k*r),a!=gameState.player&&(gameState.score.damageDealt+=T,console.log(`${o} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=u,a.poison+=m,a.health-=T,a.armor>0&&T>0&&(a.armor=Math.max(0,a.armor-T))),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,n){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,n=105,r=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=r+i%a*n,m=o+1.5*Math.floor(i/a)*n,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),Y(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),N(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&!gameState.bassSoloPlayed&&function(){gameState.bassSoloPlayed=!0;const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];Y(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&h(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&h(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.player.lifeStealThisTurn+=.2,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*n,gameState.player.health+=2*n,gameConfig.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.manaBase+=1,gameState.player.health-=6,e.updateManaBar(gameState.player),gameState.player.alive&&(gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameConfig.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=7,gameConfig.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"riotRonin"===a.key&&(a.goldCost+=1,t.chosenAction={key:"Intends to\nSkip a Turn",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Skips a Turn",probability:1},t.intentionText.setText("Intends to\nSkip a Turn"));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-x),function(t,a,n,r,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8});const n=t>0?`Deals ${t} damage`:"",r=a>0?`Deals ${a} Poison`:"",o=a&&t?`${n}\n\n${r}`:a?r:n;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(n>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${n} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(r>0){gameConfig.powerUpSound.play({volume:.15});const t=`Gains ${r} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameConfig.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(T,m,c,S,x),gameState.player.stancePoints+l>=-3&&gameState.player.stancePoints+l<=3&&(gameState.player.stancePoints+=l,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),U(a),e.updateHealthBar(a),G(gameState.player),j(a),p(),g(),N(f),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&Y(gameState.actionText,200),gameState.actionTextBackground&&Y(gameState.actionTextBackground,200)}))}function i(e){return"function"==typeof e?e():e}function l(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,a);const r=[t.turnText,n];if(gameState.player.lifeStealCounter){const a=Math.floor(gameState.player.lifeStealCounter),n=gameState.player.health+a<gameState.player.healthMax?a:gameState.player.healthMax-gameState.player.health;if(gameState.player.health+=n,e.updateHealthBar(gameState.player),gameState.player.lifeStealCounter=0,n){const a=`You stole ${n} HP`;t.lifeStealText=e.add.text(550,380,a,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),t.lifeStealTextBackground=e.add.graphics(),e.updateTextAndBackground(t.lifeStealText,t.lifeStealTextBackground,a),r.push(t.lifeStealText,t.lifeStealTextBackground)}}e.time.delayedCall(1700,(()=>{r.forEach((e=>{Y(e,100)}))}))}t.turnComplete=!1,function(t){const a=t.lifeStealText?450:380;t.poisonText=e.add.text(550,a,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),W(t),gameState.toxicAvenger&&t.poison>0&&U(t);let r=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{Y(t.poisonText),Y(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),U(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),"doubleDiscard"===a.debuffCard?(a.debuffCard="discard",m(t,a),a.debuffCard="doubleDiscard",e.time.delayedCall(2200,(()=>{e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,""),e.time.delayedCall(400,(()=>{a.debuffCard="discard",m(t,a)}))}))):a.debuffCard?m(t,a):gameState.debuffCardPlayed=!1,2==a.summonEnemy&&function(){gameState.enemy2=Object.create(gameState.enemy);const t=gameState.enemy2;t.name="Voidling",t.cardKey="hellFire",t.sprite=e.add.sprite(570,370,"voidling"),t.sprite.setScale(.3).setFlipX(!1).setAlpha(0).setInteractive(),t.health=25,t.healthMax=25,t.armor=0,t.height=t.sprite.displayHeight,t.width=t.sprite.displayWidth,t.x=t.sprite.x,t.y=t.sprite.y;let a="Summons a Voidling";e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a),function(t,a){e.tweens.add({targets:t.sprite,alpha:1,ease:"Power1",duration:a,onComplete:function(){console.log("fade-in complete"),e.addHealthBar(t,t.healthBarColor),e.addStatsDisplay(t,450),e.describeCharacter(t),gameState.summonedEnemies.push(t)}},e)}(t,500)}(),a.damage>0||a.fire>0||a.poison>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameConfig.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let r=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameConfig.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameConfig.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t,a){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),j(t),U(t)}));const r="doubleDiscard"===a.debuffCard?4500:gameState.debuffCardPlayed?1800:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&Y(gameState.actionText,200),gameState.actionTextBackground&&Y(gameState.actionTextBackground,200),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?l():(gameState.currentEnemyIndex=0,gameState.summonedEnemies.forEach((e=>{e.alive&&!gameState.enemies.includes(e)&&(gameState.enemies.unshift(e),gameState.characters.unshift(e))})),n()))}))}(t,a)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,l()))}function m(t,a){return new Promise((n=>{gameState.debuffCardPlayed=!0;let r=0;const o=t.cardKey;const s="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,i="draw"===a.debuffCard?"Draw pile":"Discard Pile",l="draw"===a.debuffCard?120:980;e.attackTweens(t,60),gameConfig.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const m=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];s.push(...m);const g=[e.add.image(450,450,o).setScale(.45).setOrigin(.5).setDepth(300),e.add.image(650,450,o).setScale(.45).setOrigin(.5).setDepth(300)];let d=`Adds 2 ${{ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"}[o]} to your ${i}`;gameState.actionText.y=250,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(2300,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:l,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===g.length&&n()}})}))}))}))}function g(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"doubleDiscard",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:1,summonEnemy:2}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:1}]:gameState.enemy2&&gameState.enemy2.alive?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.45+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/3},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.15:0)/3},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:1,armor:0,text:"Heals 10 HP\nGains 1 strenght",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.1},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:2,armor:0,text:"Heals 10 HP\nGains 2 strenght",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.05+(gameState.enemy1.health>=gameState.enemy1.healthMax?.1:0)/3},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.15},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"doubleDiscard",probability:.05}]:gameState.enemy1.actions=[{key:"Intends to\nSummon a Voidling",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Summons a Voidling",probability:.4,summonEnemy:2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.3+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.05:0)/4}],gameState.enemy2&&(gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.5}])}function d(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameConfig.music.stop(),e.updateManaBar(gameState.player),L(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameConfig.attackSound.isPlaying&&gameConfig.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&h(1),gameConfig.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&Y(gameState.actionText,200);gameState.actionTextBackground&&Y(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};let a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);const{level:n,fight:r}=e.extractLevelFightFromName(e.scene.key),o=3===r?3e3:100,s=3===r?`You have cleared Level ${n}\nLevel 4 is comming in the next patch :)`:"";e.time.delayedCall(1600,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),a.setText(s),a.setStyle({fontSize:"60px"}),e.time.delayedCall(o,(()=>{a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,n=250,r=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,n,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,n,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,n+r,"rectangularButton"),gameState.enterShopText=e.add.text(550,n+r,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,n+2*r,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,n+2*r,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{u(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,h(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,n=80,r=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${r} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*n,"rectangularButton"),S=e.add.text(t,a+1*n,` Buy 1 Card\nCost: ${s} Gold`,m),u=e.add.image(t,a+2*n,"rectangularButton"),h=e.add.text(t,a+2*n,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*n,"rectangularButton"),x=e.add.text(t,a+3*n,"Exit Shop",m);let k=[];const T=[g,f,p,u],C=[d,x,S,h];let B=[...T,...C,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),C.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t=`Welcome to my shop,\n${gameState.player.name}!`;let a="";const n=30;gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(r*n,(()=>{a+=t.charAt(r),gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),B.push(gameState.shopWelcomeText,gameState.shopTextBackground);const v="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!v,{level:P,fight:w}=e.extractLevelFightFromName(e.scene.key);v&&(g.on("pointerover",(function(){const n={fontSize:"25px",fill:"#000000"},r=`Health was reset to Max Health\n  Upon completion of Level ${P}`;gameState.healthResetText=e.add.text(t+400,a,"",n).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,r,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),y(o),gameState.player.health=Math.min(gameState.player.health+r,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${r} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const n=e.add.graphics();k.push(a,n),B.push(a,n),e.updateTextAndBackground(a,n,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=n)),B=B.filter((e=>e!=a&&e!=n)),a.destroy(),n.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),y(s),k.forEach((e=>{e&&e.destroy()})),c(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),u.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),y(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,n=120,r=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%r*n,g=s+Math.floor(l/r)*n,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&Y(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{Y(i.sprite,250)}));const t="Removed 1 card",n=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),r=e.add.graphics();e.updateTextAndBackground(n,r,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{n.destroy(),r.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{Y(e,200)})),e.time.delayedCall(250,(()=>{B.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,c()}))}()}))}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),L(),Y(gameState.actionText,200),Y(gameState.actionTextBackground,200),gameConfig.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameConfig.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((n,r)=>{console.log(`bonusCard.key: ${n.key}`),n.sprite=e.add.image(340+210*r,340,n.key),n.sprite.setScale(.45).setInteractive().setDepth(t),n.sprite.on("pointerover",(()=>{gameConfig.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(n.sprite,.58,200)}),e),n.sprite.on("pointerout",(()=>{e.cardTweens(n.sprite,.45,400)}),e),n.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},n);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==n&&Y(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===n&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=n)))})),e.tweens.add({targets:n.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{Y(e,200)}));const r="Gained 1 card",o=e.add.text(550,180,r,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,r,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,S())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,S())}))):(o.destroy(),s.destroy(),e.time.delayedCall(1e3,(()=>{Y(n.sprite,500),e.time.delayedCall(500,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,n,r){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],u(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),y(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),n.forEach((e=>{e.sprite&&e.sprite.destroy()})),c(r)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function S(){let t;for(let a=0;a<gameConfig.levels.length;a++)if(e.scene.key===gameConfig.levels[a]){t=a+1<gameConfig.levels.length?gameConfig.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameConfig.levels")}function u(e,t,a=1.1,n=.9){e.setScale(a,n).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function h(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameConfig.coinSound.play({volume:.8,seek:.02})}))}function y(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function f(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>U(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,G(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?P(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const n=7,r=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(r,o,"rectangularButton").setScale(.45).setOrigin(.5).setDepth(8).setInteractive(),gameState.healText=e.add.text(r,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(9),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(r-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(r,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButtonObjects=[gameState.healButton,gameState.healText],gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(8),gameState.healText.setDepth(9),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(y(a),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+n),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${n} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("soulSquatter"===t.key)gameState.player.lifeStealBase+=.15,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("bouncingSoles"===t.key)t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}));else if("enduringSpirit"===t.key)gameState.fightStarted||(gameState.player.healthMax+=5,updateHealthBar(gameState.player)),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?F(t):e.cameras.main.shake(70,.002,!1)}));else if("shogunsShell"===t.key)gameState.shogunsShellCondition=2,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,n=t.tokenSlot;gameState.kamishimoUberAlles+=1,G(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,G(gameState.player)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,n=t.tokenSlot;const r=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=r!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${r}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,n){n&&(n.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),N(1)}(t,a,n):e.cameras.main.shake(70,.002,!1)}))}}function x(t){t.tokenSprite.on("pointerover",(function(){gameConfig.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function k(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function T(e){gameState.foreverTrue=!1,k(e),N(8)}function C(t){gameState.rebelSpirit=!1,k(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function B(t){gameState.rebelHeart=!1,k(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function v(e){gameState.bushido=!1,k(e),gameState.player.strengthBase+=6,G(gameState.player)}function b(e){gameState.toxicAvenger=!1,k(e),gameState.enemies.forEach((e=>{e.poison+=4,U(e)}))}function P(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((n=>{n.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),n.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),n.sprite.on("pointerup",(function(){n.health<30&&a?(n.health=0,gameConfig.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),j(n),p(),G(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameConfig.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function w(t){gameState.toxicFrets=!1,k(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),j(t),p())}))}function M(t){gameState.ashenEncore=!1,k(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),j(t),p()}))}function D(e){gameState.edoEruption=!1,k(e)}function E(t){gameState.steelToe=!1,k(t),gameConfig.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameConfig.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameConfig.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,U(t),gameConfig.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameConfig.targetingCursor.setVisible(!1),a=!1)}))}))}function I(e){gameState.redrawPrice+=1,k(e)}function A(e){gameState.gundanSeizai=!1,h(3),k(e)}function O(t){gameState.lustForLife=!1,k(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+7*a.stancePoints):a.health,gameConfig.healSound.play({volume:.5}),gameState.healButtonObjects.forEach((e=>{Y(e,200)})),e.powerUpTweens(a),e.updateHealthBar(a)}function R(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameConfig.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),k(t)}function $(e){gameState.player.lifeStealBase-=.1,gameState.player.lifeStealThisTurn+=.3,k(e)}function H(e){gameState.permanentSlots.push({available:!0,x:50,y:130,index:4}),k(e)}function F(e){k(e)}function z(e){gameState.shogunsShellCondition=0,gameState.player.armor=15,G(gameState.player),k(e)}function G(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),gameState.shogunsShellCondition&&gameState.player.stancePoints<0&&(e.armor=Math.min(e.armorMax,e.armor-gameState.player.stancePoints*gameState.shogunsShellCondition)),U(e)}function U(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function j(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void R(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(h(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{Y(e,500)}))}}function L(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),Y(e.sprite,200)}}function N(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameConfig.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),j(t),p(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",n=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameConfig.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{n.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){o(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function K(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(27);const n=e.textures.get("listbox1").getSourceImage().width,r=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*r,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(26)}function Y(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function W(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameConfig.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameConfig.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,gameState.bassSoloPlayed&&(gameState.bassSoloPlayed=!1),gameState.player.lifeStealThisTurn&&(gameState.player.lifeStealThisTurn=0),L(),G(gameState.player),g(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,Y(e.intentionText,200),Y(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),l()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(N(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,j(e),p(),console.log(`${e.name} killed`)}})))}update(){gameConfig.targetingCursor.visible&&(gameConfig.targetingCursor.x=this.input.mousePointer.x,gameConfig.targetingCursor.y=this.input.mousePointer.y)}}function updateLeaderboard(e,t){fetch(`https://www.dreamlo.com/lb/CBGhFikNak2i8KjH3UPThAfGJFnWo9A0O8mjvU19hS2Q/add/${e}/${t}`).then((e=>e.text())).then((e=>console.log(e))).catch((e=>{console.error("Error:",e)}))}class Endscene extends Phaser.Scene{constructor(){super("Endscene")}async getTopScores(){try{const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");if(!e.ok)throw new Error("Failed to fetch leaderboard data");let t=(await e.json()).dreamlo.leaderboard.entry;return t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}catch(e){return console.error(e),null}}preload(){this.load.image("endscene","assets/images/endscene.jpg")}create(){self=this;this.cameras.main.fadeIn(800,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,320,"endscene").setScale(.95).setOrigin(.5,.5).on("pointerup",(()=>n())),this.add.text(550,110,"    Thanks for playing\nPunk Rock Samurai Beta v1.3",{fontSize:"57px",fill:"#a9a9a9",fontFamily:"Rock Kapak"}).setOrigin(.5,.5),gameState.score.totalScore=gameState.score.levelsCompleted>0?gameState.score.levelsCompleted*(15+Math.max(0,7-gameState.score.numberOfTurns/gameState.score.levelsCompleted)):0;let e={numberOfTurns:"Number of turns played",levelsCompleted:"Number of fights won",damageTaken:"Total damage taken",damageDealt:"Total damage dealt",totalScore:"Your score"},t=250,a=200;function n(){console.log("returnto meny called"),gameState.name="",gameState.playerName="",self.cameras.main.shake(1500,.0015,!1),self.cameras.main.flash(500),self.time.delayedCall(500,(()=>{self.cameras.main.fadeOut(1e3),gameState.restartGame=!0,gameConfig.levels.forEach((e=>self.scene.stop(e))),self.scene.stop("Preload"),self.scene.stop("Mainmenu"),self.scene.start("Preload")}))}"admin"!=gameState.playerName&&"Cheater"!=gameState.playerName&&updateLeaderboard(gameState.playerName,gameState.score.totalScore);let r=!1;self.time.delayedCall(600,(()=>{!async function(){try{console.log("displayLeaderBoard called");let n=await self.getTopScores();const r=self.add.graphics();r.fillStyle(16777215,1).setAlpha(.7),r.fillRect(t,a,600,420),self.add.text(300,a+50,"Your Results",{fontSize:"25px",fill:"#000000"}).setOrigin(0),Object.entries(gameState.score).forEach((([t,n])=>{if(console.log(`${t}: ${n}`),e[t]){let r=`${e[t]}: ${n}`;self.add.text(300,a+90,r,{color:"#000",fontSize:"16px"}),a+=20}}));const o={fontSize:"16px",fill:"#000000"};self.add.text(300,a+150,"Leaderboard",{fontSize:"25px",fill:"#000000"}).setOrigin(0),n?n.forEach(((e,t)=>{let n=e.date.split(" ")[0];const r=`${t+1}. Name: ${e.name}, Score: ${e.score}, Date: ${n}`;let s=self.add.text(300,a+190,r,o).setOrigin(0);sceneState.displayedScoreArray.push(s),a+=20})):self.add.text(300,a+190,"Leaderboard is down for maintenance",o).setOrigin(0)}catch(e){console.error("Error in displayLeaderBoard: ",e);const t={fontSize:"16px",fill:"#FF0000"};self.add.text(300,a+190,"Leaderboard is down for maintenance",t).setOrigin(0)}}()})),self.time.delayedCall(8e3,(()=>{r||(r=!0,n())})),self.input.on("pointerup",(()=>{r||(r=!0,n())}))}}const config={type:Phaser.AUTO,width:1100,height:680,scene:[BaseScene,Preload,Mainmenu,Level1Fight1,Level1Fight2,Level1Fight3,Level2Fight1,Level2Fight2,Level2Fight3,Level3Fight1,Level3Fight2,Level3Fight3,Endscene],scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},dom:{createContainer:!0}},game=new Phaser.Game(config);