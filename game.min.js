const gameState={levels:["Level1Fight1","Level1Fight2","Level1Fight3","Level2Fight1","Level2Fight2","Level2Fight3","Level3Fight1","Level3Fight2","Level3Fight3","Endscene"]};class Preload extends Phaser.Scene{constructor(){super("Preload")}preload(){WebFont.load({custom:{families:["Rock Kapak"]},active:()=>{this.fontLoaded=!0}});const e=this.cameras.main.width,t=this.cameras.main.height,a=e/2,r=t/2,n=this.add.graphics(),o=this.add.graphics();n.fillStyle(2236962,.8),n.fillRect(e/2-160,270,320,50);const s=this.add.text(a,r-50,"Loading...",{font:"20px monospace",fill:"#ffffff"}).setOrigin(.5,.5),i=this.add.text(a,r-5,"0%",{font:"18px monospace",fill:"#ffffff"}).setOrigin(.5,.5);this.load.on("progress",(function(t){i.setText(parseInt(100*t)+"%"),o.clear(),o.fillStyle(16777215,1),o.fillRect(e/2-150,280,300*t,30)})),this.load.on("complete",(function(){o.destroy(),n.destroy(),s.destroy(),i.destroy()})),gameState.restartGame||(this.load.image("knuckleFist","assets/images/cards/knuckleFist.jpg"),this.load.image("kabutu","assets/images/cards/kabutu.jpg"),this.load.image("combatBoots","assets/images/cards/combatBoots.jpg"),this.load.image("tantoBlade","assets/images/cards/tantoBlade.jpg"),this.load.image("circlePit","assets/images/cards/circlePit.jpg"),this.load.image("seppuku","assets/images/cards/seppuku.jpg"),this.load.image("katana","assets/images/cards/katana.jpg"),this.load.image("rocknRonin","assets/images/cards/rocknRonin.jpg"),this.load.image("powerChord","assets/images/cards/powerChord.jpg"),this.load.image("rawEnergy","assets/images/cards/rawEnergy.jpg"),this.load.image("pyromania","assets/images/cards/pyromania.jpg"),this.load.image("stageInvasion","assets/images/cards/stageInvasion.jpg"),this.load.image("studdedLeather","assets/images/cards/studdedLeather.jpg"),this.load.image("boneShredder","assets/images/cards/boneShredder.jpg"),this.load.image("blackFumes","assets/images/cards/blackFumes.jpg"),this.load.image("masakari","assets/images/cards/masakari.jpg"),this.load.image("discontent","assets/images/cards/discontent.jpg"),this.load.image("dogsOfWar","assets/images/cards/dogsOfWar.jpg"),this.load.image("roninsRot","assets/images/cards/roninsRot.jpg"),this.load.image("libertySpikes","assets/images/cards/libertySpikes.jpg"),this.load.image("moshpitMassacre","assets/images/cards/moshpitMassacre.jpg"),this.load.image("bladesBlight","assets/images/cards/bladesBlight.jpg"),this.load.image("scorchedSoul","assets/images/cards/scorchedSoul.jpg"),this.load.image("risingWakizashi","assets/images/cards/risingWakizashi.jpg"),this.load.image("deadCities","assets/images/cards/deadCities.jpg"),this.load.image("nastyNihonto","assets/images/cards/nastyNihonto.jpg"),this.load.image("crowdSurfer","assets/images/cards/crowdSurfer.jpg"),this.load.image("shogunShred","assets/images/cards/shogunShred.jpg"),this.load.image("rocknRejuvinate","assets/images/cards/rocknRejuvinate.jpg"),this.load.image("detox","assets/images/cards/detox.jpg"),this.load.image("laidoSoho","assets/images/cards/laidoSoho.jpg"),this.load.image("dBeat","assets/images/cards/dBeat.jpg"),this.load.image("shikoroStrike","assets/images/cards/shikoroStrike.jpg"),this.load.image("rottenResonance","assets/images/cards/rottenResonance.jpg"),this.load.image("troopsOfTakamori","assets/images/cards/troopsOfTakamori.jpg"),this.load.image("bassSolo","assets/images/cards/bassSolo.jpg"),this.load.image("zenZine","assets/images/cards/zenZine.jpg"),this.load.image("kabutuOverdrive","assets/images/cards/kabutuOverdrive.jpg"),this.load.image("nenguStyle","assets/images/cards/nenguStyle.jpg"),this.load.image("canibalize","assets/images/cards/canibalize.jpg"),this.load.image("bloodOath","assets/images/cards/bloodOath.jpg"),this.load.image("roninMerc","assets/images/cards/roninMerc.jpg"),this.load.image("pyroPunk","assets/images/cards/pyroPunk.jpg"),this.load.image("pissDrunkBastards","assets/images/cards/pissDrunkBastards.jpg"),this.load.image("gutterGeisha","assets/images/cards/gutterGeisha.jpg"),this.load.image("noFuture","assets/images/cards/noFuture.jpg"),this.load.image("coverCharge","assets/images/cards/coverCharge.jpg"),this.load.image("punksNotDead","assets/images/cards/punksNotDead.jpg"),this.load.image("punksNotDeadToken","assets/images/cards/punksNotDeadToken.png"),this.load.image("lustForLifeToken","assets/images/cards/lustForLifeToken.png"),this.load.image("lustForLife","assets/images/cards/lustForLife.jpg"),this.load.image("gundanSeizaiToken","assets/images/cards/gundanSeizaiToken.png"),this.load.image("gundanSeizai","assets/images/cards/gundanSeizai.jpg"),this.load.image("deadTokugawasToken","assets/images/cards/deadTokugawasToken.png"),this.load.image("deadTokugawas","assets/images/cards/deadTokugawas.jpg"),this.load.image("toxicFrets","assets/images/cards/toxicFrets.jpg"),this.load.image("toxicFretsToken","assets/images/cards/toxicFretsToken.png"),this.load.image("ashenEncore","assets/images/cards/ashenEncore.jpg"),this.load.image("ashenEncoreToken","assets/images/cards/ashenEncoreToken.png"),this.load.image("edoEruption","assets/images/cards/edoEruption.jpg"),this.load.image("edoEruptionToken","assets/images/cards/edoEruptionToken.png"),this.load.image("steelToe","assets/images/cards/steelToe.jpg"),this.load.image("steelToeToken","assets/images/cards/steelToeToken.png"),this.load.image("foreverTrueToken","assets/images/cards/foreverTrueToken.png"),this.load.image("foreverTrue","assets/images/cards/foreverTrue.jpg"),this.load.image("rebelSpiritToken","assets/images/cards/rebelSpiritToken.png"),this.load.image("rebelSpirit","assets/images/cards/rebelSpirit.jpg"),this.load.image("rebelHeartToken","assets/images/cards/rebelHeartToken.png"),this.load.image("rebelHeart","assets/images/cards/rebelHeart.jpg"),this.load.image("bushidoToken","assets/images/cards/bushidoToken.png"),this.load.image("bushido","assets/images/cards/bushido.jpg"),this.load.image("toxicAvengerToken","assets/images/cards/toxicAvengerToken.png"),this.load.image("toxicAvenger","assets/images/cards/toxicAvenger.jpg"),this.load.image("kirisuteGomenToken","assets/images/cards/kirisuteGomenToken.png"),this.load.image("kirisuteGomen","assets/images/cards/kirisuteGomen.jpg"),this.load.image("hollidayInKamakuraToken","assets/images/cards/hollidayInKamakuraToken.png"),this.load.image("hollidayInKamakura","assets/images/cards/hollidayInKamakura.jpg"),this.load.image("kamishimoUberAllesToken","assets/images/cards/kamishimoUberAllesToken.png"),this.load.image("kamishimoUberAlles","assets/images/cards/kamishimoUberAlles.jpg"),this.load.image("bgLoadingScreen","assets/images/bgLoadingScreen.jpg"),this.load.audio("titleTheme","assets/sounds/music/TitleTheme.mp3"),this.load.audio("thundersound","assets/sounds/thundersound.mp3"))}create(){self=this,gameState.score={numberOfTurns:0,levelsCompleted:0,damageTaken:0,damageDealt:0,totaleScore:0},gameState.player={sprite:this.add.sprite(320,350,"player").setScale(.38).setFlipX(!0).setInteractive(),healthBarColor:"0x00ff00",alive:!0,stance:"Neutral",stancePoints:0,gold:0,goldMax:99,poison:0,numCards:5,numCardsBase:5,numCardsStance:0,health:100,healthMax:100,mana:3,manaMax:3,manaBase:3,manaStance:0,manaCard:0,strength:0,strengthMax:15,strengthBase:0,strengthStance:0,strengthCard:0,armor:0,armorMax:15,armorBase:0,armorStance:0,armorCard:0,lifeSteal:0},gameState.enemy={name:"Name",sprite:"",healthBarColor:"0xff0000",alive:!0,actions:[],health:40,healthMax:40,strength:0,strengthBase:0,strengthTurn:0,strengthMax:15,armor:0,armorMax:15,poison:0},gameState.deck=[{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"combatBoots",type:"targetAll",cost:2,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?1+gameState.player.stancePoints:1,reduceTargetStrength:0,drawCard:0},{key:"tantoBlade",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?12-2*gameState.player.stancePoints:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"discontent",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints>0?-2:gameState.player.stancePoints<0?2:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}],gameState.bonusCards=[{key:"kamishimoUberAlles",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kamishimoUberAllesToken"},{key:"hollidayInKamakura",type:"permanent",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"hollidayInKamakuraToken"},{key:"rebelSpirit",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelSpiritToken"},{key:"foreverTrue",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"foreverTrueToken"},{key:"toxicFrets",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicFretsToken"},{key:"ashenEncore",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"ashenEncoreToken"},{key:"edoEruption",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"edoEruptionToken"},{key:"deadTokugawas",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"deadTokugawasToken"},{key:"punksNotDead",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"punksNotDeadToken"},{key:"toxicAvenger",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicAvengerToken"},{key:"studdedLeather",type:"buff",cost:1,stancePoints:2,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rocknRonin",type:"buff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:()=>gameState.player.strength,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rawEnergy",type:"buff",cost:()=>gameState.player.stancePoints>0?-2:-1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"powerChord",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints<=0?1:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?3:0},{key:"crowdSurfer",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:()=>gameState.player.stancePoints<0?2*gameState.player.stancePoints:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?gameState.player.stancePoints:0},{key:"rocknRejuvinate",type:"buff",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:5,poisonRemove:()=>gameState.player.stancePoints>0?3:0,strength:0,armor:()=>gameState.player.stancePoints<0?3:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"detox",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:4,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"dBeat",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shogunShred",type:"buff",cost:0,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bloodOath",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"canibalize",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutuOverdrive",type:"buff",cost:1,stancePoints:-2,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:10,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"nenguStyle",type:"buff",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"zenZine",type:"buff",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"gutterGeisha",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>Math.round(.2*(gameState.player.healthMax-gameState.player.health)),reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"noFuture",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"coverCharge",type:"buff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,oneShot:!0},{key:"seppuku",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:-5,poisonRemove:0,strength:()=>gameState.player.stancePoints<0?1-gameState.player.stancePoints:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"bassSolo",type:"targetAll",cost:1,stancePoints:0,damage:6,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rottenResonance",type:"targetAll",cost:1,stancePoints:0,damage:0,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pissDrunkBastards",type:"targetAll",cost:2,stancePoints:1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"stageInvasion",type:"targetAll",cost:2,stancePoints:0,damage:()=>3*(gameState.currentCards.length+1),fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"circlePit",type:"targetAll",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:()=>4*gameState.costPlayed,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"moshpitMassacre",type:"targetAll",cost:2,stancePoints:0,damage:8,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"blackFumes",type:()=>gameState.player.stancePoints>=0?"targetAll":"targetSelected",cost:2,stancePoints:0,damage:0,fire:0,poison:()=>gameState.player.stancePoints>0?3:gameState.player.stancePoints<0?5:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"deadCities",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"boneShredder",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:1,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"masakari",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?9*(1-gameState.player.stancePoints*gameState.player.strength/10):9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyromania",type:"targetSelected",cost:2,stancePoints:0,damage:0,fire:16,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninsRot",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"dogsOfWar",type:"targetSelected",cost:1,stancePoints:1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"libertySpikes",type:"targetSelected",cost:1,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>gameState.player.stancePoints<0?2:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bladesBlight",type:"targetSelected",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"scorchedSoul",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"katana",type:"targetSelected",cost:3,stancePoints:0,damage:()=>gameState.player.stancePoints<0?13*(1-gameState.player.stancePoints*gameState.player.strength/10):13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"risingWakizashi",type:"targetSelected",cost:1,stancePoints:-1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"nastyNihonto",type:"targetSelected",cost:2,stancePoints:0,damage:10,fire:0,poison:()=>gameState.player.stancePoints>0?2*gameState.player.stancePoints:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shikoroStrike",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.stancePoints<0?8:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?3:0,reduceTargetStrength:0,drawCard:0},{key:"laidoSoho",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.armor>0?gameState.player.armor:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninMerc",type:"targetSelected",cost:0,goldCost:1,stancePoints:0,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyroPunk",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:()=>Math.round(.2*(gameState.player.healthMax-gameState.player.health)),poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"troopsOfTakamori",type:"targetSelected",cost:1,stancePoints:0,damage:6,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}],gameState.extraCards=[{key:"kirisuteGomen",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kirisuteGomenToken"},{key:"rebelHeart",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelHeartToken"},{key:"bushido",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"bushidoToken"},{key:"steelToe",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"steelToeToken"},{key:"gundanSeizai",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"gundanSeizaiToken"},{key:"lustForLife",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"lustForLifeToken"}],gameState.minDeckSize=8,gameState.latestDraw=[],gameState.restartGame&&self.scene.start("Mainmenu");let e=this.add.image(550,480,"bgLoadingScreen").setScale(1.4).setInteractive();this.add.text(550,170,"Punk Rock Samurai",{fontSize:"100px",fill:"#000000",fontFamily:"Rock Kapak"}).setOrigin(.5),this.add.text(550,500,"Click to start",{fontSize:"45px",fill:"#ff0000",fontWeight:"bold"}).setOrigin(.5);let t=!1;gameState.thunder=this.sound.add("thundersound"),gameState.musicTheme=this.sound.add("titleTheme"),e.on("pointerup",(()=>{t||(t=!0,gameState.thunder.play({volume:.9,seek:.25}),this.cameras.main.shake(200,.002,!1),this.cameras.main.flash(100),this.time.delayedCall(100,(()=>{this.cameras.main.fadeOut(100)}),[],this),this.time.delayedCall(200,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),self.time.delayedCall(100,(()=>{self.scene.start("Mainmenu"),console.log("Mainmenu called")}))}),[],this))}))}}class BaseScene extends Phaser.Scene{create(){this.scene.start("Preload")}baseCreate(e,t=.75){this.add.image(0,0,e).setScale(t).setOrigin(.02,0),this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),gameState.targetingCursor=this.add.image(0,0,"targetingCursor").setDepth(200).setVisible(!1),gameState.playingCard=!1,gameState.discardPile=[],gameState.drawPile=[],gameState.cardsDealtSound=this.sound.add("cardsDealtSound"),gameState.victorySound=this.sound.add("victorySound"),gameState.buttonPressedSound=this.sound.add("buttonPressedSound"),gameState.attackSound=this.sound.add("attackSound"),gameState.powerUpSound=this.sound.add("powerUpSound"),gameState.healSound=this.sound.add("healSound"),gameState.thunder=this.sound.add("thundersound"),gameState.music=this.sound.add("bossTune"),gameState.coinSound=this.sound.add("coinSound"),gameState.keyboardSound=this.sound.add("keyboardSound"),gameState.canibalizeCondition=!1,gameState.endGameMenyExited=!1}resetPlayer(e,t,a=360,r=350){e.sprite=this.add.image(a,r,"player").setScale(t).setFlipX(!1).setInteractive(),e.stance="Neutral",e.poison=0,e.stancePoints=0,e.numCardsBase=5,e.numCardsStance=0,e.manaBase=3,e.manaStance=0,e.manaCard=0,e.mana=3,e.manaMax=3,e.strengthBase=0,e.strengthStance=0,e.strengthCard=0,e.strengthMax=15,e.armorBase=0,e.armorStance=0,e.armorCard=0,e.lifeSteal=0}definePermanentSlots(){gameState.permanentSlots=[{available:!0,x:50,y:50,index:0},{available:!0,x:125,y:50,index:1},{available:!0,x:200,y:50,index:2},{available:!0,x:275,y:50,index:3}]}addHealthBar(e,t){const a=e.x,r=e.y,n=e.height;e.healthBarBackground=this.add.graphics(),e.healthBarBackground.fillStyle(16777215,.5),e.healthBarBackground.fillRect(a-40,r-n/2-30,100,10),e.healthBarFrame=this.add.graphics(),e.healthBarFrame.lineStyle(3,0,1),e.healthBarFrame.strokeRect(a-40,r-n/2-30,100,10),e.healthBar=this.add.graphics(),e.healthBar.fillStyle(t,1),e.healthBar.fillRect(a-40,r-n/2-30,e.health/e.healthMax*100,10),e.healthBarText=this.add.text(a-18,r-n/2-25,`${e.health}/${e.healthMax}`,{fontSize:"11px",fill:"#000000"}).setOrigin(.5)}addManaBar(e){const t=e.x,a=e.y,r=e.height;e.manaBarBackground=this.add.graphics(),e.manaBarBackground.lineStyle(3,0,1),e.manaBarBackground.strokeRect(t-40,a-r/2-45,100,10),e.manaBarFrame=this.add.graphics(),e.manaBarFrame.lineStyle(3,0,1),e.manaBarFrame.strokeRect(e.x-40,e.y-r/2-45,100,10),e.manaBar=this.add.graphics(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(t-40,a-r/2-45,e.mana/e.manaMax*100,10),e.manaBarText=this.add.text(t-27,a-r/2-40,`${e.mana}/${e.manaMax}`,{fontSize:"11px",fill:"#000000"}).setOrigin(.5)}addStatsDisplay(e,t=420){const a={fontSize:"11px",fill:"#FFFFFF"},r=e.sprite.x;e.strengthAndArmorImage=this.add.image(r-20,t,"strengthAndArmor").setScale(.4).setInteractive().setDepth(20),e.armorText=this.add.text(r+13,t,`${e.armor}/${e.armorMax}`,a).setDepth(25),e.strengthText=this.add.text(r-40,t,`${e.strength}/${e.strengthMax}`,a).setDepth(25)}addGoldCoin(){const e=this.add.image(1040,50,"goldCoin").setScale(.1).setDepth(220).setOrigin(.5).setInteractive();gameState.goldCounter=this.add.text(1040,50,gameState.player.gold,{fontSize:"60px",fill:"#000000"}).setDepth(221).setOrigin(.5);let t="";e.on("pointerover",(()=>{gameState.goldCard=this.add.image(550,300,"goldCard").setScale(.55).setDepth(220),this.input.keyboard.on("keydown",(function(e){if(t+=e.key,"showmethemoney"===t){const e=99;console.log("showmethemoney"),gameState.player.gold+=e,gameState.goldCounter.setText(gameState.player.gold),"admin"!==gameState.playerName&&(gameState.playerName="Cheater"),t=""}t.length>30&&(t=t.substring(t.length-30))}))})),e.on("pointerout",(()=>{gameState.goldCard.destroy(),t="",this.input.keyboard.removeAllListeners("keydown")}))}describeCharacter(e){gameState.targetingCursor.visible||!0!==e.alive||e.sprite.on("pointerover",(()=>{const t=e.armor<0?"more":"less",a=e.strength<0?"less":"more",r=`${e.name}\n\n${e.armor} armor: Take ${Math.round(Math.abs(e.armor/20*100))} %\n${t} physical damage\n\nMax armor: Take 75 %\nless physical damage \n\n${e.strength} Strength: Deal ${10*Math.abs(e.strength)} %\n${a} physical damage\n\nMax strength: Deal 150 %\nmore physical damage\n\nPoison: ${e.poison}\nPoison change per turn: ${e.poison>0?-1:0}`,n=e.sprite.x-e.width/2;e.descriptionBackground=this.add.graphics({x:n-200,y:210}),e.descriptionBackground.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(30),e.descriptionBackground.fillRoundedRect(0,0,215,250,10);e.descriptionText=this.add.text(n+10,335,r,{fontSize:"12px",fill:"#000000"}).setDepth(35).setOrigin(1,.5)})),e.sprite.on("pointerout",(function(){e.descriptionBackground&&e.descriptionBackground.destroy(),e.descriptionText&&e.descriptionText.destroy()}))}addStanceBar(e,t){e.stancePoints=0;let a=this.cameras.main.width/2;gameState.stanceBarHeight=20,gameState.stanceBarMargin=60,gameState.stanceBarStartX=a-220,gameState.stanceBarBackground=this.add.graphics(),gameState.stanceBarBackground.lineStyle(3,0,1),gameState.stanceBarBackground.strokeRect(gameState.stanceBarStartX,gameState.stanceBarMargin,440,gameState.stanceBarHeight).setDepth(20);for(let e=1;e<6;e++)gameState.stanceBarBackground.moveTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin),gameState.stanceBarBackground.lineTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin+20),gameState.stanceBarBackground.strokePath();gameState.stanceBar=this.add.graphics(),gameState.stanceBar.fillStyle(65280,1);let r={fontSize:"28px",fill:t};gameState.stanceText=this.add.text(550,gameState.stanceBarMargin-25,`Stance: ${gameState.player.stance}`,r).setOrigin(.5).setInteractive(),gameState.stanceText.on("pointerover",(()=>{gameState.stanceDescriptionText=this.add.text(550,gameState.stanceBarBackground.y+105,"Stance represents the ever-shifting balance\nbetween the conflicting ideals of the\npunk rock samurai: Discipline and Freedom.\n\nPositive Discipline during your turn:\n+3 Strength\n\nPositive Discipline at the end of your turn:\n+3 Armor\n\nMax Discipline at the end of your turn:\n-1 card next turn\n\nPositive Freedom during your turn:\n+1 mana\n\nPositive Freedom at the end of your turn:\n50% chance of +1 card next turn\n50% chance of +1 mana next turn\n\nMax Freedom at the end of your turn:\n-2 Armor",{fontSize:"14px",fill:"#000000"}).setDepth(25).setOrigin(.5,0);const e=gameState.stanceDescriptionText.getBounds(),t=e.width+10,a=e.height+10,r=e.x-5,n=e.y-5;gameState.stanceTextBackground=this.add.graphics(),gameState.stanceTextBackground.fillStyle(16777215,1).setAlpha(.9).setDepth(24),gameState.stanceTextBackground.fillRoundedRect(r,n,t,a,7)})),gameState.stanceText.on("pointerout",(()=>{gameState.stanceTextBackground.destroy(),gameState.stanceDescriptionText.destroy()}))}extractLevelFightFromName(e){const t=/Level(\d+)Fight(\d+)/.exec(e);return t?{level:parseInt(t[1],10),fight:parseInt(t[2],10)}:{level:null,fight:null}}powerUpTweens(e){this.tweens.add({targets:e.sprite,scaleY:1.125*e.sprite.scaleX,scaleX:1.125*e.sprite.scaleY,duration:120,ease:"Cubic",yoyo:!0},this)}attackTweens(e,t){if("undefined"==typeof attackTweenStarted||!attackTweenStarted){let a=!0;this.tweens.add({targets:e.sprite,x:e.x+t,duration:120,ease:"Cubic",yoyo:!0,onComplete:()=>a=!1},this)}}cardTweens(e,t,a){this.tweens.add({targets:e,scaleX:t,scaleY:t,duration:a,ease:"Cubic"},this)}animateCard(e,t){e.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.08}),this.tweens.add({targets:e.sprite,y:470,angle:0,scaleX:.46,scaleY:.46,duration:300,ease:"Cubic"}),e.sprite.setDepth(100)}),this),e.sprite.on("pointerout",(()=>{e.isBeingPlayed||(this.tweens.add({targets:e.sprite,y:e.startHeight,angle:e.angle,scaleX:.35,scaleY:.35,duration:300,ease:"Cubic"}),e.sprite.setDepth(t))}),this)}addEndOfTurnButton(e=500){gameState.endOfTurnButton=this.add.image(900,e,"rectangularButton").setScale(.45).setOrigin(.5),gameState.endOfTurnText=this.add.text(900,e,"End Turn",{fontSize:"18px",fill:"#000000"}).setOrigin(.5),gameState.endOfTurnButton.on("pointerover",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButtonHovered")})),gameState.endOfTurnButton.on("pointerout",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButton")}))}addRedrawButton(){const e=900;gameState.redrawButton=this.add.image(e,52,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.redrawText=this.add.text(e,52,"Redraw",{fontSize:"18px",fill:"#000000"}).setOrigin(.5),gameState.redrawButton.on("pointerover",(()=>{gameState.redrawButton.setTexture("rectangularButtonHovered"),gameState.redrawButtonDescriptionBackground=this.add.graphics(),gameState.redrawButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.redrawButtonDescriptionBackground.fillRoundedRect(835,82,130,40,5);const t=`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`;gameState.redrawButtonDescriptionText=this.add.text(e,102,t,{fontSize:"12px",fill:"#000000"}).setDepth(123).setOrigin(.5,.5)})),gameState.redrawButton.on("pointerout",(()=>{gameState.redrawButton.setTexture("rectangularButton"),gameState.redrawButtonDescriptionBackground&&gameState.redrawButtonDescriptionBackground.destroy(),gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.destroy()}))}clearBoard(){gameState.characters.forEach((e=>{e.sprite.destroy(),e.strengthAndArmorImage.destroy(),e.armorText.destroy(),e.strengthText.destroy(),e.strengthAndArmorImage.destroy(),e.healthBarBackground.destroy(),e.healthBarFrame.destroy(),e.healthBar.destroy(),e.healthBarText.destroy()}));[gameState.player.manaBarBackground,gameState.player.manaBarFrame,gameState.player.manaBar,gameState.player.manaBarText,gameState.endOfTurnButton,gameState.endOfTurnText,gameState.drawPileImage,gameState.discardPileImage,gameState.drawPileText,gameState.discardPileText,gameState.stanceBar,gameState.stanceText,gameState.stanceBarBackground,gameState.redrawButton,gameState.redrawText,gameState.healButton,gameState.healText,gameState.actionText].forEach((e=>{e&&e.destroy()})),console.log("board cleared")}shuffleDeck(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}updateEnemyIntention(e){let t="function"==typeof e.chosenAction.key?e.chosenAction.key():e.chosenAction.key;e.intentionText.setText(`${t}`)}updateHealthBar(e){e.health=Phaser.Math.Clamp(e.health,0,e.healthMax);e.healthBar.clear(),e.healthBar.fillStyle(e===gameState.player?65280:16711680,1),e.healthBar.fillRect(e.x-40,e.y-e.height/2-30,e.health/e.healthMax*100,10),e.healthBarText.setText(`${e.health}/${e.healthMax}`),e.healthBarText.setColor("#000000")}updateManaBar(e){e.mana=Phaser.Math.Clamp(e.mana,0,e.manaMax),e.manaBar.clear(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(e.x-40,e.y-e.height/2-45,e.mana/e.manaMax*100,10),e.manaBarText.setText(`${e.mana}/${e.manaMax}`)}updateStanceBar(e){const t=gameState.player.stancePoints;if(gameState.player.stancePoints>0){Math.random()>.5?(e.manaStance=1,e.numCardsStance=0):(e.manaStance=0,e.numCardsStance=1)}else e.manaStance=0;switch(t){case-3:e.armorStance=3,e.strengthStance=3,e.numCardsStance=-1,e.stance="Discipline";break;case-2:case-1:e.armorStance=3,e.strengthStance=3,e.numCardsStance=0,e.stance="Discipline";break;case 0:e.armorStance=0,e.strengthStance=0,e.numCardsStance=0,e.stance="Neutral";break;case 1:case 2:e.armorStance=0,e.strengthStance=0,e.stance="Freedom";break;case 3:e.armorStance=-2,e.strengthStance=0,e.stance="Freedom";break;default:return void console.error(`Unexpected value for points: ${t}`)}gameState.stanceBar.clear(),t<0?gameState.stanceBar.fillRect(gameState.stanceBarStartX+220+73.33*t,gameState.stanceBarMargin,73.33*Math.abs(t),gameState.stanceBarHeight):gameState.stanceBar.fillRect(gameState.stanceBarStartX+220,gameState.stanceBarMargin,73.33*t,gameState.stanceBarHeight),gameState.stanceText.setText(`Stance: ${e.stance}`)}updateTextAndBackground(e,t,a,r=7,n=20,o=.6){e.setText(a),e.setDepth(n+1);const s=e.getBounds(),i=s.width+10,l=s.height+10,m=s.x-5,g=s.y-5;t.clear(),t.fillStyle(16777215,1).setAlpha(o).setDepth(n),t.fillRoundedRect(m,g,i,l,r)}}const sceneState={};class Mainmenu extends Phaser.Scene{constructor(){super("Mainmenu")}async getTopScores(){const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");let t=(await e.json()).dreamlo.leaderboard.entry;return t.length>1&&t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}preload(){this.load.image("player","assets/images/sprites/punkrock.png"),this.load.image("deck","assets/images/cardback.jpg"),this.load.image("strengthAndArmor","assets/images/strengthAndArmor.png"),this.load.image("targetingCursor","assets/images/targetingCursor.png"),this.load.image("targetingCursorReady","assets/images/targetingCursorReady.png"),this.load.image("listbox1","assets/images/listbox1.png"),this.load.image("rectangularButton","assets/images/stoneButtonInsetReady.png"),this.load.image("rectangularButtonHovered","assets/images/stoneButtonInsetHovered.png"),this.load.image("rectangularButtonPressed","assets/images/stoneButtonInsetPressed.png"),this.load.image("rectangularFrame","assets/images/stoneButtonFrame.png"),this.load.audio("cardsDealtSound","assets/sounds/cardsdealt.wav"),this.load.audio("buttonPressedSound","assets/sounds/buttonpressed.wav")}create(){const e=this;this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,480,"bgLoadingScreen").setScale(1.4),this.add.text(15,5,"Punk Rock Samurai Beta v1.30",{fontSize:"12px",fill:"#ff0000"});let t=!1;gameState.isEnteringName=!1,sceneState.name="",sceneState.cardsDealtSound=this.sound.add("cardsDealtSound"),sceneState.buttonPressedSound=this.sound.add("buttonPressedSound"),sceneState.newGameElements=[],sceneState.leaderboardElements=[],sceneState.creditsElements=[],sceneState.instructionsElements=[],sceneState.displayedScoreArray=[];const a={fontSize:"25px",fill:"#000000"},r={fontSize:"14px",fill:"#000000"},n={fontSize:"18px",fill:"#000000"},o=120,s=350,i=e.add.image(o,s,"rectangularButton"),l=e.add.text(o,s,"New Game",n).setOrigin(.5);sceneState.newGameButtonClicked=!1;const m=e.add.image(o,415,"rectangularButton"),g=e.add.text(o,415,"Load Game",{fontSize:"16px",fill:"#a9a9a9"}).setOrigin(.5);let d=!1;const p=e.add.image(o,480,"rectangularButton"),c=e.add.text(o,480,"Leaderboard",n).setOrigin(.5);let S=!1;const u=e.add.image(o,545,"rectangularButton"),h=e.add.text(o,545,"Credits",n).setOrigin(.5);let y=!1;const f=e.add.image(o,610,"rectangularButton"),x=e.add.text(o,610,"Instructions",n).setOrigin(.5);let k=!1;function T(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function B(t){t.on("pointerup",(()=>{if(!gameState.isEnteringName){gameState.isEnteringName=!0,console.log("isEnteringName has been activated"),"Enter your name..."===gameState.name&&(gameState.name=""),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.resume();try{T()&&gameState.hiddenInput.focus()}catch(e){console.error("Onscreen keyboard failed to open",e),gameState.isEnteringName=!1,v()}e.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER).once("down",(function(){gameState.isEnteringName=!1,v()})),e.time.delayedCall(200,(()=>{e.input.off("pointerup"),e.input.once("pointerup",(()=>{if(gameState.isEnteringName){let t=0;gameState.name||(gameState.name="Enter your name...",t=100),e.time.delayedCall(t,(()=>{gameState.isEnteringName=!1,console.log("isEnteringName has been deactivated")})),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.pause();try{T()&&gameState.hiddenInput.blur()}catch(e){console.error("Onscreen keyboard failed to close",e),gameState.isEnteringName=!1,v()}}}))}))}}))}function v(){"Enter your name..."===gameState.name||""===gameState.name?gameState.playerName="Punk Rock Samurai":gameState.playerName=gameState.name,console.log(`Playername: ${gameState.playerName}`),D(),sceneState.menuElements.forEach((e=>{e.destroy()})),e.time.delayedCall(600,(()=>{!function(){const a=320,r=430,n=220;M(gameState.extraCards);const o=gameState.extraCards.slice(0,3),s={fontSize:"50px",fill:"#ff0000"},i=e.add.text(550,170,"Choose 1 Free Permanent",s).setOrigin(.5).setDepth(21),l=e.add.graphics();P(i,l,"Choose 1 Free Permanent"),o.forEach(((s,m)=>{s.sprite=e.add.sprite(a+m*n,r,s.key).setScale(.45).setInteractive(),console.log(`bonusCardsprite added for: ${s.key}`),s.sprite.on("pointerover",(function(){sceneState.cardsDealtSound.play({volume:.8,seek:.12}),C(s.sprite,.58,200)}),this),s.sprite.on("pointerout",(function(){C(s.sprite,.45,400)}),this),s.sprite.on("pointerup",(function(){sceneState.cardsDealtSound.play({volume:1.2,seek:.12}),gameState.deck.push(s),gameState.freePermanent=s,gameState.extraCards.splice(gameState.extraCards.indexOf(s),1),M(gameState.extraCards),o.forEach((t=>{var a,r;t.sprite.removeInteractive(),t!==s&&(a=t.sprite,r=200,a&&e.tweens.add({targets:a,alpha:0,ease:"Power1",duration:r,onComplete:()=>{a.destroy()}}))})),e.tweens.add({targets:s.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),i.setText("Permanent Selected"),P(i,l,"Permanent Selected"),e.time.delayedCall(2500,(()=>{t||(t=!0,b())})),e.input.on("pointerup",(()=>{t||(t=!0,b())}))}))}))}()}))}function P(e,t,a,r=7){e.setText(a);const n=e.getBounds(),o=n.width+10,s=n.height+10,i=n.x-5,l=n.y-5;t.clear(),t.fillStyle(16777215,1).setAlpha(.4).setDepth(20),t.fillRoundedRect(i,l,o,s,r)}function b(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level1Fight1")}))}function C(t,a,r){e.tweens.add({targets:t,scaleX:a,scaleY:a,duration:r,ease:"Cubic"})}function w(e){e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))}function D(){[...sceneState.newGameElements,...sceneState.leaderboardElements,...sceneState.creditsElements,...sceneState.instructionsElements,...sceneState.displayedScoreArray].forEach((e=>{e&&"function"==typeof e.destroy?e.destroy():console.log(`${e} not phaser object`)}))}function M(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}sceneState.buttons=[i,m,p,u,f],sceneState.textArray=[l,g,c,h,x],sceneState.menuElements=[...sceneState.buttons,...sceneState.textArray],sceneState.buttons.forEach((e=>{w(e),e.setScale(.8,.5).setInteractive().setOrigin(.5)})),T()&&(gameState.hiddenInput=document.createElement("input"),gameState.hiddenInput.style.position="absolute",gameState.hiddenInput.style.opacity="0",gameState.hiddenInput.style.zIndex="-1",document.body.appendChild(gameState.hiddenInput),gameState.hiddenInput.addEventListener("input",(function(e){gameState.name=e.target.value}))),i.on("pointerdown",(()=>{if(sceneState.newGameButtonClicked)sceneState.newGameButtonClicked=!1,D();else{sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!0,d=!1,S=!1,y=!1,k=!1,D(),gameState.name="Enter your name...";const e={fontSize:"23px",fill:"#000000"};sceneState.nameText=this.add.text(420,315,gameState.name,e).setDepth(21);const t={fontSize:"28px",fill:"#000000"};sceneState.startGameButton=this.add.image(550,400,"rectangularButton").setScale(1.2,.6).setInteractive(),sceneState.startGameText=this.add.text(470,387,"Let's go!",t),w(sceneState.startGameButton),sceneState.startGameButton.on("pointerdown",(()=>{gameState.isEnteringName=!1,v()}));const a={fontSize:"32px",fill:"#000000"};sceneState.formCursor=this.add.text(420,310,"|",a).setDepth(21).setAlpha(0),sceneState.cursorTween=this.tweens.add({targets:sceneState.formCursor,alpha:1,duration:300,hold:600,yoyo:!0,repeat:-1,paused:!0}),sceneState.formFrame=this.add.image(550,325,"rectangularFrame"),sceneState.formFrame.setScale(1.2,.6).setInteractive().setDepth(22),sceneState.nameForm=this.add.graphics({x:400,y:290}),sceneState.nameForm.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(20),sceneState.nameForm.fillRect(0,0,300,65),sceneState.nameForm.setInteractive(new Phaser.Geom.Rectangle(0,0,300,65),Phaser.Geom.Rectangle.Contains),sceneState.newGameElements=[sceneState.formCursor,sceneState.nameForm,sceneState.nameText,sceneState.formFrame,sceneState.startGameButton,sceneState.startGameText],B(sceneState.nameForm),B(sceneState.formFrame)}})),this.input.keyboard.on("keydown",(t=>{if(gameState.isEnteringName){const a=18;8===t.keyCode&&gameState.name.length>0?gameState.name=gameState.name.slice(0,-1):1===t.key.length&&t.key.match(/[a-zA-Z0-9\s\-_]/)&&gameState.name.length<a?gameState.name+=t.key:gameState.name.length===a&&e.cameras.main.shake(30,.001,!1)}})),m.on("pointerup",(function(){e.cameras.main.shake(70,.002,!1)})),p.on("pointerup",(async()=>{if(sceneState.buttonPressedSound.play({volume:.7}),S)S=!1,D();else{const t=await e.getTopScores(),a=250;let n=200;sceneState.newGameButtonClicked=!1,d=!1,S=!0,y=!1,k=!1,D(),sceneState.leaderboardsBackground=this.add.graphics(),sceneState.leaderboardsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.leaderboardsBackground.fillRect(a,n,810,250);const o={fontSize:"25px",fill:"#000000"};sceneState.leaderboardHeadline=this.add.text(a+20,n+30,"Leaderboard",o).setOrigin(0),sceneState.displayedScoreArray=[];for(let e=0;e<t.length;e++){const o=t[e].date.split(" ")[0],s=`${e+1}. Name: ${t[e].name}, Score: ${t[e].score}, Date: ${o}`,i=this.add.text(a+30,n+80,s,r).setOrigin(0);sceneState.displayedScoreArray.push(i),n+=20}sceneState.leaderboardElements=[sceneState.leaderboardsBackground,sceneState.leaderboardHeadline,sceneState.displayedScoreArray]}})),u.on("pointerup",(function(){y?(y=!1,D()):(sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!1,d=!1,S=!1,y=!0,k=!1,D(),sceneState.creditsBackground=e.add.graphics(),sceneState.creditsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.creditsBackground.fillRect(250,200,810,340),sceneState.creditsHeadline=e.add.text(270,230,"Credits",a).setOrigin(0),sceneState.creditsText=e.add.text(270,280,"Game Design and Programming by Erlend Kulander Kvitrud\nMusic by Marllon Silva (xDeviruchi) (https://soundcloud.com/xdeviruchi)\nPunch sound by @danielsoundsgood (https://danielsoundsgood.itch.io/)\nHealing sound by Dylan Kelk (https://freesound.org/people/SilverIllusionist/)\nPower up sound by MATRIXXX (https://freesound.org/people/MATRIXXX_/)\nGunshot sound by Fesliyan Studios (https://www.fesliyanstudios.com)\nButton Sprites by Ian Eborn (http://thaumaturge-art.com/)\nArmor and Strength symbols by Josepzin (https://opengameart.org/users/josepzin)\nCard sprites by Avery Ross (https://opengameart.org/users/averyre)\nCoin sound by ProjectsU012 (https://freesound.org/people/ProjectsU012/)\n",r),sceneState.creditsText.setLineSpacing(2),sceneState.creditsElements=[sceneState.creditsBackground,sceneState.creditsHeadline,sceneState.creditsText])})),f.on("pointerup",(function(){sceneState.buttonPressedSound.play({volume:.7}),k?(k=!1,D()):(sceneState.newGameButtonClicked=!1,d=!1,S=!1,y=!1,k=!0,D(),sceneState.instructionsBackground=e.add.graphics(),sceneState.instructionsBackground.fillStyle(16777215,1).setAlpha(.9).setDepth(20),sceneState.instructionsBackground.fillRect(250,20,810,640),sceneState.instructionsHeadline=e.add.text(270,50,"Instructions",a).setOrigin(0).setDepth(21),sceneState.instructionsText=e.add.text(270,100,'The game consists of four levels, each of which consists of three fights.\nAt the start of each turn, you gain 3 mana and draw 5 cards. You may then play any number\nof cards before hitting "End Turn". Your remaining cards and mana are then depleted,\nand the enemy\'s turn begins. You win the fight by killing all enemies. Losing a fight\nresults in permadeath. Missing health carries over from fight to fight\n\nStance represents the balance between Discipline and Freedom.\n-Positive Discipline during your turn: +3 Strength.\n-Positive Discipline at the end of your turn: +3 Armor.\n-Max Discipline at the end of your turn: -1 card next turn.\n\n-Positive Freedom during your turn: +1 mana.\n-Positive Freedom at the end of your turn: 50/50 chance of +1 card or +1 mana next turn.\n-Max Freedom at the end of your turn:-2 Armor.\n\nPhysical damage is affected by the Strength of the attacker and the Armor of the defender\n-Each unit of Strength increases outgoing physical damage by 10 %.\n-Each unit of Armor blocks 5 % of incomming physical damage\nArmor and Strength are both capped at 15 units.\n\nFire damage is unaffected by Strength and Armor, but otherwise acts like physical damage.\n\nPoison is unaffected by Strength and Armor. A poisoned character suffers damage at the start\nof their turn equal to their poison counter. At the end of the turn, this counter is reduced\nby 1. Unlike physical and fire damage, poison cannot reduce a characters health below 1 HP.\n\nPermanents are cards that can only be played once, and are then removed from your deck.\nAfter use, they remain active and provide passive bonuses. A maximum of 4 permanents may be\nactive at any given time. Permanents can be depleted, which unleases powerful one-off\neffects and then removes them from the game. If there are no empty slots for new permanents,\npermanent cards may be played directly from hand for their depletion effects.\n\nGold is earned by defeating enemies, and may be spent in the shop, or on in-fight bonuses.\n',r),sceneState.instructionsText.setLineSpacing(1.5).setDepth(21),sceneState.instructionsElements=[sceneState.instructionsBackground,sceneState.instructionsHeadline,sceneState.instructionsText])}))}update(){let e=0;gameState.isEnteringName&&sceneState.newGameButtonClicked&&(sceneState.nameText.setText(gameState.name),e=sceneState.nameText.width,sceneState.formCursor.x=sceneState.nameText.x+e-7)}}class Level1Fight1 extends BaseScene{self;constructor(){super("Level1Fight1")}preload(){this.load.image("theCity","assets/images/theCity.jpg"),this.load.image("bakgrunnCity1","assets/images/bakgrunnCity1.jpg"),this.load.image("shop1","assets/images/shop1.jpg"),this.load.image("nazi","assets/images/sprites/nazi.png"),this.load.image("goldCard","assets/images/goldCard.jpg"),this.load.image("goldCoin","assets/images/goldCoin.png"),this.load.audio("bossTune","assets/sounds/music/DecisiveBattle.mp3"),this.load.audio("attackSound","assets/sounds/attacksound.wav"),this.load.audio("powerUpSound","assets/sounds/powerupsound.wav"),this.load.audio("healSound","assets/sounds/healsound.wav"),this.load.audio("victorySound","assets/sounds/victorysound.mp3"),this.load.audio("keyboardSound","assets/sounds/keyboardsound.mp3"),this.load.audio("coinSound","assets/sounds/coinsound.mp3")}create(){const e=this;this.baseCreate("bakgrunnCity1"),this.resetPlayer(gameState.player,.45,370,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),this.definePermanentSlots(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{j(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{j(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.permanents=[],gameState.player.name=gameState.playerName?gameState.playerName:"Punk Rock Samurai",gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Nazi Punk",gameState.enemy1.sprite=this.add.image(740,355,"nazi").setScale(.42).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,470)})),k(gameState.freePermanent),gameState.drawPile=[...gameState.deck],this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030");const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theCity").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 1:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"On City Streets",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){x(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],l(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{j(gameState.startText,200),e.time.delayedCall(300,i())}))}function i(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),L(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),F(gameState.player),S(),H(gameState.player),e.shuffleDeck(gameState.drawPile);const n=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>j(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{c(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),l(t)}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,j(a,2e3),j(r,2e3),j(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,j(a,2e3),j(r,2e3),j(n,2e3),e.time.delayedCall(2200,s()))}));function l(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),m(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function m(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&x(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),g(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;g(t,a,n)}))}else"permanent"===gameState.typePlayed?k(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),g(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function g(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),j(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:o,stancePointsPlayed:s,poisonPlayed:i,healPlayed:l,strengthPlayed:m,armorPlayed:g,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:u,drawCardPlayed:h,poisonRemovePlayed:y}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:d(e.damage),firePlayed:m?2*r:o?12:d(e.fire),stancePointsPlayed:m&&a?-1:d(e.stancePoints),poisonPlayed:s?t.poison:d(e.poison)+S,healPlayed:d(e.heal),strengthPlayed:d(e.strength),armorPlayed:p?-r:d(e.armor),reduceTargetArmorPlayed:g?c:d(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:d(e.reduceTargetStrength),drawCardPlayed:d(e.drawCard),poisonRemovePlayed:d(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,o+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=u,a.armor-=p,a.poison+=i,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=m:gameState.player.strengthCard+=m,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),j(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),U(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(e){const t=Math.floor(Math.random()*gameState.currentCards.length),a=gameState.currentCards[t];j(a.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=a)),"debuff"!==a.type&&gameState.discardPile.push(a)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&f(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&f(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),l&&(gameState.player.health=Math.min(gameState.player.health+l,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=g,gameState.player.poison=Math.max(0,gameState.player.poison-y),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,i,m,g,y),gameState.player.stancePoints+s>=-3&&gameState.player.stancePoints+s<=3&&(gameState.player.stancePoints+=s,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),z(a),e.updateHealthBar(a),H(gameState.player),F(a),S(),c(),U(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&j(gameState.actionText,200),gameState.actionTextBackground&&j(gameState.actionTextBackground,200)}))}function d(e){return"function"==typeof e?e():e}function p(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{j(e,100)}))}))}t.turnComplete=!1,function(t){t.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),L(t),gameState.toxicAvenger&&t.poison>0&&z(t);const a=""!==t.poisonText._text||t.turnText?1800:700;e.time.delayedCall(a,(()=>{j(t.poisonText),j(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),z(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),F(t),z(t)})),e.time.delayedCall(1300,(()=>{gameState.actionText&&j(gameState.actionText,200),gameState.actionTextBackground&&j(gameState.actionTextBackground,200),t.turnComplete=!0,S()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?p():(gameState.currentEnemyIndex=0,i()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,p()))}function c(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:5,text:"Heals 10 HP\nGains 5 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:3,armor:0,text:"Heals 10 HP\nGains 3 Strength",probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 17 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function S(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),G(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&f(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&j(gameState.actionText,200);gameState.actionTextBackground&&j(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{y(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,f(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),h=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),f=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,y,p,S],B=[d,f,c,h];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),x(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),x(s),k.forEach((e=>{e&&e.destroy()})),u(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),x(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&j(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{j(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{j(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,u()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),G(),j(gameState.actionText,200),j(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function u(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&j(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{j(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,h())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,h())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{j(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],y(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(x(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),u(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function h(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function y(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function f(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function x(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function k(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),function(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}(t),function(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,H(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>z(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,H(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton"),gameState.healButton.setScale(.45).setOrigin(.5).setDepth(10).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5).setDepth(11),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(x(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,H(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,H(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),U(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":B(t);break;case"rebelSpirit":v(t);break;case"rebelHeart":P(t);break;case"bushido":b(t);break;case"toxicAvenger":C(t);break;case"kirisuteGomen":w(t);case"toxicFrets":D(t);break;case"ashenEncore":M(t);break;case"edoEruption":E(t);break;case"steelToe":I(t);break;case"deadTokugawas":A(t);break;case"gundanSeizai":O(t);break;case"LustForLife":R(t);break;case"PunksNotDead":$(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}function T(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function B(e){gameState.foreverTrue=!1,T(e),U(8)}function v(t){gameState.rebelSpirit=!1,T(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function P(t){gameState.rebelHeart=!1,T(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function b(e){gameState.bushido=!1,T(e),gameState.player.strengthBase+=6,H(gameState.player)}function C(e){gameState.toxicAvenger=!1,T(e),gameState.enemies.forEach((e=>{e.poison+=4,z(e)}))}function w(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),F(r),S(),H(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function D(t){gameState.toxicFrets=!1,T(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),F(t),S())}))}function M(t){gameState.ashenEncore=!1,T(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),F(t),S()}))}function E(e){gameState.edoEruption=!1,T(e)}function I(t){gameState.steelToe=!1,T(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,z(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function A(e){gameState.redrawPrice+=1,T(e)}function O(e){gameState.gundanSeizai=!1,f(3),T(e)}function R(t){gameState.lustForLife=!1,T(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function $(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),T(t)}function H(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),z(e)}function z(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function F(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void $(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,j(e.sprite,500),e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(f(1),gameState.troopsOfTakamoriCondition=!1)}[e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{e&&e.destroy()}))}}function G(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),j(e.sprite,200)}}function U(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),F(t),S(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function j(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function L(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,G(),H(gameState.player),c(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,j(e.intentionText,200),j(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),p()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(U(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,F(e),S(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight2 extends BaseScene{self;constructor(){super("Level1Fight2")}preload(){this.load.image("bakgrunnCity2","assets/images/bakgrunnCity2.jpg"),this.load.image("rat1","assets/images/sprites/rat1.png"),this.load.image("rat2","assets/images/sprites/rat2.png"),this.load.image("ratCard","assets/images/cards/ratCard.jpg")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const r=e.add.text(550,280,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(r,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,360,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),G(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),R(gameState.player),m(),A(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,r,n].forEach((e=>F(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const r={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},n="Heads up:\nRats are\nInfectious!",o=e.add.text(550,280,"",r).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,n),e.time.delayedCall(2500,(()=>{F(o,200),F(s,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),a(t),gameState.enemies.forEach((e=>{i(),l(e),z(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{i(),l(e),z(e)})),a(t))}))}this.baseCreate("bakgrunnCity2"),this.resetPlayer(gameState.player,.48,360,285),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{F(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{F(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Mutant City Rat",gameState.enemy1.cardKey="ratCard",gameState.enemy1.sprite=this.add.image(630,332,"rat1").setScale(.4).setFlipX(!0).setInteractive(),gameState.enemy1.health=40,gameState.enemy1.healthMax=40,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mutant City Rat",gameState.enemy2.cardKey="ratCard",gameState.enemy2.sprite=this.add.image(790,355,"rat2").setScale(.42).setFlipX(!0).setInteractive(),gameState.enemy2.health=50,gameState.enemy2.healthMax=50,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#696969"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),h(a),u(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){S(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],a(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:r,fight:n}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${r}\nFight ${n}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{F(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),o=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),r(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function r(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,o=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&o)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&S(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),n(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const o=r===e.length-1;n(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),h(t),u(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":f(t);break;case"rebelSpirit":x(t);break;case"rebelHeart":k(t);break;case"bushido":T(t);break;case"toxicAvenger":B(t);break;case"kirisuteGomen":v(t);case"toxicFrets":P(t);break;case"ashenEncore":b(t);break;case"edoEruption":C(t);break;case"steelToe":w(t);break;case"deadTokugawas":D(t);break;case"gundanSeizai":M(t);break;case"LustForLife":E(t);break;case"PunksNotDead":I(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("infection"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),n(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function n(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),F(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:s,stancePointsPlayed:l,poisonPlayed:g,healPlayed:d,strengthPlayed:p,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,s="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=l?1:0;return{damagePlayed:n?11:o(e.damage),firePlayed:g?2*r:s?12:o(e.fire),stancePointsPlayed:g&&a?-1:o(e.stancePoints),poisonPlayed:i?t.poison:o(e.poison)+S,healPlayed:o(e.heal),strengthPlayed:o(e.strength),armorPlayed:p?-r:o(e.armor),reduceTargetArmorPlayed:d?c:o(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:o(e.reduceTargetStrength),drawCardPlayed:o(e.drawCard),poisonRemovePlayed:o(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=g,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=p:gameState.player.strengthCard+=p,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),F(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),H(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];F(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&c(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&c(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,280,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,g,p,S,f),gameState.player.stancePoints+l>=-3&&gameState.player.stancePoints+l<=3&&(gameState.player.stancePoints+=l,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),O(a),e.updateHealthBar(a),A(gameState.player),R(a),m(),i(),H(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&F(gameState.actionText,200),gameState.actionTextBackground&&F(gameState.actionTextBackground,200)}))}function o(e){return"function"==typeof e?e():e}function s(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){if(gameState.playersTurn){gameState.playersTurn=!1;const t="Enemy's turn!";a.turnText=e.add.text(550,280,t,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(a.turnText,r,t);const n=[a.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,360,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{F(e,100)}))}))}a.turnComplete=!1,function(a){a.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),a.poisonTextBackground=e.add.graphics(),G(a),gameState.toxicAvenger&&a.poison>0&&O(a);let r=""!==a.poisonText._text||a.turnText?1800:700;gameState.infection&&(r+=1e3,gameState.infection=!1);e.time.delayedCall(r,(()=>{F(a.poisonText),F(a.poisonTextBackground);const r=a.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,280,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),O(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.infect?function(t){new Promise((a=>{let r=0;const n=450,o=200,s=450;let i=.45;const l=2300;gameState.infection=!0,e.attackTweens(t,60),gameState.attackSound.play({volume:.8});const m=[{key:"ratCard",type:"infection",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"ratCard",type:"infection",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];gameState.drawPile.push(...m);const g=[e.add.image(n,s,"ratCard").setScale(i).setOrigin(.5).setDepth(300),e.add.image(n+o,s,"ratCard").setScale(i).setOrigin(.5).setDepth(300)];let d="Adds 2 Infectious to your draw pile";gameState.actionText.y=s-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,d),e.time.delayedCall(l,(()=>{g.forEach((t=>{e.tweens.add({targets:t,x:120,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.drawPileText.setText(gameState.drawPile.length),r++,r===g.length&&a()}})}))}))}))}(a):gameState.infection=!1,r.damage>0||r.fire>0||r.poison>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal;let n=r.poison>0?r.text:`Deals ${a.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a)):(r.strength>0||r.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),R(t),O(t)}));const r=gameState.infection?2200:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&F(gameState.actionText,200),gameState.actionTextBackground&&F(gameState.actionTextBackground,200),a.turnComplete=!0,m()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?s():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,s()))}function i(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:3===gameState.turn||4===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 4 Poison",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 poison",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nInfect you",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Infects you",infect:!0,probability:1}]:2===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]:3===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nInfect you",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Infects you",infect:!0,probability:1}]:4===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 4 Poison",probability:1}]:gameState.enemy2.actions=[{key:"Intends to\nDeal 5 poison",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:4,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function l(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function m(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),$(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"infection"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&c(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&F(gameState.actionText,200);gameState.actionTextBackground&&F(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{p(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,c(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const d=e.add.image(t,a,"rectangularButton"),p=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*r,"rectangularButton"),u=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),h=e.add.image(t,a+2*r,"rectangularButton"),y=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[d,f,c,h],B=[p,x,u,y];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(d.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),d.on("pointerout",(()=>{d.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),d.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),d.setTexture("rectangularButtonPressed"),S(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),S(s),k.forEach((e=>{e&&e.destroy()})),g(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),S(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&F(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{F(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{F(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,g()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),$(),F(gameState.actionText,200),F(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function g(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&F(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{F(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,d())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,d())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{F(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],p(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(S(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),g(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function d(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function p(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function c(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function S(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function u(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,A(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>O(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,A(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(S(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,A(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,A(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),H(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function h(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function y(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function f(e){gameState.foreverTrue=!1,y(e),H(8)}function x(t){gameState.rebelSpirit=!1,y(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function k(t){gameState.rebelHeart=!1,y(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function T(e){gameState.bushido=!1,y(e),gameState.player.strengthBase+=6,A(gameState.player)}function B(e){gameState.toxicAvenger=!1,y(e),gameState.enemies.forEach((e=>{e.poison+=4,O(e)}))}function v(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),R(r),m(),A(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,y(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),R(t),m())}))}function b(t){gameState.ashenEncore=!1,y(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),R(t),m()}))}function C(e){gameState.edoEruption=!1,y(e)}function w(t){gameState.steelToe=!1,y(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,O(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function D(e){gameState.redrawPrice+=1,y(e)}function M(e){gameState.gundanSeizai=!1,c(3),y(e)}function E(t){gameState.lustForLife=!1,y(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function I(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),y(t)}function A(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),O(e)}function O(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function R(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void I(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(c(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{F(e,500)}))}}function $(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,"infection"===e.type&&(gameState.player.poison+=2),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),F(e.sprite,200)}}function H(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),R(t),m(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){r(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function z(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function F(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function G(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,$(),A(gameState.player),i(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,F(e.intentionText,200),F(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),s()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(H(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,R(e),m(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight3 extends BaseScene{self;constructor(){super("Level1Fight3")}preload(){this.load.image("bakgrunnCity3","assets/images/bakgrunnCity3.jpg"),this.load.image("police1","assets/images/sprites/police1.png"),this.load.image("police2","assets/images/sprites/police2.png"),this.load.audio("gunShotSound","assets/sounds/gunshot.mp3")}create(){const e=this;this.baseCreate("bakgrunnCity3"),this.resetPlayer(gameState.player,.5,360,340),this.addEndOfTurnButton(510),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{z(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{z(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}));let t=7;function a(){let a=gameState.player.numCardsBase+gameState.player.numCardsStance;if(gameState.turn+=1,t-=1,gameState.endOfTurnButtonPressed=!1,2===gameState.turn&&function(){const a={fontSize:"60px",fontWeight:"bold",fill:"#000000"};gameState.turnsTextBox=e.add.rectangle(550,150,55,55,16777215).setAlpha(.3).setOrigin(.5),gameState.turnsText=e.add.text(550,152,`${t}`,a).setOrigin(.5)}(),gameState.turn>2&&gameState.turnsText.setText(`${t}`),0===t)gameState.player.health=0,gameState.punksNotDeadCondition=!1,e.sound.add("gunShotSound").play({volume:1.5}),e.cameras.main.flash(600),e.cameras.main.shake(800,.01,!1),R(gameState.player),m();else{const t="Your turn!",n=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),o=e.add.graphics();e.updateTextAndBackground(n,o,t),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),F(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),R(gameState.player),m(),A(gameState.player),e.shuffleDeck(gameState.drawPile);const s=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(s,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,n,o].forEach((e=>z(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{l(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(22);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(21)}(t)})),r(a)}))}}gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Sgt. Pig",gameState.enemy1.sprite=this.add.image(680,340,"police1").setScale(.26).setFlipX(!0).setInteractive(),gameState.enemy1.health=45,gameState.enemy1.healthMax=45,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Lt. Pig",gameState.enemy2.sprite=this.add.image(840,340,"police2").setScale(.4).setFlipX(!0).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,460)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#303030"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),h(a),u(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){S(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],r(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:t,fight:n}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${n}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{z(gameState.startText,200),e.time.delayedCall(300,a())}))}();function r(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),o=10+r+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+r];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),n(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function n(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(gameState.playingCard||console.log("not gameState.playingCard"),r||console.log("not manaCostCondition"),a||console.log("not goldCostConditions"),t.usedOneShot&&console.log("card.usedOneShot"),a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&S(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),o(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;o(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),h(t),u(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":f(t);break;case"rebelSpirit":x(t);break;case"rebelHeart":k(t);break;case"bushido":T(t);break;case"toxicAvenger":B(t);break;case"kirisuteGomen":v(t);case"toxicFrets":P(t);break;case"ashenEncore":b(t);break;case"edoEruption":C(t);break;case"steelToe":w(t);break;case"deadTokugawas":D(t);break;case"gundanSeizai":M(t);break;case"LustForLife":E(t);break;case"PunksNotDead":I(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),o(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function o(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),z(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:o,stancePointsPlayed:i,poisonPlayed:g,healPlayed:d,strengthPlayed:p,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=l?1:0;return{damagePlayed:n?11:s(e.damage),firePlayed:g?2*r:o?12:s(e.fire),stancePointsPlayed:g&&a?-1:s(e.stancePoints),poisonPlayed:i?t.poison:s(e.poison)+S,healPlayed:s(e.heal),strengthPlayed:s(e.strength),armorPlayed:p?-r:s(e.armor),reduceTargetArmorPlayed:d?c:s(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:s(e.reduceTargetStrength),drawCardPlayed:s(e.drawCard),poisonRemovePlayed:s(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,o+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=g,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=p:gameState.player.strengthCard+=p,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),z(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),H(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];z(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&c(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&c(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,g,p,S,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),O(a),e.updateHealthBar(a),A(gameState.player),R(a),m(),l(),H(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&z(gameState.actionText,200),gameState.actionTextBackground&&z(gameState.actionTextBackground,200)}))}function s(e){return"function"==typeof e?e():e}function i(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const r="Enemy's turn!";t.turnText=e.add.text(550,300,r,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,r);const o=[t.turnText,n];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,n=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(n,s,r),o.push(n,s)}e.time.delayedCall(1700,(()=>{if(o.forEach((e=>z(e,100))),1===gameState.turn){const t={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},r=e.add.text(550,300,"   The pigs are\ncalling for backup!",t).setOrigin(.5).setDepth(201);let n=r.width,o=r.height,s=20,i=20;const l=e.add.graphics();l.fillStyle(16777215,.7),l.fillRect(r.x-n/2-s,r.y-o/2-i,n+2*s,o+2*i).setDepth(200),e.time.delayedCall(3500,(()=>{r.destroy(),l.destroy();const n=e.add.text(550,300,"Police snipers\n will hit you\n  in 5 turns!",t).setOrigin(.5).setDepth(201);let o=n.width,s=n.height,i=20,m=20;const g=e.add.graphics();g.fillStyle(16777215,.7),g.fillRect(n.x-o/2-i,n.y-s/2-m,o+2*i,s+2*m).setDepth(200),e.time.delayedCall(4500,(()=>{n.destroy(),g.destroy(),a()}))}))}}))}1!=gameState.turn&&(t.turnComplete=!1,function(t){t.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),F(t),gameState.toxicAvenger&&t.poison>0&&O(t);const r=""!==t.poisonText._text||t.turnText?1800:700;e.time.delayedCall(r,(()=>{z(t.poisonText),z(t.poisonTextBackground);const r=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=r.poison,t.health=Math.min(t.health+r.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+r.strength,t.strengthMax),O(t),t.armor=Math.min(t.armor+r.armor,t.armorMax),r.damage>0||r.fire>0||r.poison>0){const a=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,r.fire+r.damage*a)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=r.poison>0?r.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(t)):(r.strength>0||r.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),R(t),O(t)})),e.time.delayedCall(1300,(()=>{gameState.actionText&&z(gameState.actionText,200),gameState.actionTextBackground&&z(gameState.actionTextBackground,200),t.turnComplete=!0,m()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?i():(gameState.currentEnemyIndex=0,a()))}))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,i()))}function l(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRequest backup",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRequest backup",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}])}function m(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),$(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1)})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&c(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&z(gameState.actionText,200);gameState.actionTextBackground&&z(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=5,r=250,n=100;gameState.goldCollected=!1;const o="Collect loot and get\n ready for Level 2!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{p(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,c(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const d=e.add.image(t,a,"rectangularButton"),p=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*r,"rectangularButton"),u=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),h=e.add.image(t,a+2*r,"rectangularButton"),y=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[d,f,c,h],B=[p,x,u,y];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(d.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),d.on("pointerout",(()=>{d.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),d.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),d.setTexture("rectangularButtonPressed"),S(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),S(s),k.forEach((e=>{e&&e.destroy()})),g(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),S(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&z(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{z(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{z(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,g()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),$(),z(gameState.actionText,200),z(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function g(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),"permanent"===r.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(r),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&z(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{z(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,d())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,d())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{z(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],p(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),S(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),g(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function d(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function p(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function c(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function S(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function u(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,A(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>O(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,A(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?v(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(S(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,A(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,A(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),H(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function h(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function y(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function f(e){gameState.foreverTrue=!1,y(e),H(8)}function x(t){gameState.rebelSpirit=!1,y(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function k(t){gameState.rebelHeart=!1,y(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function T(e){gameState.bushido=!1,y(e),gameState.player.strengthBase+=6,A(gameState.player)}function B(e){gameState.toxicAvenger=!1,y(e),gameState.enemies.forEach((e=>{e.poison+=4,O(e)}))}function v(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),R(r),m(),A(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,y(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),R(t),m())}))}function b(t){gameState.ashenEncore=!1,y(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),R(t),m()}))}function C(e){gameState.edoEruption=!1,y(e)}function w(t){gameState.steelToe=!1,y(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,O(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function D(e){gameState.redrawPrice+=1,y(e)}function M(e){gameState.gundanSeizai=!1,c(3),y(e)}function E(t){gameState.lustForLife=!1,y(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function I(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),y(t)}function A(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),O(e)}function O(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function R(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void I(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(c(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{z(e,500)}))}}function $(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),z(e.sprite,200)}}function H(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),R(t),m(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){n(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function z(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function F(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,$(),A(gameState.player),l(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,z(e.intentionText,200),z(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),i()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(H(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,R(e),m(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight1 extends BaseScene{self;constructor(){super("Level2Fight1")}preload(){this.load.image("theForest","assets/images/theForest.jpg"),this.load.image("bakgrunnForest1","assets/images/bakgrunnForest1.jpg"),this.load.image("tree1","assets/images/sprites/tree1.png"),this.load.image("tree2","assets/images/sprites/tree2.png"),this.load.image("rooted","assets/images/cards/rooted.jpg")}create(){const e=this;this.baseCreate("bakgrunnForest1"),this.resetPlayer(gameState.player,.37,360,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{K(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{K(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Timbermaw\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.cardKey="rooted",gameState.enemy1.sprite=this.add.sprite(680,315,"tree1").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy.armor=15,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mossbite\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy2.cardKey="rooted",gameState.enemy2.sprite=this.add.sprite(920,315,"tree2").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemy2.armor=15,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#696969"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),B(a),T(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theForest").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 2:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Forest",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){k(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],l(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{K(gameState.startText,200),e.time.delayedCall(300,i())}))}function i(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),W(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),U(gameState.player),u(),F(gameState.player),e.shuffleDeck(gameState.drawPile);const n=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>K(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let r="Trees start with\nfull Armor, and lose\n1 Armor when attacked";const n=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{r="Naturally, they are also\nvulnerabel to fire",e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{K(n,200),K(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),l(t),gameState.enemies.forEach((e=>{c(),S(e),N(e)}))}))}))}))}(t):(gameState.enemies.forEach((e=>{c(),S(e),N(e)})),l(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,K(a,2e3),K(r,2e3),K(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,K(a,2e3),K(r,2e3),K(n,2e3),e.time.delayedCall(2200,s()))}));function l(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),m(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function m(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&k(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),g(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;g(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),B(t),T(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":P(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":C(t);break;case"bushido":w(t);break;case"toxicAvenger":D(t);break;case"kirisuteGomen":M(t);case"toxicFrets":E(t);break;case"ashenEncore":I(t);break;case"edoEruption":A(t);break;case"steelToe":O(t);break;case"deadTokugawas":R(t);break;case"gundanSeizai":$(t);break;case"LustForLife":H(t);break;case"PunksNotDead":z(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),g(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function g(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),K(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:o,stancePointsPlayed:s,poisonPlayed:i,healPlayed:l,strengthPlayed:m,armorPlayed:g,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:S,drawCardPlayed:h,poisonRemovePlayed:y}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:d(e.damage),firePlayed:1.5*(m?2*r:o?12:d(e.fire)),stancePointsPlayed:m&&a?-1:d(e.stancePoints),poisonPlayed:s?t.poison:d(e.poison)+S,healPlayed:d(e.heal),strengthPlayed:d(e.strength),armorPlayed:p?-r:d(e.armor),reduceTargetArmorPlayed:g?c:d(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:d(e.reduceTargetStrength),drawCardPlayed:d(e.drawCard),poisonRemovePlayed:d(e.poisonRemove)}}(t,a,r),f=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,o+n*f));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*f*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=S,a.armor-=p,a.poison+=i,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=m:gameState.player.strengthCard+=m,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),K(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),L(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];K(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&x(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&x(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),l&&(gameState.player.health=Math.min(gameState.player.health+l,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=g,gameState.player.poison=Math.max(0,gameState.player.poison-y),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,i,m,g,y),gameState.player.stancePoints+s>=-3&&gameState.player.stancePoints+s<=3&&(gameState.player.stancePoints+=s,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),G(a),e.updateHealthBar(a),F(gameState.player),U(a),u(),c(),L(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&K(gameState.actionText,200),gameState.actionTextBackground&&K(gameState.actionTextBackground,200)}))}function d(e){return"function"==typeof e?e():e}function p(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{K(e,100)}))}))}t.turnComplete=!1,function(t){t.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),W(t),gameState.toxicAvenger&&t.poison>0&&G(t);let a=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(a+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(a,(()=>{K(t.poisonText),K(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),G(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameState.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),U(t),G(t)}));const a=gameState.debuffCardPlayed?2200:1300;e.time.delayedCall(a,(()=>{gameState.actionText&&K(gameState.actionText,200),gameState.actionTextBackground&&K(gameState.actionTextBackground,200),t.turnComplete=!0,u()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?p():(gameState.currentEnemyIndex=0,i()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,p()))}function c(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 13 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 13 damage",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:5,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:5,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):5===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.24+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,text:"Gains 2 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5}],gameState.enemy2.actions=[{key:"Intends to\nDeal 10 fire damage",damage:0,fire:10,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 fire damage",probability:0},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5}])}function S(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function u(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),j(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&x(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&K(gameState.actionText,200);gameState.actionTextBackground&&K(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{f(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,x(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),u=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),f=e.add.text(t,a+3*r,"Exit Shop",m);let x=[];const T=[g,y,p,S],B=[d,f,c,u];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),k(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),x.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();x.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(x=x.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),k(s),x.forEach((e=>{e&&e.destroy()})),h(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),k(i),x.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&K(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{K(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{K(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,h()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),j(),K(gameState.actionText,200),K(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function h(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&K(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{K(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,y())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,y())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{K(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],f(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),k(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),h(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function y(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function f(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function x(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function k(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function T(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,F(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>G(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,F(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?M(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(k(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,F(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,F(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),L(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function B(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function v(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function P(e){gameState.foreverTrue=!1,v(e),L(8)}function b(t){gameState.rebelSpirit=!1,v(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function C(t){gameState.rebelHeart=!1,v(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function w(e){gameState.bushido=!1,v(e),gameState.player.strengthBase+=6,F(gameState.player)}function D(e){gameState.toxicAvenger=!1,v(e),gameState.enemies.forEach((e=>{e.poison+=4,G(e)}))}function M(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),U(r),u(),F(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function E(t){gameState.toxicFrets=!1,v(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),U(t),u())}))}function I(t){gameState.ashenEncore=!1,v(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),U(t),u()}))}function A(e){gameState.edoEruption=!1,v(e)}function O(t){gameState.steelToe=!1,v(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,G(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function R(e){gameState.redrawPrice+=1,v(e)}function $(e){gameState.gundanSeizai=!1,x(3),v(e)}function H(t){gameState.lustForLife=!1,v(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function z(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),v(t)}function F(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),G(e)}function G(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function U(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void z(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(x(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{K(e,500)}))}}function j(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),K(e.sprite,200)}}function L(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),U(t),u(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function N(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function K(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function W(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,j(),F(gameState.player),c(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,K(e.intentionText,200),K(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),p()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(L(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,U(e),u(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight2 extends BaseScene{self;constructor(){super("Level2Fight2")}preload(){this.load.image("bakgrunnForest2","assets/images/bakgrunnForest2.jpg"),this.load.image("goblin1","assets/images/sprites/goblin1.png"),this.load.image("goblin2","assets/images/sprites/goblin2.png"),this.load.image("goblin3","assets/images/sprites/goblin3.png")}create(){const e=this;this.baseCreate("bakgrunnForest2"),this.resetPlayer(gameState.player,.5,360,330),this.addEndOfTurnButton(510),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{G(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{G(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}));let t=7;for(gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck];gameState.extraCards.length;)gameState.bonusCards.push(gameState.extraCards.pop());function a(){let a=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,t>0&&(t-=1),2===gameState.turn&&function(){const a={fontSize:"70px",fontWeight:"bold",fill:"#000000"};gameState.countdownTextBox=e.add.image(550,150,"goldCoin").setScale(.12),gameState.countdownText=e.add.text(530,120,`${t}`,a)}(),gameState.turn>2&&gameState.countdownText.setText(`${t}`),0===t&&(gameState.countdownTextBox.destroy(),gameState.countdownText.destroy(),e.cameras.main.shake(800,.005,!1));const n=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),o=e.add.graphics();e.updateTextAndBackground(n,o,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),U(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),$(gameState.player),g(),O(gameState.player),e.shuffleDeck(gameState.drawPile);const s=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(s,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,n,o].forEach((e=>G(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},n="Defeat the Goblins\nto steal their gold!";gameState.introText=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),gameState.introTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.introText,gameState.introTextBackground,n),e.time.delayedCall(2500,(()=>{G(gameState.introText,200),G(gameState.introTextBackground,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),r(t),gameState.enemies.forEach((e=>{l(),m(e),F(e)}))}))}))}(a):(gameState.enemies.forEach((e=>{l(),m(e),F(e)})),r(a))}))}gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Junior Goblin\nApprentice of poison",gameState.enemy1.sprite=this.add.sprite(670,380,"goblin1").setScale(.2).setFlipX(!0).setInteractive(),gameState.enemy1.health=30,gameState.enemy1.healthMax=30,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Junior Goblin\nApprentice of poison",gameState.enemy2.sprite=this.add.sprite(800,380,"goblin3").setScale(.18).setFlipX(!1).setInteractive(),gameState.enemy2.health=30,gameState.enemy2.healthMax=30,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Senior Goblin\nMaster of poison",gameState.enemy3.sprite=this.add.sprite(930,380,"goblin2").setScale(.25).setFlipX(!1).setInteractive(),gameState.enemy3.health=45,gameState.enemy3.healthMax=45,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#696969"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),y(a),h(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){u(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],r(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:t,fight:n}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${n}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{G(gameState.startText,200),e.time.delayedCall(300,a())}))}();function r(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),o=10+r+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+r];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),n(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function n(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&u(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),o(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;o(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),y(t),h(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":x(t);break;case"rebelSpirit":k(t);break;case"rebelHeart":T(t);break;case"bushido":B(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":P(t);case"toxicFrets":b(t);break;case"ashenEncore":C(t);break;case"edoEruption":w(t);break;case"steelToe":D(t);break;case"deadTokugawas":M(t);break;case"gundanSeizai":E(t);break;case"LustForLife":I(t);break;case"PunksNotDead":A(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),o(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function o(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),G(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:o,stancePointsPlayed:i,poisonPlayed:m,healPlayed:d,strengthPlayed:p,armorPlayed:c,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=l?1:0;return{damagePlayed:n?11:s(e.damage),firePlayed:g?2*r:o?12:s(e.fire),stancePointsPlayed:g&&a?-1:s(e.stancePoints),poisonPlayed:i?t.poison:s(e.poison)+S,healPlayed:s(e.heal),strengthPlayed:s(e.strength),armorPlayed:p?-r:s(e.armor),reduceTargetArmorPlayed:d?c:s(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:s(e.reduceTargetStrength),drawCardPlayed:s(e.drawCard),poisonRemovePlayed:s(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,o+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=m,a.health-=k),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=p:gameState.player.strengthCard+=p,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),G(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),z(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];G(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&S(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&S(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=c,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,m,p,c,f),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),R(a),e.updateHealthBar(a),O(gameState.player),$(a),g(),l(),z(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&G(gameState.actionText,200),gameState.actionTextBackground&&G(gameState.actionTextBackground,200)}))}function s(e){return"function"==typeof e?e():e}function i(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const r="Enemy's turn!";t.turnText=e.add.text(550,300,r,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const n=e.add.graphics();e.updateTextAndBackground(t.turnText,n,r);const o=[t.turnText,n];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,n=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(n,s,r),o.push(n,s)}e.time.delayedCall(1700,(()=>{if(o.forEach((e=>G(e,100))),1===gameState.turn){const t={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},r=e.add.text(550,300,"The Goblins are\nevacuating their gold!",t).setOrigin(.5).setDepth(201);let n=r.width,o=r.height,s=20,i=20;const l=e.add.graphics();l.fillStyle(16777215,.7),l.fillRect(r.x-n/2-s,r.y-o/2-i,n+2*s,o+2*i).setDepth(200),e.time.delayedCall(2500,(()=>{r.destroy(),l.destroy();const n=e.add.text(550,300,"Defeat them in\n5 turns to steal\nwhat's left!",t).setOrigin(.5).setDepth(201);let o=n.width,s=n.height,i=20,m=20;const g=e.add.graphics();g.fillStyle(16777215,.7),g.fillRect(n.x-o/2-i,n.y-s/2-m,o+2*i,s+2*m).setDepth(200),e.time.delayedCall(2500,(()=>{n.destroy(),g.destroy(),a()}))}))}}))}1!=gameState.turn&&(t.turnComplete=!1,function(t){t.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),U(t),gameState.toxicAvenger&&t.poison>0&&R(t);const r=""!==t.poisonText._text||t.turnText?1800:700;e.time.delayedCall(r,(()=>{G(t.poisonText),G(t.poisonTextBackground);const r=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=r.poison,t.health=Math.min(t.health+r.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+r.strength,t.strengthMax),R(t),t.armor=Math.min(t.armor+r.armor,t.armorMax),r.damage>0||r.fire>0||r.poison>0){const a=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,r.fire+r.damage*a)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=r.poison>0?r.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(t)):(r.strength>0||r.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),$(t),R(t)})),e.time.delayedCall(1300,(()=>{gameState.actionText&&G(gameState.actionText,200),gameState.actionTextBackground&&G(gameState.actionTextBackground,200),t.turnComplete=!0,g()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?i():(gameState.currentEnemyIndex=0,a()))}))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,i()))}function l(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}],gameState.enemy3.actions=[{key:"Intends to\nEvacuate Gold",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Evacuates Gold",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6}],gameState.enemy3.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:0+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(11*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:11,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage\nAnd 1 Poison",probability:.17+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage\nAnd 1 Poison",probability:.11+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.18+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 3 poison",probability:.19+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6}])}function m(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function g(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),H(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1)})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&S(1),t>0&&function(){for(let a=0;a<t;a++)e.time.delayedCall(200*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),t-=1,gameState.goldCounter.setText(gameState.player.gold),gameState.countdownText.setText(t),gameState.coinSound.play({volume:.8,seek:.02})}));0===t&&(G(gameState.countdownTextBox,250),G(gameState.countdownText,250))}(),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&G(gameState.actionText,200);gameState.actionTextBackground&&G(gameState.actionTextBackground,200);const a={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},r=e.add.text(550,300,"Victory!",a).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),r.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{c(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,S(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),p=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),c=e.add.image(t,a+1*r,"rectangularButton"),S=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),h=e.add.image(t,a+2*r,"rectangularButton"),y=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),f=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",m);let k=[];const T=[g,f,c,h],B=[p,x,S,y];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),u(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),c.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),u(s),k.forEach((e=>{e&&e.destroy()})),d(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),c.setTexture("rectangularButtonPressed"),u(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&G(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{G(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{G(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,d()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),H(),G(gameState.actionText,200),G(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function d(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&G(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{G(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,p())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,p())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{G(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],c(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),u(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),d(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function p(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function c(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function S(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function u(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function h(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,O(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>R(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,O(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?P(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(u(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,O(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,O(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),z(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function y(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function f(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(e){gameState.foreverTrue=!1,f(e),z(8)}function k(t){gameState.rebelSpirit=!1,f(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function T(t){gameState.rebelHeart=!1,f(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function B(e){gameState.bushido=!1,f(e),gameState.player.strengthBase+=6,O(gameState.player)}function v(e){gameState.toxicAvenger=!1,f(e),gameState.enemies.forEach((e=>{e.poison+=4,R(e)}))}function P(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),$(r),g(),O(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function b(t){gameState.toxicFrets=!1,f(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),$(t),g())}))}function C(t){gameState.ashenEncore=!1,f(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),$(t),g()}))}function w(e){gameState.edoEruption=!1,f(e)}function D(t){gameState.steelToe=!1,f(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,R(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function M(e){gameState.redrawPrice+=1,f(e)}function E(e){gameState.gundanSeizai=!1,S(3),f(e)}function I(t){gameState.lustForLife=!1,f(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function A(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),f(t)}function O(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),R(e)}function R(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function $(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void A(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(S(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{G(e,500)}))}}function H(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),G(e.sprite,200)}}function z(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),$(t),g(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){n(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function F(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function G(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function U(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,H(),O(gameState.player),l(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,G(e.intentionText,200),G(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),i()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(z(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,$(e),g(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight3 extends BaseScene{self;constructor(){super("Level2Fight3")}preload(){this.load.image("bakgrunnForest3","assets/images/bakgrunnForest1.jpg"),this.load.image("tree3","assets/images/sprites/tree3.png"),this.load.image("rooted","assets/images/cards/rooted.jpg")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const r=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(r,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),z(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),O(gameState.player),l(),I(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,r,n].forEach((e=>H(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),gameState.enemies.forEach((t=>{i(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),a(t)}))}this.baseCreate("bakgrunnForest1"),this.resetPlayer(gameState.player,.37,360,360),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{H(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{H(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Lord of the Trees\nLose Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.cardKey="rooted",gameState.enemy1.sprite=this.add.sprite(780,300,"tree3").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy1.health=110,gameState.enemy1.healthMax=110,gameState.enemy1.armor=15,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#696969"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),u(a),S(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){c(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],a(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:r,fight:n}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${r}\nFight ${n}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{H(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),o=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),r(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function r(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,o=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&o)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&c(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),n(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const o=r===e.length-1;n(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),u(t),S(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":y(t);break;case"rebelSpirit":f(t);break;case"rebelHeart":x(t);break;case"bushido":k(t);break;case"toxicAvenger":T(t);break;case"kirisuteGomen":B(t);case"toxicFrets":v(t);break;case"ashenEncore":P(t);break;case"edoEruption":b(t);break;case"steelToe":C(t);break;case"deadTokugawas":w(t);break;case"gundanSeizai":D(t);break;case"LustForLife":M(t);break;case"PunksNotDead":E(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),n(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function n(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),H(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:g,healPlayed:d,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,s="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=l?1:0;return{damagePlayed:n?11:o(e.damage),firePlayed:1.5*(g?2*r:s?12:o(e.fire)),stancePointsPlayed:g&&a?-1:o(e.stancePoints),poisonPlayed:i?t.poison:o(e.poison)+S,healPlayed:o(e.heal),strengthPlayed:o(e.strength),armorPlayed:p?-r:o(e.armor),reduceTargetArmorPlayed:d?c:o(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:o(e.reduceTargetStrength),drawCardPlayed:o(e.drawCard),poisonRemovePlayed:o(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=g,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),H(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),$(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];H(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&p(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&p(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,g,c,S,f),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),A(a),e.updateHealthBar(a),I(gameState.player),O(a),l(),i(),$(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&H(gameState.actionText,200),gameState.actionTextBackground&&H(gameState.actionTextBackground,200)}))}function o(e){return"function"==typeof e?e():e}function s(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){if(gameState.playersTurn){gameState.playersTurn=!1;const t="Enemy's turn!";a.turnText=e.add.text(550,300,t,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(a.turnText,r,t);const n=[a.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{H(e,100)}))}))}a.turnComplete=!1,function(a){a.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),a.poisonTextBackground=e.add.graphics(),z(a),gameState.toxicAvenger&&a.poison>0&&A(a);let r=""!==a.poisonText._text||a.turnText?1800:700;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{H(a.poisonText),H(a.poisonTextBackground);const r=a.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),A(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameState.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:2,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),n++,n===h.length&&r()}})}))}))}))}(a,r):gameState.debuffCardPlayed=!1,r.damage>0||r.fire>0||r.poison>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal;let n=r.poison>0?r.text:`Deals ${a.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a)):(r.strength>0||r.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),O(t),A(t)}));const r=gameState.debuffCardPlayed?2200:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&H(gameState.actionText,200),gameState.actionTextBackground&&H(gameState.actionTextBackground,200),a.turnComplete=!0,l()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?s():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,s()))}function i(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]:5===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.23+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5}]}function l(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),R(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&p(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&H(gameState.actionText,200);gameState.actionTextBackground&&H(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=5,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{d(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,p(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},g={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const d=e.add.image(t,a,"rectangularButton"),p=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,g),S=e.add.image(t,a+1*r,"rectangularButton"),u=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,g),h=e.add.image(t,a+2*r,"rectangularButton"),y=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,g),f=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",g);let k=[];const T=[d,f,S,h],B=[p,x,u,y];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(d.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),d.on("pointerout",(()=>{d.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),d.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),d.setTexture("rectangularButtonPressed"),c(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),S.setTexture("rectangularButtonPressed"),c(s),k.forEach((e=>{e&&e.destroy()})),m(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),S.setTexture("rectangularButtonPressed"),c(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&H(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{H(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{H(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,m()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),R(),H(gameState.actionText,200),H(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function m(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&H(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{H(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,g())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,g())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{H(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],d(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),c(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),m(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function g(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function d(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function p(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function c(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function S(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?y(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>A(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(c(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,I(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,I(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),$(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function u(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function h(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function y(e){gameState.foreverTrue=!1,h(e),$(8)}function f(t){gameState.rebelSpirit=!1,h(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function x(t){gameState.rebelHeart=!1,h(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function k(e){gameState.bushido=!1,h(e),gameState.player.strengthBase+=6,I(gameState.player)}function T(e){gameState.toxicAvenger=!1,h(e),gameState.enemies.forEach((e=>{e.poison+=4,A(e)}))}function B(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),O(r),l(),I(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function v(t){gameState.toxicFrets=!1,h(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),O(t),l())}))}function P(t){gameState.ashenEncore=!1,h(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),O(t),l()}))}function b(e){gameState.edoEruption=!1,h(e)}function C(t){gameState.steelToe=!1,h(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,A(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function w(e){gameState.redrawPrice+=1,h(e)}function D(e){gameState.gundanSeizai=!1,p(3),h(e)}function M(t){gameState.lustForLife=!1,h(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function E(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),h(t)}function I(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),A(e)}function A(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function O(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void E(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(p(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{H(e,500)}))}}function R(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),H(e.sprite,200)}}function $(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),O(t),l(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){r(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function H(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function z(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,R(),I(gameState.player),i(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,H(e.intentionText,200),H(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),s()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&($(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,O(e),l(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight1 extends BaseScene{self;constructor(){super("Level3Fight1")}preload(){this.load.image("bakgrunnLair1","assets/images/bakgrunnLair1.jpg"),this.load.image("theDemonLair","assets/images/theDemonLair.jpg"),this.load.image("demon1","assets/images/sprites/demon1.png"),this.load.image("demon2","assets/images/sprites/demon2.png"),this.load.image("hellFire","assets/images/cards/hellFire.jpg")}create(){const e=this;this.baseCreate("bakgrunnLair1"),this.resetPlayer(gameState.player,.41,350,345),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{K(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{K(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.player.health=gameState.player.healthMax,gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Voidling",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(690,355,"demon1").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Infernus",gameState.enemy2.cardKey="hellFire",gameState.enemy2.sprite=this.add.sprite(910,325,"demon2").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy2.health=65,gameState.enemy2.healthMax=65,gameState.enemy2.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#d1d1d1"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),B(a),T(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theDemonLair").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 3:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Demons' Lair",t).setDepth(301).setOrigin(.5);let o=!1;function s(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){k(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],l(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{K(gameState.startText,200),e.time.delayedCall(300,i())}))}function i(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const a=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),r=e.add.graphics();e.updateTextAndBackground(a,r,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),W(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),U(gameState.player),u(),F(gameState.player),e.shuffleDeck(gameState.drawPile);const n=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(n,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,a,r].forEach((e=>K(e,200))),1===gameState.turn?function(t){e.time.delayedCall(300,(()=>{const a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"};let r="Heads up:\nDemons fight\nwith Fire!";const n=e.add.text(550,300,"",a).setOrigin(.5).setDepth(201),o=e.add.graphics();e.updateTextAndBackground(n,o,r),e.time.delayedCall(3e3,(()=>{K(n,200),K(o,200),gameState.characters.forEach((t=>{e.describeCharacter(t,t.sprite)})),l(t),gameState.enemies.forEach((e=>{c(),S(e),N(e)}))}))}))}(t):(gameState.enemies.forEach((e=>{c(),S(e),N(e)})),l(t))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,K(a,2e3),K(r,2e3),K(n,2e3),e.time.delayedCall(2200,s()))})),e.input.on("pointerup",(()=>{o||(o=!0,K(a,2e3),K(r,2e3),K(n,2e3),e.time.delayedCall(2200,s()))}));function l(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n),t.usedOneShot&&t.sprite.setTint(8421504);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),m(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function m(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,n=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&n)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&k(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),g(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;g(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),B(t),T(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":P(t);break;case"rebelSpirit":b(t);break;case"rebelHeart":C(t);break;case"bushido":w(t);break;case"toxicAvenger":D(t);break;case"kirisuteGomen":M(t);case"toxicFrets":E(t);break;case"ashenEncore":I(t);break;case"edoEruption":A(t);break;case"steelToe":O(t);break;case"deadTokugawas":R(t);break;case"gundanSeizai":$(t);break;case"LustForLife":H(t);break;case"PunksNotDead":z(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),g(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function g(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),K(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:o,stancePointsPlayed:s,poisonPlayed:i,healPlayed:l,strengthPlayed:m,armorPlayed:g,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:S,drawCardPlayed:h,poisonRemovePlayed:y}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,s="bladesBlight"===e.key&&t.poison>0,i="rottenResonance"===e.key&&0===t.poison,l="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,g="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=i?1:0;return{damagePlayed:n?11:d(e.damage),firePlayed:1.5*(m?2*r:o?12:d(e.fire)),stancePointsPlayed:m&&a?-1:d(e.stancePoints),poisonPlayed:s?t.poison:d(e.poison)+S,healPlayed:d(e.heal),strengthPlayed:d(e.strength),armorPlayed:p?-r:d(e.armor),reduceTargetArmorPlayed:g?c:d(e.reduceTargetArmor),reduceTargetStrengthPlayed:l?t.poison:d(e.reduceTargetStrength),drawCardPlayed:d(e.drawCard),poisonRemovePlayed:d(e.poisonRemove)}}(t,a,r),f=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,o+n*f));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*f*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=S,a.armor-=p,a.poison+=i,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=m:gameState.player.strengthCard+=m,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),K(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),L(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];K(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&x(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&x(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),l&&(gameState.player.health=Math.min(gameState.player.health+l,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=g,gameState.player.poison=Math.max(0,gameState.player.poison-y),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,i,m,g,y),gameState.player.stancePoints+s>=-3&&gameState.player.stancePoints+s<=3&&(gameState.player.stancePoints+=s,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),G(a),e.updateHealthBar(a),F(gameState.player),U(a),u(),c(),L(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&K(gameState.actionText,200),gameState.actionTextBackground&&K(gameState.actionTextBackground,200)}))}function d(e){return"function"==typeof e?e():e}function p(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){if(gameState.playersTurn){gameState.playersTurn=!1;const a="Enemy's turn!";t.turnText=e.add.text(550,300,a,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(t.turnText,r,a);const n=[t.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{K(e,100)}))}))}t.turnComplete=!1,function(t){t.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),t.poisonTextBackground=e.add.graphics(),W(t),gameState.toxicAvenger&&t.poison>0&&G(t);let a=""!==t.poisonText._text||t.turnText?1800:700;gameState.debuffCardPlayed&&(a+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(a,(()=>{K(t.poisonText),K(t.poisonTextBackground);const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",r).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),G(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameState.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),n++,n===h.length&&r()}})}))}))}))}(t,a):gameState.debuffCardPlayed=!1,a.damage>0||a.fire>0||a.poison>0){const r=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*r)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;let n=a.poison>0?a.text:`Deals ${t.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t)):(a.strength>0||a.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,a.text),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),U(t),G(t)}));const a=gameState.debuffCardPlayed?2200:1300;e.time.delayedCall(a,(()=>{gameState.actionText&&K(gameState.actionText,200),gameState.actionTextBackground&&K(gameState.actionTextBackground,200),t.turnComplete=!0,u()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?p():(gameState.currentEnemyIndex=0,i()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,p()))}function c(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Applies a debuff",debuffCard:"discard",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:5,reduceTargetStrength:0,reduceTargetArmor:0,text:"Gains 2 Strength\nAnd 5 Armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nDeal 7 Fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 7 Fire damage",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 Fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 5 Fire damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 16 damage",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 Fire damage",probability:.2+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strenght",probability:.09+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 Armor",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.05}],gameState.enemy2.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 Fire damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.2+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.14+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 Armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strenght",probability:.09+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 Armor",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1}])}function S(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function u(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),j(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&x(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&K(gameState.actionText,200);gameState.actionTextBackground&&K(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="Collect loot and get\n ready for Level 3!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const m=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{f(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,x(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},m={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const g=e.add.image(t,a,"rectangularButton"),d=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,m),p=e.add.image(t,a+1*r,"rectangularButton"),c=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,m),S=e.add.image(t,a+2*r,"rectangularButton"),u=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,m),y=e.add.image(t,a+3*r,"rectangularButton"),f=e.add.text(t,a+3*r,"Exit Shop",m);let x=[];const T=[g,y,p,S],B=[d,f,c,u];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(g.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),g.on("pointerout",(()=>{g.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),g.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),g.setTexture("rectangularButtonPressed"),k(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),x.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();x.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(x=x.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),p.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),k(s),x.forEach((e=>{e&&e.destroy()})),h(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),p.setTexture("rectangularButtonPressed"),k(i),x.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&K(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{K(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),y.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{K(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...m,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,h()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),j(),K(gameState.actionText,200),K(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function h(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&K(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{K(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,y())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,y())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{K(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],f(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),k(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),h(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function y(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function f(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function x(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function k(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function T(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,F(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>G(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,F(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?M(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?I(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?A(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?O(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?$(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?R(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(k(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?H(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?z(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,F(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,F(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),L(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function B(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function v(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function P(e){gameState.foreverTrue=!1,v(e),L(8)}function b(t){gameState.rebelSpirit=!1,v(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function C(t){gameState.rebelHeart=!1,v(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function w(e){gameState.bushido=!1,v(e),gameState.player.strengthBase+=6,F(gameState.player)}function D(e){gameState.toxicAvenger=!1,v(e),gameState.enemies.forEach((e=>{e.poison+=4,G(e)}))}function M(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),U(r),u(),F(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function E(t){gameState.toxicFrets=!1,v(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),U(t),u())}))}function I(t){gameState.ashenEncore=!1,v(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),U(t),u()}))}function A(e){gameState.edoEruption=!1,v(e)}function O(t){gameState.steelToe=!1,v(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,G(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function R(e){gameState.redrawPrice+=1,v(e)}function $(e){gameState.gundanSeizai=!1,x(3),v(e)}function H(t){gameState.lustForLife=!1,v(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function z(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),v(t)}function F(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),G(e)}function G(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function U(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void z(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(x(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{K(e,500)}))}}function j(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),K(e.sprite,200)}}function L(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),U(t),u(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function N(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function K(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function W(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,j(),F(gameState.player),c(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,K(e.intentionText,200),K(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),p()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(L(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,U(e),u(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight2 extends BaseScene{self;constructor(){super("Level3Fight2")}preload(){this.load.image("bakgrunnLair2","assets/images/bakgrunnLair2.jpg"),this.load.image("skeleton1","assets/images/sprites/skeleton1.png"),this.load.image("skeleton2","assets/images/sprites/skeleton2.png")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const r=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(r,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),z(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),O(gameState.player),l(),I(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,r,n].forEach((e=>H(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{i(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),a(t)}))}this.baseCreate("bakgrunnLair2"),this.resetPlayer(gameState.player,.43,350,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{H(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{H(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Spineguard",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(700,355,"skeleton1").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=2,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Bonebaron",gameState.enemy2.cardKey="hellFire",gameState.enemy2.sprite=this.add.sprite(910,345,"skeleton2").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy2.health=70,gameState.enemy2.healthMax=70,gameState.enemy2.armor=2,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),u(a),S(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){c(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],a(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:r,fight:n}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${r}\nFight ${n}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{H(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),o=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),r(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function r(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,o=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&o)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&c(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),n(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const o=r===e.length-1;n(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),u(t),S(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":y(t);break;case"rebelSpirit":f(t);break;case"rebelHeart":x(t);break;case"bushido":k(t);break;case"toxicAvenger":T(t);break;case"kirisuteGomen":B(t);case"toxicFrets":v(t);break;case"ashenEncore":P(t);break;case"edoEruption":b(t);break;case"steelToe":C(t);break;case"deadTokugawas":w(t);break;case"gundanSeizai":D(t);break;case"LustForLife":M(t);break;case"PunksNotDead":E(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),n(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function n(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),H(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:g,healPlayed:d,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,s="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=l?1:0;return{damagePlayed:n?11:o(e.damage),firePlayed:1.5*(g?2*r:s?12:o(e.fire)),stancePointsPlayed:g&&a?-1:o(e.stancePoints),poisonPlayed:i?t.poison:o(e.poison)+S,healPlayed:o(e.heal),strengthPlayed:o(e.strength),armorPlayed:p?-r:o(e.armor),reduceTargetArmorPlayed:d?c:o(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:o(e.reduceTargetStrength),drawCardPlayed:o(e.drawCard),poisonRemovePlayed:o(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=g,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),H(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),$(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];H(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&p(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&p(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,g,c,S,f),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),A(a),e.updateHealthBar(a),I(gameState.player),O(a),l(),i(),$(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&H(gameState.actionText,200),gameState.actionTextBackground&&H(gameState.actionTextBackground,200)}))}function o(e){return"function"==typeof e?e():e}function s(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){if(gameState.playersTurn){gameState.playersTurn=!1;const t="Enemy's turn!";a.turnText=e.add.text(550,300,t,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(a.turnText,r,t);const n=[a.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{H(e,100)}))}))}a.turnComplete=!1,function(a){a.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),a.poisonTextBackground=e.add.graphics(),z(a),gameState.toxicAvenger&&a.poison>0&&A(a);let r=""!==a.poisonText._text||a.turnText?1800:700;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{H(a.poisonText),H(a.poisonTextBackground);const r=a.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),A(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameState.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),n++,n===h.length&&r()}})}))}))}))}(a,r):gameState.debuffCardPlayed=!1,r.damage>0||r.fire>0||r.poison>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal;let n=r.poison>0?r.text:`Deals ${a.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a)):(r.strength>0||r.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),O(t),A(t)}));const r=gameState.debuffCardPlayed?2200:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&H(gameState.actionText,200),gameState.actionTextBackground&&H(gameState.actionTextBackground,200),a.turnComplete=!0,l()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?s():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,s()))}function i(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:4,text:"Heals 10 HP\nGains 4 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:4,text:"Heals 15 HP\nGains 4 armor",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.09+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.22+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.04},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1}],gameState.enemy2.actions=[{key:"Intends to\nDeal 8 fire damage",damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 fire damage",probability:.08+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.25+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.14},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.08+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.19:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.15}])}function l(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),R(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&p(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&H(gameState.actionText,200);gameState.actionTextBackground&&H(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{d(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,p(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},g={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const d=e.add.image(t,a,"rectangularButton"),p=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,g),S=e.add.image(t,a+1*r,"rectangularButton"),u=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,g),h=e.add.image(t,a+2*r,"rectangularButton"),y=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,g),f=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",g);let k=[];const T=[d,f,S,h],B=[p,x,u,y];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(d.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),d.on("pointerout",(()=>{d.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),d.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),d.setTexture("rectangularButtonPressed"),c(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),S.setTexture("rectangularButtonPressed"),c(s),k.forEach((e=>{e&&e.destroy()})),m(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),S.setTexture("rectangularButtonPressed"),c(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&H(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{H(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{H(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,m()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),R(),H(gameState.actionText,200),H(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function m(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&H(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{H(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,g())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,g())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{H(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],d(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),c(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),m(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function g(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function d(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function p(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function c(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function S(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?y(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>A(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(c(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,I(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,I(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),$(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function u(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function h(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function y(e){gameState.foreverTrue=!1,h(e),$(8)}function f(t){gameState.rebelSpirit=!1,h(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function x(t){gameState.rebelHeart=!1,h(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function k(e){gameState.bushido=!1,h(e),gameState.player.strengthBase+=6,I(gameState.player)}function T(e){gameState.toxicAvenger=!1,h(e),gameState.enemies.forEach((e=>{e.poison+=4,A(e)}))}function B(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),O(r),l(),I(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function v(t){gameState.toxicFrets=!1,h(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),O(t),l())}))}function P(t){gameState.ashenEncore=!1,h(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),O(t),l()}))}function b(e){gameState.edoEruption=!1,h(e)}function C(t){gameState.steelToe=!1,h(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,A(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function w(e){gameState.redrawPrice+=1,h(e)}function D(e){gameState.gundanSeizai=!1,p(3),h(e)}function M(t){gameState.lustForLife=!1,h(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function E(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),h(t)}function I(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),A(e)}function A(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function O(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void E(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(p(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{H(e,500)}))}}function R(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),H(e.sprite,200)}}function $(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),O(t),l(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){r(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function H(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function z(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,R(),I(gameState.player),i(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,H(e.intentionText,200),H(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),s()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&($(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,O(e),l(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight3 extends BaseScene{self;constructor(){super("Level3Fight3")}preload(){this.load.image("bakgrunnLair3","assets/images/bakgrunnLair3.jpg"),this.load.image("wraith1","assets/images/sprites/wraith1.png"),this.load.image("wraith2","assets/images/sprites/wraith2.png")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1;const r=e.add.text(550,300,"",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),n=e.add.graphics();e.updateTextAndBackground(r,n,"Your turn!"),gameState.player.poisonText=e.add.text(540,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonTextBackground=e.add.graphics(),console.log(`player's turn number ${gameState.turn} has started`),function(){gameState.player.armorCard=0,gameState.player.strengthCard=0;const e=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?e+1:e,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.player.stancePoints=0;gameState.noFutureCondition&&(gameState.player.health-=2)}(),e.updateStanceBar(gameState.player),z(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),O(gameState.player),l(),I(gameState.player),e.shuffleDeck(gameState.drawPile);const o=gameState.player.poisonText._text?2500:1700;e.time.delayedCall(o,(()=>{[gameState.player.poisonText,gameState.player.poisonTextBackground,r,n].forEach((e=>H(e,200))),1===gameState.turn&&gameState.characters.forEach((t=>e.describeCharacter(t,t.sprite))),gameState.enemies.forEach((t=>{i(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.image(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)})),a(t)}))}this.baseCreate("bakgrunnLair3"),this.resetPlayer(gameState.player,.43,350,350),this.addEndOfTurnButton(),this.addRedrawButton(),this.addGoldCoin(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Draw Pile",7,200,.95),gameState.cardImages.push(o,s),gameState.drawPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{H(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){gameState.stanceText.setAlpha(0);const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150,o=e.add.text(550,n-110,"",{fontSize:"60px",fill:"#000000"}).setOrigin(.5).setDepth(201),s=e.add.graphics();e.updateTextAndBackground(o,s,"Discard Pile",7,200,.8),gameState.cardImages.push(o,s),gameState.discardPile.forEach(((o,s)=>{let i=r+s%t*a,l=n+1.5*Math.floor(s/t)*a,m=e.add.image(i,l,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(m)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{H(e,200)})),gameState.cardImages=[],gameState.stanceText.setAlpha(1)})),gameState.redrawPrice=1,gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.gundanSeizai=!1,gameState.noFutureCondition=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.drawPile=[...gameState.deck],gameState.extraCards.length&&gameState.bonusCards.push(gameState.extraCards.pop()),gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Soulripper",gameState.enemy1.cardKey="hellFire",gameState.enemy1.sprite=this.add.sprite(680,340,"wraith2").setScale(.25).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy1.armor=2,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Lord of Darkness",gameState.enemy2.cardKey="hellFire",gameState.enemy2.sprite=this.add.sprite(900,330,"wraith1").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy2.health=100,gameState.enemy2.healthMax=100,gameState.enemy2.armor=2,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e,450)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(1).setDepth(210).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),u(a),S(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile),gameState.redrawButton.on("pointerup",(()=>{if(gameState.player.gold>=gameState.redrawPrice&&gameState.redrawEnabled){c(gameState.redrawPrice),gameState.redrawPrice+=1,gameState.redrawButtonDescriptionText&&gameState.redrawButtonDescriptionText.setText(`Redraw your hand\n Cost: ${gameState.redrawPrice} gold`);let e=0;gameState.currentCards.forEach((t=>{t.slot.available=!0,t.sprite.destroy(),gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),e+=1})),gameState.currentCards=[],a(e)}else e.cameras.main.shake(70,.002,!1)})),gameState.redrawButton.removeInteractive();const{level:r,fight:n}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${r}\nFight ${n}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(29).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2300,(()=>{H(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(0===gameState.drawPile.length){if(console.log("Draw pile is empty. Reshuffling..."),0===gameState.discardPile.length)return void console.error("Both draw and discard piles are empty. Cannot continue.");gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length)}const t=gameState.drawPile.pop(),o=10+n+a;t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o),t.usedOneShot&&t.sprite.setTint(8421504);const s=gameState.slots[a+n];s&&(t.sprite.x=s.x,t.sprite.y=s.y,t.startHeight=t.sprite.y,t.angle=s.angle,t.sprite.setAngle(t.angle),s.available=!1,t.slot=s),gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){gameState.redrawEnabled&&(gameState.redrawEnabled=!1,gameState.redrawButton.removeInteractive(),gameState.redrawButton.setTexture("rectangularButtonPressed")),r(t)}))}));gameState.playersTurn=!0,gameState.redrawEnabled=!0,gameState.redrawButton.setInteractive(),gameState.redrawButton.setTexture("rectangularButton")}function r(t){gameState.typePlayed="function"==typeof t.type?t.type():t.type,t.dBeat?(delete t.dBeat,gameState.costPlayed=0):gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost;const a=!t.goldCost||t.goldCost<gameState.player.gold,r=gameState.player.mana>=gameState.costPlayed,o=!1===gameState.playingCard&&!t.usedOneShot;if(a&&r&&o)if(gameState.player.mana-=gameState.costPlayed,t.goldCost&&c(t.goldCost),e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),t.oneShot&&(t.usedOneShot=!0),"targetSelected"===gameState.typePlayed)t.sprite.removeInteractive(),function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),n(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const o=r===e.length-1;n(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t!=gameState.freePermanent&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.image(a.x,a.y,t.token).setScale(1).setDepth(210).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),u(t),S(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":y(t);break;case"rebelSpirit":f(t);break;case"rebelHeart":x(t);break;case"bushido":k(t);break;case"toxicAvenger":T(t);break;case"kirisuteGomen":B(t);case"toxicFrets":v(t);break;case"ashenEncore":P(t);break;case"edoEruption":b(t);break;case"steelToe":C(t);break;case"deadTokugawas":w(t);break;case"gundanSeizai":D(t);break;case"LustForLife":M(t);break;case"PunksNotDead":E(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):("debuff"===gameState.typePlayed||(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)),n(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function n(t,a,r=!1){gameState.playingCard=!0,gameState.targetingCursor.setVisible(!1),H(t.sprite,200),gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy();const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:g,healPlayed:d,strengthPlayed:c,armorPlayed:S,reduceTargetArmorPlayed:u,reduceTargetStrengthPlayed:h,drawCardPlayed:y,poisonRemovePlayed:f}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,s="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,l="rottenResonance"===e.key&&0===t.poison,m="roninsRot"===e.key&&t.poison>0,g="kabutu"===e.key&&gameState.edoEruption&&r>0,d="combatBoots"===e.key&&gameState.steelToe,p="knuckleFist"===e.key&&gameState.edoEruption&&r<0;gameState.troopsOfTakamoriCondition="troopsOfTakamori"===e.key;const c=r>0?2*(1+r):2,S=l?1:0;return{damagePlayed:n?11:o(e.damage),firePlayed:1.5*(g?2*r:s?12:o(e.fire)),stancePointsPlayed:g&&a?-1:o(e.stancePoints),poisonPlayed:i?t.poison:o(e.poison)+S,healPlayed:o(e.heal),strengthPlayed:o(e.strength),armorPlayed:p?-r:o(e.armor),reduceTargetArmorPlayed:d?c:o(e.reduceTargetArmor),reduceTargetStrengthPlayed:m?t.poison:o(e.reduceTargetStrength),drawCardPlayed:o(e.drawCard),poisonRemovePlayed:o(e.poisonRemove)}}(t,a,r),x=(1+.1*gameState.player.strength)*(1-a.armor/20),k=Math.round(Math.max(0,s+n*x));gameState.player.lifeSteal+=gameState.canibalizeCondition?n*x*.2:0,a!=gameState.player&&(gameState.score.damageDealt+=k,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=h,a.armor-=u,a.poison+=g,a.health-=k,a.armor>0&&k>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=c:gameState.player.strengthCard+=c,function(t,a,r){"dBeat"===a.key&&function(){if(gameState.discardPile.length>0){const t=[],a=gameState.discardPile.length<12?4:6,r=105,n=gameState.discardPile.length<12?400:250,o=150;gameState.discardPile.forEach(((s,i)=>{let l=n+i%a*r,m=o+1.5*Math.floor(i/a)*r,g=e.add.image(l,m,s.key).setScale(.27).setDepth(200).setInteractive();t.push(g),g.on("pointerup",(()=>{gameState.player.stancePoints>0&&(s.dBeat=!0),H(g,300),e.time.delayedCall(400,(()=>{t.forEach((e=>{e.destroy()})),gameState.discardPile.splice(gameState.discardPile.indexOf(s),1),gameState.drawPile.push(s),$(1)}))}))}))}}();"bassSolo"===a.key&&gameState.currentCards.length>0&&function(){const e=Math.floor(Math.random()*gameState.currentCards.length),t=gameState.currentCards[e];H(t.sprite,250),gameState.currentCards=gameState.currentCards.filter((e=>e!=t)),"debuff"!==t.type&&gameState.discardPile.push(t)}();"nenguStyle"===a.key&&gameState.currentCards.length>0&&p(1);"coverCharge"===a.key&&gameState.player.stancePoints>1&&p(1);"pissDrunkBastards"===a.key&&t.health<=18&&(gameState.score.damageDealt+=t.health,t.health=0);"canibalize"===a.key&&(gameState.canibalizeCondition=!0,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player));"zenZine"===a.key&&(gameState.player.healthMax+=2*r,gameState.player.health+=2*r,gameState.powerUpSound.play({volume:.15}),e.updateHealthBar(gameState.player),e.powerUpTweens(gameState.player));"bloodOath"===a.key&&(gameState.player.manaMax+=1,gameState.player.mana+=1,gameState.player.manaBase+=1,gameState.player.health-=4,e.updateManaBar(gameState.player),gameState.player.alive&&(gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player)));"libertySpikes"===a.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,gameState.powerUpSound.play({volume:.15}),e.updateManaBar(gameState.player),e.powerUpTweens(gameState.player));"noFuture"===a.key&&(gameState.noFutureCondition=!0,gameState.player.healthMax+=5,gameState.player.health+=5,gameState.powerUpSound.play({volume:.15}),e.powerUpTweens(gameState.player),e.updateHealthBar(t));"hellFire"===a.key&&(gameState.player.health-=2,e.updateHealthBar(gameState.player))}(a,t,gameState.costPlayed),d&&(gameState.player.health=Math.min(gameState.player.health+d,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-f),function(t,a,r,n,o){const s={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",s).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),"targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=t>0?`Deals ${t} damage`:"",n=a>0?`Deals ${a} Poison`:"",o=a&&t?`${r}\n\n${n}`:a?n:r;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,o),e.attackTweens(gameState.player,60)}else if(r>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${r} Strength`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(n>0){gameState.powerUpSound.play({volume:.15});const t=`Gains ${n} Armor`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}else if(o>0){gameState.powerUpSound.play({volume:.15});const t=`Heals ${o} Poison`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,t),e.powerUpTweens(gameState.player)}}(k,g,c,S,f),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),A(a),e.updateHealthBar(a),I(gameState.player),O(a),l(),i(),$(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&H(gameState.actionText,200),gameState.actionTextBackground&&H(gameState.actionTextBackground,200)}))}function o(e){return"function"==typeof e?e():e}function s(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){if(gameState.playersTurn){gameState.playersTurn=!1;const t="Enemy's turn!";a.turnText=e.add.text(550,300,t,{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5).setDepth(21);const r=e.add.graphics();e.updateTextAndBackground(a.turnText,r,t);const n=[a.turnText,r];if(gameState.canibalizeCondition){const t=Math.floor(gameState.player.lifeSteal),a=gameState.player.health+t<gameState.player.healthMax?t:gameState.player.healthMax-roundgameState.player.health;gameState.player.health+=a,e.updateHealthBar(gameState.player),gameState.canibalizeCondition=!1,gameState.player.lifeSteal=0;const r=`You stole ${a} HP`,o=e.add.text(550,380,r,{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),s=e.add.graphics();e.updateTextAndBackground(o,s,r),n.push(o,s)}e.time.delayedCall(1700,(()=>{n.forEach((e=>{H(e,100)}))}))}a.turnComplete=!1,function(a){a.poisonText=e.add.text(550,380,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5).setDepth(21),a.poisonTextBackground=e.add.graphics(),z(a),gameState.toxicAvenger&&a.poison>0&&A(a);let r=""!==a.poisonText._text||a.turnText?1800:700;gameState.debuffCardPlayed&&(r+=1e3,gameState.debuffCardPlayed=!1);e.time.delayedCall(r,(()=>{H(a.poisonText),H(a.poisonTextBackground);const r=a.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.actionText=e.add.text(550,300,"",n).setOrigin(.5).setDepth(21),gameState.actionTextBackground=e.add.graphics(),gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),A(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.debuffCard?function(t,a){new Promise((r=>{gameState.debuffCardPlayed=!0;let n=0;const o=t.cardKey,s=450,i=200,l=450;let m=.45;const g=2300,d="draw"===a.debuffCard?gameState.drawPile:gameState.discardPile,p="draw"===a.debuffCard?"Draw pile":"Discard Pile",c="draw"===a.debuffCard?120:980,S={ratCard:"Infectious",hellFire:"Hell Fire",rooted:"Rooted"};e.attackTweens(t,60),gameState.attackSound.play({volume:.8}),console.log(t.actions.debuffCard);const u=[{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:o,type:"debuff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}];d.push(...u);const h=[e.add.image(s,l,o).setScale(m).setOrigin(.5).setDepth(300),e.add.image(s+i,l,o).setScale(m).setOrigin(.5).setDepth(300)];let y=`Adds 2 ${S[o]} to your ${p}`;gameState.actionText.y=l-200,e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,y),e.time.delayedCall(g,(()=>{h.forEach((t=>{e.tweens.add({targets:t,x:c,y:600,scaleX:0,scaleY:0,ease:"Cubic",duration:600,onComplete:function(){t.destroy(),gameState.discardPileText.setText(gameState.discardPile.length),n++,n===h.length&&r()}})}))}))}))}(a,r):gameState.debuffCardPlayed=!1,r.damage>0||r.fire>0||r.poison>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal;let n=r.poison>0?r.text:`Deals ${a.damageTotal} damage`;e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,n),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a)):(r.strength>0||r.armor>0)&&(gameState.powerUpSound.play({volume:.2}),e.updateTextAndBackground(gameState.actionText,gameState.actionTextBackground,r.text),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),O(t),A(t)}));const r=gameState.debuffCardPlayed?2200:1300;e.time.delayedCall(r,(()=>{gameState.actionText&&H(gameState.actionText,200),gameState.actionTextBackground&&H(gameState.actionTextBackground,200),a.turnComplete=!0,l()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?s():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,s()))}function i(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.09+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.22+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.19:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.15},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.04},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.1}],gameState.enemy2.actions=[{key:"Intends to\nDeal 10 fire damage",damage:0,fire:10,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.25+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.14},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.08+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.2:0)/5},{key:"Intends to\nApply a debuff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Applies a debuff",debuffCard:"draw",probability:.12}])}function l(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),R(),gameState.deck.forEach((e=>{e.usedOneShot&&(e.usedOneShot=!1),"debuff"===e.type&&(gameState.deck=gameState.deck.filter((t=>t!=e)))})),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.gundanSeizai&&gameState.player.gold<gameState.player.goldMax&&p(1),gameState.victorySound.play({volume:.9,rate:1,seek:.05}),e.clearBoard()})),gameState.actionText&&H(gameState.actionText,200);gameState.actionTextBackground&&H(gameState.actionTextBackground,200);const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5).setDepth(21);e.time.delayedCall(1600,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){const t={fontSize:"22px",fill:"#000000"},a=3,r=250,n=100;gameState.goldCollected=!1;const o="  Collect loot and get\nready for your next fight!",s={fontSize:"40px",fill:"#ff0000"},i=e.add.text(550,130,o,s).setOrigin(.5).setDepth(103),l=e.add.graphics();e.updateTextAndBackground(i,l,o),gameState.rewardCollectGoldButton=e.add.image(550,r,"rectangularButton"),gameState.rewardCollectGoldText=e.add.text(550,r,`Collect ${a} Gold`,t).setOrigin(.5).setDepth(103),gameState.enterShopButton=e.add.image(550,r+n,"rectangularButton"),gameState.enterShopText=e.add.text(550,r+n,"Enter Shop",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,r+2*n,"rectangularButton"),gameState.rewardAddCardsText=e.add.text(550,r+2*n,"Collect free card\n  and continue",t).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardCollectGoldButton,gameState.enterShopButton,gameState.rewardAddCardsButton];const g=[gameState.rewardCollectGoldText,gameState.enterShopText,gameState.rewardAddCardsText];gameState.rewardButtons.forEach((e=>{d(e,103,1.1,.7)})),gameState.rewardCollectGoldButton.on("pointerup",(function(){gameState.goldCollected?e.cameras.main.shake(50,.0015,!1):(gameState.goldCollected=!0,p(a))})),gameState.enterShopButton.on("pointerup",(function(){gameState.enterShopButton.setTexture("rectangularButtonPressed"),gameState.rewardButtons.forEach((e=>{e.removeInteractive()})),e.cameras.main.shake(100,.0015,!1),e.cameras.main.flash(350),e.time.delayedCall(150,(()=>{gameState.shopBackground=e.add.image(0,0,"shop1").setScale(.85).setOrigin(.02,0).setDepth(200),function(){const t=170,a=280,r=80,n=8,o=2,s=2,i=3,l={fontSize:"50px",fill:"#ff0000"},g={fontSize:"17px",fill:"#000000"};gameState.shopButtonPressed=!1;const d=e.add.image(t,a,"rectangularButton"),p=e.add.text(t,a,` Gain ${n} HP\nCost: ${o} Gold`,g),S=e.add.image(t,a+1*r,"rectangularButton"),u=e.add.text(t,a+1*r,` Buy 1 Card\nCost: ${s} Gold`,g),h=e.add.image(t,a+2*r,"rectangularButton"),y=e.add.text(t,a+2*r,`Deplete 1 card\n Cost: ${i} Gold`,g),f=e.add.image(t,a+3*r,"rectangularButton"),x=e.add.text(t,a+3*r,"Exit Shop",g);let k=[];const T=[d,f,S,h],B=[p,x,u,y];let v=[...T,...B,gameState.shopBackground];T.forEach((e=>{gameState.shopButtonPressed||(e.setInteractive().setScale(.9,.6).setOrigin(.5).setDepth(201),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))})),B.forEach((e=>e.setOrigin(.5).setDepth(202))),function(){const t="Welcome to my shop";let a="";gameState.shopWelcomeText=e.add.text(550,60,a,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(202),gameState.shopTextBackground=e.add.graphics();for(let r=0;r<t.length;r++)e.time.delayedCall(30*r,(()=>{a+=t[r],gameState.shopWelcomeText.setText(a),e.updateTextAndBackground(gameState.shopWelcomeText,gameState.shopTextBackground,a,7,201)}))}(),v.push(gameState.shopWelcomeText,gameState.shopTextBackground);const P="3"===e.scene.key.slice(-1),b=gameState.player.gold>=o&&gameState.player.health<gameState.player.healthMax&&!P,{level:C,fight:w}=e.extractLevelFightFromName(e.scene.key);P&&(d.on("pointerover",(function(){const r={fontSize:"25px",fill:"#000000"},n=`Health was reset to Max Health\n  Upon completion of Level ${C}`;gameState.healthResetText=e.add.text(t+400,a,"",r).setOrigin(.5,.5),gameState.healthResetTextBackground=e.add.graphics(),e.updateTextAndBackground(gameState.healthResetText,gameState.healthResetTextBackground,n,7,205)})),d.on("pointerout",(()=>{d.setTexture("rectangularButton"),gameState.healthResetText&&gameState.healthResetText.destroy(),gameState.healthResetTextBackground&&gameState.healthResetTextBackground.destroy()}))),d.on("pointerup",(function(){if(b&&!gameState.shopButtonPressed){gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),d.setTexture("rectangularButtonPressed"),c(o),gameState.player.health=Math.min(gameState.player.health+n,gameState.player.healthMax),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))})),k.forEach((e=>{e&&e.destroy()}));const t=`    You bought ${n} HP\nTotal health: ${gameState.player.health}/${gameState.player.healthMax}`,a=e.add.text(550,150,t,l).setOrigin(.5).setDepth(205);console.log(`health: ${gameState.player.health}\nhealthMax: ${gameState.player.healthMax}`);const r=e.add.graphics();k.push(a,r),v.push(a,r),e.updateTextAndBackground(a,r,t,7,204),e.time.delayedCall(2e3,(()=>{a&&(k=k.filter((e=>e!=a&&e!=r)),v=v.filter((e=>e!=a&&e!=r)),a.destroy(),r.destroy())})),gameState.shopButtonPressed=!1}else e.cameras.main.shake(50,.0015,!1)})),S.on("pointerup",(function(){gameState.player.gold>=s&&!gameState.shopButtonPressed?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),S.setTexture("rectangularButtonPressed"),c(s),k.forEach((e=>{e&&e.destroy()})),m(210),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),h.on("pointerup",(function(){gameState.player.gold>=i&&!gameState.shopButtonPressed&&gameState.deck.length>gameState.minDeckSize?(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),S.setTexture("rectangularButtonPressed"),c(i),k.forEach((e=>{e&&e.destroy()})),function(t=220){const a=gameState.deck,r=120,n=a.length<12?4:6,o=a.length<12?400:250,s=250;a.forEach(((i,l)=>{let m=o+l%n*r,g=s+Math.floor(l/n)*r,d=t+l;i.sprite=e.add.image(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(250)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){console.log(`Deck length before removal: ${gameState.deck.length}`),a.splice(a.indexOf(i),1),a.forEach((e=>{e.sprite.removeInteractive(),e!==i&&H(e.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.time.delayedCall(600,(()=>{H(i.sprite,250)}));const t="Removed 1 card",r=e.add.text(550,180,t,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),n=e.add.graphics();e.updateTextAndBackground(r,n,t,7,210),gameState.shopButtonPressed=!1,e.time.delayedCall(1e3,(()=>{r.destroy(),n.destroy()}))}))}))}(),e.time.delayedCall(200,(()=>{T.forEach((e=>e.setInteractive()))}))):e.cameras.main.shake(50,.0015,!1)})),f.on("pointerup",(function(){gameState.shopButtonPressed?e.cameras.main.shake(50,.0015,!1):(gameState.shopButtonPressed=!0,T.forEach((e=>e.removeInteractive())),e.cameras.main.shake(100,.001,!1),e.cameras.main.flash(300),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{H(e,200)})),e.time.delayedCall(250,(()=>{v.forEach((e=>{e&&e.destroy()})),e.time.delayedCall(100,(()=>{gameState.rewardButtons.forEach((e=>e.setInteractive()))}))})))}))}()}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardButtons.forEach((e=>e.setDepth(1)));const e=[...gameState.rewardButtons,...g,i,l];console.log("Destroying objects:",e),e.forEach((t=>{t.destroy(),console.log(`gameOverObjects.length: ${e.length}`)})),gameState.endGameMenyExited=!0,m()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),R(),H(gameState.actionText,200),H(gameState.actionTextBackground,200),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300,"Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function m(t=102){e.shuffleDeck(gameState.bonusCards);let a=gameState.bonusCards.splice(0,3);gameState.latestDraw&&gameState.latestDraw.forEach((e=>{gameState.bonusCards.push(e)})),gameState.latestDraw=[...a],a.forEach(((r,n)=>{console.log(`bonusCard.key: ${r.key}`),r.sprite=e.add.image(340+210*n,340,r.key),r.sprite.setScale(.45).setInteractive().setDepth(t),r.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6,seek:.1}),e.cardTweens(r.sprite,.58,200)}),e),r.sprite.on("pointerout",(()=>{e.cardTweens(r.sprite,.45,400)}),e),r.sprite.on("pointerup",(()=>{gameState.nextlevelstarting=!1;const t=Object.assign({},r);gameState.deck.push(t),a.forEach((e=>{e.sprite.removeInteractive(),e!==r&&H(e.sprite,200)})),gameState.latestDraw.forEach((e=>{e===r&&"permanent"===e.type&&(gameState.latestDraw=gameState.latestDraw.filter((e=>e!=r)))})),e.tweens.add({targets:r.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),gameState.redrawButtonObjects&&gameState.redrawButtonObjects.forEach((e=>{H(e,200)}));const n="Gained 1 card",o=e.add.text(550,180,n,{fontSize:"40px",fill:"#000000"}).setOrigin(.5).setDepth(211),s=e.add.graphics();e.updateTextAndBackground(o,s,n,7,210),gameState.endGameMenyExited?(e.time.delayedCall(2500,(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,g())})),e.input.on("pointerup",(()=>{gameState.nextlevelstarting||(gameState.nextlevelstarting=!0,g())}))):(o.destroy(),s.destroy(),e.time.delayedCall(350,(()=>{H(r.sprite,200),e.time.delayedCall(200,(()=>{gameState.shopButtonPressed&&(gameState.shopButtonPressed=!1)}))})))}))})),function(t,a,r,n){const o={fontSize:"23px",fill:"#000000"},s=e.add.image(550,t+220,"rectangularButton"),i=e.add.text(550,t+220,`   Redraw\nCost: ${a} Gold`,o).setOrigin(.5).setDepth(202);gameState.redrawButtonObjects=[s,i],d(s,201),s.on("pointerup",(function(){gameState.player.gold>=a?(console.log("rewardAddCardsButton activated"),c(a),gameState.redrawButtonObjects.forEach((e=>{e.destroy()})),r.forEach((e=>{e.sprite&&e.sprite.destroy()})),m(n)):e.cameras.main.shake(50,.0015,!1)}))}(340,1,a,t)}function g(){let t;for(let a=0;a<gameState.levels.length;a++)if(e.scene.key===gameState.levels[a]){t=a+1<gameState.levels.length?gameState.levels[a+1]:"Endscene";break}t?(e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start(t)}))):console.error("Current level not found in gameState.levels")}function d(e,t,a=1.1,r=.9){e.setScale(a,r).setOrigin(.5).setDepth(t),e==gameState.rewardCollectGoldButton&&gameState.goldCollected?(e.removeInteractive(),e.setTexture("rectangularButtonPressed")):(e.setInteractive(),e.on("pointerover",(function(){e.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){e.setTexture("rectangularButton")})))}function p(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold=Math.min(gameState.player.gold+1,gameState.player.goldMax),gameState.goldCounter.setText(gameState.player.gold),gameState.coinSound.play({volume:.8,seek:.02})}))}function c(t){for(let a=1;a<=t;a++)e.time.delayedCall(75*a,(()=>{gameState.player.gold-=1,gameState.goldCounter.setText(gameState.player.gold)}))}function S(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?y(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>A(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?B(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("gundanSeizai"===t.key)gameState.gundanSeizai=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?D(t):e.cameras.main.shake(70,.002,!1)}));else if("deadTokugawas"===t.key)gameState.redrawPrice=Math.max(0,gameState.redrawPrice-1),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("lustForLife"===t.key){let a=1;const r=6,n=900,o=130,s={fontSize:"12px",fill:"#000000"};gameState.healButton=e.add.image(n,o,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.healText=e.add.text(n,o,"Heal",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.healButton.on("pointerover",(()=>{const t=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButton.setTexture("rectangularButtonHovered").setDepth(122),gameState.healText.setDepth(123),gameState.healButtonDescriptionBackground=e.add.graphics(),gameState.healButtonDescriptionBackground.fillStyle(16777215,1).setAlpha(.8).setDepth(122),gameState.healButtonDescriptionBackground.fillRoundedRect(n-65,o+30,130,40,5),gameState.healButtonDescriptionText=e.add.text(n,o+50,t,s).setDepth(123).setOrigin(.5,.5)})),gameState.healButton.on("pointerout",(()=>{gameState.healButton.setTexture("rectangularButton").setDepth(10),gameState.healText.setDepth(11),gameState.healButtonDescriptionBackground&&gameState.healButtonDescriptionBackground.destroy(),gameState.healButtonDescriptionText&&gameState.healButtonDescriptionText.destroy()})),gameState.healButton.on("pointerup",(()=>{if(gameState.player.gold>=a&&gameState.playersTurn&&(c(a),a+=1,gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+r),e.updateHealthBar(gameState.player),gameState.healButtonDescriptionText)){const e=`  Heal ${r} HP\n Cost: ${a} gold`;gameState.healButtonDescriptionText.setText(e)}})),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}))}else if("punksNotDead"===t.key)gameState.punksNotDeadCondition=!0,gameState.punksNotDeadCard=t,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?E(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,I(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,I(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const s=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${s}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&s?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),$(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function u(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5,seek:.1}),t.permanentCardSprite=e.add.image(550,300,t.key).setScale(.55).setDepth(220)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function h(e){e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function y(e){gameState.foreverTrue=!1,h(e),$(8)}function f(t){gameState.rebelSpirit=!1,h(t),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function x(t){gameState.rebelHeart=!1,h(t);const a=gameState.player;a.health=Math.min(a.healthMax,a.health+12),gameState.healSound.play({volume:.5}),e.updateHealthBar(a),e.powerUpTweens(a)}function k(e){gameState.bushido=!1,h(e),gameState.player.strengthBase+=6,I(gameState.player)}function T(e){gameState.toxicAvenger=!1,h(e),gameState.enemies.forEach((e=>{e.poison+=4,A(e)}))}function B(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),O(r),l(),I(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function v(t){gameState.toxicFrets=!1,h(t),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),O(t),l())}))}function P(t){gameState.ashenEncore=!1,h(t);const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),O(t),l()}))}function b(e){gameState.edoEruption=!1,h(e)}function C(t){gameState.steelToe=!1,h(t),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,A(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function w(e){gameState.redrawPrice+=1,h(e)}function D(e){gameState.gundanSeizai=!1,p(3),h(e)}function M(t){gameState.lustForLife=!1,h(t);const a=gameState.player;a.health=a.stancePoints>0?Math.min(a.healthMax,a.health+5*a.StancePoints):a.health,gameState.healSound.play({volume:.5}),e.powerUpTweens(a),e.updateHealthBar(a)}function E(t){gameState.punksNotDeadCondition=!1,gameState.player.alive||(gameState.player.alive=!0,gameState.player.health=Math.round(.2*gameState.player.healthMax),gameState.healSound.play({volume:.5}),e.updateHealthBar(gameState.player)),h(t)}function I(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),A(e)}function A(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function O(e){if(e.health<=0){if(e.health=0,e.alive=!1,e===gameState.player&&gameState.punksNotDeadCondition)return void E(gameState.punksNotDeadCard);if(e.sprite.removeInteractive(),e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1),gameState.troopsOfTakamoriCondition&&(p(1),gameState.troopsOfTakamoriCondition=!1)}[e.sprite,e.healthBarBackground,e.healthBarFrame,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBarFrame,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{H(e,500)}))}}function R(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),e.dBeat&&delete e.dBeat,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),H(e.sprite,200)}}function $(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.image(0,0,t.key).setScale(.35).setInteractive(),t.usedOneShot&&t.sprite.setTint(8421504),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2,seek:.1}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&!t.dBeat&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),O(t),l(),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){r(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function H(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}function z(t){if(t.poison>0){if(console.log("character.poison > 0"),t.health=Math.max(1,t.health-t.poison),t.poisonText){console.log("character.poisonText exists");const a=`-${t.health+1>t.poison?t.poison:t.health-1} HP from Poison`;e.updateTextAndBackground(t.poisonText,t.poisonTextBackground,a,7,20,.7)}t.poison-=1}}gameState.slots=[{available:!0,x:250,y:640,index:0,angle:-12},{available:!0,x:340,y:610,index:1,angle:-8},{available:!0,x:430,y:590,index:2,angle:-4},{available:!0,x:520,y:580,index:3,angle:0},{available:!0,x:610,y:590,index:4,angle:4},{available:!0,x:700,y:610,index:5,angle:8},{available:!0,x:790,y:640,index:6,angle:12},{available:!0,x:880,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,gameState.redrawEnabled=!1,R(),I(gameState.player),i(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,H(e.intentionText,200),H(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),gameState.actionTextBackground&&gameState.actionTextBackground.destroy(),s()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.image(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.image(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&($(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.image(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,O(e),l(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}function updateLeaderboard(e,t){fetch(`https://www.dreamlo.com/lb/CBGhFikNak2i8KjH3UPThAfGJFnWo9A0O8mjvU19hS2Q/add/${e}/${t}`).then((e=>e.text())).then((e=>console.log(e))).catch((e=>{console.error("Error:",e)}))}class Endscene extends Phaser.Scene{constructor(){super("Endscene")}async getTopScores(){try{const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");if(!e.ok)throw new Error("Failed to fetch leaderboard data");let t=(await e.json()).dreamlo.leaderboard.entry;return t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}catch(e){return console.error(e),null}}preload(){this.load.image("endscene","assets/images/endscene.jpg")}create(){self=this;this.cameras.main.fadeIn(800,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,320,"endscene").setScale(.95).setOrigin(.5,.5).on("pointerup",(()=>r())),this.add.text(550,110,"    Thanks for playing\nPunk Rock Samurai Beta v1.3",{fontSize:"57px",fill:"#a9a9a9",fontFamily:"Rock Kapak"}).setOrigin(.5,.5),gameState.score.totalScore=gameState.score.levelsCompleted>0?gameState.score.levelsCompleted*(15+Math.max(0,7-gameState.score.numberOfTurns/gameState.score.levelsCompleted)):0;let e={numberOfTurns:"Number of turns played",levelsCompleted:"Number of fights won",damageTaken:"Total damage taken",damageDealt:"Total damage dealt",totalScore:"Your score"},t=250,a=200;function r(){console.log("returnto meny called"),gameState.name="",gameState.playerName="",self.cameras.main.shake(1500,.0015,!1),self.cameras.main.flash(500),self.time.delayedCall(500,(()=>{self.cameras.main.fadeOut(1e3),gameState.restartGame=!0,gameState.levels.forEach((e=>self.scene.stop(e))),self.scene.stop("Preload"),self.scene.stop("Mainmenu"),self.scene.start("Preload")}))}"admin"!=gameState.playerName&&"Cheater"!=gameState.playerName&&updateLeaderboard(gameState.playerName,gameState.score.totalScore);let n=!1;self.time.delayedCall(600,(()=>{!async function(){try{console.log("displayLeaderBoard called");let r=await self.getTopScores();const n=self.add.graphics();n.fillStyle(16777215,1).setAlpha(.7),n.fillRect(t,a,600,420),self.add.text(300,a+50,"Your Results",{fontSize:"25px",fill:"#000000"}).setOrigin(0),Object.entries(gameState.score).forEach((([t,r])=>{if(console.log(`${t}: ${r}`),e[t]){let n=`${e[t]}: ${r}`;self.add.text(300,a+90,n,{color:"#000",fontSize:"16px"}),a+=20}}));const o={fontSize:"16px",fill:"#000000"};self.add.text(300,a+150,"Leaderboard",{fontSize:"25px",fill:"#000000"}).setOrigin(0),r?r.forEach(((e,t)=>{let r=e.date.split(" ")[0];const n=`${t+1}. Name: ${e.name}, Score: ${e.score}, Date: ${r}`;let s=self.add.text(300,a+190,n,o).setOrigin(0);sceneState.displayedScoreArray.push(s),a+=20})):self.add.text(300,a+190,"Leaderboard is down for maintenance",o).setOrigin(0)}catch(e){console.error("Error in displayLeaderBoard: ",e);const t={fontSize:"16px",fill:"#FF0000"};self.add.text(300,a+190,"Leaderboard is down for maintenance",t).setOrigin(0)}}()})),self.time.delayedCall(8e3,(()=>{n||(n=!0,r())})),self.input.on("pointerup",(()=>{n||(n=!0,r())}))}}const config={type:Phaser.AUTO,width:1100,height:680,scene:[BaseScene,Preload,Mainmenu,Level1Fight1,Level1Fight2,Level1Fight3,Level2Fight1,Level2Fight2,Level2Fight3,Level3Fight1,Level3Fight2,Level3Fight3,Endscene],scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},dom:{createContainer:!0}},game=new Phaser.Game(config);