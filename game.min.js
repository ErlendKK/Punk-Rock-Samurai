const gameState={};class Preload extends Phaser.Scene{constructor(){super("Preload")}preload(){WebFont.load({custom:{families:["Rock Kapak"]},active:()=>{this.fontLoaded=!0}});const e=this.cameras.main.width,t=this.cameras.main.height,a=e/2,r=t/2,n=this.add.graphics(),o=this.add.graphics();n.fillStyle(2236962,.8),n.fillRect(e/2-160,270,320,50);const i=this.add.text(a,r-50,"Loading...",{font:"20px monospace",fill:"#ffffff"}).setOrigin(.5,.5),s=this.add.text(a,r-5,"0%",{font:"18px monospace",fill:"#ffffff"}).setOrigin(.5,.5);this.load.on("progress",(function(t){s.setText(parseInt(100*t)+"%"),o.clear(),o.fillStyle(16777215,1),o.fillRect(e/2-150,280,300*t,30)})),this.load.on("complete",(function(){o.destroy(),n.destroy(),i.destroy(),s.destroy()})),this.load.image("knuckleFist","assets/images/cards/knuckleFist.jpg"),this.load.image("kabutu","assets/images/cards/kabutu.jpg"),this.load.image("combatBoots","assets/images/cards/combatBoots.jpg"),this.load.image("tantoBlade","assets/images/cards/tantoBlade.jpg"),this.load.image("circlePit","assets/images/cards/circlePit.jpg"),this.load.image("seppuku","assets/images/cards/seppuku.jpg"),this.load.image("katana","assets/images/cards/katana.jpg"),this.load.image("rocknRonin","assets/images/cards/rocknRonin.jpg"),this.load.image("powerChord","assets/images/cards/powerChord.jpg"),this.load.image("rawEnergy","assets/images/cards/rawEnergy.jpg"),this.load.image("pyromania","assets/images/cards/pyromania.jpg"),this.load.image("stageInvasion","assets/images/cards/stageInvasion.jpg"),this.load.image("studdedLeather","assets/images/cards/studdedLeather.jpg"),this.load.image("boneShredder","assets/images/cards/boneShredder.jpg"),this.load.image("blackFumes","assets/images/cards/blackFumes.jpg"),this.load.image("masakari","assets/images/cards/masakari.jpg"),this.load.image("discontent","assets/images/cards/discontent.jpg"),this.load.image("dogsOfWar","assets/images/cards/dogsOfWar.jpg"),this.load.image("roninsRot","assets/images/cards/roninsRot.jpg"),this.load.image("libertySpikes","assets/images/cards/libertySpikes.jpg"),this.load.image("moshpitMassacre","assets/images/cards/moshpitMassacre.jpg"),this.load.image("bladesBlight","assets/images/cards/bladesBlight.jpg"),this.load.image("scorchedSoul","assets/images/cards/scorchedSoul.jpg"),this.load.image("risingWakizashi","assets/images/cards/risingWakizashi.jpg"),this.load.image("deadCities","assets/images/cards/deadCities.jpg"),this.load.image("nastyNihonto","assets/images/cards/nastyNihonto.jpg"),this.load.image("crowdSurfer","assets/images/cards/crowdSurfer.jpg"),this.load.image("shikoroStrike","assets/images/cards/shikoroStrike.jpg"),this.load.image("toxicFrets","assets/images/cards/toxicFrets.jpg"),this.load.image("toxicFretsToken","assets/images/cards/toxicFretsToken.png"),this.load.image("ashenEncore","assets/images/cards/ashenEncore.jpg"),this.load.image("ashenEncoreToken","assets/images/cards/ashenEncoreToken.png"),this.load.image("edoEruption","assets/images/cards/edoEruption.jpg"),this.load.image("edoEruptionToken","assets/images/cards/edoEruptionToken.png"),this.load.image("steelToe","assets/images/cards/steelToe.jpg"),this.load.image("steelToeToken","assets/images/cards/steelToeToken.png"),this.load.image("foreverTrueToken","assets/images/cards/foreverTrueToken.png"),this.load.image("foreverTrue","assets/images/cards/foreverTrue.jpg"),this.load.image("rebelSpiritToken","assets/images/cards/rebelSpiritToken.png"),this.load.image("rebelSpirit","assets/images/cards/rebelSpirit.jpg"),this.load.image("rebelHeartToken","assets/images/cards/rebelHeartToken.png"),this.load.image("rebelHeart","assets/images/cards/rebelHeart.jpg"),this.load.image("bushidoToken","assets/images/cards/bushidoToken.png"),this.load.image("bushido","assets/images/cards/bushido.jpg"),this.load.image("toxicAvengerToken","assets/images/cards/toxicAvengerToken.png"),this.load.image("toxicAvenger","assets/images/cards/toxicAvenger.jpg"),this.load.image("kirisuteGomenToken","assets/images/cards/kirisuteGomenToken.png"),this.load.image("kirisuteGomen","assets/images/cards/kirisuteGomen.jpg"),this.load.image("hollidayInKamakuraToken","assets/images/cards/hollidayInKamakuraToken.png"),this.load.image("hollidayInKamakura","assets/images/cards/hollidayInKamakura.jpg"),this.load.image("kamishimoUberAllesToken","assets/images/cards/kamishimoUberAllesToken.png"),this.load.image("kamishimoUberAlles","assets/images/cards/kamishimoUberAlles.jpg"),this.load.image("player","assets/images/sprites/punkrock.png"),this.load.image("deck","assets/images/cardback.jpg"),this.load.image("strengthAndArmor","assets/images/strengthAndArmor.png"),this.load.image("rectangularButton","assets/images/stoneButtonInsetReady.png"),this.load.image("rectangularButtonHovered","assets/images/stoneButtonInsetHovered.png"),this.load.image("rectangularButtonPressed","assets/images/stoneButtonInsetPressed.png"),this.load.image("radioButtonRoundOn","assets/images/radioButtonRoundOn.png"),this.load.image("radioButtonRoundOff","assets/images/radioButtonRoundOff.png"),this.load.image("targetingCursor","assets/images/targetingCursor.png"),this.load.image("targetingCursorReady","assets/images/targetingCursorReady.png"),this.load.image("bgLoadingScreen","assets/images/bgLoadingScreen.jpg"),this.load.image("endscene","assets/images/endscene.jpg"),this.load.audio("cardsDealtSound","assets/sounds/cardsdealt.wav"),this.load.audio("thundersound","assets/sounds/thundersound.mp3"),this.load.audio("buttonPressedSound","assets/sounds/buttonpressed.wav"),this.load.audio("attackSound","assets/sounds/attacksound.wav"),this.load.audio("powerUpSound","assets/sounds/powerupsound.wav"),this.load.audio("healSound","assets/sounds/healsound.wav"),this.load.audio("victorySound","assets/sounds/victorysound.mp3"),this.load.audio("bossTune","assets/sounds/music/DecisiveBattle.mp3"),this.load.audio("titleTheme","assets/sounds/music/TitleTheme.mp3"),this.load.audio("gunShotSound","assets/sounds/gunshot.mp3")}create(){self=this,gameState.score={numberOfTurns:0,levelsCompleted:0,damageTaken:0,damageDealt:0,totaleScore:0},gameState.player={sprite:this.add.sprite(320,350,"player").setScale(.38).setFlipX(!0).setInteractive(),healthBarColor:"0x00ff00",alive:!0,stance:"Neutral",poison:0,stancePoints:0,numCards:5,numCardsBase:5,numCardsStance:0,health:90,healthMax:90,mana:4,manaMax:4,manaBase:4,manaStance:0,manaCard:0,strength:0,strengthMax:15,strengthBase:0,strengthStance:0,strengthCard:0,armor:0,armorMax:15,armorBase:0,armorStance:0,armorCard:0},gameState.enemy={name:"Name",sprite:"",healthBarColor:"0xff0000",alive:!0,actions:[],health:40,healthMax:40,strength:0,strengthBase:0,strengthTurn:0,strengthMax:15,armor:0,armorMax:15,poison:0},gameState.deck=[{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"knuckleFist",type:"targetSelected",cost:1,stancePoints:1,damage:7,fire:0,poison:()=>gameState.toxicFrets?1:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"kabutu",type:()=>gameState.edoEruption&&gameState.player.stancePoints>0?"targetAll":"buff",cost:1,stancePoints:-1,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"combatBoots",type:"targetAll",cost:2,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?1+gameState.player.stancePoints:1,reduceTargetStrength:0,drawCard:0},{key:"tantoBlade",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?12-2*gameState.player.stancePoints:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"discontent",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints>0?-2:gameState.player.stancePoints<0?2:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0}],gameState.bonusCards=[{key:"kamishimoUberAlles",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kamishimoUberAllesToken"},{key:"hollidayInKamakura",type:"permanent",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"hollidayInKamakuraToken"},{key:"rebelSpirit",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelSpiritToken"},{key:"foreverTrue",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"foreverTrueToken"},{key:"toxicFrets",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicFretsToken"},{key:"ashenEncore",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"ashenEncoreToken"},{key:"edoEruption",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"edoEruptionToken"},{key:"studdedLeather",type:"buff",cost:1,stancePoints:2,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rocknRonin",type:"buff",cost:0,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:()=>gameState.player.strength,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"seppuku",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:-5,poisonRemove:0,strength:()=>gameState.player.stancePoints<0?1-gameState.player.stancePoints:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"rawEnergy",type:"buff",cost:()=>gameState.player.stancePoints>0?-2:-1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"powerChord",type:"buff",cost:1,stancePoints:()=>gameState.player.stancePoints<=0?1:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?3:0},{key:"crowdSurfer",type:"buff",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:()=>gameState.player.stancePoints<0?2*gameState.player.stancePoints:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?gameState.player.stancePoints:0},{key:"stageInvasion",type:"targetAll",cost:2,stancePoints:0,damage:()=>2*(gameState.currentCards.length+1),fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"circlePit",type:"targetAll",cost:()=>gameState.player.mana,stancePoints:0,damage:0,fire:()=>4*gameState.costPlayed,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"moshpitMassacre",type:"targetAll",cost:2,stancePoints:0,damage:8,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"blackFumes",type:()=>gameState.player.stancePoints>=0?"targetAll":"targetSelected",cost:2,stancePoints:0,damage:0,fire:0,poison:()=>gameState.player.stancePoints>0?3:gameState.player.stancePoints<0?5:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"boneShredder",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetArmor:0,reduceTargetStrength:1,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"masakari",type:"targetSelected",cost:2,stancePoints:0,damage:()=>gameState.player.stancePoints<0?9*(1-gameState.player.stancePoints*gameState.player.strength/10):9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"pyromania",type:"targetSelected",cost:2,stancePoints:0,damage:0,fire:16,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"roninsRot",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"dogsOfWar",type:"targetSelected",cost:1,stancePoints:1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"libertySpikes",type:"targetSelected",cost:1,stancePoints:0,damage:5,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:()=>gameState.player.stancePoints<0?2:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:()=>gameState.player.stancePoints>0?1:0},{key:"bladesBlight",type:"targetSelected",cost:3,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"scorchedSoul",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"katana",type:"targetSelected",cost:3,stancePoints:0,damage:()=>gameState.player.stancePoints<0?13*(1-gameState.player.stancePoints*gameState.player.strength/10):13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"risingWakizashi",type:"targetSelected",cost:1,stancePoints:-1,damage:9,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"deadCities",type:"targetSelected",cost:1,stancePoints:0,damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"nastyNihonto",type:"targetSelected",cost:2,stancePoints:0,damage:10,fire:0,poison:()=>gameState.player.stancePoints>0?2*gameState.player.stancePoints:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0},{key:"shikoroStrike",type:"targetSelected",cost:1,stancePoints:0,damage:()=>gameState.player.stancePoints<0?7:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:()=>gameState.player.stancePoints>0?2:0,reduceTargetStrength:0,drawCard:0}],gameState.extraCards=[{key:"kirisuteGomen",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"kirisuteGomenToken"},{key:"rebelHeart",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"rebelHeartToken"},{key:"bushido",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"bushidoToken"},{key:"toxicAvenger",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"toxicAvengerToken"},{key:"steelToe",type:"permanent",cost:1,stancePoints:0,damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetArmor:0,reduceTargetStrength:0,drawCard:0,token:"steelToeToken"}];let e=this.add.image(550,480,"bgLoadingScreen").setScale(1.4).setInteractive();this.add.text(550,170,"Punk Rock Samurai",{fontSize:"100px",fill:"#000000",fontFamily:"Rock Kapak"}).setOrigin(.5),this.add.text(550,500,"Click to start",{fontSize:"45px",fill:"#ff0000",fontWeight:"bold"}).setOrigin(.5);let t=!1;gameState.thunder=this.sound.add("thundersound"),gameState.musicTheme=this.sound.add("titleTheme"),e.on("pointerup",(()=>{t||(t=!0,gameState.thunder.play({volume:.9,seek:.25}),this.cameras.main.shake(200,.002,!1),this.cameras.main.flash(100),this.time.delayedCall(100,(()=>{this.cameras.main.fadeOut(100)}),[],this),this.time.delayedCall(200,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),self.time.delayedCall(100,(()=>{self.scene.start("Mainmenu"),console.log("Mainmenu called")}))}),[],this))}))}}class BaseScene extends Phaser.Scene{preload(){this.load.image("listbox1","assets/images/listbox1.png"),this.load.image("listbox2","assets/images/listbox2.png")}create(){this.scene.start("Preload")}baseCreate(e,t=.75){this.add.image(0,0,e).setScale(t).setOrigin(.02,0),this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),gameState.targetingCursor=this.add.sprite(0,0,"targetingCursor").setDepth(200).setVisible(!1),gameState.playingCard=!1,gameState.drawPile=[...gameState.deck],gameState.discardPile=[],gameState.cardsDealtSound=this.sound.add("cardsDealtSound"),gameState.victorySound=this.sound.add("victorySound"),gameState.buttonPressedSound=this.sound.add("buttonPressedSound"),gameState.attackSound=this.sound.add("attackSound"),gameState.powerUpSound=this.sound.add("powerUpSound"),gameState.healSound=this.sound.add("healSound"),gameState.thunder=this.sound.add("thundersound"),gameState.gunShotSound=this.sound.add("gunShotSound"),gameState.music=this.sound.add("bossTune")}resetPlayer(e,t){e.sprite=this.add.sprite(320,350,"player").setScale(t).setFlipX(!0).setInteractive(),e.stance="Neutral",e.poison=0,e.stancePoints=0,e.numCardsBase=5,e.numCardsStance=0,e.manaBase=4,e.manaStance=0,e.manaCard=0,e.mana=4,e.manaMax=4,e.strengthBase=0,e.strengthStance=0,e.strengthCard=0,e.strengthMax=15,e.armorBase=0,e.armorStance=0,e.armorCard=0}addHealthBar(e,t){const a=e.x,r=e.y,n=e.height;e.healthBarBackground=this.add.graphics(),e.healthBarBackground.lineStyle(3,0,1),e.healthBarBackground.strokeRect(a-40,r-n/2-30,100,10),e.healthBar=this.add.graphics(),e.healthBar.fillStyle(t,1),e.healthBar.fillRect(a-40,r-n/2-30,e.health/e.healthMax*100,10),e.healthBarText=this.add.text(a-18,r-n/2-25,`${e.health}/${e.healthMax}`,{fontSize:"11px",fill:"#000000"}).setOrigin(.5)}addManaBar(e){const t=e.x,a=e.y,r=e.height;e.manaBarBackground=this.add.graphics(),e.manaBarBackground.lineStyle(3,0,1),e.manaBarBackground.strokeRect(e.x-40,e.y-r/2-45,100,10),e.manaBar=this.add.graphics(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(t-40,a-r/2-45,e.mana/e.manaMax*100,10),e.manaBarText=this.add.text(t-27,a-r/2-40,`${e.mana}/${e.manaMax}`,{fontSize:"11px",fill:"#000000"}).setOrigin(.5)}addStatsDisplay(e){let t={fontSize:"11px",fill:"#FFFFFF"};e.strengthAndArmorImage=this.add.sprite(e.sprite.x-20,460,"strengthAndArmor").setScale(.4).setInteractive().setDepth(20),e.armorText=this.add.text(e.sprite.x+13,462,`${e.armor}/${e.armorMax}`,t).setDepth(25),e.strengthText=this.add.text(e.sprite.x-40,462,`${e.strength}/${e.strengthMax}`,t).setDepth(25)}describeCharacter(e){gameState.targetingCursor.visible||!0!==e.alive||e.sprite.on("pointerover",(()=>{const t=e.armor<0?"more":"less",a=e.strength<0?"less":"more",r=`${e.name}\n\n${e.armor} armor: Take ${Math.round(Math.abs(e.armor/20*100))} %\n${t} physical damage\n\nMax armor: Take 75 %\nless physical damage \n\n${e.strength} Strength: Deal ${10*Math.abs(e.strength)} %\n${a} physical damage\n\nMax strength: Deal 150 %\nmore physical damage\n\nPoison: ${e.poison}\nPoison change per turn: ${e.poison>0?-1:0}`,n=e.sprite.x-e.width/2;e.descriptionBackground=this.add.graphics({x:n-200,y:210}),e.descriptionBackground.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(30),e.descriptionBackground.fillRect(0,0,215,250);e.descriptionText=this.add.text(n+10,335,r,{fontSize:"12px",fill:"#000000"}).setDepth(35).setOrigin(1,.5)})),e.sprite.on("pointerout",(function(){e.descriptionBackground&&e.descriptionBackground.destroy(),e.descriptionText&&e.descriptionText.destroy()}))}addStanceBar(e,t){e.stancePoints=0;let a=this.cameras.main.width/2;gameState.stanceBarHeight=20,gameState.stanceBarMargin=60,gameState.stanceBarStartX=a-220,gameState.stanceBarBackground=this.add.graphics(),gameState.stanceBarBackground.lineStyle(3,0,1),gameState.stanceBarBackground.strokeRect(gameState.stanceBarStartX,gameState.stanceBarMargin,440,gameState.stanceBarHeight).setDepth(20);for(let e=1;e<6;e++)gameState.stanceBarBackground.moveTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin),gameState.stanceBarBackground.lineTo(gameState.stanceBarStartX+73.33*e,gameState.stanceBarMargin+20),gameState.stanceBarBackground.strokePath();gameState.stanceBar=this.add.graphics(),gameState.stanceBar.fillStyle(65280,1);let r={fontSize:"30px",fill:t};gameState.stanceText=this.add.text(550,gameState.stanceBarMargin-25,`Stance: ${gameState.player.stance}`,r).setOrigin(.5).setInteractive(),gameState.stanceText.on("pointerover",(()=>{gameState.stanceDescriptionBackground=this.add.sprite(550,gameState.stanceBarBackground.y+50,"listbox2").setScale(2.9,7.3),gameState.stanceDescriptionBackground.setInteractive().setDepth(20).setOrigin(.5,0).setAlpha(.85),gameState.stanceDescriptionText=this.add.text(550,gameState.stanceBarBackground.y+105,"Stance represents the ever-shifting balance\nbetween the conflicting ideals of the\npunk rock samurai: Discipline and Freedom.\n\nPositive Discipline during your turn:\n+3 Strength\n\nPositive Discipline at the end of your turn:\n+3 Armor\n\nMax Discipline at the end of your turn:\n-1 card next turn\n\nPositive Freedom during your turn:\n+1 mana\n\nPositive Freedom at the end of your turn:\n+1 card next turn\n+1 mana next turn\n\nMax Freedom at the end of your turn:\n-2 Armor",{fontSize:"14px",fill:"#000000"}).setDepth(25).setOrigin(.5,0)})),gameState.stanceText.on("pointerout",(()=>{this.time.delayedCall(20,(()=>{gameState.stanceDescriptionBackground.destroy(),gameState.stanceDescriptionText.destroy()}))}))}extractLevelFightFromName(e){const t=/Level(\d+)Fight(\d+)/.exec(e);return t?{level:parseInt(t[1],10),fight:parseInt(t[2],10)}:{level:null,fight:null}}powerUpTweens(e){this.tweens.add({targets:e.sprite,scaleY:1.125*e.sprite.scaleX,scaleX:1.125*e.sprite.scaleY,duration:120,ease:"Cubic",yoyo:!0},this)}attackTweens(e,t){if("undefined"==typeof attackTweenStarted||!attackTweenStarted){let a=!0;this.tweens.add({targets:e.sprite,x:e.x+t,duration:120,ease:"Cubic",yoyo:!0,onComplete:()=>a=!1},this)}}cardTweens(e,t,a){this.tweens.add({targets:e,scaleX:t,scaleY:t,duration:a,ease:"Cubic"},this)}animateCard(e,t){e.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),this.tweens.add({targets:e.sprite,y:470,angle:0,scaleX:.46,scaleY:.46,duration:300,ease:"Cubic"}),e.sprite.setDepth(100)}),this),e.sprite.on("pointerout",(()=>{e.isBeingPlayed||(this.tweens.add({targets:e.sprite,y:e.startHeight,angle:e.angle,scaleX:.35,scaleY:.35,duration:300,ease:"Cubic"}),e.sprite.setDepth(t))}),this)}addButtons(){const e=this.add.sprite(1050,40,"radioButtonRoundOff").setScale(.5).setInteractive();gameState.muteText=this.add.text(875,30,"Mute music",{fontSize:"25px",fill:"#000000"}),e.on("pointerup",(()=>{gameState.music.mute?(gameState.music.mute=!1,e.setTexture("radioButtonRoundOff")):(gameState.music.mute=!0,e.setTexture("radioButtonRoundOn"))})),gameState.endOfTurnButton=this.add.sprite(870,510,"rectangularButton").setScale(.45).setOrigin(.5),gameState.endOfTurnText=this.add.text(870,510,"End Turn",{fontSize:"20px",fill:"#000000"}).setOrigin(.5),gameState.endOfTurnButton.on("pointerover",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButtonHovered")})),gameState.endOfTurnButton.on("pointerout",(function(){gameState.endOfTurnButtonPressed||this.setTexture("rectangularButton")}))}clearBoard(){gameState.characters.forEach((e=>{e.sprite.destroy(),e.strengthAndArmorImage.destroy(),e.armorText.destroy(),e.strengthText.destroy(),e.strengthAndArmorImage.destroy(),e.healthBarBackground.destroy(),e.healthBar.destroy(),e.healthBarText.destroy()})),gameState.player.manaBarBackground.destroy(),gameState.player.manaBar.destroy(),gameState.player.manaBarText.destroy(),gameState.endOfTurnButton.destroy(),gameState.endOfTurnText.destroy(),gameState.drawPileImage.destroy(),gameState.discardPileImage.destroy(),gameState.drawPileText.destroy(),gameState.discardPileText.destroy(),gameState.stanceBar.destroy(),gameState.stanceText.destroy(),gameState.stanceBarBackground.destroy(),gameState.actionText&&gameState.actionText.destroy(),console.log("board cleared")}shuffleDeck(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}updateEnemyIntention(e){let t="function"==typeof e.chosenAction.key?e.chosenAction.key():e.chosenAction.key;e.intentionText.setText(`${t}`)}updateHealthBar(e){e.health=Phaser.Math.Clamp(e.health,0,e.healthMax),e.healthBar.clear(),e.healthBar.fillStyle(e===gameState.player?65280:16711680,1),e.healthBar.fillRect(e.x-40,e.y-e.height/2-30,e.health/e.healthMax*100,10),e.healthBarText.setText(`${e.health}/${e.healthMax}`)}updateManaBar(e){e.mana=Phaser.Math.Clamp(e.mana,0,e.manaMax),e.manaBar.clear(),e.manaBar.fillStyle(255,1),e.manaBar.fillRect(e.x-40,e.y-e.height/2-45,e.mana/e.manaMax*100,10),e.manaBarText.setText(`${e.mana}/${e.manaMax}`)}updatePoison(e){e.poison>0&&(console.log("character.poison > 0"),e.health=Math.max(1,e.health-e.poison),e.poisonText&&(console.log("character.poisonText exists"),e.poisonText.setText(`Poison: -${e.poison} HP`)),e.poison-=1)}updateStanceBar(e){const t=gameState.player.stancePoints;switch(t){case-3:e.armorStance=3,e.strengthStance=3,e.manaStance=0,e.numCardsStance=-1,e.stance="Discipline";break;case-2:case-1:e.armorStance=3,e.strengthStance=3,e.manaStance=0,e.numCardsStance=0,e.stance="Discipline";break;case 0:e.armorStance=0,e.strengthStance=0,e.manaStance=0,e.numCardsStance=0,e.stance="Neutral";break;case 1:case 2:e.armorStance=0,e.strengthStance=0,e.manaStance=1,e.numCardsStance=1,e.stance="Freedom";break;case 3:e.armorStance=-2,e.strengthStance=0,e.manaStance=1,e.numCardsStance=1,e.stance="Freedom";break;default:return void console.error(`Unexpected value for points: ${t}`)}gameState.stanceBar.clear(),t<0?gameState.stanceBar.fillRect(gameState.stanceBarStartX+220+73.33*t,gameState.stanceBarMargin,73.33*Math.abs(t),gameState.stanceBarHeight):gameState.stanceBar.fillRect(gameState.stanceBarStartX+220,gameState.stanceBarMargin,73.33*t,gameState.stanceBarHeight),gameState.stanceText.setText(`Stance: ${e.stance}`)}}const sceneState={};class Mainmenu extends Phaser.Scene{constructor(){super("Mainmenu")}async getTopScores(){const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");let t=(await e.json()).dreamlo.leaderboard.entry;return t.length>1&&t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}preload(){this.load.image("rectangularFrame","assets/images/stoneButtonFrame.png")}create(){const e=this;this.cameras.main.fadeIn(600,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,480,"bgLoadingScreen").setScale(1.4),this.add.text(15,5,"Punk Rock Samurai Beta v1.00",{fontSize:"12px",fill:"#ff0000"});let t=!1;gameState.isEnteringName=!1,sceneState.name="",sceneState.cardsDealtSound=this.sound.add("cardsDealtSound"),sceneState.buttonPressedSound=this.sound.add("buttonPressedSound"),sceneState.newGameElements=[],sceneState.leaderboardElements=[],sceneState.creditsElements=[],sceneState.instructionsElements=[],sceneState.displayedScoreArray=[];const a={fontSize:"25px",fill:"#000000"},r={fontSize:"14px",fill:"#000000"},n={fontSize:"18px",fill:"#000000"},o=120,i=350,s=e.add.image(o,i,"rectangularButton"),m=e.add.text(o,i,"New Game",n).setOrigin(.5);sceneState.newGameButtonClicked=!1;const l=e.add.image(o,415,"rectangularButton"),g=e.add.text(o,415,"Load Game",{fontSize:"16px",fill:"#a9a9a9"}).setOrigin(.5);let d=!1;const S=e.add.image(o,480,"rectangularButton"),p=e.add.text(o,480,"Leaderboard",n).setOrigin(.5);let c=!1;const y=e.add.image(o,545,"rectangularButton"),h=e.add.text(o,545,"Credits",n).setOrigin(.5);let u=!1;const f=e.add.image(o,610,"rectangularButton"),x=e.add.text(o,610,"Instructions",n).setOrigin(.5);let k=!1;function T(t){t.on("pointerup",(()=>{gameState.isEnteringName||(gameState.isEnteringName=!0,console.log("isEnteringName has been activated"),"Enter your name..."===gameState.name&&(gameState.name=""),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.resume(),e.time.delayedCall(200,(()=>{e.input.off("pointerup"),e.input.once("pointerup",(()=>{if(gameState.isEnteringName){let t=0;gameState.name||(gameState.name="Enter your name...",t=100),e.time.delayedCall(t,(()=>{gameState.isEnteringName=!1,console.log("isEnteringName has been deactivated")})),sceneState.formCursor.setAlpha(0),sceneState.cursorTween.pause()}}))})))}))}function b(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level1Fight1")}))}function v(t,a,r){e.tweens.add({targets:t,scaleX:a,scaleY:a,duration:r,ease:"Cubic"})}function C(e){e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))}function P(){[...sceneState.newGameElements,...sceneState.leaderboardElements,...sceneState.creditsElements,...sceneState.instructionsElements,...sceneState.displayedScoreArray].forEach((e=>{e&&"function"==typeof e.destroy?e.destroy():console.log(`${e} not phaser object`)}))}sceneState.buttons=[s,l,S,y,f],sceneState.textArray=[m,g,p,h,x],sceneState.menuElements=[...sceneState.buttons,...sceneState.textArray],sceneState.buttons.forEach((e=>{C(e),e.setScale(.8,.5).setInteractive().setOrigin(.5)})),s.on("pointerdown",(()=>{if(sceneState.newGameButtonClicked)sceneState.newGameButtonClicked=!1,P();else{sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!0,d=!1,c=!1,u=!1,k=!1,P(),gameState.name="Enter your name...";const a={fontSize:"23px",fill:"#000000"};sceneState.nameText=this.add.text(420,315,gameState.name,a).setDepth(21);const r={fontSize:"28px",fill:"#000000"};sceneState.startGameButton=this.add.image(550,400,"rectangularButton").setScale(1.2,.6).setInteractive(),sceneState.startGameText=this.add.text(470,387,"Let's go!",r),C(sceneState.startGameButton),sceneState.startGameButton.on("pointerdown",(()=>{gameState.isEnteringName=!1,function(){"Enter your name..."===gameState.name||""===gameState.name?gameState.playerName="Punk Rock Samurai":gameState.playerName=gameState.name;console.log(`Playername: ${gameState.playerName}`),P(),sceneState.menuElements.forEach((e=>{e.destroy()})),e.time.delayedCall(600,(()=>{!function(){const a=320,r=430,n=220,o=gameState.extraCards.slice(0,3),i={fontSize:"50px",fill:"#ff0000"},s=e.add.text(550,170,"Choose 1 Free Permanent",i).setOrigin(.5);o.forEach(((i,m)=>{i.sprite=e.add.sprite(a+m*n,r,i.key).setScale(.45).setInteractive(),console.log(`bonusCardsprite added for: ${i.key}`),i.sprite.on("pointerover",(function(){sceneState.cardsDealtSound.play({volume:.8}),v(i.sprite,.58,200)}),this),i.sprite.on("pointerout",(function(){v(i.sprite,.45,400)}),this),i.sprite.on("pointerup",(function(){sceneState.cardsDealtSound.play({volume:1.8}),gameState.bonusCard=i,gameState.extraCards.splice(gameState.extraCards.indexOf(i),1),o.forEach((t=>{var a,r;t.sprite.removeInteractive(),t!==i&&(a=t.sprite,r=200,a&&e.tweens.add({targets:a,alpha:0,ease:"Power1",duration:r,onComplete:()=>{a.destroy()}}))})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),s.setText("Permanent Selected"),e.time.delayedCall(2500,(()=>{t||(t=!0,b())})),e.input.on("pointerup",(()=>{t||(t=!0,b())}))}))}))}()}))}()}));const n={fontSize:"32px",fill:"#000000"};sceneState.formCursor=this.add.text(420,310,"|",n).setDepth(21).setAlpha(0),sceneState.cursorTween=this.tweens.add({targets:sceneState.formCursor,alpha:1,duration:300,hold:600,yoyo:!0,repeat:-1,paused:!0}),sceneState.formFrame=this.add.image(550,325,"rectangularFrame"),sceneState.formFrame.setScale(1.2,.6).setInteractive().setDepth(22),sceneState.nameForm=this.add.graphics({x:400,y:290}),sceneState.nameForm.fillStyle(16777215,1).setAlpha(.9).setInteractive().setDepth(20),sceneState.nameForm.fillRect(0,0,300,65),sceneState.nameForm.setInteractive(new Phaser.Geom.Rectangle(0,0,300,65),Phaser.Geom.Rectangle.Contains),sceneState.newGameElements=[sceneState.formCursor,sceneState.nameForm,sceneState.nameText,sceneState.formFrame,sceneState.startGameButton,sceneState.startGameText],T(sceneState.nameForm),T(sceneState.formFrame)}})),this.input.keyboard.on("keydown",(t=>{if(gameState.isEnteringName){const a=16;8===t.keyCode&&gameState.name.length>0?gameState.name=gameState.name.slice(0,-1):1===t.key.length&&t.key.match(/[a-zA-Z0-9\s\-_]/)&&gameState.name.length<a?gameState.name+=t.key:gameState.name.length===a&&e.cameras.main.shake(30,.001,!1)}})),l.on("pointerup",(function(){e.cameras.main.shake(70,.002,!1)})),S.on("pointerup",(async()=>{if(sceneState.buttonPressedSound.play({volume:.7}),c)c=!1,P();else{const t=await e.getTopScores(),a=250;let n=200;sceneState.newGameButtonClicked=!1,d=!1,c=!0,u=!1,k=!1,P(),sceneState.leaderboardsBackground=this.add.graphics(),sceneState.leaderboardsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.leaderboardsBackground.fillRect(a,n,810,250);const o={fontSize:"25px",fill:"#000000"};sceneState.leaderboardHeadline=this.add.text(a+20,n+30,"Leaderboard",o).setOrigin(0),sceneState.displayedScoreArray=[];for(let e=0;e<t.length;e++){const o=t[e].date.split(" ")[0],i=`${e+1}. Name: ${t[e].name}, Score: ${t[e].score}, Date: ${o}`,s=this.add.text(a+30,n+80,i,r).setOrigin(0);sceneState.displayedScoreArray.push(s),n+=20}sceneState.leaderboardElements=[sceneState.leaderboardsBackground,sceneState.leaderboardHeadline,sceneState.displayedScoreArray]}})),y.on("pointerup",(function(){u?(u=!1,P()):(sceneState.buttonPressedSound.play({volume:.7}),sceneState.newGameButtonClicked=!1,d=!1,c=!1,u=!0,k=!1,P(),sceneState.creditsBackground=e.add.graphics(),sceneState.creditsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.creditsBackground.fillRect(250,200,810,340),sceneState.creditsHeadline=e.add.text(270,230,"Credits",a).setOrigin(0),sceneState.creditsText=e.add.text(270,280,"Game Design and Programming by Erlend Kulander Kvitrud\nMusic by Marllon Silva (xDeviruchi) (https://soundcloud.com/xdeviruchi)\nPunch sound by @danielsoundsgood (https://danielsoundsgood.itch.io/)\nHealing sound by Dylan Kelk (https://freesound.org/people/SilverIllusionist/)\nPower up sound by MATRIXXX (https://freesound.org/people/MATRIXXX_/)\nGunshot sound by Fesliyan Studios (https://www.fesliyanstudios.com)\nButton Sprites by Ian Eborn (http://thaumaturge-art.com/)\nArmor and Strength symbols by Josepzin (https://opengameart.org/users/josepzin)\nCard sprites by Avery Ross (https://opengameart.org/users/averyre)\nCharacter sprites and backgrounds were generated with MidJourney",r),sceneState.creditsText.setLineSpacing(2),sceneState.creditsElements=[sceneState.creditsBackground,sceneState.creditsHeadline,sceneState.creditsText])})),f.on("pointerup",(function(){sceneState.buttonPressedSound.play({volume:.7}),k?(k=!1,P()):(sceneState.newGameButtonClicked=!1,d=!1,c=!1,u=!1,k=!0,P(),sceneState.instructionsBackground=e.add.graphics(),sceneState.instructionsBackground.fillStyle(16777215,1).setAlpha(.9),sceneState.instructionsBackground.fillRect(250,20,810,650),sceneState.instructionsHeadline=e.add.text(270,50,"Instructions",a).setOrigin(0),sceneState.instructionsText=e.add.text(270,100,'The game consists of four levels, each of which consists of three fights.\nAt the start of your turn, you gain 4 mana and draw 5 cards. You may then play any number\nof cards before hitting "End Turn". Your remaining cards and mana are then depleted,\nand the enemy\'s turn begins. You win the fight by killing all enemies. Losing a fight\nresults in permadeath. Missing health carries over from fight to fight, but is reset at\nthe beginning of each new level\n\nThere are three different kinds of attack: physical damage, fire damage and poison.\n\nPhysical damage is affected by the Strength of the attacker and the Armor of the defender\n-Each unit of Strength increases outgoing physical damage by 10 %.\n-Each unit of Armor blocks 5 % of incomming physical damage\nArmor and Strength are both capped at 15 units.\n\nFire damage is unaffected by Strength and Armor, but otherwise acts like physical damage.\n\nPoison is unaffected by Strength and Armor. A poisoned character suffers damage each\nround equal to his poison counter. At the end of his turn, this counter is reduced by 1. \nUnlike physical and fire damage, poison cannot reduce a characters health below 1 HP.\n\nPermanents are cards that can only be played once, and are then removed from your deck.\nAfter use, they remain active and provide passive bonuses. A maximum of 4 permanents may be\nactive at any given time. Permanents can be depleted, which unleases powerful one-off\neffects and then removes them from the game. If there are no empty slots for new permanents,\npermanent cards may be played directly from hand for their depletion effects.\n\nStance represents the balance between Discipline and Freedom.\n-Positive Discipline during your turn: +3 Strength.\n-Positive Discipline at the end of your turn: +3 Armor.\n-Max Discipline at the end of your turn: -1 card next turn.\n\n-Positive Freedom during your turn: +1 mana.\n-Positive Freedom at the end of your turn: +1 card and +1 mana next turn.\n-Max Freedom at the end of your turn:-2 Armor.',r),sceneState.instructionsText.setLineSpacing(1.5),sceneState.instructionsElements=[sceneState.instructionsBackground,sceneState.instructionsHeadline,sceneState.instructionsText])}))}update(){let e=0;gameState.isEnteringName&&sceneState.newGameButtonClicked&&(sceneState.nameText.setText(gameState.name),e=sceneState.nameText.width,sceneState.formCursor.x=sceneState.nameText.x+e-7)}}class Level1Fight1 extends BaseScene{self;constructor(){super("Level1Fight1")}preload(){this.load.image("theCity","assets/images/theCity.jpg"),this.load.image("bakgrunnCity1","assets/images/bakgrunnCity1.jpg"),this.load.image("nazi","assets/images/sprites/nazi.png")}create(){const e=this;this.baseCreate("bakgrunnCity1"),this.resetPlayer(gameState.player,.37),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{E(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{E(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.permanents=[],gameState.player.name=gameState.playerName?gameState.playerName:"Punk Rock Samurai",gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Nazi Punk",gameState.enemy1.sprite=this.add.sprite(710,350,"nazi").setScale(.38).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9");const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theCity").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 1:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The City",t).setDepth(301).setOrigin(.5);let o=!1;function i(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),y(gameState.bonusCard),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(2800,(()=>{E(gameState.startText,200),e.time.delayedCall(300,s())}))}function s(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const a=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?a+1:a,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),w(gameState.player),B(gameState.player),e.time.delayedCall(2e3,(()=>{gameState.player.poisonText.destroy(),E(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{S(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,E(a,2e3),E(r,2e3),E(n,2e3),e.time.delayedCall(2200,i()))})),e.input.on("pointerup",(()=>{o||(o=!0,E(a,2e3),E(r,2e3),E(n,2e3),e.time.delayedCall(2200,i()))}));function m(t){if(gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),l(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;l(t,a,n)}))}else"permanent"===gameState.typePlayed?y(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),l(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function l(t,a,r=!1){gameState.playingCard=!0,E(t.sprite,200),E(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:o,stancePointsPlayed:i,poisonPlayed:s,healPlayed:m,strengthPlayed:l,armorPlayed:d,reduceTargetArmorPlayed:c,reduceTargetStrengthPlayed:y,drawCardPlayed:h}=function(e,t,a=!1){const r=gameState.player.stancePoints,n="moshpitMassacre"===e.key&&r>0&&t.poison>0,o="scorchedSoul"===e.key&&t.poison>0,i="bladesBlight"===e.key&&t.poison>0,s="roninsRot"===e.key&&t.poison>0,m="kabutu"===e.key&&gameState.edoEruption&&r>0,l="combatBoots"===e.key&&gameState.steelToe,d="knuckleFist"===e.key&&gameState.edoEruption&&r<0,S=r>0?2*(1+r):2;return{damagePlayed:n?11:g(e.damage),firePlayed:m?2*r:o?12:g(e.fire),stancePointsPlayed:m&&a?-1:g(e.stancePoints),poisonPlayed:i?t.poison:g(e.poison),healPlayed:g(e.heal),strengthPlayed:g(e.strength),armorPlayed:d?-r:g(e.armor),reduceTargetArmorPlayed:l?S:g(e.reduceTargetArmor),reduceTargetStrengthPlayed:s?t.poison:g(e.reduceTargetStrength),drawCardPlayed:g(e.drawCard)}}(t,a,r),u=(1+.1*gameState.player.strength)*(1-a.armor/20),f=Math.round(Math.max(0,o+n*u));a!=gameState.player&&(gameState.score.damageDealt+=f,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=c,a.poison+=s,a.health-=f),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=l:gameState.player.strengthCard+=l,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(f,s,l,d),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),M(a),e.updateHealthBar(a),B(gameState.player),w(a),p(),S(),A(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function g(e){return"function"==typeof e?e():e}function d(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){gameState.playersTurn&&(gameState.playersTurn=!1,t.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1600,(()=>{E(t.turnText,200)})));t.turnComplete=!1,function(t){t.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(t),gameState.toxicAvenger&&t.poison>0&&M(t);const a=""!==t.poisonText._text||t.turnText?1800:600;e.time.delayedCall(a,(()=>{t.poisonText.destroy();const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),M(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${t.damageTotal} damage`,r).setOrigin(.5),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t)):(a.strength>0||a.armor>0||a.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),w(t),M(t)})),e.time.delayedCall(1300,(()=>{E(gameState.actionText,200),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?d():(gameState.currentEnemyIndex=0,s()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,d()))}function S(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:7,text:"Gains 7 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 17 damage",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:1,text:"Heals 25 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),I(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(1800,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&E(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,c())})),e.input.on("pointerup",(()=>{t||(t=!0,c())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),I(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&E(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2400,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level1Fight2")}))}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,I(),B(gameState.player),S(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,E(e.intentionText,200),E(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),d()})))}));function y(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):t!=gameState.bonusCard&&(gameState.deck=gameState.deck.filter((e=>e!==t))),a?(t!=gameState.bonusCard&&(t.slot.available=!0,t.sprite.destroy()),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),function(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}(t),function(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,B(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>M(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,B(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?T(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,B(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,B(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),A(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":h(t);break;case"rebelSpirit":u(t);break;case"rebelHeart":f(t);break;case"bushido":x(t);break;case"toxicAvenger":k(t);break;case"kirisuteGomen":T(t);case"toxicFrets":b(t);break;case"ashenEncore":v(t);break;case"edoEruption":C(t);break;case"steelToe":P(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}function h(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),A(8)}function u(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function f(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function x(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,B(gameState.player)}function k(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,M(e)}))}function T(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),w(r),p(),B(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function b(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),w(t),p())}))}function v(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),w(t),p()}))}function C(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function P(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,M(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function B(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),M(e)}function M(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function w(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{E(e,500)}))}}function I(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),E(e.sprite,200)}}function A(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),w(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function E(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.permanentSlots=[{available:!0,x:40,y:40,index:0},{available:!0,x:115,y:40,index:1},{available:!0,x:190,y:40,index:2},{available:!0,x:265,y:40,index:3}],"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(A(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,w(e),p(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight2 extends BaseScene{self;constructor(){super("Level1Fight2")}preload(){this.load.image("bakgrunnCity2","assets/images/bakgrunnCity2.jpg"),this.load.image("police1","assets/images/sprites/police1.png"),this.load.image("police2","assets/images/sprites/police2.png")}create(){const e=this;for(this.baseCreate("bakgrunnCity2"),this.resetPlayer(gameState.player,.36),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[];gameState.extraCards.length;)gameState.bonusCards.push(gameState.extraCards.pop());function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Police Officer",gameState.enemy1.sprite=this.add.sprite(700,350,"police1").setScale(.22).setFlipX(!0).setInteractive(),gameState.enemy1.health=40,gameState.enemy1.healthMax=40,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Police Officer",gameState.enemy2.sprite=this.add.sprite(870,350,"police2").setScale(.33).setFlipX(!0).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:P(e.fire),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),T(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,o).setOrigin(.5),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:6,text:"Gains 6 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strength",probability:1}]:gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level1Fight3")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){console.log("DEBUG: depleteAshenEncore started"),gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level1Fight3 extends BaseScene{self;constructor(){super("Level1Fight3")}preload(){this.load.image("bakgrunnCity3","assets/images/bakgrunnCity3.jpg"),this.load.image("skinhead1","assets/images/sprites/skinhead1.png"),this.load.image("skinhead2","assets/images/sprites/skinhead2.png")}create(){const e=this;this.baseCreate("bakgrunnCity3",.7),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{w(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{w(e,200)})),gameState.cardImages=[]}));let t=7;function a(){let a=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,t-=1,gameState.endOfTurnButtonPressed=!1,2===gameState.turn&&function(){const a={fontSize:"60px",fontWeight:"bold",fill:"#000000"};gameState.turnsTextBox=e.add.rectangle(550,150,55,55,16777215).setAlpha(.3).setOrigin(.5),gameState.turnsText=e.add.text(550,152,`${t}`,a).setOrigin(.5)}(),gameState.turn>2&&gameState.turnsText.setText(`${t}`),0===t?(e.sound.add("gunShotSound").play({volume:1.2}),e.cameras.main.flash(700),e.cameras.main.shake(1e3,.003,!1),m()):(gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0,gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?1+gameState.player.manaBase+gameState.player.manaStance:gameState.player.manaBase+gameState.player.manaStance,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),C(gameState.player),b(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),w(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+a;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[a+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){r(t)}))}));gameState.playersTurn=!0}(a),gameState.enemies.forEach((t=>{i(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))})))}gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Police Informant",gameState.enemy1.sprite=this.add.sprite(700,340,"skinhead1").setScale(.25).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Police Informant",gameState.enemy2.sprite=this.add.sprite(880,340,"skinhead2").setScale(.38).setFlipX(!1).setInteractive(),gameState.enemy2.health=70,gameState.enemy2.healthMax=70,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),d(a),g(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:t,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{w(gameState.startText,200),e.time.delayedCall(300,a())}))}();function r(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),n(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const o=r===e.length-1;n(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),d(t),g(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":S(t);break;case"rebelSpirit":p(t);break;case"rebelHeart":c(t);break;case"bushido":y(t);break;case"toxicAvenger":h(t);break;case"kirisuteGomen":u(t);case"toxicFrets":f(t);break;case"ashenEncore":x(t);break;case"edoEruption":k(t);break;case"steelToe":T(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),n(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function n(t,a,r=!1){gameState.playingCard=!0,w(t.sprite,200),w(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:o,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:M(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:M(e.fire),stancePointsPlayed:s&&a?-1:M(e.stancePoints),poisonPlayed:o?t.poison:M(e.poison),healPlayed:M(e.heal),strengthPlayed:M(e.strength),armorPlayed:l?-gameState.player.stancePoints:M(e.armor),reduceTargetArmorPlayed:m?g:M(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:M(e.reduceTargetStrength),drawCardPlayed:M(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,o+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),v(a),e.updateHealthBar(a),b(gameState.player),C(a),s(),i(),B(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function o(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){gameState.playersTurn&&(gameState.playersTurn=!1,t.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{if(w(t.turnText,200),1===gameState.turn){const t={fontSize:"40px",fontWeight:"bold",fill:"#ff0000"},r=e.add.text(550,300,"  The enemy is\nratting you out!",t).setOrigin(.5).setDepth(201);let n=r.width,o=r.height,i=20,s=20;const m=e.add.graphics();m.fillStyle(16777215,.7),m.fillRect(r.x-n/2-i,r.y-o/2-s,n+2*i,o+2*s).setDepth(200),e.time.delayedCall(3500,(()=>{r.destroy(),m.destroy();const n=e.add.text(550,300,"Police snipers\n will hit you\n  in 5 turns!",t).setOrigin(.5).setDepth(201);let o=n.width,i=n.height,s=20,l=20;const g=e.add.graphics();g.fillStyle(16777215,.7),g.fillRect(n.x-o/2-s,n.y-i/2-l,o+2*s,i+2*l).setDepth(200),e.time.delayedCall(4500,(()=>{n.destroy(),g.destroy(),a()}))}))}})));1!=gameState.turn&&(t.turnComplete=!1,function(t){t.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(t),gameState.toxicAvenger&&t.poison>0&&v(t);const r=""!==t.poisonText._text||t.turnText?1800:800;e.time.delayedCall(r,(()=>{t.poisonText.destroy();const r=t.chosenAction,n={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,t.health=Math.min(t.health+r.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+r.strength,t.strengthMax),v(t),t.armor=Math.min(t.armor+r.armor,t.armorMax),r.damage>0||r.fire>0){const a=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,r.fire+r.damage*a)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${t.damageTotal} damage`,n).setOrigin(.5),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,n).setOrigin(.5),e.powerUpTweens(t)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,n).setOrigin(.5),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),C(t),v(t)})),e.time.delayedCall(1500,(()=>{w(gameState.actionText,200),t.turnComplete=!0,s()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?o():(gameState.currentEnemyIndex=0,a()))}))}(t)}))}(t))}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,o()))}function i(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRat you out",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRat you out",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rats you out",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}])}function s(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),P(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,350,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsText=e.add.text(550,350,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardRemoveCardButton=e.add.image(550,500,"rectangularButton"),gameState.rewardRemoveCardButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardRemoveCardText=e.add.text(550,500,"Remove 1 card\nfrom your deck",a).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardAddCardsButton,gameState.rewardRemoveCardButton],gameState.rewardTexts=[gameState.rewardAddCardsText,gameState.rewardRemoveCardText,gameState.gameOverText],gameState.rewardButtons.forEach((e=>{e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardTexts.forEach((e=>e.destroy())),gameState.rewardButtons.forEach((e=>e.destroy())),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&w(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,l())})),e.input.on("pointerup",(()=>{t||(t=!0,l())}))}))}))}()})),gameState.rewardRemoveCardButton.on("pointerup",(function(){gameState.rewardTexts.forEach((e=>e.destroy())),gameState.rewardButtons.forEach((e=>e.destroy())),gameState.rewardAddCardsButton.destroy(),function(){console.log("button pressed"),gameState.rewardButtons.forEach((e=>e.destroy())),gameState.rewardTexts.forEach((e=>e.destroy()));const t=4,a=300,r=250,n=120,o=gameState.deck;o.forEach((e=>console.log(e.key))),o.forEach(((i,s)=>{let m=a+s%t*n,g=r+Math.floor(s/t)*n,d=110+s;i.sprite=e.add.sprite(m,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(200)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){let t=!1;console.log(`Deck length before removal: ${gameState.deck.length}`),o.splice(o.indexOf(i),1),o.forEach((e=>{e.sprite.removeInteractive(),e!==i&&w(i.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Removed 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),console.log(`Deck length after removal: ${gameState.deck.length}`),e.time.delayedCall(2500,(()=>{t||(t=!0,l())})),e.input.on("pointerup",(()=>{t||(t=!0,l())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,m(),!0)}function m(){gameState.player.health=0,e.updateManaBar(gameState.player),P(),gameState.music.stop(),e.clearBoard(),gameState.actionText&&w(gameState.actionText,200),gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}function l(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level2Fight1")}))}function g(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,b(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>v(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,b(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?u(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,b(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,b(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),B(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function d(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function S(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),B(8)}function p(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function c(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function y(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,b(gameState.player)}function h(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,v(e)}))}function u(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),C(r),s(),b(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function f(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),C(t),s())}))}function x(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),C(t),s()}))}function k(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function T(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,v(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function b(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),v(e)}function v(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function C(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{w(e,500)}))}}function P(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),w(e.sprite,200)}}function B(t){const a=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),n=a[Math.floor(a.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),C(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){r(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function M(e){return"function"==typeof e?e():e}function w(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,P(),b(gameState.player),i(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,w(e.intentionText,200),w(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),o()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(B(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,C(e),s(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight1 extends BaseScene{self;constructor(){super("Level2Fight1")}preload(){this.load.image("theForest","assets/images/theForest.jpg"),this.load.image("bakgrunnForest1","assets/images/bakgrunnForest1.jpg"),this.load.image("tree1","assets/images/sprites/tree1.png"),this.load.image("tree2","assets/images/sprites/tree2.png")}create(){const e=this;this.baseCreate("bakgrunnForest1"),this.resetPlayer(gameState.player,.37),gameState.player.health=gameState.player.healthMax,this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{R(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{R(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Timbermaw\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.sprite=this.add.sprite(690,330,"tree1").setScale(.29).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy.armor=15,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Mossbite\nLoses Armor when attacked\nTakes +50% damage from Fire",gameState.enemy2.sprite=this.add.sprite(920,330,"tree2").setScale(.29).setFlipX(!1).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemy2.armor=15,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),f(a),u(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theForest").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 2:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Forest",t).setDepth(301).setOrigin(.5);let o=!1;function i(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{R(gameState.startText,200),e.time.delayedCall(300,s())}))}function s(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const a=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?a+1:a,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),E(gameState.player),I(gameState.player),e.time.delayedCall(2200,(()=>{if(R(gameState.yourTurnText,200),gameState.player.poisonText.destroy(),1===gameState.turn){let a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},r=e.add.text(550,300,"Trees start with full\nArmor, and lose 1 Armor\n    when attacked",a).setOrigin(.5).setDepth(201),n=r.width,o=r.height,i=20,s=20;const l=e.add.graphics();l.fillStyle(16777215,.7),l.fillRect(r.x-n/2-i,r.y-o/2-s,n+2*i,o+2*s).setDepth(200),e.time.delayedCall(4500,(()=>{R(r,200),R(l,200),m(t),gameState.enemies.forEach((e=>{p(),c(e),$(e)}))}))}else m(t),gameState.enemies.forEach((e=>{p(),c(e),$(e)}))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,R(a,2e3),R(r,2e3),R(n,2e3),e.time.delayedCall(2200,i()))})),e.input.on("pointerup",(()=>{o||(o=!0,R(a,2e3),R(r,2e3),R(n,2e3),e.time.delayedCall(2200,i()))}));function m(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){l(t)}))}));gameState.playersTurn=!0}function l(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),g(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;g(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),f(t),u(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":x(t);break;case"rebelSpirit":k(t);break;case"rebelHeart":T(t);break;case"bushido":b(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":C(t);case"toxicFrets":P(t);break;case"ashenEncore":B(t);break;case"edoEruption":M(t);break;case"steelToe":w(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),g(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function g(t,a,r=!1){gameState.playingCard=!0,R(t.sprite,200),R(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:o,stancePointsPlayed:i,poisonPlayed:s,healPlayed:m,strengthPlayed:l,armorPlayed:g,reduceTargetArmorPlayed:S,reduceTargetStrengthPlayed:c,drawCardPlayed:h}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:d(e.damage),firePlayed:1.5*(s?2*gameState.player.stancePoints:n?12:d(e.fire)),stancePointsPlayed:s&&a?-1:d(e.stancePoints),poisonPlayed:o?t.poison:d(e.poison),healPlayed:d(e.heal),strengthPlayed:d(e.strength),armorPlayed:l?-gameState.player.stancePoints:d(e.armor),reduceTargetArmorPlayed:m?g:d(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:d(e.reduceTargetStrength),drawCardPlayed:d(e.drawCard)}}(t,a,r),u=(1+.1*gameState.player.strength)*(1-a.armor/20),f=Math.round(Math.max(0,o+n*u));a!=gameState.player&&(gameState.score.damageDealt+=f,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=S,a.poison+=s,a.health-=f,a.armor>0&&f>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=l:gameState.player.strengthCard+=l,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=g,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(f,s,l,g),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),A(a),e.updateHealthBar(a),I(gameState.player),E(a),y(),p(),D(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function d(e){return"function"==typeof e?e():e}function S(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){gameState.playersTurn&&(gameState.playersTurn=!1,t.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{R(t.turnText,200)})));t.turnComplete=!1,function(t){t.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(t),gameState.toxicAvenger&&t.poison>0&&A(t);const a=""!==t.poisonText._text||t.turnText?1800:800;e.time.delayedCall(a,(()=>{t.poisonText.destroy();const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),A(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${t.damageTotal} damage`,r).setOrigin(.5),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t)):(a.strength>0||a.armor>0||a.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),E(t),A(t)})),e.time.delayedCall(1500,(()=>{R(gameState.actionText,200),t.turnComplete=!0,y()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?S():(gameState.currentEnemyIndex=0,s()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,S()))}function p(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strength",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strength",probability:1}]):2===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:10,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):3===gameState.turn?(gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(13*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 13 damage",probability:1}],gameState.enemy2.actions=[{key:()=>`Intends to\nDeal ${Math.round(13*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:13,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 13 damage",probability:1}]):4===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:5,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:5,poisonRemove:0,strength:0,armor:0,text:"Heals 10 HP",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(16*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:16,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 16 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,text:"Gains 2 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 10 fire damage",damage:0,fire:10,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,text:"Gains 3 armor",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}])}function c(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function y(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),O(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&R(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,h())})),e.input.on("pointerup",(()=>{t||(t=!0,h())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),O(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&R(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function h(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level2Fight2")}))}function u(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>A(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?C(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,I(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,I(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),D(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function f(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function x(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),D(8)}function k(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function T(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function b(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,I(gameState.player)}function v(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,A(e)}))}function C(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),E(r),y(),I(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),E(t),y())}))}function B(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),E(t),y()}))}function M(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function w(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,A(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function I(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),A(e)}function A(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function E(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{R(e,500)}))}}function O(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),R(e.sprite,200)}}function D(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),E(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){l(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function $(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function R(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,O(),I(gameState.player),p(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,R(e.intentionText,200),R(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),S()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(D(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,E(e),y(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight2 extends BaseScene{self;constructor(){super("Level2Fight2")}preload(){this.load.image("bakgrunnForest2","assets/images/bakgrunnForest2.jpg"),this.load.image("goblin1","assets/images/sprites/goblin1.png"),this.load.image("goblin2","assets/images/sprites/goblin2.png"),this.load.image("goblin3","assets/images/sprites/goblin3.png")}create(){const e=this;for(this.baseCreate("bakgrunnForest2"),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[];gameState.extraCards.length;)gameState.bonusCards.push(gameState.extraCards.pop());function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Junior Goblin\nApprentice of poison",gameState.enemy1.sprite=this.add.sprite(670,370,"goblin1").setScale(.19).setFlipX(!0).setInteractive(),gameState.enemy1.health=30,gameState.enemy1.healthMax=30,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Junior Goblin\nApprentice of poison",gameState.enemy2.sprite=this.add.sprite(800,370,"goblin3").setScale(.17).setFlipX(!1).setInteractive(),gameState.enemy2.health=30,gameState.enemy2.healthMax=30,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Senior Goblin\nMaster of poison",gameState.enemy3.sprite=this.add.sprite(930,370,"goblin2").setScale(.23).setFlipX(!1).setInteractive(),gameState.enemy3.health=45,gameState.enemy3.healthMax=45,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:P(e.fire),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),T(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,o).setOrigin(.5),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/6}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:0+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(8*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:8,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 damage\nAnd 1 Poison",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage\nAnd 1 Poison",probability:.11+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:2,text:"Heals 15 HP\nGains 2 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 strenght",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:5,text:"Gains 5 armor",probability:.14+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:2,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 2 poison",probability:.18+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/6}],gameState.enemy3.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:0+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(11*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:11,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage\nAnd 1 Poison",probability:.17+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy3.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:1,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage\nAnd 1 Poison",probability:.11+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy3.health>=gameState.enemy3.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.13+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.18+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6},{key:"Intends to\nPoison you",damage:0,fire:0,poison:3,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 3 poison",probability:.19+(gameState.enemy3.health>=gameState.enemy3.healthMax?.22:0)/6}]}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn;const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};gameState.gameOverText=e.add.text(550,300," Defeat!",t).setOrigin(.5),gameState.gameOverText.setInteractive();let a=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a||(gameState.gameOverText.on("pointerup",(()=>{a=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{a=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level2Fight3")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){console.log("DEBUG: depleteAshenEncore started"),gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level2Fight3 extends BaseScene{self;constructor(){super("Level2Fight3")}preload(){this.load.image("bakgrunnForest3","assets/images/bakgrunnForest3.jpg"),this.load.image("tree3","assets/images/sprites/tree3.png")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}this.baseCreate("bakgrunnForest3",.7),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Lord of the Trees\nLose Armor when attacked\nTakes +50% damage from Fire",gameState.enemy1.sprite=this.add.sprite(750,300,"tree3").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy1.health=110,gameState.enemy1.healthMax=110,gameState.enemy1.armor=15,gameState.enemies=[gameState.enemy1],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:1.5*(s?2*gameState.player.stancePoints:n?12:P(e.fire)),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u,a.armor>0&&u>0&&(a.armor-=1)),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),T(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);if(e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,a===gameState.enemy1||a===gameState.enemy2){const t=r.armor>0?`Steals ${r.armor} Armor`:`Steals ${r.strength} Strength`;gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage\n${t}`,o).setOrigin(.5)}else gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,o).setOrigin(.5);e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:4,armor:0,text:"Gains 4 Strength",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 Strength",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:4===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nRest",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Rests",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,350,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsText=e.add.text(550,350,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardRemoveCardButton=e.add.image(550,500,"rectangularButton"),gameState.rewardRemoveCardButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardRemoveCardText=e.add.text(550,500,"Remove 1 card\nfrom your deck",a).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardAddCardsButton,gameState.rewardRemoveCardButton],gameState.rewardTexts=[gameState.rewardAddCardsText,gameState.rewardRemoveCardText,gameState.gameOverText],gameState.rewardButtons.forEach((e=>{e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardTexts.forEach((e=>e.destroy())),gameState.rewardButtons.forEach((e=>e.destroy())),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()})),gameState.rewardRemoveCardButton.on("pointerup",(function(){gameState.rewardTexts.forEach((e=>e.destroy())),gameState.rewardButtons.forEach((e=>e.destroy())),gameState.rewardAddCardsButton.destroy(),function(){console.log("button pressed"),gameState.rewardButtons.forEach((e=>e.destroy())),gameState.rewardTexts.forEach((e=>e.destroy()));const t=4,a=300,r=250,n=120,o=gameState.deck;o.forEach((e=>console.log(e.key))),o.forEach(((i,m)=>{let l=a+m%t*n,g=r+Math.floor(m/t)*n,d=110+m;i.sprite=e.add.sprite(l,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(200)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){let t=!1;console.log(`Deck length before removal: ${gameState.deck.length}`),o.splice(o.indexOf(i),1),o.forEach((e=>{e.sprite.removeInteractive(),e!==i&&B(i.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Removed 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),console.log(`Deck length after removal: ${gameState.deck.length}`),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level3Fight1")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight1 extends BaseScene{self;constructor(){super("Level3Fight1")}preload(){this.load.image("theDemonLair","assets/images/theDemonLair.jpg"),this.load.image("bakgrunnLair1","assets/images/bakgrunnLair1.jpg"),this.load.image("demon1","assets/images/sprites/demon1.png"),this.load.image("demon2","assets/images/sprites/demon2.png")}create(){const e=this;this.baseCreate("bakgrunnLair1"),this.resetPlayer(gameState.player,.37),gameState.player.health=gameState.player.healthMax,this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{O(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{O(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Voidling",gameState.enemy1.sprite=this.add.sprite(680,350,"demon1").setScale(.32).setFlipX(!1).setInteractive(),gameState.enemy1.health=45,gameState.enemy1.healthMax=45,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Infernus",gameState.enemy2.sprite=this.add.sprite(890,330,"demon2").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy2.health=65,gameState.enemy2.healthMax=65,gameState.enemy2.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),h(a),y(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theDemonLair").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 3:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Lair",t).setDepth(301).setOrigin(.5);let o=!1;function i(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{O(gameState.startText,200),e.time.delayedCall(300,s())}))}function s(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const a=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?a+1:a,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),I(gameState.player),M(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),O(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{S(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,O(a,2e3),O(r,2e3),O(n,2e3),e.time.delayedCall(2200,i()))})),e.input.on("pointerup",(()=>{o||(o=!0,O(a,2e3),O(r,2e3),O(n,2e3),e.time.delayedCall(2200,i()))}));function m(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),l(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;l(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),h(t),y(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":u(t);break;case"rebelSpirit":f(t);break;case"rebelHeart":x(t);break;case"bushido":k(t);break;case"toxicAvenger":T(t);break;case"kirisuteGomen":b(t);case"toxicFrets":v(t);break;case"ashenEncore":C(t);break;case"edoEruption":P(t);break;case"steelToe":B(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),l(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function l(t,a,r=!1){gameState.playingCard=!0,O(t.sprite,200),O(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:o,stancePointsPlayed:i,poisonPlayed:s,healPlayed:m,strengthPlayed:l,armorPlayed:d,reduceTargetArmorPlayed:c,reduceTargetStrengthPlayed:y,drawCardPlayed:h}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,d=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:g(e.damage),firePlayed:1.5*(s?2*gameState.player.stancePoints:n?12:g(e.fire)),stancePointsPlayed:s&&a?-1:g(e.stancePoints),poisonPlayed:o?t.poison:g(e.poison),healPlayed:g(e.heal),strengthPlayed:g(e.strength),armorPlayed:l?-gameState.player.stancePoints:g(e.armor),reduceTargetArmorPlayed:m?d:g(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:g(e.reduceTargetStrength),drawCardPlayed:g(e.drawCard)}}(t,a,r),u=(1+.1*gameState.player.strength)*(1-a.armor/20),f=Math.round(Math.max(0,o+n*u));a!=gameState.player&&(gameState.score.damageDealt+=f,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=y,a.armor-=c,a.poison+=s,a.health-=f),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=l:gameState.player.strengthCard+=l,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=d,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(f,s,l,d),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),w(a),e.updateHealthBar(a),M(gameState.player),I(a),p(),S(),E(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function g(e){return"function"==typeof e?e():e}function d(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){gameState.playersTurn&&(gameState.playersTurn=!1,t.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{O(t.turnText,200)})));t.turnComplete=!1,function(t){t.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(t),gameState.toxicAvenger&&t.poison>0&&w(t);const a=""!==t.poisonText._text||t.turnText?1800:800;e.time.delayedCall(a,(()=>{t.poisonText.destroy();const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),w(t),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${t.damageTotal} damage`,r).setOrigin(.5),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t)):(a.strength>0||a.armor>0||a.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),I(t),w(t)})),e.time.delayedCall(1500,(()=>{O(gameState.actionText,200),t.turnComplete=!0,p()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?d():(gameState.currentEnemyIndex=0,s()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,d()))}function S(){gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nDeal 6 fire damage",damage:0,fire:6,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 5 fire damage",probability:1}]:gameState.enemy2.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:7,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function p(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),A(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&O(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,c())})),e.input.on("pointerup",(()=>{t||(t=!0,c())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),A(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&O(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function c(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level3Fight2")}))}function y(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,M(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>w(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,M(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?C(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,M(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,M(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),E(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function h(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function u(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),E(8)}function f(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function x(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function k(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,M(gameState.player)}function T(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,w(e)}))}function b(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),I(r),p(),M(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function v(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),I(t),p())}))}function C(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),I(t),p()}))}function P(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function B(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,w(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function M(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),w(e)}function w(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function I(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{O(e,500)}))}}function A(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),O(e.sprite,200)}}function E(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),I(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){m(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function O(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,A(),M(gameState.player),S(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,O(e.intentionText,200),O(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),d()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(E(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,I(e),p(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight2 extends BaseScene{self;constructor(){super("Level3Fight2")}preload(){this.load.image("skeleton1","assets/images/sprites/skeleton1.png"),this.load.image("skeleton2","assets/images/sprites/skeleton2.png"),this.load.image("bakgrunnLair2","assets/images/bakgrunnLair2.jpg")}create(){const e=this;for(this.baseCreate("bakgrunnLair2"),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[];gameState.extraCards.length;)gameState.bonusCards.push(gameState.extraCards.pop());function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Spineguard",gameState.enemy1.sprite=this.add.sprite(690,350,"skeleton1").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=2,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Bonebaron",gameState.enemy2.sprite=this.add.sprite(910,330,"skeleton2").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy2.health=70,gameState.enemy2.healthMax=70,gameState.enemy2.armor=2,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:P(e.fire),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),T(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,o).setOrigin(.5),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){1===gameState.turn?(gameState.enemy1.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:1}],gameState.enemy2.actions=[{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:1}]):(gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.245+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.16+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 8 fire damage",damage:0,fire:8,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 8 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(14*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:14,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 14 damage",probability:.245+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(18*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:18,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 18 damage",probability:.16+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}])}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn;const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"};gameState.gameOverText=e.add.text(550,300," Defeat!",t).setOrigin(.5),gameState.gameOverText.setInteractive();let a=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a||(gameState.gameOverText.on("pointerup",(()=>{a=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{a=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level3Fight3")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){console.log("DEBUG: depleteAshenEncore started"),gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level3Fight3 extends BaseScene{self;constructor(){super("Level3Fight3")}preload(){this.load.image("bakgrunnLair3","assets/images/bakgrunnLair3.jpg"),this.load.image("wraith1","assets/images/sprites/wraith1.png"),this.load.image("wraith2","assets/images/sprites/wraith2.png")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}this.baseCreate("bakgrunnLair3",.7),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Soulripper",gameState.enemy1.sprite=this.add.sprite(670,340,"wraith2").setScale(.26).setFlipX(!1).setInteractive(),gameState.enemy1.health=60,gameState.enemy1.healthMax=60,gameState.enemy1.armor=2,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Lord of Darkness",gameState.enemy2.sprite=this.add.sprite(890,330,"wraith1").setScale(.27).setFlipX(!1).setInteractive(),gameState.enemy2.health=100,gameState.enemy2.healthMax=100,gameState.enemy2.armor=2,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:1.5*(s?2*gameState.player.stancePoints:n?12:P(e.fire)),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),T(a),a.armor=Math.min(a.armor+r.armor,a.armorMax),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,o).setOrigin(.5),e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.235+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.17+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 10 fire damage",damage:0,fire:10,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 10 fire damage",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:.235+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 20 damage",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,text:"Heals 15 HP\nGains 1 armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:0,armor:0,text:"Heals 25 HP",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,text:"Gains 3 strenght",probability:.125+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Gains 4 armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 5 poison",probability:0}]}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,350,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsText=e.add.text(550,350,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardRemoveCardButton=e.add.image(550,500,"rectangularButton"),gameState.rewardRemoveCardButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardRemoveCardText=e.add.text(550,500,"Remove 1 card\nfrom your deck",a).setOrigin(.5).setDepth(103),gameState.rewardButtons=[gameState.rewardAddCardsButton,gameState.rewardRemoveCardButton],gameState.rewardTexts=[gameState.rewardAddCardsText,gameState.rewardRemoveCardText,gameState.gameOverText],gameState.rewardButtons.forEach((e=>{e.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),e.on("pointerout",(function(){this.setTexture("rectangularButton")}))})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardTexts.forEach((e=>e.destroy())),gameState.rewardButtons.forEach((e=>e.destroy())),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()})),gameState.rewardRemoveCardButton.on("pointerup",(function(){gameState.rewardTexts.forEach((e=>e.destroy())),gameState.rewardButtons.forEach((e=>e.destroy())),gameState.rewardAddCardsButton.destroy(),function(){console.log("button pressed"),gameState.rewardButtons.forEach((e=>e.destroy())),gameState.rewardTexts.forEach((e=>e.destroy()));const t=4,a=300,r=250,n=120,o=gameState.deck;o.forEach((e=>console.log(e.key))),o.forEach(((i,m)=>{let l=a+m%t*n,g=r+Math.floor(m/t)*n,d=110+m;i.sprite=e.add.sprite(l,g,i.key).setScale(.27).setInteractive().setDepth(d),i.sprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(i.sprite,.4,200),i.sprite.setDepth(200)}),this),i.sprite.on("pointerout",(function(){e.cardTweens(i.sprite,.27,400),i.sprite.setDepth(d)}),this),i.sprite.on("pointerup",(function(){let t=!1;console.log(`Deck length before removal: ${gameState.deck.length}`),o.splice(o.indexOf(i),1),o.forEach((e=>{e.sprite.removeInteractive(),e!==i&&B(i.sprite,200)})),e.tweens.add({targets:i.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Removed 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),console.log(`Deck length after removal: ${gameState.deck.length}`),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level4Fight1")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level4Fight1 extends BaseScene{self;constructor(){super("Level4Fight1")}preload(){this.load.image("theFortress","assets/images/theFortress.jpg"),this.load.image("bakgrunnFortress1","assets/images/bakgrunnFortress1.jpg"),this.load.image("monster1","assets/images/sprites/monster1.png"),this.load.image("monster2","assets/images/sprites/monster2.png")}create(){const e=this;this.baseCreate("bakgrunnFortress1"),this.resetPlayer(gameState.player,.37),gameState.player.health=gameState.player.healthMax,this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{R(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{R(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Mong\nSteals Strength and Armor",gameState.enemy1.sprite=this.add.sprite(600,355,"monster1").setScale(.16).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Goh\nSteals Strength and Armor",gameState.enemy2.sprite=this.add.sprite(790,350,"monster2").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy2.health=60,gameState.enemy2.healthMax=60,gameState.enemy1.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),f(a),u(a))}));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=this.add.image(0,0,"theFortress").setScale(.87).setOrigin(.02,0).setDepth(300),r=this.add.text(550,270,"Level 4:",t).setDepth(301).setOrigin(.5),n=this.add.text(550,430,"The Fortress",t).setDepth(301).setOrigin(.5);let o=!1;function i(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:t,fight:a}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${t}\nFight ${a}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{R(gameState.startText,200),e.time.delayedCall(300,s())}))}function s(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const a=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?a+1:a,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),E(gameState.player),I(gameState.player),e.time.delayedCall(2200,(()=>{if(R(gameState.yourTurnText,200),gameState.player.poisonText.destroy(),1===gameState.turn){let a={fontSize:"38px",fill:"#ff0000",fontWeight:"bold"},r=e.add.text(550,300,"Monsters steal Armor or\nStrength when they attack",a).setOrigin(.5).setDepth(201),n=r.width,o=r.height,i=20,s=20;const l=e.add.graphics();l.fillStyle(16777215,.7),l.fillRect(r.x-n/2-i,r.y-o/2-s,n+2*i,o+2*s).setDepth(200),e.time.delayedCall(4500,(()=>{R(r,200),R(l,200),m(t),gameState.enemies.forEach((e=>{p(),c(e),$(e)}))}))}else m(t),gameState.enemies.forEach((e=>{p(),c(e),$(e)}))}))}e.time.delayedCall(4e3,(()=>{o||(o=!0,R(a,2e3),R(r,2e3),R(n,2e3),e.time.delayedCall(2200,i()))})),e.input.on("pointerup",(()=>{o||(o=!0,R(a,2e3),R(r,2e3),R(n,2e3),e.time.delayedCall(2200,i()))}));function m(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const a=Math.floor((gameState.slots.length-t)/2);for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),n=10+r+a;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(n);const o=gameState.slots[a+r];o&&(t.sprite.x=o.x,t.sprite.y=o.y,t.startHeight=t.sprite.y,t.angle=o.angle,t.sprite.setAngle(t.angle),o.available=!1,t.slot=o),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,n),gameState.playersTurn&&t.sprite.on("pointerup",(function(){l(t)}))}));gameState.playersTurn=!0}function l(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),g(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,r)=>{const n=r===e.length-1;g(t,a,n)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));"kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t));a?(t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),f(t),u(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":x(t);break;case"rebelSpirit":k(t);break;case"rebelHeart":T(t);break;case"bushido":b(t);break;case"toxicAvenger":v(t);break;case"kirisuteGomen":C(t);case"toxicFrets":P(t);break;case"ashenEncore":B(t);break;case"edoEruption":M(t);break;case"steelToe":w(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),g(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function g(t,a,r=!1){gameState.playingCard=!0,R(t.sprite,200),R(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:o,stancePointsPlayed:i,poisonPlayed:s,healPlayed:m,strengthPlayed:l,armorPlayed:g,reduceTargetArmorPlayed:S,reduceTargetStrengthPlayed:c,drawCardPlayed:h}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:d(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:d(e.fire),stancePointsPlayed:s&&a?-1:d(e.stancePoints),poisonPlayed:o?t.poison:d(e.poison),healPlayed:d(e.heal),strengthPlayed:d(e.strength),armorPlayed:l?-gameState.player.stancePoints:d(e.armor),reduceTargetArmorPlayed:m?g:d(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:d(e.reduceTargetStrength),drawCardPlayed:d(e.drawCard)}}(t,a,r),u=(1+.1*gameState.player.strength)*(1-a.armor/20),f=Math.round(Math.max(0,o+n*u));a!=gameState.player&&(gameState.score.damageDealt+=f,console.log(`${n} Physical Damage and ${o} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=S,a.poison+=s,a.health-=f),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=l:gameState.player.strengthCard+=l,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),m&&(gameState.player.health=Math.min(gameState.player.health+m,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=g,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(f,s,l,g),gameState.player.stancePoints+i>=-3&&gameState.player.stancePoints+i<=3&&(gameState.player.stancePoints+=i,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),A(a),e.updateHealthBar(a),I(gameState.player),E(a),y(),p(),D(h),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function d(e){return"function"==typeof e?e():e}function S(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(t){gameState.playersTurn&&(gameState.playersTurn=!1,t.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{R(t.turnText,200)})));t.turnComplete=!1,function(t){t.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(t),gameState.toxicAvenger&&t.poison>0&&A(t);const a=""!==t.poisonText._text||t.turnText?1800:800;e.time.delayedCall(a,(()=>{t.poisonText.destroy();const a=t.chosenAction,r={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=a.poison,t.health=Math.min(t.health+a.heal,t.healthMax),t.strengthBase=Math.min(t.strengthBase+a.strength,t.strengthMax),gameState.player.armorBase-=a.reduceTargetArmor,gameState.player.strengthBase-=a.reduceTargetStrength,A(t),A(gameState.player),t.armor=Math.min(t.armor+a.armor,t.armorMax),a.damage>0||a.fire>0){const n=(1+.1*t.strength)*(1-gameState.player.armor/20);e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${t.damageTotal}`),t.damageTotal=Math.round(Math.max(0,a.fire+a.damage*n)),gameState.player.health-=t.damageTotal,gameState.score.damageTaken+=t.damageTotal;const o=a.armor>0?`Steals ${a.armor} Armor`:`Steals ${a.strength} Strength`;gameState.actionText=e.add.text(550,300,`Deals ${t.damageTotal} damage\n${o}`,r).setOrigin(.5),e.tweens.add({targets:t.sprite,x:t.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else a.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t)):(a.strength>0||a.armor>0||a.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,a.text,r).setOrigin(.5),e.powerUpTweens(t));t.strengthTurn=0,function(t){[gameState.player,t].forEach((t=>{e.updateHealthBar(t),E(t),A(t)})),e.time.delayedCall(1500,(()=>{R(gameState.actionText,200),t.turnComplete=!0,y()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?S():(gameState.currentEnemyIndex=0,s()))}))}(t)}))}(t)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,S()))}function p(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,reduceTargetStrength:0,reduceTargetArmor:3,text:"Steals 3 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 12 damage",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 12 damage\nSteals 1 Armor",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 17 damage\nSteals 1 Strength",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 15 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 25 HP\nSteals 1 Strength",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.05},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:1,reduceTargetStrength:2,reduceTargetArmor:1,text:"Steals 2 Strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 Armor",probability:.11+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy2.actions=[{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:0,reduceTargetStrength:3,reduceTargetArmor:0,text:"Steals 3 Strength",probability:1}]:gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 5 fire damage\n Steals 1 Strength",probability:.1+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:" Deals 15 damage\nSteals 1 Strength",probability:.24+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(20*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:20,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 20 damage\nSteals 1 Armor",probability:.17+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:1,armor:1,reduceTargetStrength:1,reduceTargetArmor:0,text:" Heals 15 HP\nSteals 1 Strength",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"  Heals 25 HP\nSteals 1 Armor",probability:gameState.enemy2.health>=gameState.enemy2.healthMax?0:.05},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:0,reduceTargetStrength:2,reduceTargetArmor:0,text:"Steals 2 Strenght",probability:.12+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,reduceTargetStrength:0,reduceTargetArmor:3,text:"Steals 3 Armor",probability:.15+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 5 poison",probability:0}]}function c(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}function y(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),O(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&R(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,h())})),e.input.on("pointerup",(()=>{t||(t=!0,h())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),O(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&R(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function h(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level4Fight2")}))}function u(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?k(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?T(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?b(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>A(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?v(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,I(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?C(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?P(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?B(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?M(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?w(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,I(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,I(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),D(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function f(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function x(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),D(8)}function k(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function T(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function b(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,I(gameState.player)}function v(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,A(e)}))}function C(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),E(r),y(),I(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function P(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),E(t),y())}))}function B(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),E(t),y()}))}function M(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function w(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,A(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function I(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),A(e)}function A(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function E(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{R(e,500)}))}}function O(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),R(e.sprite,200)}}function D(t){const a=Math.min(gameState.deck.length,8),r=gameState.slots.filter((e=>e.available)).length;t=r<t?r:t;for(let r=0;r<t;r++)e.time.delayedCall(75*r,(()=>{if(gameState.currentCards.length<a){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let a=gameState.slots.filter((e=>e.available)),r=a[Math.floor(a.length/2)];if(r){t.sprite.x=r.x,t.sprite.y=r.y,t.startHeight=t.sprite.y,t.angle=r.angle,t.sprite.setAngle(t.angle),r.available=!1,t.slot=r;let a=10+r.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),E(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){l(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function $(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key;t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,{fontSize:"13px",fill:"#000000"}),t.intentionText.setOrigin(.5,1).setDepth(11);const r=e.textures.get("listbox1").getSourceImage().width,n=t.intentionText.width/r;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*n,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}function R(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,O(),I(gameState.player),p(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,R(e.intentionText,200),R(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),S()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(D(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,E(e),y(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level4Fight2 extends BaseScene{self;constructor(){super("Level4Fight2")}preload(){this.load.image("bakgrunnFortress2","assets/images/bakgrunnFortress2.jpg"),this.load.image("monster3","assets/images/sprites/monster3.png"),this.load.image("monster4","assets/images/sprites/monster4.png"),this.load.image("sorcerer1","assets/images/sprites/sorcerer1.png")}create(){const e=this;for(this.baseCreate("bakgrunnFortress2"),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[];gameState.extraCards.length;)gameState.bonusCards.push(gameState.extraCards.pop());function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Gloomhoof\nSteals Strength and Armor",gameState.enemy1.sprite=this.add.sprite(610,350,"monster3").setScale(.34).setFlipX(!1).setInteractive(),gameState.enemy1.health=40,gameState.enemy1.healthMax=40,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Darktuft\nSteals Strength and Armor",gameState.enemy2.sprite=this.add.sprite(820,350,"monster4").setScale(.39).setFlipX(!0).setInteractive(),gameState.enemy2.health=40,gameState.enemy2.healthMax=40,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Ampward\nMaster of healing and buffing",gameState.enemy3.sprite=this.add.sprite(1e3,370,"sorcerer1").setScale(.36).setFlipX(!1).setInteractive(),gameState.enemy3.health=50,gameState.enemy3.healthMax=50,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:P(e.fire),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction,o={fontSize:"32px",fill:"#ff0000"};if(gameState.player.poison+=r.poison,a===gameState.enemy3?gameState.enemies.forEach((e=>{e.health=Math.min(e.health+r.heal,e.healthMax),e.strengthBase=Math.min(e.strengthBase+r.strength,e.strengthMax),e.armor=Math.min(e.armor+r.armor,e.armorMax),T(e)})):(a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),a.armor=Math.min(a.armor+r.armor,a.armorMax),gameState.player.armorBase-=r.reduceTargetArmor,gameState.player.strengthBase-=r.reduceTargetStrength,T(a),T(gameState.player)),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);if(e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,a===gameState.enemy1||a===gameState.enemy2){const t=r.armor>0?`Steals ${r.armor} Armor`:`Steals ${r.strength} Strength`;gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage\n${t}`,o).setOrigin(.5)}else gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,o).setOrigin(.5);e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,o).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:3,reduceTargetStrength:0,reduceTargetArmor:3,text:"Gains 3 armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,reduceTargetStrength:0,reduceTargetArmor:3,text:"Deals 12 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 fire damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.2:0)/5},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 12 damage\nSteals 1 Armor",probability:.22+(gameState.enemy1.health>=gameState.enemy1.healthMax?.23:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 17 damage\nSteals 1 Strength",probability:.13+(gameState.enemy1.health>=gameState.enemy1.healthMax?.23:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 15 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 25 HP\nSteals 1 Strength",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:1,reduceTargetStrength:2,reduceTargetArmor:1,text:"Steals 2 Strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.23:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:2,text:"Steals 2 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.23:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 fire damage",probability:.15+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(10*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:10,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 12 damage\nSteals 1 Armor",probability:.23+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 17 damage\nSteals 1 Strength",probability:.13+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 15 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.16},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 25 HP\nSteals 1 Strength",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:1,reduceTargetStrength:2,reduceTargetArmor:1,text:"Steals 2 Strenght",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:3,text:"Steals 3 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 poison",probability:0}],gameState.turn%2==1?gameState.enemy3.actions=[{key:"Intends to\nHeal his team",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:0,text:"All enemies heals 15 HP",probability:1}]:gameState.enemy3.actions=[{key:()=>"Intends to\nBuff his team",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:3,text:"All enemies Gain 2 strength and 3 armor",probability:1}]}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Level4Fight3")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){console.log("DEBUG: depleteAshenEncore started"),gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}class Level4Fight3 extends BaseScene{self;constructor(){super("Level4Fight3")}preload(){this.load.image("bakgrunnFortress3","assets/images/bakgrunnFortress3.jpg"),this.load.image("monster5","assets/images/sprites/monster5.png"),this.load.image("sorcerer2","assets/images/sprites/sorcerer2.png")}create(){const e=this;function t(){let t=gameState.player.numCardsBase+gameState.player.numCardsStance;gameState.turn+=1,gameState.endOfTurnButtonPressed=!1,gameState.yourTurnText=e.add.text(550,300,"Your turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),gameState.player.poisonText=e.add.text(570,350,"",{fontSize:"25px",fill:"#ff0000"}).setOrigin(.5),console.log(`player's turn number ${gameState.turn} has started`),gameState.player.armorCard=0,gameState.player.strengthCard=0;const r=gameState.player.manaBase+gameState.player.manaStance;gameState.player.manaMax=gameState.rebelSpirit&&gameState.turn%3==0?r+1:r,gameState.player.mana=gameState.player.manaMax,gameState.foreverTrue&&gameState.player.stancePoints>0?(gameState.player.manaMax+=1,gameState.player.mana+=1):gameState.foreverTrue||(gameState.player.stancePoints=0),e.updateStanceBar(gameState.player),e.updateManaBar(gameState.player),e.updateHealthBar(gameState.player),e.updatePoison(gameState.player),b(gameState.player),k(gameState.player),e.time.delayedCall(2200,(()=>{gameState.player.poisonText.destroy(),B(gameState.yourTurnText,200),function(t){gameState.endOfTurnButton.setTexture("rectangularButton"),gameState.endOfTurnButton.setInteractive();const r=Math.floor((gameState.slots.length-t)/2);for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));const t=gameState.drawPile.pop(),o=10+n+r;t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),t.isBeingPlayed=!1,gameState.currentCards.push(t),t.sprite.setDepth(o);const i=gameState.slots[r+n];i&&(t.sprite.x=i.x,t.sprite.y=i.y,t.startHeight=t.sprite.y,t.angle=i.angle,t.sprite.setAngle(t.angle),i.available=!1,t.slot=i),gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),e.animateCard(t,o),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}));gameState.playersTurn=!0}(t),gameState.enemies.forEach((t=>{o(),function(e){!function(e){const t=e.actions.reduce(((e,t)=>e+t.probability),0);if(1!==t){const a=1/t;for(let t of e.actions)t.probability*=a}}(e);let t=0;for(let a=0;a<e.actions.length;a++)t+=e.actions[a].probability,e.actions[a].cumulativeProbability=t;const a=Math.random();e.chosenAction=e.actions.find((e=>a<e.cumulativeProbability))}(t),function(t){const a="function"==typeof t.chosenAction.key?t.chosenAction.key():t.chosenAction.key,r={fontSize:"13px",fill:"#000000"};t.intentionText=e.add.text(t.x+10,t.y-t.height/2-40,`${a}`,r),t.intentionText.setOrigin(.5,1).setDepth(11);const n=e.textures.get("listbox1").getSourceImage().width,o=t.intentionText.width/n;t.intentionBackground=e.add.sprite(t.x+10,t.y-t.height/2-33,"listbox1").setScale(1.05*o,1),t.intentionBackground.setInteractive().setOrigin(.5,1).setAlpha(.85).setDepth(10)}(t)}))}))}this.baseCreate("bakgrunnFortress3",.7),this.resetPlayer(gameState.player,.35),this.addButtons(),function(){gameState.drawPileImage=e.add.image(120,600,"deck"),gameState.drawPileImage.setScale(.13).setOrigin(.5,.5).setInteractive();gameState.drawPileText=e.add.text(120,600,gameState.drawPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.drawPileText.setDepth(100).setOrigin(.5,.5),gameState.drawPileImage.on("pointerover",(function(){if(gameState.drawPile.length>0){const t=gameState.drawPile.length<12?4:6,a=105,r=gameState.drawPile.length<12?400:250,n=150;gameState.drawPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.drawPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]}))}(),gameState.discardPileText=e.add.text(980,600,gameState.discardPile.length,{fontSize:"45px",fill:"#000000",fontWeight:"bold"}),gameState.discardPileText.setDepth(100).setOrigin(.5,.5),gameState.discardPileImage=e.add.image(980,600,"deck"),gameState.discardPileImage.setScale(.13).setOrigin(.5,.5).setInteractive().setTint(16711680),gameState.discardPileImage.on("pointerover",(function(){if(gameState.discardPile.length>0){const t=gameState.discardPile.length<12?4:6,a=105,r=gameState.discardPile.length<12?400:250,n=150;gameState.discardPile.forEach(((o,i)=>{let s=r+i%t*a,m=n+1.5*Math.floor(i/t)*a,l=e.add.image(s,m,o.key).setScale(.27).setDepth(200);gameState.cardImages.push(l)}))}})),gameState.discardPileImage.on("pointerout",(function(){gameState.cardImages.forEach((e=>{B(e,200)})),gameState.cardImages=[]})),gameState.kamishimoUberAlles=0,gameState.kirisuteGomen=!1,gameState.toxicFrets=!1,gameState.ashenEncore=!1,gameState.edoEruption=!1,gameState.steelToe=!1,gameState.currentCards=[],gameState.cardImages=[],gameState.enemy1=Object.create(gameState.enemy),gameState.enemy1.name="Goh Resurrected\nSteals Strength and Armor",gameState.enemy1.sprite=this.add.sprite(600,370,"monster2").setScale(.31).setFlipX(!1).setInteractive(),gameState.enemy1.health=50,gameState.enemy1.healthMax=50,gameState.enemy1.armor=0,gameState.enemy2=Object.create(gameState.enemy),gameState.enemy2.name="Terrorsnout\nSteals Strength and Armor",gameState.enemy2.sprite=this.add.sprite(770,370,"monster5").setScale(.48).setFlipX(!1).setInteractive(),gameState.enemy2.health=50,gameState.enemy2.healthMax=50,gameState.enemy2.armor=0,gameState.enemy3=Object.create(gameState.enemy),gameState.enemy3.name="Necronis\nMaster of fire and buffs",gameState.enemy3.sprite=this.add.sprite(950,350,"sorcerer2").setScale(.29).setFlipX(!1).setInteractive(),gameState.enemy3.health=80,gameState.enemy3.healthMax=80,gameState.enemy3.armor=0,gameState.enemies=[gameState.enemy1,gameState.enemy2,gameState.enemy3],gameState.characters=[...gameState.enemies,gameState.player],gameState.characters.forEach((e=>{e.height=e.sprite.displayHeight,e.width=e.sprite.displayWidth,e.x=e.sprite.x,e.y=e.sprite.y,this.addHealthBar(e,e.healthBarColor),this.addStatsDisplay(e),this.describeCharacter(e,e.sprite)})),this.addManaBar(gameState.player),this.addStanceBar(gameState.player,"#a9a9a9"),gameState.permanents.forEach((t=>{const a=t.card,r=t.slot;"kamishimoUberAlles"===a.key||"hollidayInKamakura"===a.key?r.available=!0:(a.tokenSprite=e.add.sprite(r.x,r.y,a.token).setScale(.075).setInteractive(),r.available=!1,a.tokenSlot=r,console.log(`Recreated permanent: ${a.key}\nfor slot ${r.index}`),l(a),m(a))})),function(){gameState.turn=0,gameState.musicTheme.stop(),e.shuffleDeck(gameState.drawPile);const{level:a,fight:r}=e.extractLevelFightFromName(e.scene.key);gameState.startText=e.add.text(550,300,`Level ${a}\nFight ${r}!`,{fontSize:"60px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setDepth(200).setOrigin(.5),e.time.delayedCall(350,(()=>{gameState.music.play({loop:!0,volume:.35})})),e.time.delayedCall(3e3,(()=>{B(gameState.startText,200),e.time.delayedCall(300,t())}))}();function a(t){if(gameState.costPlayed="function"==typeof t.cost?t.cost():t.cost,gameState.typePlayed="function"==typeof t.type?t.type():t.type,gameState.player.mana>=gameState.costPlayed&&!1===gameState.playingCard)if(gameState.player.mana-=gameState.costPlayed,e.updateManaBar(gameState.player),console.log(`activated card: ${t.key}\nCost: ${gameState.costPlayed}`),gameState.player.freedomBeforeCardPlayed="Freedom"===gameState.player.stance,t.isBeingPlayed=!0,gameState.currentCards=gameState.currentCards.filter((e=>e!==t)),t.slot&&(t.slot.available=!0),"targetSelected"===gameState.typePlayed)!function(e,t){gameState.targetingCursor.setVisible(!0),gameState.thisTurn=gameState.turn;for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.removeInteractive();for(let a of gameState.enemies)a.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),a.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),a.sprite.on("pointerup",(function(){e.isBeingPlayed&&gameState.playersTurn&&gameState.thisTurn===gameState.turn&&(e.isBeingPlayed=!1,gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),r(e,a));for(let e of t)e.sprite&&e.sprite.scene&&e.sprite.setInteractive()}))}(t,gameState.currentCards);else if("targetAll"===gameState.typePlayed){gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length);const e=[...gameState.enemies];gameState.enemiesLength=e.length,e.forEach(((a,n)=>{const o=n===e.length-1;r(t,a,o)}))}else"permanent"===gameState.typePlayed?function(t){const a=gameState.permanentSlots.find((e=>e.available));a?("kamishimoUberAlles"===t.key||"hollidayInKamakura"===t.key?(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length)):gameState.deck=gameState.deck.filter((e=>e!==t)),t.slot.available=!0,t.sprite.destroy(),t.tokenSprite=e.add.sprite(a.x,a.y,t.token).setScale(.075).setInteractive(),a.available=!1,t.tokenSlot=a,gameState.permanents.push({card:t,slot:a,tokenSprite:t.tokenSprite}),l(t),m(t)):function(t){switch(e.cameras.main.shake(70,.002,!1),t.isBeingPlayed=!1,console.log(`No available slot for permanent card ${t.key}`),t.key){case"foreverTrue":g(t);break;case"rebelSpirit":d(t);break;case"rebelHeart":S(t);break;case"bushido":p(t);break;case"toxicAvenger":c(t);break;case"kirisuteGomen":y(t);case"toxicFrets":h(t);break;case"ashenEncore":u(t);break;case"edoEruption":f(t);break;case"steelToe":x(t);break;case"kamishimoUberAlles":case"hollidayInKamakura":gameState.currentCards.push(t),t.slot.available=!1}}(t)}(t):(gameState.discardPile.push(t),gameState.discardPileText.setText(gameState.discardPile.length),r(t,gameState.player));else e.cameras.main.shake(70,.002,!1)}function r(t,a,r=!1){gameState.playingCard=!0,B(t.sprite,200),B(gameState.actionText,50),gameState.targetingCursor.setVisible(!1);const{damagePlayed:n,firePlayed:s,stancePointsPlayed:m,poisonPlayed:l,healPlayed:g,strengthPlayed:d,armorPlayed:S,reduceTargetArmorPlayed:p,reduceTargetStrengthPlayed:c,drawCardPlayed:y}=function(e,t,a=!1){const r="moshpitMassacre"===e.key&&gameState.player.stancePoints>0&&t.poison>0,n="scorchedSoul"===e.key&&t.poison>0,o="bladesBlight"===e.key&&t.poison>0,i="roninsRot"===e.key&&t.poison>0,s="kabutu"===e.key&&gameState.edoEruption&&gameState.player.stancePoints>0,m="combatBoots"===e.key&&gameState.steelToe,l="knuckleFist"===e.key&&gameState.edoEruption&&gameState.player.stancePoints<0,g=gameState.player.stancePoints>0?2*(1+gameState.player.stancePoints):2;return{damagePlayed:r?11:P(e.damage),firePlayed:s?2*gameState.player.stancePoints:n?12:P(e.fire),stancePointsPlayed:s&&a?-1:P(e.stancePoints),poisonPlayed:o?t.poison:P(e.poison),healPlayed:P(e.heal),strengthPlayed:P(e.strength),armorPlayed:l?-gameState.player.stancePoints:P(e.armor),reduceTargetArmorPlayed:m?g:P(e.reduceTargetArmor),reduceTargetStrengthPlayed:i?t.poison:P(e.reduceTargetStrength),drawCardPlayed:P(e.drawCard)}}(t,a,r),h=(1+.1*gameState.player.strength)*(1-a.armor/20),u=Math.round(Math.max(0,s+n*h));a!=gameState.player&&(gameState.score.damageDealt+=u,console.log(`${n} Physical Damage and ${s} Fire Damage was dealt to ${a.name}`),a.strengthTurn-=c,a.armor-=p,a.poison+=l,a.health-=u),"seppuku"===t.key||"boneShredder"===t.key?gameState.player.strengthBase+=d:gameState.player.strengthCard+=d,"libertySpikes"===t.key&&gameState.player.stancePoints>0&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),g&&(gameState.player.health=Math.min(gameState.player.health+g,gameState.player.healthMax),e.updateHealthBar(gameState.player)),gameState.player.armorCard+=S,gameState.player.poison=Math.max(0,gameState.player.poison-t.poisonRemove),function(t,a,r,n){const o={fontSize:"32px",fill:"#ff0000"};if("targetSelected"===gameState.typePlayed||"targetAll"===gameState.typePlayed){e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8});const r=`${t>0?`Deals ${t} damage`:""}\n\n${a>0?`Deals ${a} Poison`:""}`;gameState.actionText=e.add.text(550,300,r,o).setOrigin(.5),e.attackTweens(gameState.player,60)}else r>0?(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${r} Strength`,o).setOrigin(.5),e.powerUpTweens(gameState.player)):n>0&&(gameState.powerUpSound.play({volume:.15}),gameState.actionText=e.add.text(550,300,`Gains ${n} Armor`,o).setOrigin(.5),e.powerUpTweens(gameState.player))}(u,l,d,S),gameState.player.stancePoints+m>=-3&&gameState.player.stancePoints+m<=3&&(gameState.player.stancePoints+=m,e.updateStanceBar(gameState.player)),gameState.player.freedomAfterCardPlayed="Freedom"===gameState.player.stance,!gameState.player.freedomBeforeCardPlayed&&gameState.player.freedomAfterCardPlayed&&(gameState.player.mana+=1,gameState.player.manaMax+=1,e.updateManaBar(gameState.player)),T(a),e.updateHealthBar(a),k(gameState.player),b(a),i(),o(),C(y),gameState.enemies.forEach((t=>{e.updateEnemyIntention(t)})),e.time.delayedCall(260,(()=>{gameState.playingCard=!1})),e.time.delayedCall(1500,(()=>{gameState.actionText&&gameState.actionText.destroy()}))}function n(){0!==gameState.enemies.length&&(gameState.enemies[gameState.currentEnemyIndex].alive?function(a){gameState.playersTurn&&(gameState.playersTurn=!1,a.turnText=e.add.text(550,300,"Enemy turn!",{fontSize:"60px",fill:"#ff0000"}).setOrigin(.5),e.time.delayedCall(1800,(()=>{B(a.turnText,200)})));a.turnComplete=!1,function(a){a.poisonText=e.add.text(570,350,"",{fontSize:"30px",fill:"#ff0000"}).setOrigin(.5),e.updatePoison(a),gameState.toxicAvenger&&a.poison>0&&T(a);const r=""!==a.poisonText._text||a.turnText?1800:800;e.time.delayedCall(r,(()=>{a.poisonText.destroy();const r=a.chosenAction;if(gameState.player.poison+=r.poison,a===gameState.enemy3?gameState.enemies.forEach((e=>{e.health=Math.min(e.health+r.heal,e.healthMax),e.strengthBase=Math.min(e.strengthBase+r.strength,e.strengthMax),e.armor=Math.min(e.armor+r.armor,e.armorMax),T(e)})):(a.health=Math.min(a.health+r.heal,a.healthMax),a.strengthBase=Math.min(a.strengthBase+r.strength,a.strengthMax),a.armor=Math.min(a.armor+r.armor,a.armorMax),gameState.player.armorBase-=r.reduceTargetArmor,gameState.player.strengthBase-=r.reduceTargetStrength,T(a),T(gameState.player)),r.damage>0||r.fire>0){const t=(1+.1*a.strength)*(1-gameState.player.armor/20);if(e.cameras.main.shake(120,.005,!1),gameState.attackSound.play({volume:.8}),console.log(`enemy.damageTotal: ${a.damageTotal}`),a.damageTotal=Math.round(Math.max(0,r.fire+r.damage*t)),gameState.player.health-=a.damageTotal,gameState.score.damageTaken+=a.damageTotal,a===gameState.enemy1||a===gameState.enemy2){const t=r.armor>0?`Steals ${r.armor} Armor`:`Steals ${r.strength} Strength`;gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage\n${t}`,actionTextConfig).setOrigin(.5)}else gameState.actionText=e.add.text(550,300,`Deals ${a.damageTotal} damage`,actionTextConfig).setOrigin(.5);e.tweens.add({targets:a.sprite,x:a.sprite.x-60,duration:120,ease:"Cubic",yoyo:!0})}else r.heal>0?(gameState.healSound.play({volume:.5}),gameState.actionText=e.add.text(550,300,r.text,{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5),e.powerUpTweens(a)):(r.strength>0||r.armor>0||r.poison>0)&&(gameState.powerUpSound.play({volume:.2}),gameState.actionText=e.add.text(550,300,r.text,{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5),e.powerUpTweens(a));a.strengthTurn=0,function(a){[gameState.player,a].forEach((t=>{e.updateHealthBar(t),b(t),T(t)})),e.time.delayedCall(1500,(()=>{B(gameState.actionText,200),a.turnComplete=!0,i()||!gameState.enemies[gameState.currentEnemyIndex].turnComplete&&gameState.enemies[gameState.currentEnemyIndex].alive||(gameState.currentEnemyIndex++,gameState.currentEnemyIndex<gameState.enemies.length?n():(gameState.currentEnemyIndex=0,t()))}))}(a)}))}(a)}(gameState.enemies[gameState.currentEnemyIndex]):(gameState.currentEnemyIndex++,n()))}function o(){1===gameState.turn?gameState.enemy1.actions=[{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:4,text:"Steals 4 Armor",probability:1}]:2===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 12 damage",probability:1}]:3===gameState.turn?gameState.enemy1.actions=[{key:()=>`Intends to\nDeal ${Math.round(15*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:15,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 15 damage",probability:1}]:gameState.enemy1.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 12 damage\nSteals 1 Armor",probability:.27+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy1.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 17 damage\nSteals 1 Strength",probability:.18+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 15 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 25 HP\nSteals 1 Strength",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:1,reduceTargetStrength:2,reduceTargetArmor:1,text:"Steals 2 Strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:3,text:"Steals 3 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 poison",probability:0}],gameState.enemy2.actions=[{key:"Intends to\nDeal 5 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 fire damage",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(12*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:12,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 12 damage\nSteals 1 Armor",probability:.27+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:()=>`Intends to\nDeal ${Math.round(17*(1+.1*gameState.enemy2.strength)*(1-gameState.player.armor/20))} damage`,damage:17,fire:0,poison:0,heal:0,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Deals 17 damage\nSteals 1 Strength",probability:.18+(gameState.enemy2.health>=gameState.enemy2.healthMax?.22:0)/5},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:15,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Heals 15 HP\nSteals 1 Armor",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.17},{key:"Intends to\nApply a buff",damage:0,fire:0,poison:0,heal:25,poisonRemove:0,strength:1,armor:0,reduceTargetStrength:1,reduceTargetArmor:0,text:"Heals 25 HP\nSteals 1 Strength",probability:gameState.enemy1.health>=gameState.enemy1.healthMax?0:.06},{key:"Intends to\nSteal Strength",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:1,reduceTargetStrength:2,reduceTargetArmor:1,text:"Steals 2 Strenght",probability:.12+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nSteal Armor",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:0,armor:2,reduceTargetStrength:0,reduceTargetArmor:3,text:"Steals 3 Armor",probability:.1+(gameState.enemy1.health>=gameState.enemy1.healthMax?.22:0)/5},{key:"Intends to\nPoison you",damage:0,fire:0,poison:5,heal:0,poisonRemove:0,strength:0,armor:1,reduceTargetStrength:0,reduceTargetArmor:1,text:"Deals 5 poison",probability:0}],1===gameState.turn?gameState.enemy3.actions=[{key:"Intends to\nBuff team",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:3,armor:4,text:"Team gains 3 Strength and 4 Armor",probability:1}]:gameState.enemy3.actions=[{key:"Intends to\nDeal 7 fire damage",damage:0,fire:5,poison:0,heal:0,poisonRemove:0,strength:0,armor:0,text:"Deals 7 fire damage",probability:.7},{key:"Intends to\nBuff Team",damage:0,fire:0,poison:0,heal:0,poisonRemove:0,strength:2,armor:3,text:"Team gains 2 Strength and 3 armor",probability:.3}]}function i(){return gameState.player.alive?!gameState.enemies.some((e=>e.alive))&&(gameState.playersTurn=!1,function(){gameState.score.numberOfTurns+=gameState.turn,gameState.score.levelsCompleted+=1,gameState.music.stop(),e.updateManaBar(gameState.player),v(),e.time.delayedCall(600,(()=>{gameState.attackSound.isPlaying&&gameState.attackSound.stop(),gameState.victorySound.play({volume:.9,rate:1}),e.clearBoard()})),gameState.actionText&&(gameState.actionText.destroy(),console.log("gameState.actionText still existed at initiateVictory and got destroyed"));const t={fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"},a=e.add.text(550,300,"Victory!",t).setOrigin(.5);e.time.delayedCall(2e3,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),a.destroy(),function(){e.shuffleDeck(gameState.bonusCards);const t={fontSize:"40px",fill:"#000000"},a={fontSize:"25px",fill:"#000000"};gameState.gameOverText=e.add.text(550,180,"Choose a reward",t).setOrigin(.5).setDepth(103),gameState.rewardAddCardsText=e.add.text(550,400,"Add 1 card\nto your deck",a).setOrigin(.5).setDepth(103),gameState.rewardAddCardsButton=e.add.image(550,400,"rectangularButton"),gameState.rewardAddCardsButton.setScale(1.2).setInteractive().setOrigin(.5).setDepth(102),gameState.rewardAddCardsButton.on("pointerover",(function(){this.setTexture("rectangularButtonHovered")})),gameState.rewardAddCardsButton.on("pointerout",(function(){this.setTexture("rectangularButton")})),gameState.rewardAddCardsButton.on("pointerup",(function(){gameState.rewardAddCardsText.destroy(),gameState.gameOverText.destroy(),gameState.rewardAddCardsButton.destroy(),function(){console.log("rewardAddCard called"),gameState.gameOverText.destroy();const t=320,a=300,r=220;let n=gameState.bonusCards.slice(0,3);console.log(`bonusCards: ${n.key}`),n.forEach(((o,i)=>{o.sprite=e.add.sprite(t+i*r,a,o.key),o.sprite.setScale(.45).setInteractive().setDepth(102),console.log(`bonusCardsprite added for: ${o.key}`),o.sprite.on("pointerover",(()=>{gameState.cardsDealtSound.play({volume:.6}),e.cardTweens(o.sprite,.58,200)}),e),o.sprite.on("pointerout",(()=>{e.cardTweens(o.sprite,.45,400)}),e),o.sprite.on("pointerup",(()=>{let t=!1;gameState.deck.push(o),"permanent"===o.type&&gameState.bonusCards.splice(gameState.bonusCards.indexOf(o),1),n.forEach((e=>{e.sprite.removeInteractive(),e!==o&&B(e.sprite,200)})),e.tweens.add({targets:o.sprite,x:e.cameras.main.centerX,y:e.cameras.main.centerY+100,scaleX:.6,scaleY:.6,duration:1e3,ease:"Power2"}),e.add.text(550,180,"Gained 1 card",{fontSize:"40px",fill:"#000000"}).setOrigin(.5),e.time.delayedCall(2500,(()=>{t||(t=!0,s())})),e.input.on("pointerup",(()=>{t||(t=!0,s())}))}))}))}()}))}()}))}(),!0):(gameState.playersTurn=!1,function(){gameState.player.health=0,e.updateManaBar(gameState.player),v(),gameState.music.stop(),gameState.endOfTurnButton.destroy(),gameState.actionText&&B(gameState.actionText,200);gameState.score.numberOfTurns+=gameState.turn,gameState.gameOverText=e.add.text(550,300," Defeat!",{fontSize:"100px",fill:"#ff0000",fontFamily:"Rock Kapak"}).setOrigin(.5),gameState.gameOverText.setInteractive();let t=!1;e.time.delayedCall(400,(()=>{gameState.musicTheme.play({loop:!0,volume:.3}),t||(gameState.gameOverText.on("pointerup",(()=>{t=!0,e.scene.start("Endscene")})),e.time.delayedCall(2500,(()=>{t=!0,e.scene.start("Endscene")})))}))}(),!0)}function s(){e.cameras.main.fadeOut(1e3),e.time.delayedCall(1e3,(()=>{e.scene.start("Endscene")}))}function m(t){if("foreverTrue"===t.key)gameState.foreverTrue=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?g(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelSpirit"===t.key)gameState.rebelSpirit=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?d(t):e.cameras.main.shake(70,.002,!1)}));else if("rebelHeart"===t.key)gameState.rebelHeart=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?S(t):e.cameras.main.shake(70,.002,!1)}));else if("bushido"===t.key)gameState.bushido=!0,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?p(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicAvenger"===t.key)gameState.toxicAvenger=!0,gameState.enemies.forEach((e=>T(e))),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?c(t):e.cameras.main.shake(70,.002,!1)}));else if("kirisuteGomen"===t.key)gameState.player.strengthMax+=5,k(gameState.player),t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn&&gameState.enemies.some((e=>e.health<30))?y(t):e.cameras.main.shake(70,.002,!1)}));else if("toxicFrets"===t.key)gameState.toxicFrets=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?h(t):e.cameras.main.shake(70,.002,!1)}));else if("ashenEncore"===t.key)gameState.ashenEncore=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?u(t):e.cameras.main.shake(70,.002,!1)}));else if("edoEruption"===t.key)gameState.edoEruption=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?f(t):e.cameras.main.shake(70,.002,!1)}));else if("steelToe"===t.key)gameState.steelToe=!0,t.tokenSprite.on("pointerup",(()=>{gameState.playersTurn?x(t):e.cameras.main.shake(70,.002,!1)}));else if("kamishimoUberAlles"===t.key){const a=t.tokenSprite,r=t.tokenSlot;gameState.kamishimoUberAlles+=1,k(gameState.player),a.on("pointerup",(()=>{gameState.playersTurn?function(e,t,a){a&&(a.available=!0);t&&t.destroy();e.permanentCardSprite&&e.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==t)),gameState.kamishimoUberAlles-=1,k(gameState.player)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}else if("hollidayInKamakura"===t.key){let a=t.tokenSprite,r=t.tokenSlot;const n=gameState.turn,o=gameState.score.levelsCompleted;a.on("pointerup",(()=>{const i=n!=gameState.turn||o!=gameState.score.levelsCompleted;console.log(`depletedDifferentTurn: ${i}\nturnplayed: ${n}\ngameState.turn: ${gameState.turn}\nfightplayed: ${o}\ngameState.score.levelsCompleted: ${gameState.score.levelsCompleted}\ngameState.playersTurn: ${gameState.playersTurn}`),gameState.playersTurn&&i?function(t,a,r){r&&(r.available=!0);a&&a.destroy();t.permanentCardSprite&&t.permanentCardSprite.destroy();gameState.permanents=gameState.permanents.filter((e=>e.tokenSprite!==a)),gameState.player.manaMax+=1,gameState.player.mana+=1,e.updateManaBar(gameState.player),C(1)}(t,a,r):e.cameras.main.shake(70,.002,!1)}))}}function l(t){t.tokenSprite.on("pointerover",(function(){gameState.cardsDealtSound.play({volume:1.5}),t.permanentCardSprite=e.add.sprite(550,300,t.key).setScale(.55).setDepth(26)})),t.tokenSprite.on("pointerout",(function(){t.permanentCardSprite.destroy()}))}function g(e){gameState.foreverTrue=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),C(8)}function d(t){gameState.rebelSpirit=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.mana+=3,gameState.player.manaMax+=3,e.updateManaBar(gameState.player)}function S(t){gameState.rebelHeart=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+12),e.updateHealthBar(gameState.player)}function p(e){gameState.bushido=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.player.strengthBase+=6,k(gameState.player)}function c(e){gameState.toxicAvenger=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e)),gameState.enemies.forEach((e=>{e.poison+=4,T(e)}))}function y(t){if(gameState.enemies.some((e=>e.health<30))){gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((r=>{r.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),r.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),r.sprite.on("pointerup",(function(){r.health<30&&a?(r.health=0,gameState.attackSound.play({volume:1}),e.cameras.main.shake(120,.025,!1),t.tokenSlot&&(t.tokenSlot.available=!0,gameState.player.strengthMax-=5),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),b(r),i(),k(gameState.player)):(e.cameras.main.shake(70,.002,!1),a=!1),gameState.targetingCursor.setVisible(!1)}))}))}else e.cameras.main.shake(70,.002,!1),t.slot.available=!1,gameState.currentCards.some((e=>"kirisuteGomen"===e.key))||(gameState.currentCards.push(t),gameState.player.mana+=1,e.updateManaBar(gameState.player))}function h(t){gameState.toxicFrets=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.enemies.forEach((t=>{t.poison>0&&(t.health-=2*t.poison,e.updateHealthBar(t),b(t),i())}))}function u(t){gameState.ashenEncore=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t));const a=e.add.text(550,350,"Deals 12 firedamage\n to all enemies",{fontSize:"32px",fill:"#ff0000"}).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{a.destroy()})),gameState.enemies.forEach((t=>{t.health-=12,e.updateHealthBar(t),b(t),i()}))}function f(e){gameState.edoEruption=!1,e.tokenSlot&&(e.tokenSlot.available=!0),e.sprite&&e.sprite.destroy(),e.tokenSprite&&e.tokenSprite.destroy(),e.permanentCardSprite&&e.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((t=>t.card!==e)),gameState.deck=gameState.deck.filter((t=>t!==e))}function x(t){gameState.steelToe=!1,t.tokenSlot&&(t.tokenSlot.available=!0),t.sprite&&t.sprite.destroy(),t.tokenSprite&&t.tokenSprite.destroy(),t.permanentCardSprite&&t.permanentCardSprite.destroy(),gameState.permanents=gameState.permanents.filter((e=>e.card!==t)),gameState.deck=gameState.deck.filter((e=>e!==t)),gameState.targetingCursor.setVisible(!0);let a=!0;gameState.enemies.forEach((t=>{t.sprite.on("pointerover",(function(){gameState.targetingCursor.setTexture("targetingCursorReady")})),t.sprite.on("pointerout",(function(){gameState.targetingCursor.setTexture("targetingCursor")})),t.sprite.on("pointerup",(function(){a&&(t.armor-=7,T(t),gameState.attackSound.play({volume:.6}),e.cameras.main.shake(100,.012,!1),gameState.targetingCursor.setVisible(!1),a=!1)}))}))}function k(e){let t=0;gameState.endOfTurnButtonPressed?(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard+e.armorStance),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+t)):(e.armor=Math.min(e.armorMax,e.armorBase+e.armorCard),t=gameState.bushido?Math.floor(e.armor/4):0,e.strength=Math.min(e.strengthMax,e.strengthBase+e.strengthStance+e.strengthCard+t)),gameState.kamishimoUberAlles>0&&gameState.player.stancePoints<0&&(e.strength=Math.min(e.strengthMax,e.strength-gameState.player.stancePoints*gameState.kamishimoUberAlles)),T(e)}function T(e){e!=gameState.player&&(e.strength=e.strengthBase+e.strengthTurn,gameState.toxicAvenger&&e.poison>0&&(e.strength-=4)),e.armorText.setText(`${e.armor}/${e.armorMax}`),e.strengthText.setText(`${e.strength}/${e.strengthMax}`)}function b(e){if(e.health<=0){if(e.health=0,e.sprite.removeInteractive(),e.alive=!1,e.turnComplete=!0,e!=gameState.player){const t=gameState.enemies.indexOf(e),a=gameState.characters.indexOf(e);-1!==t&&gameState.enemies.splice(t,1),-1!==a&&gameState.characters.splice(a,1)}[e.sprite,e.healthBarBackground,e.healthBar,e.healthBarText,e.manaBarBackground,e.manaBar,e.manaBarText,e.strengthAndArmorImage,e.strengthText,e.armorText,e.descriptionBackground,e.descriptionText,e.intentionText,e.intentionBackground].forEach((e=>{B(e,500)}))}}function v(){for(;gameState.currentCards.length>0;){let e=gameState.currentCards.pop();e.slot.available||(e.slot.available=!0),gameState.discardPile.push(e),gameState.discardPileText.setText(gameState.discardPile.length),B(e.sprite,200)}}function C(t){const r=Math.min(gameState.deck.length,8),n=gameState.slots.filter((e=>e.available)).length;t=n<t?n:t;for(let n=0;n<t;n++)e.time.delayedCall(75*n,(()=>{if(gameState.currentCards.length<r){0===gameState.drawPile.length&&(gameState.drawPile=gameState.discardPile,e.shuffleDeck(gameState.drawPile),gameState.discardPile=[],gameState.discardPileText.setText(gameState.discardPile.length));let t=gameState.drawPile.pop();t.sprite=e.add.sprite(0,0,t.key).setScale(.35).setInteractive(),console.log(`card added: ${t.key}`),t.isBeingPlayed=!1,gameState.currentCards.push(t);let r=gameState.slots.filter((e=>e.available)),n=r[Math.floor(r.length/2)];if(n){t.sprite.x=n.x,t.sprite.y=n.y,t.startHeight=t.sprite.y,t.angle=n.angle,t.sprite.setAngle(t.angle),n.available=!1,t.slot=n;let a=10+n.index;t.sprite.setDepth(a),e.animateCard(t,a)}gameState.cardsDealtSound.play({volume:2.2}),gameState.drawPileText.setText(gameState.drawPile.length),gameState.ashenEncore&&gameState.enemies.forEach((t=>{if(t.health-=4,e.updateHealthBar(t),b(t),"undefined"==typeof ashenEncoreText||!ashenEncoreText){const t={fontSize:"32px",fill:"#ff0000"},a="Deals 4 fire damage to all enemies",r=e.add.text(550,350,a,t).setOrigin(.5);e.cameras.main.shake(100,.003,!1),gameState.attackSound.play({volume:.8}),e.time.delayedCall(1500,(()=>{r.destroy()}))}})),gameState.playersTurn&&t.sprite.on("pointerup",(function(){a(t)}))}else e.cameras.main.shake(70,.002,!1)}))}function P(e){return"function"==typeof e?e():e}function B(t,a){t&&e.tweens.add({targets:t,alpha:0,ease:"Power1",duration:a,onComplete:()=>{t.destroy()}},e)}gameState.slots=[{available:!0,x:230,y:640,index:0,angle:-12},{available:!0,x:320,y:610,index:1,angle:-8},{available:!0,x:410,y:590,index:2,angle:-4},{available:!0,x:500,y:580,index:3,angle:0},{available:!0,x:590,y:590,index:4,angle:4},{available:!0,x:680,y:610,index:5,angle:8},{available:!0,x:770,y:640,index:6,angle:12},{available:!0,x:860,y:670,index:7,angle:16}],gameState.endOfTurnButton.on("pointerup",(function(){gameState.currentEnemyIndex=0,gameState.targetingCursor.visible||!gameState.playersTurn?e.cameras.main.shake(70,.002,!1):(this.setTexture("rectangularButtonPressed"),this.removeInteractive(),gameState.buttonPressedSound.play(),gameState.endOfTurnButtonPressed=!0,v(),k(gameState.player),o(),gameState.rebelHeart&&(gameState.player.health=Math.min(gameState.player.healthMax,gameState.player.health+Math.abs(gameState.player.stancePoints)),e.updateHealthBar(gameState.player)),gameState.enemies.forEach((e=>{e.turnComplete=!e.alive,B(e.intentionText,200),B(e.intentionBackground,200)})),0!=gameState.player.mana&&(gameState.player.mana=0,e.updateManaBar(gameState.player)),e.time.delayedCall(100,(()=>{gameState.actionText&&gameState.actionText.destroy(),n()})))})),"admin"===gameState.playerName&&(gameState.getManaButton=e.add.sprite(550,200,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.getManaText=e.add.text(550,200,"Get Mana",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.getManaButton.on("pointerup",(()=>{gameState.playersTurn&&(gameState.player.mana=gameState.player.manaMax,e.updateManaBar(gameState.player),console.log("mana gained"))})),gameState.drawCardButton=e.add.sprite(550,300,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.drawCardText=e.add.text(550,300,"Draw Card",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.drawCardButton.on("pointerup",(()=>{gameState.playersTurn&&(C(1),console.log("card drawn"))})),gameState.killEnemyButton=e.add.sprite(550,400,"rectangularButton").setScale(.45).setOrigin(.5).setInteractive(),gameState.killEnemyText=e.add.text(550,400,"Kill Enemy",{fontSize:"15px",fill:"#ff0000"}).setOrigin(.5),gameState.killEnemyButton.on("pointerup",(()=>{if(gameState.enemies.some((e=>e.health>0&&gameState.playersTurn))){const e=gameState.enemies.find((e=>e.health>0));e.health=0,b(e),i(),console.log(`${e.name} killed`)}})))}update(){gameState.targetingCursor.visible&&(gameState.targetingCursor.x=this.input.mousePointer.x,gameState.targetingCursor.y=this.input.mousePointer.y)}}function updateLeaderboard(e,t){fetch(`https://www.dreamlo.com/lb/CBGhFikNak2i8KjH3UPThAfGJFnWo9A0O8mjvU19hS2Q/add/${e}/${t}`).then((e=>e.text())).then((e=>console.log(e))).catch((e=>{console.error("Error:",e)}))}class Endscene extends Phaser.Scene{constructor(){super("Endscene")}async getTopScores(){try{const e=await fetch("https://www.dreamlo.com/lb/64c442f28f40bb8380e27ce7/json");if(!e.ok)throw new Error("Failed to fetch leaderboard data");let t=(await e.json()).dreamlo.leaderboard.entry;return t.sort(((e,t)=>t.score-e.score)),t.slice(0,5)}catch(e){return console.error(e),null}}preload(){this.load.image("endscene","assets/images/endscene.jpg")}create(){self=this;this.cameras.main.fadeIn(800,0,0,0),this.input.keyboard.createCursorKeys(),this.add.image(550,320,"endscene").setScale(.95).setOrigin(.5,.5).on("pointerup",(()=>r())),this.add.text(550,110,"    Thanks for playing\nPunk Rock Samurai alpha v1.1",{fontSize:"57px",fill:"#a9a9a9",fontFamily:"Rock Kapak"}).setOrigin(.5,.5),gameState.score.totalScore=gameState.score.levelsCompleted>0?gameState.score.levelsCompleted*(15+Math.max(0,7-gameState.score.numberOfTurns/gameState.score.levelsCompleted)):0;let e={numberOfTurns:"Number of turns played",levelsCompleted:"Number of fights won",damageTaken:"Total damage taken",damageDealt:"Total damage dealt",totalScore:"Your score"},t=280,a=200;function r(){console.log("returnto meny called"),gameState.name="",self.cameras.main.shake(1500,.0015,!1),self.cameras.main.flash(500),self.time.delayedCall(500,(()=>{self.cameras.main.fadeOut(1e3),location.reload()}))}"admin"!=gameState.playerName&&updateLeaderboard(gameState.playerName,gameState.score.totalScore),self.time.delayedCall(600,(()=>{!async function(){try{console.log("displayLeaderBoard called");let r=await self.getTopScores();const n=self.add.graphics();n.fillStyle(16777215,1).setAlpha(.8),n.fillRect(t,a,540,420),self.add.text(330,a+50,"Your Results",{fontSize:"25px",fill:"#000000"}).setOrigin(0),Object.entries(gameState.score).forEach((([t,r])=>{if(console.log(`${t}: ${r}`),e[t]){let n=`${e[t]}: ${r}`;self.add.text(330,a+90,n,{color:"#000",fontSize:"16px"}),a+=20}}));const o={fontSize:"16px",fill:"#000000"};self.add.text(330,a+150,"Leaderboard",{fontSize:"25px",fill:"#000000"}).setOrigin(0),r?r.forEach(((e,t)=>{let r=e.date.split(" ")[0];const n=`${t+1}. Name: ${e.name}, Score: ${e.score}, Date: ${r}`;let i=self.add.text(330,a+190,n,o).setOrigin(0);sceneState.displayedScoreArray.push(i),a+=20})):self.add.text(330,a+190,"Leaderboard is down for maintenance",o).setOrigin(0)}catch(e){console.error("Error in displayLeaderBoard: ",e);const t={fontSize:"16px",fill:"#FF0000"};self.add.text(330,a+190,"Leaderboard is down for maintenance",t).setOrigin(0)}}()})),self.time.delayedCall(7e3,(()=>{console.log("timeout"),r()}))}}const config={type:Phaser.AUTO,width:1100,height:680,scene:[BaseScene,Preload,Mainmenu,Level1Fight1,Level1Fight2,Level1Fight3,Level2Fight1,Level2Fight2,Level2Fight3,Level3Fight1,Level3Fight2,Level3Fight3,Level4Fight1,Level4Fight2,Level4Fight3,Endscene],scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},dom:{createContainer:!0}},game=new Phaser.Game(config);
